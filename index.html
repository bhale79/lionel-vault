<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸš‚</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230e0f11'/><text y='0.9em' font-size='80'>ğŸš‚</text></svg>">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Lionel Vault">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0e0f11">
  <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Lionel Vault&quot;,&quot;short_name&quot;:&quot;Lionel Vault&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%230e0f11&quot;,&quot;theme_color&quot;:&quot;%230e0f11&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230e0f11'/><text y='0.9em' font-size='80'>ğŸš‚</text></svg>&quot;,&quot;sizes&quot;:&quot;any&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Lionel Vault â€” Postwar Collector's Inventory</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  /* â”€â”€ Reset & Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  /* Prevent iOS auto-zoom on inputs */
  @media (max-width: 640px) {
    input, select, textarea { font-size: 16px !important; }
  }

  :root {
    --bg:        #0e0f11;
    --surface:   #161820;
    --surface2:  #1e2028;
    --border:    #2a2d38;
    --accent:    #e8401c;
    --accent2:   #f5a623;
    --text:      #e8e9ec;
    --text-dim:  #7c8090;
    --text-mid:  #b0b4c0;
    --green:     #2ecc71;
    --red:       #e74c3c;
    --radius:    10px;
    --font-head: 'Bebas Neue', sans-serif;
    --font-body: 'DM Sans', sans-serif;
    --font-mono: 'DM Mono', monospace;
    --sidebar-w: 260px;
    --header-h:  60px;
  }

  html, body { height: 100%; font-family: var(--font-body); background: var(--bg); color: var(--text); font-size: 14px; }

  /* â”€â”€ Auth Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #auth-screen {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 100vh; padding: 2rem;
    background: radial-gradient(ellipse at 30% 20%, #1a1f3a 0%, var(--bg) 60%),
                radial-gradient(ellipse at 80% 80%, #2a1008 0%, transparent 50%);
  }

  .auth-logo {
    font-family: var(--font-head); font-size: clamp(3rem, 10vw, 6rem);
    letter-spacing: 0.05em; line-height: 1;
    background: linear-gradient(135deg, #fff 0%, var(--accent2) 50%, var(--accent) 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    margin-bottom: 0.25rem;
  }
  .auth-sub {
    font-size: 0.8rem; letter-spacing: 0.3em; text-transform: uppercase;
    color: var(--text-dim); margin-bottom: 3rem;
  }
  .auth-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 2.5rem; width: 100%; max-width: 400px;
    text-align: center;
  }
  .auth-card h2 { font-size: 1.1rem; font-weight: 500; margin-bottom: 0.5rem; }
  .auth-card p { color: var(--text-dim); font-size: 0.85rem; margin-bottom: 2rem; line-height: 1.6; }

  .btn-google {
    display: flex; align-items: center; justify-content: center; gap: 0.75rem;
    width: 100%; padding: 0.85rem 1.5rem;
    background: #fff; color: #333; border: none; border-radius: 8px;
    font-family: var(--font-body); font-size: 0.95rem; font-weight: 500;
    cursor: pointer; transition: all 0.2s;
  }
  .btn-google:hover { background: #f0f0f0; transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .btn-google svg { width: 20px; height: 20px; flex-shrink: 0; }

  .auth-note {
    margin-top: 1.5rem; font-size: 0.75rem; color: var(--text-dim); line-height: 1.5;
  }

  /* â”€â”€ App Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #app { display: none; height: 100vh; flex-direction: column; }
  #app.active { display: flex; }

  /* Header */
  .header {
    height: var(--header-h); background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 1.25rem;
    gap: 1rem; flex-shrink: 0; z-index: 100;
  }
  .header-logo { font-family: var(--font-head); font-size: 1.6rem; letter-spacing: 0.05em;
    background: linear-gradient(135deg, #fff, var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; flex-shrink: 0; }
  .header-search {
    flex: 1; max-width: 480px;
    display: flex; align-items: center; gap: 0.5rem;
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; padding: 0.4rem 0.75rem;
  }
  .header-search input {
    flex: 1; background: none; border: none; outline: none;
    color: var(--text); font-family: var(--font-body); font-size: 0.9rem;
  }
  .header-search input::placeholder { color: var(--text-dim); }
  .header-search svg { color: var(--text-dim); flex-shrink: 0; }
  .header-right { margin-left: auto; display: flex; align-items: center; gap: 0.75rem; }
  .user-chip {
    display: flex; align-items: center; gap: 0.5rem;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 20px; padding: 0.3rem 0.75rem 0.3rem 0.3rem;
    font-size: 0.8rem;
  }
  .user-avatar {
    width: 26px; height: 26px; border-radius: 50%; background: var(--accent);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem; font-weight: 600; color: white;
  }
  .btn-sign-out {
    background: none; border: 1px solid var(--border); border-radius: 6px;
    padding: 0.3rem 0.6rem; color: var(--text-dim); cursor: pointer;
    font-size: 0.75rem; font-family: var(--font-body); transition: all 0.2s;
  }
  .btn-sign-out:hover { border-color: var(--accent); color: var(--accent); }

  /* Body layout */
  .app-body { display: flex; flex: 1; overflow: hidden; }

  /* Sidebar Nav */
  .sidebar {
    width: var(--sidebar-w); background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column; flex-shrink: 0;
    overflow-y: auto;
  }
  .nav-section { padding: 1.25rem 0.75rem 0.5rem; }
  .nav-label { font-size: 0.65rem; letter-spacing: 0.15em; text-transform: uppercase;
    color: var(--text-dim); padding: 0 0.5rem; margin-bottom: 0.4rem; }
  .nav-item {
    display: flex; align-items: center; gap: 0.65rem;
    padding: 0.55rem 0.75rem; border-radius: 7px; cursor: pointer;
    color: var(--text-mid); font-size: 0.875rem; font-weight: 400;
    transition: all 0.15s; border: none; background: none; width: 100%; text-align: left;
  }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { background: rgba(232,64,28,0.12); color: var(--accent); font-weight: 500; }
  .nav-item svg { flex-shrink: 0; opacity: 0.8; }
  .nav-badge {
    margin-left: auto; background: var(--accent); color: white;
    border-radius: 10px; padding: 0.1rem 0.45rem; font-size: 0.7rem; font-weight: 600;
  }
  .nav-badge.green { background: var(--green); }

  /* Main content */
  .main { flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }

  /* â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .page { display: none; }
  .page.active { display: contents; }

  .page-title {
    font-family: var(--font-head); font-size: 2rem; letter-spacing: 0.04em;
    display: flex; align-items: baseline; gap: 0.75rem;
  }
  .page-title span { font-family: var(--font-body); font-size: 0.8rem;
    color: var(--text-dim); font-weight: 400; letter-spacing: 0; }

  /* Stat cards */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1rem; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 1.25rem; position: relative; overflow: hidden;
  }
  .stat-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: var(--accent-color, var(--accent));
  }
  .stat-label { font-size: 0.72rem; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--text-dim); margin-bottom: 0.5rem; }
  .stat-value { font-family: var(--font-head); font-size: 2.2rem; letter-spacing: 0.02em;
    line-height: 1; color: var(--text); }
  .stat-sub { font-size: 0.75rem; color: var(--text-dim); margin-top: 0.3rem; }

  /* Category breakdown */
  .section-title { font-size: 0.72rem; letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--text-dim); margin-bottom: 0.75rem; padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border); }

  .cat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; }
  .cat-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 1rem; display: flex; align-items: center; gap: 0.75rem;
    cursor: pointer; transition: all 0.15s;
  }
  .cat-card:hover { border-color: var(--accent); transform: translateY(-1px); }
  .cat-icon { width: 36px; height: 36px; border-radius: 8px; background: var(--surface2);
    display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
  .cat-info { flex: 1; min-width: 0; }
  .cat-name { font-weight: 500; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .cat-count { font-size: 0.75rem; color: var(--text-dim); }
  .cat-bar { height: 3px; background: var(--border); border-radius: 2px; margin-top: 0.4rem; }
  .cat-bar-fill { height: 100%; border-radius: 2px; background: var(--accent); transition: width 0.8s ease; }

  /* Recent / want list */
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  @media (max-width: 700px) { .two-col { grid-template-columns: 1fr; } }

  .panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; }

  /* â”€â”€ Browse / Search Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .filter-bar {
    display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;
  }
  .filter-select {
    background: var(--surface); border: 1px solid var(--border); border-radius: 7px;
    padding: 0.45rem 0.75rem; color: var(--text); font-family: var(--font-body); font-size: 0.85rem;
    outline: none; cursor: pointer; transition: border-color 0.15s;
  }
  .filter-select:focus { border-color: var(--accent); }
  .filter-toggle {
    padding: 0.45rem 0.75rem; border-radius: 7px; border: 1px solid var(--border);
    background: var(--surface); color: var(--text-mid); font-size: 0.85rem;
    font-family: var(--font-body); cursor: pointer; transition: all 0.15s;
  }
  .filter-toggle.on { background: rgba(232,64,28,0.15); border-color: var(--accent); color: var(--accent); }

  /* Item table */
  .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
  .item-table { width: 100%; border-collapse: collapse; }
  .item-table th {
    background: var(--surface2); padding: 0.65rem 1rem; text-align: left;
    font-size: 0.7rem; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--text-dim); border-bottom: 1px solid var(--border);
    font-weight: 500; white-space: nowrap;
  }
  .item-table td {
    padding: 0.75rem 1rem; border-bottom: 1px solid var(--border);
    font-size: 0.85rem; vertical-align: middle;
  }
  .item-table tr:last-child td { border-bottom: none; }
  .item-table tr:hover td { background: var(--surface2); cursor: pointer; }

  .item-num { font-family: var(--font-mono); font-size: 0.8rem; color: var(--accent2); font-weight: 500; }
  .item-road { color: var(--text-dim); font-size: 0.8rem; }
  .owned-badge {
    display: inline-flex; align-items: center; gap: 0.3rem;
    padding: 0.2rem 0.55rem; border-radius: 12px; font-size: 0.72rem; font-weight: 500;
  }
  .owned-badge.yes  { background: rgba(46,204,113,0.12); color: var(--green); }
  .owned-badge.no   { background: var(--surface2); color: var(--text-dim); }
  .owned-badge.want { background: rgba(245,166,35,0.12); color: var(--accent2); }
  .condition-pip {
    display: inline-block; width: 8px; height: 8px; border-radius: 50%;
    margin-right: 0.25rem;
  }
  .cond-9, .cond-10 { background: #2ecc71; }
  .cond-7, .cond-8  { background: #f1c40f; }
  .cond-5, .cond-6  { background: #e67e22; }
  .cond-low         { background: #e74c3c; }

  .table-pagination {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0.75rem 1rem; border-top: 1px solid var(--border);
    font-size: 0.8rem; color: var(--text-dim);
  }
  .pagination-btns { display: flex; gap: 0.35rem; }
  .page-btn {
    width: 30px; height: 30px; border-radius: 6px; border: 1px solid var(--border);
    background: var(--surface); color: var(--text-mid); cursor: pointer;
    font-size: 0.8rem; font-family: var(--font-body); transition: all 0.15s;
    display: flex; align-items: center; justify-content: center;
  }
  .page-btn:hover { border-color: var(--accent); color: var(--accent); }
  .page-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
  .page-btn:disabled { opacity: 0.3; cursor: default; }

  /* â”€â”€ Item Detail Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200;
    display: flex; align-items: center; justify-content: center; padding: 1rem;
    opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
    width: 100%; max-width: 680px; max-height: 90vh; overflow-y: auto;
    transform: translateY(20px); transition: transform 0.2s;
  }
  .modal-overlay.open .modal { transform: translateY(0); }

  .modal-header {
    display: flex; align-items: flex-start; justify-content: space-between;
    padding: 1.5rem 1.5rem 1rem; border-bottom: 1px solid var(--border);
    position: sticky; top: 0; background: var(--surface); z-index: 1;
  }
  .modal-item-num { font-family: var(--font-mono); font-size: 0.8rem; color: var(--accent2); margin-bottom: 0.25rem; }
  .modal-title { font-size: 1.1rem; font-weight: 600; }
  .modal-subtitle { font-size: 0.82rem; color: var(--text-dim); margin-top: 0.2rem; }
  .btn-close {
    width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border);
    background: var(--surface2); color: var(--text-dim); cursor: pointer;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    font-size: 1rem; transition: all 0.15s;
  }
  .btn-close:hover { border-color: var(--accent); color: var(--accent); }

  .modal-body { padding: 1.25rem 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }

  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
  @media (max-width: 480px) { .info-grid { grid-template-columns: 1fr; } }
  .info-field { }
  .info-field label { font-size: 0.68rem; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--text-dim); display: block; margin-bottom: 0.25rem; }
  .info-field .info-val { font-size: 0.875rem; color: var(--text); }
  .info-field a { color: var(--accent2); text-decoration: none; font-size: 0.8rem; }
  .info-field a:hover { text-decoration: underline; }

  .desc-block { background: var(--surface2); border-radius: 8px; padding: 0.85rem;
    font-size: 0.82rem; line-height: 1.6; color: var(--text-mid); }

  /* Form fields */
  .form-section-title {
    font-size: 0.68rem; letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--accent); font-weight: 600; padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(232,64,28,0.2);
  }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
  @media (max-width: 480px) { .form-grid { grid-template-columns: 1fr; } }
  .form-field label { font-size: 0.72rem; letter-spacing: 0.08em; text-transform: uppercase;
    color: var(--text-dim); display: block; margin-bottom: 0.3rem; }
  .form-field input, .form-field select, .form-field textarea {
    width: 100%; background: var(--bg); border: 1px solid var(--border);
    border-radius: 7px; padding: 0.55rem 0.75rem; color: var(--text);
    font-family: var(--font-body); font-size: 0.875rem; outline: none;
    transition: border-color 0.15s;
  }
  .form-field input:focus, .form-field select:focus, .form-field textarea:focus { border-color: var(--accent); }
  .form-field textarea { resize: vertical; min-height: 70px; }
  .form-field.full { grid-column: 1 / -1; }

  /* Toggle switch */
  .toggle-row { display: flex; align-items: center; gap: 0.75rem; }
  .toggle-label { font-size: 0.875rem; }
  .toggle {
    position: relative; width: 40px; height: 22px;
    background: var(--border); border-radius: 11px; cursor: pointer;
    transition: background 0.2s; flex-shrink: 0;
  }
  .toggle.on { background: var(--green); }
  .toggle::after {
    content: ''; position: absolute; top: 3px; left: 3px;
    width: 16px; height: 16px; border-radius: 50%; background: white;
    transition: transform 0.2s;
  }
  .toggle.on::after { transform: translateX(18px); }

  /* Condition slider */
  .condition-display { display: flex; align-items: center; gap: 0.75rem; }
  .condition-num { font-family: var(--font-head); font-size: 2rem; width: 2rem; color: var(--accent2); }
  input[type=range] { flex: 1; accent-color: var(--accent); }

  /* Price row */
  .price-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; }
  @media (max-width: 480px) { .price-row { grid-template-columns: 1fr; } }

  .modal-footer {
    display: flex; gap: 0.75rem; justify-content: flex-end;
    padding: 1rem 1.5rem; border-top: 1px solid var(--border);
    position: sticky; bottom: 0; background: var(--surface);
  }
  .btn { padding: 0.6rem 1.25rem; border-radius: 8px; font-family: var(--font-body);
    font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.15s; border: none; }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: #d63518; }
  .btn-secondary { background: var(--surface2); color: var(--text-mid); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--accent); color: var(--text); }

  /* â”€â”€ Reports Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .report-controls { display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; }
  .btn-export {
    display: flex; align-items: center; gap: 0.5rem;
    padding: 0.55rem 1rem; border-radius: 8px; border: 1px solid var(--border);
    background: var(--surface); color: var(--text-mid); font-family: var(--font-body);
    font-size: 0.85rem; cursor: pointer; transition: all 0.15s;
  }
  .btn-export:hover { border-color: var(--accent2); color: var(--accent2); }

  .report-table { width: 100%; border-collapse: collapse; }
  .report-table th {
    text-align: left; padding: 0.6rem 1rem; font-size: 0.7rem;
    letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim);
    background: var(--surface2); border-bottom: 1px solid var(--border);
  }
  .report-table td { padding: 0.65rem 1rem; border-bottom: 1px solid var(--border); font-size: 0.83rem; }
  .report-table tr:last-child td { border-bottom: none; }

  /* â”€â”€ Loading & Empty States â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .loading {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 3rem; gap: 1rem; color: var(--text-dim);
  }
  .spinner {
    width: 32px; height: 32px; border: 3px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .empty-state { text-align: center; padding: 3rem; color: var(--text-dim); }
  .empty-state .empty-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
  .empty-state p { font-size: 0.875rem; }

  /* â”€â”€ Setup Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #setup-screen {
    display: none; flex-direction: column; align-items: center; justify-content: center;
    min-height: 100vh; padding: 2rem;
  }
  #setup-screen.active { display: flex; }
  .setup-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
    padding: 2.5rem; width: 100%; max-width: 500px;
  }
  .setup-card h2 { font-family: var(--font-head); font-size: 1.8rem; margin-bottom: 0.5rem; }
  .setup-card p { color: var(--text-dim); font-size: 0.875rem; margin-bottom: 1.5rem; line-height: 1.6; }
  .setup-step { display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 1rem; }
  .setup-num {
    width: 24px; height: 24px; border-radius: 50%; background: var(--accent);
    color: white; font-size: 0.75rem; font-weight: 700; display: flex;
    align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px;
  }
  .setup-step p { color: var(--text-mid); font-size: 0.85rem; margin: 0; }
  .input-group { margin-top: 1.25rem; }
  .input-group label { display: block; font-size: 0.72rem; letter-spacing: 0.08em;
    text-transform: uppercase; color: var(--text-dim); margin-bottom: 0.4rem; }
  .input-group input {
    width: 100%; background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; padding: 0.65rem 0.9rem; color: var(--text);
    font-family: var(--font-mono); font-size: 0.85rem; outline: none; transition: border-color 0.15s;
  }
  .input-group input:focus { border-color: var(--accent); }

  /* â”€â”€ Mobile nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .mobile-nav {
    display: none; background: var(--surface); border-top: 1px solid var(--border);
    padding: 0.5rem 0; flex-shrink: 0;
  }
  .mobile-nav-items { display: flex; justify-content: space-around; }
  .mobile-nav-item {
    display: flex; flex-direction: column; align-items: center; gap: 0.2rem;
    padding: 0.4rem 0.75rem; color: var(--text-dim); cursor: pointer;
    font-size: 0.65rem; border: none; background: none; font-family: var(--font-body);
    transition: color 0.15s; border-radius: 8px;
  }
  .mobile-nav-item.active { color: var(--accent); }
  .mobile-add-btn { color: var(--text-dim) !important; padding-top: 0 !important; }

  @media (max-width: 640px) {
    /* Layout */
    .sidebar { display: none; }
    .mobile-nav { display: block; }
    .app-layout { padding-bottom: 64px; } /* room for bottom nav */
    .main { padding: 0.75rem 0.75rem 1rem; }
    .stats-grid { grid-template-columns: 1fr 1fr; }

    /* Browse â€” switch from table to cards on mobile */
    .browse-table-wrap { overflow-x: visible !important; }
    .item-table { display: none; }
    #browse-cards { display: flex; flex-direction: column; gap: 0.5rem; }
    .browse-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: background 0.15s;
    }
    .browse-card:active { background: var(--surface2); }
    .browse-card-left { flex: 1; min-width: 0; }
    .browse-card-num { font-family: var(--font-head); font-size: 1.1rem; color: var(--accent); }
    .browse-card-name { font-size: 0.85rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .browse-card-sub { font-size: 0.72rem; color: var(--text-dim); margin-top: 0.15rem; }
    .browse-card-right { display: flex; flex-direction: column; align-items: flex-end; gap: 0.25rem; flex-shrink: 0; }

    /* Filters bar on mobile */
    .filter-bar { gap: 0.4rem; flex-wrap: wrap; }
    .filter-bar input { font-size: 16px !important; } /* prevent iOS zoom */

    /* Wizard modal â€” full screen on mobile */
    .wizard-modal-inner {
      width: 100% !important;
      max-width: 100% !important;
      height: 100dvh !important;
      max-height: 100dvh !important;
      border-radius: 0 !important;
      margin: 0 !important;
    }

    /* Photo grid â€” single column on small screens */
    #photo-grid { grid-template-columns: 1fr 1fr 1fr !important; gap: 0.4rem !important; }

    /* Buttons â€” bigger tap targets */
    .btn { min-height: 44px; }
    .page-btn { min-width: 40px; min-height: 40px; }

    /* Modal full screen */
    .modal-inner { width: 100% !important; max-width: 100% !important;
      margin: 0 !important; border-radius: 0 !important;
      max-height: 100dvh !important; height: 100dvh !important; }

    /* Fix safe areas for notched phones */
    .mobile-nav {
      padding-bottom: max(0.5rem, env(safe-area-inset-bottom));
      height: calc(60px + env(safe-area-inset-bottom));
    }
    .app-layout { padding-bottom: calc(60px + env(safe-area-inset-bottom)); }
    .main {
      padding-top: 0.75rem;
      padding-left: max(0.75rem, env(safe-area-inset-left));
      padding-right: max(0.75rem, env(safe-area-inset-right));
    }
    /* Bigger stat cards on mobile */
    .stat-card { padding: 1rem; }
    .stat-val { font-size: 1.6rem; }
    /* Search bar full width */
    #search-input { width: 100%; }
    /* Dashboard recent items as cards */
    .two-col { gap: 0.75rem; }
  }

  /* â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tag {
    display: inline-block; padding: 0.15rem 0.5rem; border-radius: 4px;
    font-size: 0.7rem; font-weight: 500; background: var(--surface2); color: var(--text-dim);
  }
  .market-val { font-family: var(--font-mono); color: var(--accent2); }
  .text-dim { color: var(--text-dim); }
  .text-accent { color: var(--accent); }
  .mt-sm { margin-top: 0.5rem; }
  .link-btn {
    background: none; border: none; color: var(--accent2); cursor: pointer;
    font-size: 0.8rem; font-family: var(--font-body); text-decoration: underline; padding: 0;
  }
</style>
</head>
<body>

<!-- â•â• AUTH SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-screen">
  <div class="auth-logo">LIONEL VAULT</div>
  <div class="auth-sub">Postwar Collector's Inventory</div>
  <div class="auth-card">
    <h2>Sign in to your collection</h2>
    <p>Connect with Google to access the master inventory and manage your personal collection across any device.</p>
    <button class="btn-google" onclick="handleSignIn()">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
      </svg>
      Continue with Google
    </button>
    <p class="auth-note">Your personal collection data is stored in your own Google Sheet. The master inventory is shared read-only.</p>
  </div>
</div>

<!-- â•â• FIRST-TIME SETUP SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="setup-screen" style="display:none!important">
  <div class="setup-card">
    <h2>Welcome!</h2>
    <p>One-time setup â€” just two steps to connect your inventory.</p>
    <div class="setup-step">
      <div class="setup-num">1</div>
      <p>Enter the Master Inventory Sheet ID (get this from whoever shared the app with you).</p>
    </div>
    <div class="setup-step">
      <div class="setup-num">2</div>
      <p>Create a blank Google Sheet for your personal collection, then paste its ID below. Go to <a href="https://sheets.google.com" target="_blank" style="color:var(--accent2)">sheets.google.com</a>, create a blank sheet, name it "My Lionel Collection", and copy the ID from the URL.</p>
    </div>
    <div class="input-group">
      <label>Master Sheet ID</label>
      <input id="master-sheet-input" type="text" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgVE2upms" />
    </div>
    <div class="input-group" style="margin-top:0.75rem">
      <label>Your Personal Collection Sheet ID</label>
      <input id="personal-sheet-input" type="text" placeholder="Paste your blank sheet ID here" />
    </div>
    <div style="margin-top:1.25rem">
      <button class="btn btn-primary" style="width:100%" onclick="completeSetup()">Set Up My Collection</button>
    </div>
  </div>
</div>

<!-- â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">

  <!-- Header -->
  <header class="header">
    <div class="header-logo">LIONEL VAULT</div>
    <div class="header-search">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input id="global-search" type="text" placeholder="Search item number, road name, descriptionâ€¦" oninput="onGlobalSearch(this.value)">
    </div>
    <div class="header-right">
      <div class="user-chip">
        <div class="user-avatar" id="user-avatar">?</div>
        <span id="user-name">Loadingâ€¦</span>
      </div>
      <button class="btn-sign-out" onclick="handleSignOut()">Sign out</button>
    </div>
  </header>

  <div class="app-body">

    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="nav-section">
        <div class="nav-label">Overview</div>
        <button class="nav-item active" onclick="showPage('dashboard', this)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
          Dashboard
        </button>
      </div>
      <div class="nav-section">
        <div class="nav-label">Inventory</div>
        <button class="nav-item" onclick="showPage('browse', this); resetFilters(); renderBrowse();">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
          Browse All
          <span class="nav-badge" id="nav-total">â€”</span>
        </button>
        <button class="nav-item" onclick="showPage('browse', this); filterOwned()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
          My Collection
          <span class="nav-badge green" id="nav-owned">â€”</span>
        </button>
        <button class="nav-item" onclick="showPage('browse', this); filterWanted()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4m0 4h.01"/></svg>
          Want List
          <span class="nav-badge" id="nav-wanted" style="background:var(--accent2);color:#000">â€”</span>
        </button>
        <button class="nav-item" onclick="showPage('sold', this)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          Sold Items
          <span class="nav-badge" id="nav-sold" style="background:#9b59b6">â€”</span>
        </button>
      </div>
      <div class="nav-section">
        <div class="nav-label">Reports</div>
        <button class="nav-item" onclick="showPage('reports', this)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
          Reports
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main" id="main-content">

      <!-- â”€â”€ Dashboard â”€â”€ -->
      <div class="page active" id="page-dashboard">
        <button onclick="showDebugInfo()" style="position:fixed;top:0.5rem;right:0.5rem;z-index:999;font-size:0.65rem;padding:0.3rem 0.6rem;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text-dim);cursor:pointer">ğŸ” Debug</button>
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.75rem">
          <div class="page-title">Dashboard <span id="dash-greeting"></span></div>
          <button class="btn btn-primary" onclick="startAddWizard()" style="display:flex;align-items:center;gap:0.5rem;font-size:0.9rem;padding:0.65rem 1.25rem">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Item
          </button>
        </div>

        <div class="stats-grid" id="stats-grid">
          <div class="stat-card" style="--accent-color: var(--accent)">
            <div class="stat-label">Total Items in Master</div>
            <div class="stat-value" id="stat-total">â€”</div>
            <div class="stat-sub">unique item/variation rows</div>
          </div>
          <div class="stat-card" style="--accent-color: var(--green)">
            <div class="stat-label">Items I Own</div>
            <div class="stat-value" id="stat-owned">â€”</div>
            <div class="stat-sub" id="stat-owned-pct">â€” of catalog</div>
          </div>
          <div class="stat-card" style="--accent-color: var(--accent2)">
            <div class="stat-label">Collection Value</div>
            <div class="stat-value" id="stat-value">â€”</div>
            <div class="stat-sub">item+box complete</div>
          </div>
          <div class="stat-card" style="--accent-color: #9b59b6">
            <div class="stat-label">Avg Condition</div>
            <div class="stat-value" id="stat-cond">â€”</div>
            <div class="stat-sub">out of 10</div>
          </div>
          <div class="stat-card" style="--accent-color: #3498db">
            <div class="stat-label">With Original Box</div>
            <div class="stat-value" id="stat-boxed">â€”</div>
            <div class="stat-sub">of owned items</div>
          </div>
          <div class="stat-card" style="--accent-color: #1abc9c">
            <div class="stat-label">All Original</div>
            <div class="stat-value" id="stat-orig">â€”</div>
            <div class="stat-sub">unmodified pieces</div>
          </div>
        </div>

        <div class="section-title">By Category</div>
        <div class="cat-grid" id="cat-grid">
          <div class="loading"><div class="spinner"></div></div>
        </div>

        <div class="two-col">
          <div class="panel">
            <div class="section-title">Recent Additions</div>
            <div id="recent-list">
              <div class="empty-state"><div class="empty-icon">ğŸ“¦</div><p>No items owned yet</p></div>
            </div>
          </div>
          <div class="panel">
            <div class="section-title">Top Want List Items</div>
            <div id="want-preview">
              <div class="loading"><div class="spinner"></div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Browse â”€â”€ -->
      <div class="page" id="page-browse">
        <div class="page-title">Browse Inventory</div>

        <div class="filter-bar">
          <select class="filter-select" id="filter-type" onchange="applyFilters()">
            <option value="">All Types</option>
          </select>
          <select class="filter-select" id="filter-road" onchange="applyFilters()">
            <option value="">All Roads</option>
          </select>

          <span style="margin-left:auto;font-size:0.8rem;color:var(--text-dim)" id="result-count"></span>
        </div>

        <div class="table-wrap">
          <table class="item-table">
            <thead>
              <tr>
                <th>Item #</th>
                <th>Type</th>
                <th>Road / Name</th>
                <th>Variation</th>
                <th>Year</th>
                <th>Owned</th>
                <th>Cond.</th>
                <th>Market Value</th>
              </tr>
            </thead>
            <tbody id="browse-tbody"></tbody>
          </table>
          <div id="browse-cards" style="display:none"></div>
          <div class="table-pagination">
            <span id="page-info"></span>
            <div class="pagination-btns" id="pagination-btns"></div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Sold â”€â”€ -->
      <div class="page" id="page-sold">
        <div class="page-title">Sold Items</div>
        <div class="table-wrap">
          <table class="item-table">
            <thead>
              <tr>
                <th>Item #</th>
                <th>Type</th>
                <th>Road / Name</th>
                <th>Variation</th>
                <th>Condition</th>
                <th>Sale Price</th>
                <th>Date Sold</th>
              </tr>
            </thead>
            <tbody id="sold-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- â”€â”€ Reports â”€â”€ -->
      <div class="page" id="page-reports">
        <div class="page-title">Reports</div>

        <div class="report-controls">
          <select class="filter-select" id="report-type" onchange="buildReport()">
            <option value="wantlist">Want List</option>
            <option value="collection">Full Collection</option>
            <option value="value">Value Summary by Category</option>
            <option value="missing-box">Owned â€” Missing Box</option>
          </select>
          <button class="btn-export" onclick="exportReport()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export CSV
          </button>
          <button class="btn-export" onclick="window.print()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6,9 6,2 18,2 18,9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
            Print
          </button>
        </div>

        <div class="table-wrap" style="margin-top:0">
          <table class="report-table">
            <thead id="report-thead"></thead>
            <tbody id="report-tbody"></tbody>
          </table>
        </div>
      </div>

    </main>
  </div>

  <!-- Mobile nav -->
  <nav class="mobile-nav">
    <div class="mobile-nav-items">
      <button class="mobile-nav-item active" id="mnav-dashboard" onclick="showPage('dashboard', this)">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        Dashboard
      </button>
      <button class="mobile-nav-item" id="mnav-browse" onclick="showPage('browse', this); resetFilters(); renderBrowse();">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        Browse
      </button>
      <button class="mobile-nav-item mobile-add-btn" onclick="openWizard()">
        <div style="width:44px;height:44px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:-8px;box-shadow:0 4px 12px rgba(232,64,28,0.5)">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
        </div>
        Add
      </button>
      <button class="mobile-nav-item" id="mnav-sold" onclick="showPage('sold', this)">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        Sold
      </button>
      <button class="mobile-nav-item" id="mnav-reports" onclick="showPage('reports', this)">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Reports
      </button>
    </div>
  </nav>
</div>

<!-- â•â• ITEM DETAIL MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="item-modal" onclick="closeModalOnOverlay(event)">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-item-num" id="modal-item-num"></div>
        <div class="modal-title" id="modal-title"></div>
        <div class="modal-subtitle" id="modal-subtitle"></div>
      </div>
      <button class="btn-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">

      <!-- Box-only prompt banner -->
      <div id="box-only-prompt" style="display:none;background:rgba(245,166,35,0.1);border:1px solid var(--accent2);border-radius:10px;padding:0.85rem 1rem;display:flex;align-items:center;justify-content:space-between;gap:1rem">
        <div>
          <div style="font-weight:600;font-size:0.875rem;color:var(--accent2)">ğŸ“¦ Box without item info</div>
          <div style="font-size:0.8rem;color:var(--text-mid);margin-top:0.2rem">This entry has a box but no item details. Want to add the item info?</div>
        </div>
        <button onclick="fillItemFromBoxRow()" class="btn btn-primary" style="font-size:0.8rem;padding:0.5rem 0.9rem;white-space:nowrap">Add Item Info</button>
      </div>

      <!-- Reference Info -->
      <div>
        <div class="section-title" style="margin-bottom:0.75rem">Reference Information</div>
        <div class="info-grid">
          <div class="info-field"><label>Item Type</label><div class="info-val" id="mi-type"></div></div>
          <div class="info-field"><label>Year Produced</label><div class="info-val" id="mi-year"></div></div>
          <div class="info-field"><label>Road Name</label><div class="info-val" id="mi-road"></div></div>
          <div class="info-field"><label>Variation</label><div class="info-val" id="mi-var"></div></div>
          <div class="info-field"><label>Est. Market Value</label><div class="info-val market-val" id="mi-market"></div></div>
          <div class="info-field"><label>COTT Reference</label><div class="info-val" id="mi-ref"></div></div>
        </div>
        <div id="mi-desc-wrap" style="margin-top:0.75rem">
          <div class="desc-block" id="mi-desc"></div>
        </div>
        <div id="mi-varDesc-wrap" style="margin-top:0.5rem;display:none">
          <div style="font-size:0.68rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-dim);margin-bottom:0.3rem">Variation Notes</div>
          <div class="desc-block" id="mi-varDesc"></div>
        </div>
      </div>

      <!-- Collection Form -->
      <div>
        <div class="form-section-title" style="margin-bottom:0.75rem">Your Collection Data</div>

        <div style="margin-bottom:0.85rem">
          <label style="font-size:0.72rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-dim);display:block;margin-bottom:0.4rem">Status</label>
          <div style="display:flex;gap:0.5rem">
            <button class="status-btn" id="status-want" onclick="setStatus('Want')" style="flex:1;padding:0.5rem;border-radius:7px;border:1px solid var(--border);background:var(--surface2);color:var(--text-mid);cursor:pointer;font-family:var(--font-body);font-size:0.85rem;transition:all 0.15s">Want</button>
            <button class="status-btn" id="status-owned" onclick="setStatus('Owned')" style="flex:1;padding:0.5rem;border-radius:7px;border:1px solid var(--border);background:var(--surface2);color:var(--text-mid);cursor:pointer;font-family:var(--font-body);font-size:0.85rem;transition:all 0.15s">Owned</button>
            <button class="status-btn" id="status-sold" onclick="setStatus('Sold')" style="flex:1;padding:0.5rem;border-radius:7px;border:1px solid var(--border);background:var(--surface2);color:var(--text-mid);cursor:pointer;font-family:var(--font-body);font-size:0.85rem;transition:all 0.15s">Sold</button>
          </div>
        </div>

        <div id="sold-fields" style="display:none;margin-bottom:0.75rem">
          <div class="price-row">
            <div class="form-field">
              <label>Sale Price ($)</label>
              <input type="number" id="fc-sale-price" placeholder="0.00" min="0" step="0.01">
            </div>
            <div class="form-field">
              <label>Date Sold</label>
              <input type="date" id="fc-date-sold">
            </div>
          </div>
        </div>
        <div id="want-fields" style="display:none;margin-bottom:0.75rem">
          <div class="form-grid">
            <div class="form-field">
              <label>Priority</label>
              <select id="fc-want-priority">
                <option value="High">High</option>
                <option value="Medium" selected>Medium</option>
                <option value="Low">Low</option>
              </select>
            </div>
            <div class="form-field">
              <label>Expected Price ($)</label>
              <input type="number" id="fc-want-price" placeholder="0.00" min="0" step="0.01">
            </div>
          </div>
          <div class="form-field full" style="margin-top:0.5rem">
            <label>Notes</label>
            <input type="text" id="fc-want-notes" placeholder="Why you want it, where to find itâ€¦">
          </div>
        </div>
        <div id="collection-form" style="display:none">
          <div class="form-grid">
            <div class="form-field">
              <label>Copy #</label>
              <select id="fc-copy">
                <option value="1">1</option><option value="2">2</option>
                <option value="3">3</option><option value="4">4</option><option value="5">5</option>
              </select>
            </div>
            <div class="form-field">
              <label>All Original?</label>
              <select id="fc-original">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
                <option value="Unknown">Unknown</option>
              </select>
            </div>
          </div>

          <div class="form-field" style="margin-top:0.75rem">
            <label>Condition (1â€“10)</label>
            <div class="condition-display">
              <div class="condition-num" id="cond-display">7</div>
              <input type="range" min="1" max="10" value="7" id="fc-condition" oninput="document.getElementById('cond-display').textContent=this.value">
            </div>
          </div>

          <div class="price-row" style="margin-top:0.75rem">
            <div class="form-field">
              <label>Item Only Price ($)</label>
              <input type="number" id="fc-price-item" placeholder="0.00" min="0" step="0.01">
            </div>
            <div class="form-field">
              <label>Box Only Price ($)</label>
              <input type="number" id="fc-price-box" placeholder="0.00" min="0" step="0.01">
            </div>
            <div class="form-field">
              <label>Item+Box Complete ($)</label>
              <input type="number" id="fc-price-complete" placeholder="0.00" min="0" step="0.01">
            </div>
          </div>

          <div class="form-grid" style="margin-top:0.75rem">
            <div class="form-field">
              <label>Has Box?</label>
              <select id="fc-has-box">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="form-field">
              <label>Box Condition (1â€“10)</label>
              <input type="number" id="fc-box-cond" min="1" max="10" placeholder="â€”">
            </div>
          </div>

          <div class="form-field full" style="margin-top:0.75rem">
            <label>Item Photo Link (Google Photos)</label>
            <input type="url" id="fc-photo-item" placeholder="https://photos.google.com/â€¦">
          </div>
          <div class="form-field full" style="margin-top:0.5rem">
            <label>Box Photo Link (Google Photos)</label>
            <input type="url" id="fc-photo-box" placeholder="https://photos.google.com/â€¦">
          </div>
          <div class="form-field full" style="margin-top:0.5rem">
            <label>Notes</label>
            <textarea id="fc-notes" placeholder="Any personal notes about this itemâ€¦"></textarea>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveItem()">Save to Collection</button>
    </div>
  </div>
</div>

<!-- â•â• SOLD MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="sold-modal" onclick="closeSoldModalOnOverlay(event)">
  <div class="modal" style="max-width:420px">
    <div class="modal-header">
      <div>
        <div class="modal-title">Mark as Sold?</div>
        <div class="modal-subtitle" id="sold-modal-subtitle"></div>
      </div>
      <button class="btn-close" onclick="closeSoldModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-field">
        <label>Sale Price ($)</label>
        <input type="number" id="sold-price" placeholder="0.00" min="0" step="0.01">
      </div>
      <div class="form-field" style="margin-top:0.75rem">
        <label>Date Sold</label>
        <input type="date" id="sold-date">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeSoldModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmSold()">Mark as Sold</button>
    </div>
  </div>
</div>


<!-- â•â• ADD ITEM WIZARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="wizard-modal" onclick="closeWizardOnOverlay(event)">
  <div class="modal" style="max-width:520px">
    <div class="modal-header">
      <div>
        <div class="modal-item-num" id="wizard-step-label"></div>
        <div class="modal-title" id="wizard-title"></div>
      </div>
      <button class="btn-close" onclick="closeWizard()">âœ•</button>
    </div>

    <!-- Progress bar -->
    <div style="padding:0 1.5rem;padding-top:0.75rem">
      <div style="background:var(--border);border-radius:4px;height:4px">
        <div id="wizard-progress" style="height:100%;border-radius:4px;background:var(--accent);transition:width 0.3s ease;width:0%"></div>
      </div>
    </div>

    <div class="modal-body" id="wizard-body" style="min-height:180px">
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" id="wizard-back-btn" onclick="wizardBack()" style="display:none">â† Back</button>
      <button class="btn btn-secondary" onclick="closeWizard()">Cancel</button>
      <button class="btn btn-primary" id="wizard-next-btn" onclick="wizardNext()">Next â†’</button>
    </div>
  </div>
</div>

<!-- â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Replace with your actual Google OAuth Client ID after setup
const CLIENT_ID = '161569968813-vrhet7p68vkthkunare60nqr34li5uuh.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';
const API_KEY = 'AIzaSyBjwyQ7qvqrH0goUVidOO0Da9hVQWOzvI8'; // Replace with your Google Cloud API key
const PERSONAL_SHEET_NAME = 'Lionel Vault â€” My Collection';
const PERSONAL_HEADERS = [
  'Item Number','Variation','Condition (1-10)','All Original',
  'Item Only Price','Box Only Price','Item+Box Complete','Has Box',
  'Box Condition (1-10)','Item Photo Link','Box Photo Link','Notes',
  'Date Purchased','User Est. Worth'
];
const SOLD_HEADERS = [
  'Item Number','Variation','Copy #','Condition (1-10)','Item Only Price Paid',
  'Sale Price','Date Sold','Notes'
];
const WANT_HEADERS = [
  'Item Number','Variation','Priority','Expected Price','Notes'
];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = {
  user: null,
  masterSheetId: null,
  personalSheetId: null,
  masterData: [],      // all rows from master sheet
  personalData: {},    // keyed by "itemNum|variation" -> personal row (owned items)
  soldData: {},        // keyed by "itemNum|variation" -> sold row
  wantData: {},        // keyed by "itemNum|variation" -> want list row
  filteredData: [],
  currentPage: 1,
  pageSize: 50,
  filters: { owned: false, unowned: false, boxed: false, wantList: false, type: '', road: '', search: '' },
  currentItem: null,
};

// â”€â”€ GOOGLE IDENTITY / AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tokenClient;

function initGoogle() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: onTokenReceived,
  });

  // Check for existing session â€” master ID is hardcoded, just need saved user
  const savedUser = localStorage.getItem('lv_user');
  const savedPersonalId = localStorage.getItem('lv_personal_id');
  state.masterSheetId = '1cLmCcI4Ekao2gn-TntAGjhsPrIYe39-cX6rV1WAyDCM';
  localStorage.setItem('lv_master_id', state.masterSheetId);

  if (savedUser) {
    state.user = JSON.parse(savedUser);
    state.personalSheetId = savedPersonalId;
    showApp();
    showLoading(); // show spinner â€” onTokenReceived will call loadAllData once token is ready
    const savedEmail = state.user?.email || '';
    tokenClient.requestAccessToken({ prompt: '', login_hint: savedEmail });
  }
}

function handleSignIn() {
  tokenClient.requestAccessToken({ prompt: 'consent' });
}

function onGoogleSignIn(response) {
  const payload = parseJwt(response.credential);
  state.user = { name: payload.given_name, email: payload.email, picture: payload.picture };
  localStorage.setItem('lv_user', JSON.stringify(state.user));
}

let accessToken = null;

function onTokenReceived(resp) {
  if (resp.error) {
    console.error('Token error:', resp);
    // If silent token refresh failed, prompt user to sign in again
    if (resp.error === 'interaction_required' || resp.error === 'login_required') {
      const hint = state.user?.email || '';
      tokenClient.requestAccessToken({ prompt: 'consent', login_hint: hint });
    }
    return;
  }
  accessToken = resp.access_token;
  // Auto-refresh token before it expires (tokens last 1 hour)
  setTimeout(() => {
    if (accessToken) {
      const hint = state.user?.email || '';
      tokenClient.requestAccessToken({ prompt: '', login_hint: hint });
    }
  }, 55 * 60 * 1000);

  // Fetch user info from Google if we don't have it yet
  if (!state.user) {
    fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
      headers: { Authorization: 'Bearer ' + accessToken }
    })
    .then(r => r.json())
    .then(info => {
      state.user = { name: info.given_name || info.name || 'User', email: info.email };
      localStorage.setItem('lv_user', JSON.stringify(state.user));
      updateUserUI();
    });
  } else {
    updateUserUI();
  }

  // Master sheet is hardcoded
  state.masterSheetId = '1cLmCcI4Ekao2gn-TntAGjhsPrIYe39-cX6rV1WAyDCM';
  localStorage.setItem('lv_master_id', state.masterSheetId);

  // Always re-read personalSheetId from localStorage (mobile may not have it in state yet)
  state.personalSheetId = localStorage.getItem('lv_personal_id');
  console.log('onTokenReceived: personalSheetId =', state.personalSheetId, '| token ok =', !!accessToken);

  if (!state.personalSheetId) {
    createPersonalSheet().then(loadAllData);
  } else {
    driveEnsureSetup().catch(e => console.warn('Drive setup:', e));
    loadAllData();
  }
}

function handleSignOut() {
  google.accounts.oauth2.revoke(localStorage.getItem('lv_token'), () => {});
  localStorage.removeItem('lv_user');
  localStorage.removeItem('lv_token');
  state.user = null;
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('app').classList.remove('active');
}

function showApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('setup-screen').classList.remove('active');
  document.getElementById('app').classList.add('active');
  updateUserUI();
  const hr = new Date().getHours();
  document.getElementById('dash-greeting').textContent =
    hr < 12 ? 'Good morning' : hr < 17 ? 'Good afternoon' : 'Good evening';
}

function showSetup() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').classList.remove('active');
  document.getElementById('setup-screen').classList.add('active');
}

function updateUserUI() {
  if (!state.user) return;
  document.getElementById('user-name').textContent = state.user.name;
  document.getElementById('user-avatar').textContent = state.user.name[0].toUpperCase();
}

async function completeSetup() {
  let rawMaster = document.getElementById('master-sheet-input').value.trim();
  let rawPersonal = document.getElementById('personal-sheet-input').value.trim();
  if (!rawMaster) { alert('Please enter the Master Sheet ID.'); return; }
  if (!rawPersonal) { alert('Please enter your Personal Collection Sheet ID.'); return; }

  // Extract IDs if full URLs were pasted
  const masterMatch = rawMaster.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
  const personalMatch = rawPersonal.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
  const masterId = masterMatch ? masterMatch[1] : rawMaster;
  const personalId = personalMatch ? personalMatch[1] : rawPersonal;

  state.masterSheetId = masterId;
  state.personalSheetId = personalId;
  localStorage.setItem('lv_master_id', masterId);
  localStorage.setItem('lv_personal_id', personalId);

  // Initialize personal sheet headers
  try {
    await initPersonalSheet(personalId);
    showApp();
    loadAllData();
  } catch(e) {
    console.error('Setup error:', e);
    alert('Error connecting to your personal sheet: ' + e.message + '\n\nMake sure the sheet exists and you are signed in with the account that owns it.');
  }
}

async function initPersonalSheet(sheetId) {
  // Write My Collection title + headers if empty
  const res = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/My%20Collection!A1:M2`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  );
  const data = await res.json();
  const rows = data.values || [];
  if (rows.length === 0 || !rows[0] || rows[0].length === 0) {
    // Brand new sheet â€” write title row 1 and headers row 2
    await sheetsUpdate(sheetId, 'My Collection!A1:A1', [['My Collection']]);
    await sheetsUpdate(sheetId, 'My Collection!A2:N2', [PERSONAL_HEADERS]);
  } else if (rows.length === 1 || !rows[1] || rows[1].length < 13) {
    // Has title but missing/old headers â€” rewrite row 2
    await sheetsUpdate(sheetId, 'My Collection!A2:N2', [PERSONAL_HEADERS]);
  }
  // Get existing sheet tab names
  const metaRes = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?fields=sheets.properties.title`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  );
  const meta = await metaRes.json();
  const existingTabs = (meta.sheets || []).map(s => s.properties.title);

  // Build list of tabs to create
  const toCreate = [];
  if (!existingTabs.includes('Sold'))      toCreate.push({ addSheet: { properties: { title: 'Sold' } } });
  if (!existingTabs.includes('Want List')) toCreate.push({ addSheet: { properties: { title: 'Want List' } } });

  if (toCreate.length > 0) {
    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}:batchUpdate`, {
      method: 'POST',
      headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ requests: toCreate }),
    });
  }

  // Write headers to all tabs
  await sheetsUpdate(sheetId, 'Sold!A1:A1',      [['Sold']]);
  await sheetsUpdate(sheetId, 'Sold!A2:H2',      [SOLD_HEADERS]);
  await sheetsUpdate(sheetId, 'Want List!A1:A1', [['Want List']]);
  await sheetsUpdate(sheetId, 'Want List!A2:E2', [WANT_HEADERS]);
}


// â”€â”€ GOOGLE DRIVE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const ITEM_VIEWS = [
  { key: 'RSV', label: 'Right Side View', abbr: 'RSV' },
  { key: 'TV',  label: 'Top View',        abbr: 'TV'  },
  { key: 'BV',  label: 'Bottom View',     abbr: 'BV'  },
  { key: 'BKV', label: 'Back View',       abbr: 'BKV' },
  { key: 'FV',  label: 'Front View',      abbr: 'FV'  },
  { key: 'LSV', label: 'Left Side View',  abbr: 'LSV' },
];
const BOX_VIEWS = [
  { key: 'BOX-RSV', label: 'Box Right Side', abbr: 'BOX-RSV' },
  { key: 'BOX-TV',  label: 'Box Top',        abbr: 'BOX-TV'  },
  { key: 'BOX-BV',  label: 'Box Bottom',     abbr: 'BOX-BV'  },
  { key: 'BOX-BKV', label: 'Box Back',       abbr: 'BOX-BKV' },
  { key: 'BOX-FV',  label: 'Box Front',      abbr: 'BOX-FV'  },
  { key: 'BOX-LSV', label: 'Box Left Side',  abbr: 'BOX-LSV' },
];

// Folder structure:
//  Lionel Vault - My Collection/         (vault root â€” stores sheet + photo subfolders)
//    My Collection Photos/               (item photo folders)
//      726/
//        726 FV.jpg, 726 RSV.jpg ...
//    My Sold Collection Photos/          (sold item photo folders â€” moved here on sale)

const driveCache = {
  vaultId: null,       // "Lionel Vault - My Collection" root
  photosId: null,      // "My Collection Photos"
  soldPhotosId: null,  // "My Sold Collection Photos"
  itemFolders: {},     // itemNum -> folderId
};

async function driveRequest(method, endpoint, body) {
  const res = await fetch('https://www.googleapis.com/drive/v3' + endpoint, {
    method,
    headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
    body: body !== undefined ? JSON.stringify(body) : undefined,
  });
  return res.json();
}

async function driveUploadFile(file, name, folderId) {
  const metadata = { name, parents: [folderId], mimeType: file.type };
  const form = new FormData();
  form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
  form.append('file', file);
  const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink,webContentLink', {
    method: 'POST',
    headers: { Authorization: 'Bearer ' + accessToken },
    body: form,
  });
  return res.json();
}

async function driveFindOrCreateFolder(name, parentId) {
  const q = encodeURIComponent(`name='${name}' and mimeType='application/vnd.google-apps.folder' and '${parentId}' in parents and trashed=false`);
  const res = await driveRequest('GET', `/files?q=${q}&fields=files(id,name)&spaces=drive`);
  if (res.files && res.files.length > 0) return res.files[0].id;
  const created = await driveRequest('POST', '/files?fields=id', {
    name, mimeType: 'application/vnd.google-apps.folder', parents: [parentId],
  });
  return created.id;
}

async function driveMoveFileToFolder(fileId, fromFolderId, toFolderId) {
  await driveRequest('PATCH', `/files/${fileId}?addParents=${toFolderId}&removeParents=${fromFolderId}&fields=id`, {});
}

// Called once on first run â€” creates the full vault folder structure
async function driveSetupVault() {
  // Find or create root vault folder
  const rootRes = await driveRequest('GET', '/files/root?fields=id');
  const rootId = rootRes.id;
  driveCache.vaultId = await driveFindOrCreateFolder('Lionel Vault - My Collection', rootId);
  localStorage.setItem('lv_vault_id', driveCache.vaultId);

  // Find or create both photo subfolders (always, so nothing is missing)
  driveCache.photosId     = await driveFindOrCreateFolder('My Collection Photos',      driveCache.vaultId);
  driveCache.soldPhotosId = await driveFindOrCreateFolder('My Sold Collection Photos', driveCache.vaultId);
  localStorage.setItem('lv_photos_id',      driveCache.photosId);
  localStorage.setItem('lv_sold_photos_id', driveCache.soldPhotosId);

  // Move the personal sheet into the vault folder if we have its ID
  const sheetId = localStorage.getItem('lv_personal_id');
  if (sheetId) {
    try { await driveMoveSheetToVault(sheetId); } catch(e) { console.warn('Sheet move:', e); }
  }

  console.log('Vault ready:', driveCache.vaultId, '| Photos:', driveCache.photosId, '| Sold:', driveCache.soldPhotosId);
  return driveCache.vaultId;
}

async function driveEnsureSetup() {
  if (driveCache.vaultId && driveCache.photosId && driveCache.soldPhotosId) return;
  // Try from localStorage first (fast path)
  const vId = localStorage.getItem('lv_vault_id');
  const pId = localStorage.getItem('lv_photos_id');
  const sId = localStorage.getItem('lv_sold_photos_id');
  if (vId && pId && sId) {
    driveCache.vaultId      = vId;
    driveCache.photosId     = pId;
    driveCache.soldPhotosId = sId;
  } else {
    // Always run full setup so any missing folders get created
    await driveSetupVault();
  }
}

async function driveEnsureItemFolder(itemNum) {
  await driveEnsureSetup();
  const key = String(itemNum);
  if (driveCache.itemFolders[key]) return driveCache.itemFolders[key];
  const folderId = await driveFindOrCreateFolder(key, driveCache.photosId);
  driveCache.itemFolders[key] = folderId;
  return folderId;
}

function driveFolderLink(folderId) {
  return `https://drive.google.com/drive/folders/${folderId}`;
}

async function driveUploadItemPhoto(file, itemNum, viewAbbr) {
  await driveEnsureSetup();
  const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
  const fileName = `${itemNum} ${viewAbbr}.${ext}`;
  const folderId = await driveEnsureItemFolder(itemNum);
  await driveUploadFile(file, fileName, folderId);
  // Return folder link (not individual photo link)
  return driveFolderLink(folderId);
}

async function driveMoveToSold(itemNum) {
  await driveEnsureSetup();
  const key = String(itemNum);
  // Find item folder in My Collection Photos
  const q = encodeURIComponent(`name='${key}' and mimeType='application/vnd.google-apps.folder' and '${driveCache.photosId}' in parents and trashed=false`);
  const res = await driveRequest('GET', `/files?q=${q}&fields=files(id)`);
  if (res.files && res.files.length > 0) {
    const fId = res.files[0].id;
    await driveMoveFileToFolder(fId, driveCache.photosId, driveCache.soldPhotosId);
    delete driveCache.itemFolders[key];
  }
}

// Move sheet into vault folder after creation
async function driveMoveSheetToVault(sheetId) {
  await driveEnsureSetup();
  // Get current parents of the sheet file
  const meta = await driveRequest('GET', `/files/${sheetId}?fields=parents`);
  const currentParents = (meta.parents || []).join(',');
  await fetch(`https://www.googleapis.com/drive/v3/files/${sheetId}?addParents=${driveCache.vaultId}&removeParents=${currentParents}&fields=id`, {
    method: 'PATCH',
    headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
    body: JSON.stringify({}),
  });
}

// â”€â”€ SHEETS API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sheetsGet(spreadsheetId, range) {
  // Use API key for master sheet (public), OAuth token for personal sheet
  const isMaster = spreadsheetId === state.masterSheetId;
  const url = isMaster && API_KEY !== 'YOUR_API_KEY'
    ? `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}?key=${API_KEY}`
    : `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}`;
  const headers = isMaster && API_KEY !== 'YOUR_API_KEY'
    ? {}
    : { Authorization: `Bearer ${accessToken}` };
  const res = await fetch(url, { headers });
  return res.json();
}

async function sheetsUpdate(spreadsheetId, range, values) {
  const res = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}?valueInputOption=USER_ENTERED`,
    {
      method: 'PUT',
      headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ range, majorDimension: 'ROWS', values }),
    }
  );
  return res.json();
}

async function sheetsAppend(spreadsheetId, range, values) {
  const res = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`,
    {
      method: 'POST',
      headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ values }),
    }
  );
  const result = await res.json();
  console.log('sheetsAppend result:', JSON.stringify(result));
  return result;
}

async function sheetsDeleteRow(spreadsheetId, sheetName, rowNumber) {
  // First get the sheetId (numeric) for the named tab
  const metaRes = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?fields=sheets.properties`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  );
  const meta = await metaRes.json();
  const sheet = meta.sheets.find(s => s.properties.title === sheetName);
  if (!sheet) return;
  const sheetId = sheet.properties.sheetId;

  // Delete the row (0-indexed, startIndex = rowNumber-1)
  await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`, {
    method: 'POST',
    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({
      requests: [{
        deleteDimension: {
          range: {
            sheetId,
            dimension: 'ROWS',
            startIndex: rowNumber - 1,
            endIndex: rowNumber
          }
        }
      }]
    })
  });
}

async function createPersonalSheet() {
  // 1. Set up Drive vault folders first
  await driveSetupVault();

  // 2. Create new spreadsheet
  const res = await fetch('https://sheets.googleapis.com/v4/spreadsheets', {
    method: 'POST',
    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({
      properties: { title: PERSONAL_SHEET_NAME },
      sheets: [{ properties: { title: 'My Collection' } }]
    })
  });
  const data = await res.json();
  state.personalSheetId = data.spreadsheetId;
  localStorage.setItem('lv_personal_id', state.personalSheetId);

  // 3. Write headers and create all tabs
  await sheetsUpdate(state.personalSheetId, 'My Collection!A1:A1', [['My Collection']]);
  await sheetsUpdate(state.personalSheetId, 'My Collection!A2:N2', [PERSONAL_HEADERS]);
  await initPersonalSheet(state.personalSheetId);

  // 4. Move the sheet file into the vault folder
  try { await driveMoveSheetToVault(state.personalSheetId); } catch(e) { console.warn('Could not move sheet to vault:', e); }

  return state.personalSheetId;
}

// â”€â”€ LOAD DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAllData() {
  showLoading();
  try {
    console.log('loadAllData: starting, accessToken present:', !!accessToken);
    await loadMasterData();
    console.log('loadAllData: master loaded, rows:', state.masterData.length);
    await loadPersonalData();
    console.log('loadAllData: personal loaded, keys:', Object.keys(state.personalData).length);
    buildApp();
    console.log('loadAllData: buildApp done');
  } catch(e) {
    console.error('Load error:', e.message, e.stack);
    showToast('Error loading data: ' + e.message);
    document.getElementById('browse-tbody').innerHTML = 
      '<tr><td colspan="8" style="padding:2rem;color:var(--red);text-align:center">Error loading data: ' + e.message + '<br><small>Pull down to refresh</small></td></tr>';
  }
}

async function loadMasterData() {
  // Try 'Master Inventory' tab first, fall back to 'Sheet1' if renamed during import
  let res = await sheetsGet(state.masterSheetId, 'Master Inventory!A3:O');
  if (!res.values) {
    res = await sheetsGet(state.masterSheetId, 'Sheet1!A3:O');
  }
  const rows = res.values || [];
  state.masterData = rows.map(r => ({
    itemNum:    r[0]  || '',
    itemType:   r[1]  || '',
    subType:    r[2]  || '',
    wheelArr:   r[3]  || '',
    tenderNum:  r[4]  || '',
    roadName:   r[5]  || '',
    description:r[6]  || '',
    yearProd:   r[7]  || '',
    variation:  r[8]  || '',
    varDesc:    r[9]  || '',
    refLink:    r[10] || '',
    ebayAvg:    r[11] || '',
    ebaySample: r[12] || '',
    ebayUpdated:r[13] || '',
    marketVal:  r[14] || '',
  }));
}

async function loadPersonalData() {
  if (!state.personalSheetId) return;
  state.personalData = {};
  state.soldData = {};
  state.wantData = {};

  // Load My Collection tab
  try {
  const res = await sheetsGet(state.personalSheetId, 'My Collection!A3:N');
  console.log('My Collection raw response:', JSON.stringify(res).substring(0, 200));
  const rows = res.values || [];
  console.log('My Collection rows loaded:', rows.length, '| first row:', rows[0]);
  rows.forEach((r, idx) => {
    if (!r[0] || r[0] === 'Item Number') return; // skip header row if present
    const rowNum = idx + 3;
    const key = `${r[0]}|${r[1] || ''}|${rowNum}`;
    state.personalData[key] = {
      row:          rowNum,
      itemNum:      r[0]  || '',
      variation:    r[1]  || '',
      status:       'Owned',
      owned:        true,
      condition:    r[2]  || '',
      allOriginal:  r[3]  || '',
      priceItem:    r[4]  || '',
      priceBox:     r[5]  || '',
      priceComplete:r[6]  || '',
      hasBox:       r[7]  || '',
      boxCond:      r[8]  || '',
      photoItem:    r[9]  || '',
      photoBox:     r[10] || '',
      notes:        r[11] || '',
      datePurchased:r[12] || '',
      userEstWorth: r[13] || '',
    };
  });
  } catch(e) { console.error('My Collection load error:', e); }

  // Load Sold tab
  try {
    const soldRes = await sheetsGet(state.personalSheetId, 'Sold!A3:H').catch(() => ({values:[]}));
    const soldRows = soldRes.values || [];
    console.log('Sold rows loaded:', soldRows.length);
    soldRows.forEach((r, idx) => {
      if (!r[0] || r[0] === 'Item Number') return; // skip header row if present
      const key = `${r[0]}|${r[1] || ''}`;
      state.soldData[key] = {
        row:       idx + 3,
        itemNum:   r[0] || '',
        variation: r[1] || '',
        copy:      r[2] || '1',
        condition: r[3] || '',
        priceItem: r[4] || '',
        salePrice: r[5] || '',
        dateSold:  r[6] || '',
        notes:     r[7] || '',
      };
    });
  } catch(e) { console.log('Sold tab error:', e); }

  // Load Want List tab
  try {
    const wantRes = await sheetsGet(state.personalSheetId, 'Want List!A3:E').catch(() => ({values:[]}));
    const wantRows = wantRes.values || [];
    console.log('Want rows loaded:', wantRows.length);
    wantRows.forEach((r, idx) => {
      if (!r[0] || r[0] === 'Item Number') return; // skip header row if present
      const key = `${r[0]}|${r[1] || ''}`;
      state.wantData[key] = {
        row:           idx + 3,
        itemNum:       r[0] || '',
        variation:     r[1] || '',
        priority:      r[2] || 'Medium',
        expectedPrice: r[3] || '',
        notes:         r[4] || '',
      };
    });
  } catch(e) { console.log('Want List tab error:', e); }
}

// â”€â”€ BUILD APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildApp() {
  showApp();
  populateFilters();
  buildDashboard();
  buildBrowse();
  buildSoldPage();
  buildReport();
}

function showLoading() {
  document.getElementById('browse-tbody').innerHTML = '<tr><td colspan="8"><div class="loading"><div class="spinner"></div><span>Loading inventoryâ€¦</span></div></td></tr>';
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showDebugInfo() {
  const pid = state.personalSheetId || localStorage.getItem('lv_personal_id');
  let sheetTest = 'not tested';
  if (pid && accessToken) {
    try {
      const r = await fetch(
        'https://sheets.googleapis.com/v4/spreadsheets/' + pid + '/values/My%20Collection!A1:A3',
        { headers: { Authorization: 'Bearer ' + accessToken } }
      );
      const d = await r.json();
      sheetTest = r.status + ' â€” ' + JSON.stringify(d).substring(0, 80);
    } catch(e) { sheetTest = 'ERROR: ' + e.message; }
  }
  const pdSample = JSON.stringify(Object.values(state.personalData)[0] || {}).substring(0, 200);
  const owned = Object.values(state.personalData).filter(pd => pd.owned).length;
  const boxOnly = Object.values(state.personalData).filter(pd => {
    const c = pd.condition?.toString().trim();
    const p = pd.priceItem?.toString().trim();
    return pd.hasBox === 'Yes' && (!c || c === 'N/A') && (!p || p === 'N/A');
  }).length;
  // Force rebuild dashboard and read result
  buildDashboard();
  const statOwned = document.getElementById('stat-owned')?.textContent;
  const statTotal = document.getElementById('stat-total')?.textContent;
  const info = [
    'token: ' + (accessToken ? 'YES' : 'MISSING'),
    'personalSheetId: ' + (pid || 'MISSING'),
    'masterRows: ' + state.masterData.length,
    'personalKeys: ' + Object.keys(state.personalData).length,
    'owned flag: ' + owned,
    'boxOnly excluded: ' + boxOnly,
    'stat-owned el: ' + statOwned,
    'stat-total el: ' + statTotal,
    'sheet test: ' + sheetTest,
    'sample: ' + pdSample,
  ].join('\n');
  alert(info);
}

function buildDashboard() {
  const total = state.masterData.length;
  // Count ALL owned entries including box-only rows
  const allOwned = Object.values(state.personalData).filter(pd => {
    if (!pd.owned) return false;
    // Exclude pure box-only rows (has box but NO item condition AND NO item price)
    const condVal = pd.condition?.toString().trim();
    const priceVal = pd.priceItem?.toString().trim();
    const noCondition = !condVal || condVal === '' || condVal === 'N/A';
    const noItemPrice = !priceVal || priceVal === '' || priceVal === 'N/A';
    const isBoxOnly = pd.hasBox === 'Yes' && noCondition && noItemPrice;
    return !isBoxOnly; // count everything except pure box-only rows
  });
  const owned = allOwned.length;
  const pct = total > 0 ? Math.round((owned / total) * 100) : 0;

  let totalValue = 0, condSum = 0, condCount = 0, boxedCount = 0, origCount = 0;
  // Count value across ALL owned rows (items + boxes)
  const allOwnedEntries = Object.values(state.personalData).filter(pd => pd.owned);
  allOwnedEntries.forEach(pd => {
    if (pd.priceComplete) totalValue += parseFloat(pd.priceComplete) || 0;
    else if (pd.priceItem && pd.priceItem !== 'N/A') totalValue += parseFloat(pd.priceItem) || 0;
    else if (pd.priceBox) totalValue += parseFloat(pd.priceBox) || 0;
  });

  allOwned.forEach(pd => {
    if (pd.condition && pd.condition !== 'N/A') { const c = parseInt(pd.condition); if (!isNaN(c)) { condSum += c; condCount++; } }
    if (pd.hasBox === 'Yes') boxedCount++;
    if (pd.allOriginal === 'Yes') origCount++;
  });

  document.getElementById('stat-total').textContent = total.toLocaleString();
  document.getElementById('stat-owned').textContent = owned.toLocaleString();
  document.getElementById('stat-owned-pct').textContent = `${pct}% of catalog`;
  document.getElementById('stat-value').textContent = totalValue > 0 ? `$${Math.round(totalValue).toLocaleString()}` : 'â€”';
  document.getElementById('stat-cond').textContent = condCount > 0 ? (condSum / condCount).toFixed(1) : 'â€”';
  document.getElementById('stat-boxed').textContent = owned > 0 ? `${boxedCount} / ${owned}` : 'â€”';
  document.getElementById('stat-orig').textContent = owned > 0 ? `${origCount} / ${owned}` : 'â€”';

  const soldCount = Object.keys(state.soldData).length;
  const wantCount = total - owned - soldCount;
  document.getElementById('nav-total').textContent = total.toLocaleString();
  document.getElementById('nav-owned').textContent = owned.toLocaleString();
  const wantListCount = Object.keys(state.wantData).length;
  document.getElementById('nav-wanted').textContent = wantListCount.toLocaleString();
  if (document.getElementById('nav-sold')) document.getElementById('nav-sold').textContent = soldCount;

  // Category breakdown
  const cats = {};
  state.masterData.forEach(item => {
    const t = item.itemType || 'Other';
    if (!cats[t]) cats[t] = { total: 0, owned: 0 };
    cats[t].total++;
    if (findPD(item.itemNum, item.variation)?.owned) cats[t].owned++;
  });

  const catIcons = {
    'Steam': 'ğŸš‚', 'Diesel': 'ğŸšƒ', 'Electric': 'âš¡', 'Motorized Unit': 'ğŸš„',
    'Boxcar': 'ğŸ“¦', 'Gondola': 'ğŸšƒ', 'Hopper': 'ğŸª¨', 'Tank Car': 'â›½',
    'Flatcar': 'ğŸ“‹', 'Caboose': 'ğŸ”´', 'Passenger': 'ğŸ’º', 'Accessories': 'ğŸ—',
    'Track': 'ğŸ›¤', 'Transformer': 'ğŸ”Œ', 'Other': 'ğŸ“',
  };
  const maxTotal = Math.max(...Object.values(cats).map(c => c.total));
  const catHtml = Object.entries(cats)
    .sort((a,b) => b[1].total - a[1].total)
    .map(([name, counts]) => `
      <div class="cat-card" onclick="filterByType('${name}')">
        <div class="cat-icon">${catIcons[name] || 'ğŸ“'}</div>
        <div class="cat-info">
          <div class="cat-name">${name}</div>
          <div class="cat-count">${counts.owned} / ${counts.total} owned</div>
          <div class="cat-bar"><div class="cat-bar-fill" style="width:${(counts.total/maxTotal*100).toFixed(0)}%"></div></div>
        </div>
      </div>
    `).join('');
  document.getElementById('cat-grid').innerHTML = catHtml || '<div class="empty-state"><p>No data yet</p></div>';

  // Want list preview (first 6 unowned)
  const wants = state.masterData.filter(i => state.wantData[`${i.itemNum}|${i.variation}`]).slice(0, 6);
  document.getElementById('want-preview').innerHTML = wants.length ? wants.map(i => `
    <div style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="openItem(${state.masterData.indexOf(i)})">
      <span class="item-num">${i.itemNum}</span>
      <span style="font-size:0.8rem;color:var(--text-mid);flex:1">${i.roadName || i.itemType || 'â€”'}</span>
      <span class="market-val" style="font-size:0.8rem">${i.marketVal ? '$'+i.marketVal : 'â€”'}</span>
    </div>
  `).join('') : '<div class="empty-state"><p>All items owned! ğŸ‰</p></div>';
}

// â”€â”€ BROWSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function populateFilters() {
  const types = [...new Set(state.masterData.map(i => i.itemType).filter(Boolean))].sort();
  const roads = [...new Set(state.masterData.map(i => i.roadName).filter(Boolean))].sort();

  const typeEl = document.getElementById('filter-type');
  types.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; typeEl.appendChild(o); });

  const roadEl = document.getElementById('filter-road');
  roads.slice(0, 80).forEach(r => { const o = document.createElement('option'); o.value = r; o.textContent = r; roadEl.appendChild(o); });
}

function applyFilters() {
  state.filters.type = document.getElementById('filter-type').value;
  state.filters.road = document.getElementById('filter-road').value;
  state.filters.wantList = false;
  state.currentPage = 1;
  renderBrowse();
}

function toggleFilter(name) {
  state.filters[name] = !state.filters[name];
  document.getElementById('toggle-' + name).classList.toggle('on', state.filters[name]);
  state.currentPage = 1;
  renderBrowse();
}

function resetFilters() {
  state.filters.owned = false;
  state.filters.unowned = false;
  state.filters.boxed = false;
  state.filters.wantList = false;
  state.filters.type = '';
  state.filters.road = '';
  state.currentPage = 1;
  document.getElementById('filter-type').value = '';
  document.getElementById('filter-road').value = '';

}

function filterOwned() { resetFilters(); state.filters.owned = true; renderBrowse(); }
function filterWanted() {
  resetFilters();
  state.filters.wantList = true;
  renderBrowse();
}
function filterByType(type) { document.getElementById('filter-type').value = type; showPage('browse'); applyFilters(); }

function onGlobalSearch(val) {
  state.filters.search = val.toLowerCase();
  state.currentPage = 1;
  renderBrowse();
}

function buildBrowse() { renderBrowse(); }

function renderBrowse() {
  const { type, road, owned, unowned, boxed, search } = state.filters;
  state.filteredData = state.masterData.filter(item => {
    const pd = findPD(item.itemNum, item.variation);
    const isOwned = pd?.owned || false;
    const hasBox = pd?.hasBox === 'Yes';
    const isSold = !!state.soldData[`${item.itemNum}|${item.variation}`];
    if (isSold) return false;
    const isWanted = !!state.wantData[`${item.itemNum}|${item.variation}`];
    if (state.filters.wantList && !isWanted) return false;
    if (owned && !isOwned) return false;
    if (unowned && (isOwned || isWanted)) return false;
    if (boxed && !hasBox) return false;
    if (type && item.itemType !== type) return false;
    if (road && item.roadName !== road) return false;
    if (search) {
      const haystack = `${item.itemNum} ${item.roadName} ${item.description} ${item.itemType}`.toLowerCase();
      if (!haystack.includes(search)) return false;
    }
    return true;
  });

  const total = state.filteredData.length;
  const pages = Math.ceil(total / state.pageSize);
  const start = (state.currentPage - 1) * state.pageSize;
  const pageData = state.filteredData.slice(start, start + state.pageSize);

  document.getElementById('result-count').textContent = `${total.toLocaleString()} items`;
  document.getElementById('page-info').textContent = `Showing ${start+1}â€“${Math.min(start+state.pageSize, total)} of ${total.toLocaleString()}`;

  // Rows
  const tbody = document.getElementById('browse-tbody');
  const isMobile = window.innerWidth <= 640;
  const cardsEl = document.getElementById('browse-cards');
  const tableEl = document.querySelector('.item-table');

  if (isMobile) {
    if (tableEl) tableEl.style.display = 'none';
    if (cardsEl) cardsEl.style.display = 'flex';
  } else {
    if (tableEl) tableEl.style.display = '';
    if (cardsEl) cardsEl.style.display = 'none';
  }

  const rowsHtml = pageData.map((item, i) => {
    const pd = findPD(item.itemNum, item.variation);
    const isOwned = pd?.owned || false;
    const isWanted = !!state.wantData[`${item.itemNum}|${item.variation}`];
    const cond = pd?.condition ? parseInt(pd.condition) : null;
    const condClass = cond >= 9 ? 'cond-9' : cond >= 7 ? 'cond-7' : cond >= 5 ? 'cond-5' : cond ? 'cond-low' : '';
    const globalIdx = state.masterData.indexOf(item);
    const badgeClass = isOwned ? 'yes' : isWanted ? 'want' : 'no';
    const badgeText  = isOwned ? 'âœ“ Owned' : isWanted ? 'â˜… Want' : 'â€”';
    const marketVal  = item.marketVal ? '$' + parseFloat(item.marketVal).toLocaleString() : '';

    if (isMobile) {
      return `<div class="browse-card" onclick="openItem(${globalIdx})">
        <div class="browse-card-left">
          <div class="browse-card-num">${item.itemNum}${item.variation ? ' <span style="font-size:0.75rem;color:var(--text-dim)">${item.variation}</span>' : ''}</div>
          <div class="browse-card-name">${item.roadName || item.itemType || 'â€”'}</div>
          <div class="browse-card-sub">${[item.itemType, item.yearProd].filter(Boolean).join(' Â· ')}</div>
        </div>
        <div class="browse-card-right">
          <span class="owned-badge ${badgeClass}">${badgeText}</span>
          ${cond ? `<span style="font-size:0.75rem"><span class="condition-pip ${condClass}"></span>${cond}</span>` : ''}
          ${marketVal ? `<span class="market-val" style="font-size:0.78rem">${marketVal}</span>` : ''}
        </div>
      </div>`;
    } else {
      return `<tr onclick="openItem(${globalIdx})">
        <td><span class="item-num">${item.itemNum}</span></td>
        <td><span class="tag">${item.itemType || 'â€”'}</span></td>
        <td>${item.roadName || '<span class="text-dim">â€”</span>'}</td>
        <td>${item.variation || '<span class="text-dim">â€”</span>'}</td>
        <td class="text-dim">${item.yearProd || 'â€”'}</td>
        <td><span class="owned-badge ${badgeClass}">${badgeText}</span></td>
        <td>${cond ? `<span class="condition-pip ${condClass}"></span>${cond}` : '<span class="text-dim">â€”</span>'}</td>
        <td class="market-val">${item.marketVal ? '$' + parseFloat(item.marketVal).toLocaleString() : '<span class="text-dim">â€”</span>'}</td>
      </tr>`;
    }
  });

  const emptyHtml = isMobile
    ? '<div style="text-align:center;padding:3rem 1rem;color:var(--text-dim)"><div style="font-size:2.5rem;margin-bottom:0.5rem">ğŸ”</div><p>No items match your filters</p></div>'
    : '<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">ğŸ”</div><p>No items match your filters</p></div></td></tr>';

  if (isMobile) {
    if (cardsEl) cardsEl.innerHTML = rowsHtml.join('') || emptyHtml;
  } else {
    tbody.innerHTML = rowsHtml.join('') || emptyHtml;
  }

  // Pagination
  const paginEl = document.getElementById('pagination-btns');
  let btns = '';
  if (state.currentPage > 1) btns += `<button class="page-btn" onclick="goPage(${state.currentPage-1})">â€¹</button>`;
  const range = [1, ...Array.from({length: pages}, (_,i)=>i+1).filter(p => Math.abs(p - state.currentPage) <= 2), pages];
  [...new Set(range)].sort((a,b)=>a-b).forEach((p, i, arr) => {
    if (i > 0 && arr[i-1] < p - 1) btns += `<span style="padding:0 4px;color:var(--text-dim)">â€¦</span>`;
    btns += `<button class="page-btn ${p === state.currentPage ? 'active' : ''}" onclick="goPage(${p})">${p}</button>`;
  });
  if (state.currentPage < pages) btns += `<button class="page-btn" onclick="goPage(${state.currentPage+1})">â€º</button>`;
  paginEl.innerHTML = btns;
}

function goPage(p) { state.currentPage = p; renderBrowse(); document.getElementById('main-content').scrollTop = 0; }

// â”€â”€ ITEM MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openItem(idx) {
  const item = state.masterData[idx];
  state.currentItem = { item, idx };
  // Find by prefix since key now includes row number
  const keyPrefix = `${item.itemNum}|${item.variation}|`;
  const pdKey = Object.keys(state.personalData).find(k => k.startsWith(keyPrefix));
  const pd = pdKey ? state.personalData[pdKey] : {};

  document.getElementById('modal-item-num').textContent = `No. ${item.itemNum}${item.variation ? ' â€” Variation ' + item.variation : ''}`;
  document.getElementById('modal-title').textContent = item.roadName || item.itemType || item.description.substring(0, 60);
  document.getElementById('modal-subtitle').textContent = `${item.itemType}${item.subType ? ' â€” ' + item.subType : ''}${item.yearProd ? ' Â· ' + item.yearProd : ''}`;
  document.getElementById('mi-type').textContent = item.itemType || 'â€”';
  document.getElementById('mi-year').textContent = item.yearProd || 'â€”';
  document.getElementById('mi-road').textContent = item.roadName || 'â€”';
  document.getElementById('mi-var').textContent = item.variation || '(no variation)';
  document.getElementById('mi-market').textContent = item.marketVal ? '$' + parseFloat(item.marketVal).toLocaleString() : 'â€”';
  document.getElementById('mi-ref').innerHTML = item.refLink ? `<a href="${item.refLink}" target="_blank">View on COTT â†—</a>` : 'â€”';
  document.getElementById('mi-desc').textContent = item.description || 'No description available.';
  const vd = document.getElementById('mi-varDesc-wrap');
  if (item.varDesc) { document.getElementById('mi-varDesc').textContent = item.varDesc; vd.style.display = 'block'; }
  else { vd.style.display = 'none'; }

  // Personal data - check owned and sold
  const sd = state.soldData[key] || {};
  const wd = state.wantData[key] || {};
  const itemStatus = pd.owned ? 'Owned' : sd.itemNum ? 'Sold' : wd.itemNum ? 'Want' : '';
  currentStatus = itemStatus || '';
  setStatus(itemStatus || 'Want');
  document.getElementById('fc-sale-price').value = sd.salePrice || '';
  document.getElementById('fc-date-sold').value = sd.dateSold || '';
  document.getElementById('fc-want-priority').value = wd.priority || 'Medium';
  document.getElementById('fc-want-price').value = wd.expectedPrice || '';
  document.getElementById('fc-want-notes').value = wd.notes || '';

  // copy field removed
  document.getElementById('fc-original').value = pd.allOriginal || 'Unknown';
  const cond = pd.condition || 7;
  document.getElementById('fc-condition').value = cond;
  document.getElementById('cond-display').textContent = cond;
  const toNum = v => (v && !isNaN(parseFloat(v))) ? v : '';
  document.getElementById('fc-price-item').value = toNum(pd.priceItem);
  document.getElementById('fc-price-box').value = toNum(pd.priceBox);
  document.getElementById('fc-price-complete').value = toNum(pd.priceComplete);
  document.getElementById('fc-has-box').value = ['Yes','No'].includes(pd.hasBox) ? pd.hasBox : 'No';
  document.getElementById('fc-box-cond').value = toNum(pd.boxCond);
  document.getElementById('fc-photo-item').value = pd.photoItem || '';
  document.getElementById('fc-photo-box').value = pd.photoBox || '';
  document.getElementById('fc-notes').value = pd.notes || '';

  // Show box-only prompt if row has box but no item info
  const isBoxOnly = pd.owned && pd.hasBox === 'Yes' && 
    (!pd.condition || pd.condition === 'N/A') && 
    (!pd.priceItem || pd.priceItem === 'N/A');
  const prompt = document.getElementById('box-only-prompt');
  if (prompt) prompt.style.display = isBoxOnly ? 'flex' : 'none';

  document.getElementById('item-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function fillItemFromBoxRow() {
  if (!state.currentItem) return;
  const { item } = state.currentItem;
  closeModal();
  // Start wizard in collection mode, pre-filled with item number, skip to item-info steps
  wizard = {
    step: 0,
    tab: 'collection',
    data: {
      tab: 'collection',
      itemNum: item.itemNum,
      variation: item.variation || '',
      boxOnly: false,
      _fillItemMode: true, // flag so we can pre-set item number
    },
    steps: getSteps('collection'),
    matchedItem: state.masterData.find(i => i.itemNum === item.itemNum) || null,
  };
  // Advance past tab and itemNum steps since we already know them
  wizard.step = 2; // start at condition step
  document.getElementById('wizard-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  renderWizardStep();
}

function closeModal() {
  document.getElementById('item-modal').classList.remove('open');
  document.body.style.overflow = '';
  state.currentItem = null;
}

function closeModalOnOverlay(e) { if (e.target === document.getElementById('item-modal')) closeModal(); }

let currentStatus = 'Want';

function setStatus(status) {
  currentStatus = status;
  // Update button styles
  ['Want','Owned','Sold'].forEach(s => {
    const btn = document.getElementById('status-' + s.toLowerCase());
    if (!btn) return;
    if (s === status) {
      const colors = { Want: 'var(--accent2)', Owned: 'var(--green)', Sold: '#9b59b6' };
      btn.style.background = colors[s] + '22';
      btn.style.borderColor = colors[s];
      btn.style.color = colors[s];
    } else {
      btn.style.background = 'var(--surface2)';
      btn.style.borderColor = 'var(--border)';
      btn.style.color = 'var(--text-mid)';
    }
  });
  document.getElementById('collection-form').style.display = (status === 'Owned' || status === 'Sold') ? 'block' : 'none';
  const soldFields = document.getElementById('sold-fields');
  if (soldFields) soldFields.style.display = status === 'Sold' ? 'block' : 'none';
  const wantFields = document.getElementById('want-fields');
  if (wantFields) wantFields.style.display = status === 'Want' ? 'block' : 'none';
}

async function saveItem() {
  if (!state.currentItem) return;
  const { item } = state.currentItem;
  const key = `${item.itemNum}|${item.variation}`;

  const copy = document.getElementById('fc-copy').value;
  const condition = document.getElementById('fc-condition').value;

  if (currentStatus === 'Owned') {
    // Write/update in My Collection tab
    const ownedRow = [
      item.itemNum, item.variation || '', copy, condition,
      document.getElementById('fc-original').value,
      document.getElementById('fc-price-item').value,
      document.getElementById('fc-price-box').value,
      document.getElementById('fc-price-complete').value,
      document.getElementById('fc-has-box').value,
      document.getElementById('fc-box-cond').value,
      document.getElementById('fc-photo-item').value,
      document.getElementById('fc-photo-box').value,
      document.getElementById('fc-notes').value,
    ];
    const existing = state.personalData[key];
    if (existing && existing.row) {
      await sheetsUpdate(state.personalSheetId, `My Collection!A${existing.row}:N${existing.row}`, [ownedRow]);
    } else {
      await sheetsAppend(state.personalSheetId, 'My Collection!A:N', [ownedRow]);
    }
    // Remove from Sold tab if it was there
    const soldEntry = state.soldData[key];
    if (soldEntry && soldEntry.row) {
      await sheetsUpdate(state.personalSheetId, `Sold!A${soldEntry.row}:H${soldEntry.row}`, [['','','','','','','','']]);
    }
    // Remove from Want List if it was there
    const wantEntry = state.wantData[key];
    if (wantEntry && wantEntry.row) {
      await sheetsUpdate(state.personalSheetId, `Want List!A${wantEntry.row}:E${wantEntry.row}`, [['','','','','']]);
    }

  } else if (currentStatus === 'Sold') {
    // Remove from My Collection
    const existing = state.personalData[key];
    if (existing && existing.row) {
      await sheetsUpdate(state.personalSheetId, `My Collection!A${existing.row}:N${existing.row}`, [['','','','','','','','','','','','','']]);
    }
    // Write to Sold tab
    const soldRow = [
      item.itemNum, item.variation || '', copy, condition,
      existing?.priceItem || document.getElementById('fc-price-item').value,
      document.getElementById('fc-sale-price').value,
      document.getElementById('fc-date-sold').value,
      document.getElementById('fc-notes').value,
    ];
    const soldEntry = state.soldData[key];
    if (soldEntry && soldEntry.row) {
      await sheetsUpdate(state.personalSheetId, `Sold!A${soldEntry.row}:H${soldEntry.row}`, [soldRow]);
    } else {
      await sheetsAppend(state.personalSheetId, 'Sold!A:H', [soldRow]);
    }

  } else if (currentStatus === 'Want') {
    // Remove from My Collection if present
    const existing = state.personalData[key];
    if (existing && existing.row) {
      await sheetsUpdate(state.personalSheetId, `My Collection!A${existing.row}:N${existing.row}`, [['','','','','','','','','','','','','']]);
    }
    // Write/update Want List tab
    const wantRow = [
      item.itemNum,
      item.variation || '',
      document.getElementById('fc-want-priority').value,
      document.getElementById('fc-want-price').value,
      document.getElementById('fc-want-notes').value,
    ];
    const wantEntry = state.wantData[key];
    if (wantEntry && wantEntry.row) {
      await sheetsUpdate(state.personalSheetId, `Want List!A${wantEntry.row}:E${wantEntry.row}`, [wantRow]);
    } else {
      await sheetsAppend(state.personalSheetId, 'Want List!A:E', [wantRow]);
    }
  }

  await loadPersonalData();

  // Reset all filters so the browse view shows everything
  state.filters.wantList = false;
  state.filters.owned = false;
  state.filters.unowned = false;
  state.filters.boxed = false;
  // Reset toggle button visual states


  closeModal();
  buildDashboard();
  buildSoldPage();
  renderBrowse();
}

// â”€â”€ REPORTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildReport() {
  const type = document.getElementById('report-type')?.value || 'wantlist';
  const thead = document.getElementById('report-thead');
  const tbody = document.getElementById('report-tbody');
  if (!thead || !tbody) return;

  if (type === 'wantlist') {
    thead.innerHTML = '<tr><th>Item #</th><th>Type</th><th>Road Name</th><th>Year</th><th>Variation</th><th>Est. Market Value</th><th>COTT Link</th></tr>';
    const wants = state.masterData.filter(i => !state.personalData[`${i.itemNum}|${i.variation}`]?.owned);
    tbody.innerHTML = wants.map(i => `
      <tr>
        <td><span class="item-num">${i.itemNum}</span></td>
        <td><span class="tag">${i.itemType || 'â€”'}</span></td>
        <td>${i.roadName || 'â€”'}</td>
        <td>${i.yearProd || 'â€”'}</td>
        <td>${i.variation || 'â€”'}</td>
        <td class="market-val">${i.marketVal ? '$'+parseFloat(i.marketVal).toLocaleString() : 'â€”'}</td>
        <td>${i.refLink ? `<a href="${i.refLink}" target="_blank" style="color:var(--accent2)">View â†—</a>` : 'â€”'}</td>
      </tr>`).join('') || '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-dim)">All items owned! ğŸ‰</td></tr>';

  } else if (type === 'collection') {
    thead.innerHTML = '<tr><th>Item #</th><th>Type</th><th>Road Name</th><th>Variation</th><th>Copy #</th><th>Condition</th><th>Has Box</th><th>All Original</th><th>Item Price</th><th>Item+Box</th></tr>';
    const owned = state.masterData.filter(i => state.personalData[`${i.itemNum}|${i.variation}`]?.owned);
    tbody.innerHTML = owned.map(i => {
      const pd = state.personalData[`${i.itemNum}|${i.variation}`];
      return `<tr>
        <td><span class="item-num">${i.itemNum}</span></td>
        <td><span class="tag">${i.itemType || 'â€”'}</span></td>
        <td>${i.roadName || 'â€”'}</td>
        <td>${i.variation || 'â€”'}</td>
        <td>${pd.copy || '1'}</td>
        <td>${pd.condition || 'â€”'}</td>
        <td>${pd.hasBox || 'â€”'}</td>
        <td>${pd.allOriginal || 'â€”'}</td>
        <td class="market-val">${pd.priceItem ? '$'+parseFloat(pd.priceItem).toLocaleString() : 'â€”'}</td>
        <td class="market-val">${pd.priceComplete ? '$'+parseFloat(pd.priceComplete).toLocaleString() : 'â€”'}</td>
      </tr>`;
    }).join('') || '<tr><td colspan="10" style="text-align:center;padding:2rem;color:var(--text-dim)">No owned items yet</td></tr>';

  } else if (type === 'value') {
    thead.innerHTML = '<tr><th>Category</th><th>Owned</th><th>Total in Master</th><th>% Complete</th><th>Est. Collection Value</th></tr>';
    const cats = {};
    state.masterData.forEach(i => {
      const t = i.itemType || 'Other';
      if (!cats[t]) cats[t] = { total: 0, owned: 0, value: 0 };
      cats[t].total++;
      const pd = state.personalData[`${i.itemNum}|${i.variation}`];
      if (pd?.owned) {
        cats[t].owned++;
        cats[t].value += parseFloat(pd.priceComplete || pd.priceItem || 0);
      }
    });
    tbody.innerHTML = Object.entries(cats).sort((a,b)=>b[1].owned-a[1].owned).map(([name, c]) => `
      <tr>
        <td>${name}</td>
        <td>${c.owned}</td>
        <td>${c.total}</td>
        <td>${c.total > 0 ? Math.round(c.owned/c.total*100) + '%' : 'â€”'}</td>
        <td class="market-val">${c.value > 0 ? '$'+Math.round(c.value).toLocaleString() : 'â€”'}</td>
      </tr>`).join('');

  } else if (type === 'missing-box') {
    thead.innerHTML = '<tr><th>Item #</th><th>Type</th><th>Road Name</th><th>Condition</th><th>Est. Market Value</th></tr>';
    const noBox = state.masterData.filter(i => {
      const pd = state.personalData[`${i.itemNum}|${i.variation}`];
      return pd?.owned && pd?.hasBox !== 'Yes';
    });
    tbody.innerHTML = noBox.map(i => {
      const pd = state.personalData[`${i.itemNum}|${i.variation}`];
      return `<tr>
        <td><span class="item-num">${i.itemNum}</span></td>
        <td><span class="tag">${i.itemType || 'â€”'}</span></td>
        <td>${i.roadName || 'â€”'}</td>
        <td>${pd.condition || 'â€”'}</td>
        <td class="market-val">${i.marketVal ? '$'+parseFloat(i.marketVal).toLocaleString() : 'â€”'}</td>
      </tr>`;
    }).join('') || '<tr><td colspan="5" style="text-align:center;padding:2rem;color:var(--text-dim)">All owned items have boxes!</td></tr>';
  }
}

function exportReport() {
  const thead = document.getElementById('report-thead');
  const tbody = document.getElementById('report-tbody');
  const headers = [...thead.querySelectorAll('th')].map(th => th.textContent).join(',');
  const rows = [...tbody.querySelectorAll('tr')].map(tr =>
    [...tr.querySelectorAll('td')].map(td => `"${td.textContent.replace(/"/g,'""')}"`).join(',')
  ).join('\n');
  const csv = headers + '\n' + rows;
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'lionel-report.csv'; a.click();
}

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSoldPage() {
  const soldEntries = Object.values(state.soldData);
  const tbody = document.getElementById('sold-tbody');

  tbody.innerHTML = soldEntries.length ? soldEntries.map(sd => {
    // Look up master data for type/road info
    const master = state.masterData.find(i => i.itemNum === sd.itemNum && i.variation === sd.variation) || {};
    return `<tr>
      <td><span class="item-num">${sd.itemNum}</span></td>
      <td><span class="tag">${master.itemType || 'â€”'}</span></td>
      <td>${master.roadName || 'â€”'}</td>
      <td>${sd.variation || 'â€”'}</td>
      <td>${sd.condition || 'â€”'}</td>
      <td class="market-val">${sd.salePrice ? '$' + parseFloat(sd.salePrice).toLocaleString() : 'â€”'}</td>
      <td class="text-dim">${sd.dateSold || 'â€”'}</td>
    </tr>`;
  }).join('') : '<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">ğŸ’°</div><p>No sold items yet</p></div></td></tr>';

  document.getElementById('nav-sold').textContent = soldEntries.length;
}

function showPage(name, clickedEl) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.mobile-nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (clickedEl) clickedEl.classList.add('active');
  if (name === 'browse') renderBrowse();
  if (name === 'reports') buildReport();
  if (name === 'sold') buildSoldPage();
  document.getElementById('main-content').scrollTop = 0;
}

// â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseJwt(token) {
  const base64 = token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/');
  return JSON.parse(atob(base64));
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = () => {
  if (typeof google !== 'undefined') initGoogle();
};
</script>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>
<script>
// â”€â”€ ADD ITEM WIZARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let wizard = {
  step: 0,
  tab: null,       // 'collection' | 'sold' | 'want'
  data: {},
  steps: [],
  matchedItem: null,
};

// Step definitions per tab
function getSteps(tab) {
  const base = [
    { id: 'tab',        title: 'What would you like to add?',          type: 'choice' },
    { id: 'itemNum',    title: 'What is the Lionel item number?',       type: 'text',     placeholder: 'e.g. 726, 2046, 6464-1' },
    { id: 'variation',  title: 'Which variation is it?',                type: 'variation', optional: true },
  ];

  if (tab === 'collection') {
    // Box-only mode: skip item condition/price, only ask box info
    if (wizard.data.boxOnly) {
      return [
        { id: 'tab',           title: 'What would you like to add?',       type: 'choice' },
        { id: 'itemNum',       title: 'What is the Lionel item number?',    type: 'text',     placeholder: 'e.g. 726, 2046, 6464-1' },
        { id: 'pickRow',       title: 'Which item is this box for?',        type: 'pickRow',  skipIf: (d) => {
          const matches = Object.keys(state.personalData).filter(k => k.split('|')[0] === (d.itemNum||'').trim());
          return matches.length <= 1; // skip if 0 or 1 match â€” no choice needed
        }},
        { id: 'boxCond',       title: 'What condition is the box?',         type: 'slider',   min:1, max:10 },
        { id: 'priceBox',      title: 'What did you pay for the box?',      type: 'money',    placeholder: '0.00', optional: true },
        { id: 'purchaseDate',  title: 'When did you buy the box?',          type: 'date',     optional: true },
        { id: 'userEstWorth',  title: 'What do you estimate it is worth?',  type: 'money',    placeholder: '0.00', optional: true },
        { id: 'notes',         title: 'Any notes about this box?',          type: 'textarea', optional: true },
        { id: 'confirm',       title: 'Ready to save box info!',            type: 'confirm' },
      ];
    }
    return [...base,
      { id: 'condition',   title: 'What condition is the item?',          type: 'slider',   min:1, max:10, skipIf: () => false },
      { id: 'allOriginal', title: 'Is it all original parts?',             type: 'choice3',  choices: ['Yes','No','Unknown'] },
      { id: 'hasBox',      title: 'Did it come with a box?',              type: 'choice2',  choices: ['Yes','No'], skipIf: (d) => !!d._attachToBox },
      { id: 'boxCond',     title: 'What condition is the box?',           type: 'slider',   min:1, max:10, skipIf: (d) => d.hasBox !== 'Yes' && !d._attachToBox || !!d._attachToBox },
      { id: 'pricePaid',   title: 'What did you pay?',                    type: 'pricePaid' },
      { id: 'datePurchased', title: 'When did you purchase it?',          type: 'date',     optional: true },
      { id: 'photosItem',  title: 'Add photos of the item',               type: 'drivePhotos', label: 'Item' },
      { id: 'photosBox',   title: 'Add photos of the box',                type: 'drivePhotos', label: 'Box',  skipIf: (d) => (d.hasBox !== 'Yes' && !d._attachToBox) || !!d._attachToBox },
      { id: 'userEstWorth', title: 'What do you estimate it is worth?',     type: 'money', placeholder: '0.00', optional: true, note: (d) => (d._attachToBox || d._fillItemMode || d.hasBox === 'Yes') ? 'Include the value of both the item and the box in your estimate' : '' },
      { id: 'notes',       title: 'Any notes about this item?',           type: 'textarea', optional: true },
      { id: 'confirm',     title: 'Ready to save!',                       type: 'confirm' },
    ];
  } else if (tab === 'sold') {
    return [
      { id: 'tab',          title: 'What would you like to add?',         type: 'choice' },
      { id: 'itemNum',      title: 'What is the Lionel item number?',      type: 'text',        placeholder: 'e.g. 726, 2046, 6464-1' },
      { id: 'pickSoldItem', title: 'Which item are you selling?',          type: 'pickSoldItem',
        skipIf: (d) => {
          const matches = Object.keys(state.personalData).filter(k => k.split('|')[0] === (d.itemNum||'').trim());
          return matches.length === 0; // not in collection â€” skip picker
        }
      },
      { id: 'condition',    title: 'What condition was the item?',         type: 'slider',      min:1, max:10,
        skipIf: (d) => !!d.selectedSoldKey },
      { id: 'priceItem',    title: 'What did you originally pay for it?',  type: 'money',       placeholder: '0.00', optional: true,
        skipIf: (d) => !!d.selectedSoldKey },
      { id: 'salePrice',    title: 'What did you sell it for?',            type: 'money',       placeholder: '0.00' },
      { id: 'dateSold',     title: 'When did you sell it?',                type: 'date',        optional: true },
      { id: 'notes',        title: 'Any notes about the sale?',            type: 'textarea',    optional: true },
      { id: 'confirm',      title: 'Ready to save!',                       type: 'confirm' },
    ];
  } else { // want
    return [...base,
      { id: 'priority',      title: 'How high is your priority for this item?', type: 'choice3', choices: ['High','Medium','Low'] },
      { id: 'expectedPrice', title: 'What do you expect to pay?',               type: 'money',   placeholder: '0.00', optional: true },
      { id: 'notes',         title: "Any notes about what you're looking for?", type: 'textarea', optional: true },
      { id: 'confirm',       title: 'Ready to add to Want List!',               type: 'confirm' },
    ];
  }
}

function startAddWizard() {
  wizard = { step: 0, tab: null, data: {}, steps: getSteps(null), matchedItem: null };
  document.getElementById('wizard-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  renderWizardStep();
}

function closeWizard() {
  document.getElementById('wizard-modal').classList.remove('open');
  document.body.style.overflow = '';
}

function closeWizardOnOverlay(e) {
  if (e.target === document.getElementById('wizard-modal')) closeWizard();
}

function renderWizardStep() {
  const steps = wizard.tab ? getSteps(wizard.tab) : getSteps(null);
  wizard.steps = steps;

  // Skip steps based on skipIf
  let step = wizard.step;
  while (step < steps.length - 1 && steps[step].skipIf && steps[step].skipIf(wizard.data)) {
    step++;
    wizard.step = step;
  }

  const s = steps[step];
  const total = steps.filter(st => !st.skipIf || !st.skipIf(wizard.data)).length;
  const current = steps.slice(0, step).filter(st => !st.skipIf || !st.skipIf(wizard.data)).length + 1;
  const pct = Math.round((current / total) * 100);

  document.getElementById('wizard-step-label').textContent = `Step ${current} of ${total}`;
  document.getElementById('wizard-title').textContent = s.title;
  document.getElementById('wizard-progress').style.width = pct + '%';
  document.getElementById('wizard-back-btn').style.display = step > 0 ? 'inline-flex' : 'none';
  document.getElementById('wizard-next-btn').textContent = s.type === 'confirm' ? 'âœ“ Save' : 'Next â†’';

  const body = document.getElementById('wizard-body');

  if (s.type === 'choice') {
    // First step - choose tab
    body.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:0.75rem;padding-top:0.5rem">
        ${[['collection','âœ“ My Collection','Add an item you own','var(--green)'],
           ['sold','$ Sold','Record a sold item','#9b59b6'],
           ['want','â˜… Want List','Add to your wish list','var(--accent2)']].map(([val,label,desc,color]) => `
          <button onclick="wizardChooseTab('${val}')" style="
            display:flex;align-items:center;gap:1rem;padding:1rem 1.25rem;
            border-radius:10px;border:2px solid ${wizard.tab===val ? color : 'var(--border)'};
            background:${wizard.tab===val ? color+'22' : 'var(--surface2)'};
            color:var(--text);cursor:pointer;text-align:left;font-family:var(--font-body);
            transition:all 0.15s;width:100%
          ">
            <div style="font-size:1.5rem;width:36px;text-align:center">${label.split(' ')[0]}</div>
            <div>
              <div style="font-weight:600;font-size:0.95rem">${label.split(' ').slice(1).join(' ')}</div>
              <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.15rem">${desc}</div>
            </div>
          </button>`).join('')}

      </div>`;

  } else if (s.type === 'variation') {
    // Look up all variations for the entered item number
    const itemNum = wizard.data.itemNum || '';
    const variations = state.masterData.filter(i => i.itemNum === itemNum && i.variation);
    const val = wizard.data.variation || '';
    if (variations.length === 0) {
      // No variations in master - fall back to text input
      body.innerHTML = `
        <div style="padding-top:0.75rem">
          <input type="text" id="wiz-input" value="${val}" placeholder="Leave blank if no variation"
            style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;
            padding:0.75rem 1rem;color:var(--text);font-family:var(--font-body);font-size:1rem;outline:none"
            oninput="wizard.data.variation=this.value"
            onkeydown="if(event.key==='Enter')wizardNext()">
          ${s.note && s.note(wizard.data) ? `<div style="font-size:0.8rem;color:var(--accent2);margin-top:0.6rem;padding:0.5rem 0.75rem;background:rgba(245,166,35,0.1);border-radius:6px">${s.note(wizard.data)}</div>` : ''}
        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>
        </div>`;
      setTimeout(() => { const i = document.getElementById('wiz-input'); if(i) i.focus(); }, 50);
    } else {
      // Show variation cards with description tooltip
      body.innerHTML = `
        <div style="padding-top:0.5rem">
          <div style="display:flex;flex-direction:column;gap:0.5rem" id="var-cards">
            ${[{variation:'', varDesc:'No specific variation / not sure'}, ...variations].map(v => `
              <button onclick="wizardChooseVariation('${v.variation}')" style="
                display:flex;align-items:flex-start;gap:0.75rem;padding:0.85rem 1rem;
                border-radius:10px;text-align:left;width:100%;cursor:pointer;
                font-family:var(--font-body);transition:all 0.15s;
                border:2px solid ${val===v.variation ? 'var(--accent)' : 'var(--border)'};
                background:${val===v.variation ? 'rgba(232,64,28,0.12)' : 'var(--surface2)'};
                color:var(--text);
              ">
                <span style="
                  font-family:var(--font-mono);font-size:1rem;font-weight:600;
                  color:${val===v.variation ? 'var(--accent)' : 'var(--accent2)'};
                  min-width:2rem;padding-top:0.1rem;
                ">${v.variation || 'â€”'}</span>
                <span style="font-size:0.82rem;color:var(--text-mid);line-height:1.5">${v.varDesc || v.description || 'No description available'}</span>
              </button>`).join('')}
          </div>
          <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Selecting a variation will auto-advance</div>
        </div>`;
    }

  } else if (s.type === 'text') {
    const val = wizard.data[s.id] || '';
    const showBoxOnly = s.id === 'itemNum' && wizard.tab === 'collection';
    const boxOnlyChecked = wizard.data.boxOnly || false;
    body.innerHTML = `
      <div style="padding-top:0.75rem">
        <input type="text" id="wiz-input" value="${val}" placeholder="${s.placeholder || ''}"
          style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;
          padding:0.75rem 1rem;color:var(--text);font-family:var(--font-body);font-size:1rem;outline:none"
          oninput="wizard.data['${s.id}']=this.value"
          onkeydown="if(event.key==='Enter')wizardNext()">
        ${s.optional ? '<div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>' : ''}
        <div id="wiz-match" style="margin-top:0.75rem"></div>
        ${showBoxOnly ? `
        <label onclick="toggleBoxOnly()" style="
          display:flex;align-items:center;gap:0.75rem;padding:0.85rem 1rem;margin-top:0.75rem;
          border-radius:10px;border:2px solid ${boxOnlyChecked ? 'var(--accent2)' : 'var(--border)'};
          background:${boxOnlyChecked ? 'rgba(245,166,35,0.1)' : 'var(--surface2)'};
          cursor:pointer;transition:all 0.15s;
        ">
          <div style="
            width:20px;height:20px;border-radius:5px;flex-shrink:0;
            border:2px solid ${boxOnlyChecked ? 'var(--accent2)' : 'var(--border)'};
            background:${boxOnlyChecked ? 'var(--accent2)' : 'transparent'};
            display:flex;align-items:center;justify-content:center;
            font-size:0.75rem;color:white;font-weight:700;transition:all 0.15s;
          ">${boxOnlyChecked ? 'âœ“' : ''}</div>
          <div>
            <div style="font-weight:600;font-size:0.9rem;color:var(--text)">Adding box info only</div>
            <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.1rem">I bought a separate box for this item</div>
          </div>
        </label>` : ''}
      </div>`;
    setTimeout(() => {
      const inp = document.getElementById('wiz-input');
      if (inp) { inp.focus(); if (s.id === 'itemNum') inp.addEventListener('input', debounceItemLookup); }
    }, 50);

  } else if (s.type === 'slider') {
    const val = wizard.data[s.id] || 7;
    body.innerHTML = `
      <div style="padding-top:1rem">
        <div style="display:flex;align-items:center;gap:1rem">
          <div style="font-family:var(--font-head);font-size:3rem;color:var(--accent2);width:3rem" id="wiz-slider-val">${val}</div>
          <input type="range" min="${s.min}" max="${s.max}" value="${val}" id="wiz-slider" style="flex:1;accent-color:var(--accent)"
            oninput="wizard.data['${s.id}']=parseInt(this.value);document.getElementById('wiz-slider-val').textContent=this.value">
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:var(--text-dim);margin-top:0.25rem">
          <span>1 â€” Poor</span><span>5 â€” Good</span><span>10 â€” Mint</span>
        </div>
      </div>`;

  } else if (s.type === 'choice2' || s.type === 'choice3') {
    const val = wizard.data[s.id] || '';
    body.innerHTML = `
      <div style="display:flex;gap:0.75rem;flex-wrap:wrap;padding-top:0.75rem">
        ${s.choices.map(c => `
          <button onclick="wizardChoose('${s.id}','${c}')" style="
            flex:1;min-width:80px;padding:0.85rem;border-radius:10px;
            border:2px solid ${val===c ? 'var(--accent)' : 'var(--border)'};
            background:${val===c ? 'rgba(232,64,28,0.15)' : 'var(--surface2)'};
            color:${val===c ? 'var(--accent)' : 'var(--text-mid)'};
            font-family:var(--font-body);font-size:0.95rem;font-weight:500;cursor:pointer;transition:all 0.15s
          ">${c}</button>`).join('')}
      </div>`;

  } else if (s.type === 'pricePaid') {
    const itemVal = wizard.data.priceItem || '';
    body.innerHTML = `
      <div style="padding-top:0.75rem">
        <div style="font-size:0.72rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-dim);margin-bottom:0.4rem">What did you pay for the item? ($)</div>
        <div style="display:flex;align-items:center;gap:0.5rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem">
          <span style="color:var(--text-dim);font-size:1.2rem">$</span>
          <input type="number" id="wiz-price-item" value="${itemVal}" placeholder="0.00" min="0" step="0.01"
            style="flex:1;background:none;border:none;outline:none;color:var(--text);font-family:var(--font-body);font-size:1.1rem"
            oninput="wizard.data.priceItem=this.value"
            onkeydown="if(event.key==='Enter')wizardNext()">
        </div>
        ${s.note && s.note(wizard.data) ? `<div style="font-size:0.8rem;color:var(--accent2);margin-top:0.6rem;padding:0.5rem 0.75rem;background:rgba(245,166,35,0.1);border-radius:6px">${s.note(wizard.data)}</div>` : ''}
        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>
      </div>`;
    setTimeout(() => { const i = document.getElementById('wiz-price-item'); if(i) i.focus(); }, 50);

  } else if (s.type === 'money') {
    const val = wizard.data[s.id] || '';
    const moneyNote = s.note ? s.note(wizard.data) : '';
    const moneyNoteHtml = moneyNote ? '<div style="font-size:0.82rem;color:var(--accent2);margin-top:0.6rem;padding:0.5rem 0.75rem;background:rgba(245,166,35,0.12);border:1px solid rgba(245,166,35,0.4);border-radius:6px;line-height:1.4">' + moneyNote + '</div>' : '';
    body.innerHTML = `
      <div style="padding-top:0.75rem">
        <div style="display:flex;align-items:center;gap:0.5rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem">
          <span style="color:var(--text-dim);font-size:1.2rem">$</span>
          <input type="number" id="wiz-input" value="${val}" placeholder="${s.placeholder || '0.00'}" min="0" step="0.01"
            style="flex:1;background:none;border:none;outline:none;color:var(--text);font-family:var(--font-body);font-size:1.1rem"
            oninput="wizard.data['${s.id}']=this.value"
            onkeydown="if(event.key==='Enter')wizardNext()">
        </div>
        ${moneyNoteHtml}
        ${s.optional ? '<div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>' : ''}
      </div>`;
    setTimeout(() => { const i = document.getElementById('wiz-input'); if(i) i.focus(); }, 50);

  } else if (s.type === 'date') {
    const val = wizard.data[s.id] || '';
    body.innerHTML = `
      <div style="padding-top:0.75rem">
        <input type="date" id="wiz-input" value="${val}"
          style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;
          padding:0.75rem 1rem;color:var(--text);font-family:var(--font-body);font-size:1rem;outline:none"
          oninput="wizard.data['${s.id}']=this.value">
        ${s.note && s.note(wizard.data) ? `<div style="font-size:0.8rem;color:var(--accent2);margin-top:0.6rem;padding:0.5rem 0.75rem;background:rgba(245,166,35,0.1);border-radius:6px">${s.note(wizard.data)}</div>` : ''}
        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>
      </div>`;

  } else if (s.type === 'drivePhotos') {
    const views = s.label === 'Box' ? BOX_VIEWS : ITEM_VIEWS;
    const stored = wizard.data[s.id] || {};
    body.innerHTML = `
      <div style="padding-top:0.25rem">
        <div style="font-size:0.78rem;color:var(--text-dim);margin-bottom:0.75rem">
          Drag & drop or click each slot to upload. Photos save to Google Drive automatically.
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.6rem" id="photo-grid">
          ${views.map(v => {
            const url = stored[v.key] || '';
            return `<div class="photo-drop-zone" data-view="${v.key}" data-sid="${s.id}"
              ondragover="event.preventDefault();this.style.borderColor='var(--accent)'"
              ondragleave="this.style.borderColor='var(--border)'"
              ondrop="handlePhotoDrop(event,'${s.id}','${v.key}')"
              onclick="document.getElementById('file-${s.id}-${v.key}').click()"
              style="border:2px dashed var(--border);border-radius:10px;min-height:90px;
              display:flex;flex-direction:column;align-items:center;justify-content:center;
              cursor:pointer;transition:border-color 0.2s;position:relative;overflow:hidden;
              background:var(--surface2)">
              ${url
                ? `<img src="${url}" style="width:100%;height:100%;object-fit:cover;position:absolute;inset:0" onerror="this.style.display='none'">
                   <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.6);
                   font-size:0.62rem;color:#fff;padding:2px 4px;text-align:center">${v.abbr} âœ“</div>`
                : `<div style="font-size:0.7rem;color:var(--text-dim);text-align:center;padding:0.5rem">
                   <div style="font-size:1.4rem;margin-bottom:0.2rem">ğŸ“·</div>
                   <div style="font-weight:600;color:var(--text-mid)">${v.abbr}</div>
                   <div style="font-size:0.62rem">${v.label}</div>
                   </div>`
              }
              <div id="prog-${s.id}-${v.key}" style="display:none;position:absolute;inset:0;
                background:rgba(0,0,0,0.7);align-items:center;justify-content:center;flex-direction:column">
                <div style="color:white;font-size:0.75rem">Uploadingâ€¦</div>
              </div>
            </div>
            <input type="file" id="file-${s.id}-${v.key}" accept="image/*" capture="environment" style="display:none"
              onchange="handlePhotoFile(event,'${s.id}','${v.key}')">`;
          }).join('')}
        </div>
        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.6rem">Optional â€” press Next to skip any views</div>
      </div>`;

  } else if (s.type === 'textarea') {
    const val = wizard.data[s.id] || '';
    body.innerHTML = `
      <div style="padding-top:0.75rem">
        <textarea id="wiz-input" placeholder="Optional notesâ€¦"
          style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;
          padding:0.75rem 1rem;color:var(--text);font-family:var(--font-body);font-size:0.9rem;
          outline:none;resize:vertical;min-height:100px"
          oninput="wizard.data['${s.id}']=this.value">${val}</textarea>
        ${s.note && s.note(wizard.data) ? `<div style="font-size:0.8rem;color:var(--accent2);margin-top:0.6rem;padding:0.5rem 0.75rem;background:rgba(245,166,35,0.1);border-radius:6px">${s.note(wizard.data)}</div>` : ''}
        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>
      </div>`;
    setTimeout(() => { const i = document.getElementById('wiz-input'); if(i) i.focus(); }, 50);

  } else if (s.type === 'pickSoldItem') {
    const itemNum = (wizard.data.itemNum || '').trim();
    const matchKeys = Object.keys(state.personalData).filter(k => {
      const pd = state.personalData[k];
      // Show all owned rows for this item number
      // Include rows with real item info (condition not N/A or empty)
      return k.split('|')[0] === itemNum && pd.owned;
    });
    console.log('pickSoldItem matchKeys for', itemNum, ':', matchKeys, 'personalData keys:', Object.keys(state.personalData).filter(k => k.startsWith(itemNum + '|')));
    const selected = wizard.data.selectedSoldKey || '';
    body.innerHTML = `
      <div style="padding-top:0.5rem;display:flex;flex-direction:column;gap:0.5rem">
        ${matchKeys.length === 0 ? '<div style="color:var(--text-dim);font-size:0.85rem">No owned items found for this number.</div>' : ''}
        ${matchKeys.map(k => {
          const pd = state.personalData[k];
          const isSelected = selected === k;
          return `<button onclick="wizardPickSoldItem('${k}')" style="
            display:flex;align-items:flex-start;gap:0.75rem;padding:0.85rem 1rem;
            border-radius:10px;text-align:left;width:100%;cursor:pointer;
            font-family:var(--font-body);transition:all 0.15s;
            border:2px solid ${isSelected ? 'var(--accent)' : 'var(--border)'};
            background:${isSelected ? 'rgba(232,64,28,0.12)' : 'var(--surface2)'};
          ">
            <div style="flex:1">
              <div style="font-family:var(--font-mono);color:var(--accent2);font-size:0.9rem;font-weight:600">
                ${pd.itemNum}${pd.variation ? ' â€” Var ' + pd.variation : ''}
              </div>
              <div style="font-size:0.8rem;color:var(--text-mid);margin-top:0.3rem;display:flex;gap:1rem;flex-wrap:wrap">
                ${pd.condition ? `<span>Condition: <strong style="color:var(--text)">${pd.condition}</strong></span>` : ''}
                ${pd.hasBox === 'Yes' ? `<span style="color:var(--green)">âœ“ Has box</span>` : ''}
                ${pd.priceItem ? `<span>Paid: <strong style="color:var(--text)">$${parseFloat(pd.priceItem).toLocaleString()}</strong></span>` : ''}
                ${pd.allOriginal === 'Yes' ? `<span style="color:var(--accent2)">All original</span>` : ''}
              </div>
            </div>
            ${isSelected ? '<span style="color:var(--accent);font-size:1.1rem;align-self:center">âœ“</span>' : ''}
          </button>`;
        }).join('')}
        <button onclick="wizardPickSoldItem('__new__')" style="
          padding:0.75rem 1rem;border-radius:10px;text-align:left;width:100%;cursor:pointer;
          font-family:var(--font-body);font-size:0.85rem;transition:all 0.15s;
          border:2px solid ${selected==='__new__' ? 'var(--border)' : 'var(--border)'};
          background:var(--surface2);color:var(--text-dim);
        ">Not in my collection â€” enter details manually</button>
      </div>`;

  } else if (s.type === 'pickRow') {
    const itemNum = (wizard.data.itemNum || '').trim();
    const matchKeys = Object.keys(state.personalData).filter(k => k.split('|')[0] === itemNum);
    const selected = wizard.data.selectedRowKey || '';
    body.innerHTML = `
      <div style="padding-top:0.5rem;display:flex;flex-direction:column;gap:0.5rem">
        ${matchKeys.map(k => {
          const pd = state.personalData[k];
          const hasBoxAlready = pd.hasBox === 'Yes';
          const isSelected = selected === k;
          return `<button onclick="wizardPickRow('${k}')" style="
            display:flex;align-items:center;gap:0.75rem;padding:0.85rem 1rem;
            border-radius:10px;text-align:left;width:100%;cursor:pointer;
            font-family:var(--font-body);transition:all 0.15s;
            border:2px solid ${isSelected ? 'var(--accent)' : 'var(--border)'};
            background:${isSelected ? 'rgba(232,64,28,0.12)' : 'var(--surface2)'};
          ">
            <div style="flex:1">
              <div style="font-family:var(--font-mono);color:var(--accent2);font-size:0.85rem">${pd.itemNum} ${pd.variation ? 'â€” Var ' + pd.variation : ''}</div>
              <div style="font-size:0.8rem;color:var(--text-mid);margin-top:0.2rem">
                Condition: ${pd.condition || 'â€”'} Â· 
                ${hasBoxAlready
                  ? '<span style="color:var(--accent2)">Already has a box â€” will add new row</span>'
                  : '<span style="color:var(--green)">No box yet â€” will update this row</span>'}
              </div>
            </div>
            ${isSelected ? '<span style="color:var(--accent);font-size:1rem">âœ“</span>' : ''}
          </button>`;
        }).join('')}
      </div>`;

  } else if (s.type === 'confirm') {
    const item = wizard.matchedItem;
    body.innerHTML = `
      <div style="padding-top:0.5rem">
        ${item ? `
          <div style="background:var(--surface2);border-radius:8px;padding:0.85rem;margin-bottom:1rem">
            <div style="font-family:var(--font-mono);color:var(--accent2);font-size:0.8rem">No. ${item.itemNum}${item.variation ? ' â€” Var ' + item.variation : ''}</div>
            <div style="font-weight:600;margin-top:0.2rem">${item.roadName || item.itemType || ''}</div>
            <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.1rem">${item.yearProd || ''} Â· ${item.itemType || ''}</div>
          </div>` : `
          <div style="background:var(--surface2);border-radius:8px;padding:0.85rem;margin-bottom:1rem">
            <div style="font-family:var(--font-mono);color:var(--accent2)">Item ${wizard.data.itemNum || '?'}${wizard.data.variation ? ' Var ' + wizard.data.variation : ''}</div>
            <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.2rem">Not found in master inventory â€” will save with entered data</div>
          </div>`}
        <div style="display:flex;flex-direction:column;gap:0.35rem;font-size:0.83rem">
          ${Object.entries(wizard.data).filter(([k,v]) => k !== 'tab' && v && v !== '' && !Array.isArray(v)).map(([k,v]) => `
            <div style="display:flex;gap:0.5rem">
              <span style="color:var(--text-dim);min-width:130px;text-transform:capitalize">${k.replace(/([A-Z])/g,' $1').toLowerCase()}</span>
              <span>${k.includes('price') || k.includes('Price') || k.includes('Value') ? '$'+parseFloat(v).toLocaleString() : v}</span>
            </div>`).join('')}
        </div>
      </div>`;
  }
}

function wizardChooseTab(tab) {
  wizard.tab = tab;
  wizard.data.tab = tab;
  wizard.steps = getSteps(tab);
  // Re-render with highlighted selection
  renderWizardStep();
}

function wizardChoose(field, val) {
  wizard.data[field] = val;
  renderWizardStep();
}

// Find personalData entry by itemNum|variation prefix (key includes row number)
function findPD(itemNum, variation) {
  const prefix = `${itemNum}|${variation || ''}|`;
  const k = Object.keys(state.personalData).find(k => k.startsWith(prefix));
  return k ? state.personalData[k] : null;
}
function findPDKey(itemNum, variation) {
  const prefix = `${itemNum}|${variation || ''}|`;
  return Object.keys(state.personalData).find(k => k.startsWith(prefix)) || null;
}

// â”€â”€ PHOTO UPLOAD HANDLERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function handlePhotoDrop(event, stepId, viewKey) {
  event.preventDefault();
  event.currentTarget.style.borderColor = 'var(--border)';
  const file = event.dataTransfer.files[0];
  if (file && file.type.startsWith('image/')) {
    await uploadWizardPhoto(file, stepId, viewKey);
  }
}

async function handlePhotoFile(event, stepId, viewKey) {
  const file = event.target.files[0];
  if (file) await uploadWizardPhoto(file, stepId, viewKey);
}

async function uploadWizardPhoto(file, stepId, viewKey) {
  const d = wizard.data;
  const itemNum = (d.itemNum || 'unknown').trim();
  const variation = (d.variation || '').trim();

  // Show progress overlay
  const prog = document.getElementById('prog-' + stepId + '-' + viewKey);
  if (prog) { prog.style.display = 'flex'; }

  try {
    const url = await driveUploadItemPhoto(file, itemNum, viewKey);
    if (!wizard.data[stepId]) wizard.data[stepId] = {};
    wizard.data[stepId][viewKey] = url;
    // Re-render just this zone
    const zone = document.querySelector(`.photo-drop-zone[data-view="${viewKey}"][data-sid="${stepId}"]`);
    if (zone && url) {
      zone.innerHTML = `
        <img src="${url}" style="width:100%;height:100%;object-fit:cover;position:absolute;inset:0" onerror="this.style.display='none'">
        <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.6);
          font-size:0.62rem;color:#fff;padding:2px 4px;text-align:center">${viewKey} âœ“</div>`;
    }
  } catch(e) {
    console.error('Photo upload failed:', e);
    showToast('Photo upload failed: ' + e.message);
  } finally {
    if (prog) prog.style.display = 'none';
  }
}

function toggleBoxOnly() {
  wizard.data.boxOnly = !wizard.data.boxOnly;
  // Reset the step list so it picks up new boxOnly steps
  wizard.steps = getSteps(wizard.tab);
  renderWizardStep();
}

function wizardChooseAndAdvance(field, val) {
  wizard.data[field] = val;
  // Brief visual flash then advance
  setTimeout(() => wizardNext(), 150);
}

function toggleAttachToBox(itemNum) {
  wizard.data._attachToBox = !wizard.data._attachToBox;
  // Re-trigger lookup to refresh the checkbox display
  lookupItem(itemNum);
}

function wizardPickSoldItem(key) {
  wizard.data.selectedSoldKey = key;
  if (key !== '__new__') {
    const pd = state.personalData[key];
    if (pd) {
      // Pre-fill condition and original price from collection data
      if (pd.condition && pd.condition !== 'N/A') wizard.data.condition = parseInt(pd.condition);
      if (pd.priceItem && pd.priceItem !== 'N/A') wizard.data.priceItem = pd.priceItem;
    }
  }
  setTimeout(() => wizardNext(), 150);
}

function wizardPickRow(key) {
  wizard.data.selectedRowKey = key;
  setTimeout(() => wizardNext(), 150);
}

function wizardChooseVariation(variation) {
  wizard.data.variation = variation;
  setTimeout(() => wizardNext(), 150);
}

function updateWizardPhoto(field, idx, val) {
  // Legacy handler
  if (!wizard.data[field]) wizard.data[field] = {};
}

let itemLookupTimer;
function debounceItemLookup(e) {
  clearTimeout(itemLookupTimer);
  itemLookupTimer = setTimeout(() => lookupItem(e.target.value), 400);
}

function lookupItem(num) {
  const match = state.masterData.find(i => i.itemNum.toLowerCase() === num.trim().toLowerCase());
  wizard.matchedItem = match || null;
  const el = document.getElementById('wiz-match');
  if (!el) return;
  const trimmed = num.trim();
  if (!trimmed) { el.innerHTML = ''; return; }

  if (wizard.tab === 'sold') {
    // Sold mode: check collection first, show what they own
    const collectionKeys = Object.keys(state.personalData).filter(k => k.split('|')[0] === trimmed);
    const inCollection = collectionKeys.length > 0;
    if (inCollection) {
      const count = collectionKeys.length;
      el.innerHTML = `<div style="background:rgba(46,204,113,0.1);border:1px solid var(--green);border-radius:8px;padding:0.65rem 0.85rem;font-size:0.82rem">
        <span style="color:var(--green)">âœ“ Found in your collection</span> â€” ${count} item${count>1?'s':''} Â· select which one on the next step
      </div>`;
    } else {
      // Not in collection â€” show master catalog info if available
      if (match) {
        el.innerHTML = `<div style="background:rgba(245,166,35,0.1);border:1px solid var(--accent2);border-radius:8px;padding:0.65rem 0.85rem;font-size:0.82rem">
          <span style="color:var(--accent2)">Not in your collection</span> Â· ${match.roadName || match.itemType || ''} Â· ${match.yearProd || ''}<br>
          <span style="color:var(--text-dim)">You can still enter sale details manually</span>
        </div>`;
      } else {
        el.innerHTML = `<div style="font-size:0.8rem;color:var(--text-dim)">Not found in collection or catalog â€” enter details manually</div>`;
      }
    }
  } else if (wizard.data.boxOnly) {
    // Box-only mode: show collection status
    const collectionKey = Object.keys(state.personalData).find(k => k.startsWith(trimmed + '|'));
    const inCollection = !!collectionKey;
    const pd = inCollection ? state.personalData[collectionKey] : null;
    if (match) {
      el.innerHTML = `<div style="border-radius:8px;padding:0.65rem 0.85rem;font-size:0.82rem;
        background:rgba(46,204,113,0.1);border:1px solid var(--green)">
        <div><span style="color:var(--green)">âœ“ Found in catalog:</span> ${match.roadName || match.itemType || ''} Â· ${match.yearProd || ''}</div>
        <div style="margin-top:0.4rem;padding-top:0.4rem;border-top:1px solid rgba(255,255,255,0.08)">
          ${inCollection
            ? `<span style="color:var(--green)">âœ“ In your collection</span> Â· Condition: ${pd.condition || '?'} Â· Has box: ${pd.hasBox || 'No'}`
            : `<span style="color:var(--accent2)">âš  Box will be listed under Lionel Number ${trimmed}</span>`}
        </div>
      </div>`;
    } else {
      el.innerHTML = `<div style="background:rgba(245,166,35,0.1);border:1px solid var(--accent2);border-radius:8px;padding:0.65rem 0.85rem;font-size:0.82rem">
        <span style="color:var(--accent2)">âš  Not found in catalog</span> â€” will save box info anyway
        ${inCollection ? '<br><span style="color:var(--green)">âœ“ Found in your collection</span>' : ''}
      </div>`;
    }
  } else {
    // Normal mode: show catalog match + check for existing box-only row
    const boxOnlyKeys = Object.keys(state.personalData).filter(k => {
      const pd = state.personalData[k];
      return k.split('|')[0] === trimmed && pd.hasBox === 'Yes' &&
        (!pd.condition || pd.condition === 'N/A') && (!pd.priceItem || pd.priceItem === 'N/A');
    });
    const hasBoxOnlyRow = boxOnlyKeys.length > 0;

    if (match) {
      el.innerHTML = `<div style="background:rgba(46,204,113,0.1);border:1px solid var(--green);border-radius:8px;padding:0.65rem 0.85rem;font-size:0.82rem">
        <span style="color:var(--green)">âœ“ Found:</span> ${match.roadName || match.itemType || ''} Â· ${match.yearProd || ''} Â· ${match.itemType || ''}
        ${match.variation ? '<br><span style="color:var(--text-dim)">Note: multiple variations exist â€” select on next step</span>' : ''}
        ${hasBoxOnlyRow ? `<div style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid rgba(255,255,255,0.08)">
          <span style="color:var(--accent2)">ğŸ“¦ A box is already logged for this item.</span>
          <label onclick="toggleAttachToBox('${trimmed}')" style="display:inline-flex;align-items:center;gap:0.4rem;margin-left:0.5rem;cursor:pointer">
            <span id="attach-box-check" style="
              display:inline-flex;align-items:center;justify-content:center;
              width:16px;height:16px;border-radius:3px;font-size:0.65rem;font-weight:700;color:white;
              background:${wizard.data._attachToBox ? 'var(--accent2)' : 'transparent'};
              border:2px solid ${wizard.data._attachToBox ? 'var(--accent2)' : 'var(--text-dim)'}
            ">${wizard.data._attachToBox ? 'âœ“' : ''}</span>
            <span style="color:var(--text-dim);font-size:0.8rem">Add item info to that box row</span>
          </label>
        </div>` : ''}
      </div>`;
    } else {
      el.innerHTML = `<div style="font-size:0.8rem;color:var(--text-dim)">Not found in master inventory â€” will save anyway</div>`;
    }
  }
}

function wizardBack() {
  if (wizard.step > 0) {
    wizard.step--;
    // Skip back over skipIf steps
    while (wizard.step > 0 && wizard.steps[wizard.step].skipIf && wizard.steps[wizard.step].skipIf(wizard.data)) {
      wizard.step--;
    }
    renderWizardStep();
  }
}

async function wizardNext() {
  const steps = wizard.steps;
  const s = steps[wizard.step];

  // Validate required fields
  if (s.type === 'choice' && !wizard.tab) {
    alert('Please select where to add the item.'); return;
  }
  if (s.type === 'text' && !s.optional && !wizard.data[s.id]?.trim()) {
    alert('This field is required.'); return;
  }
  if (s.type === 'money' && !s.optional && !wizard.data[s.id]) {
    alert('Please enter a price.'); return;
  }
  if ((s.type === 'choice2' || s.type === 'choice3') && !wizard.data[s.id]) {
    alert('Please make a selection.'); return;
  }

  // If this is the confirm step, save
  if (s.type === 'confirm') {
    await saveWizardItem();
    return;
  }

  // Commit slider default if user never moved it
  if (s.type === 'slider' && (wizard.data[s.id] === undefined || wizard.data[s.id] === null)) {
    wizard.data[s.id] = 7;
  }

  // Advance
  wizard.step++;

  // Skip steps based on skipIf
  while (wizard.step < steps.length - 1 && steps[wizard.step].skipIf && steps[wizard.step].skipIf(wizard.data)) {
    wizard.step++;
  }

  renderWizardStep();
}

async function saveWizardItem() {
  const d = wizard.data;
  const tab = wizard.tab;
  const itemNum = (d.itemNum || '').trim();
  const variation = (d.variation || '').trim();
  const key = `${itemNum}|${variation}`;
  // Photos are now Drive URL objects keyed by view
  const photoObj = d.photosItem || {};
  const boxPhotoObj = d.photosBox || {};
  // Primary display photo = Front View, fallback to first available
  // All views return the same folder link â€” just grab the first one found
  const anyItemLink = Object.values(photoObj).find(v => v) || '';
  const anyBoxLink  = Object.values(boxPhotoObj).find(v => v) || '';
  const photos    = [anyItemLink];
  const boxPhotos = [anyBoxLink];

  try {
    if (tab === 'collection') {
      // Find existing by row-keyed lookup (key includes row number now)
      let existing = Object.keys(state.personalData)
        .map(k => state.personalData[k])
        .find(pd => pd.itemNum === itemNum && pd.variation === variation) || null;
      if (d.boxOnly) {
        // Use explicitly selected row if user picked one
        if (d.selectedRowKey && state.personalData[d.selectedRowKey]) {
          existing = state.personalData[d.selectedRowKey];
        } else if (!existing) {
          // Fall back to first match by item number
          const matchKey = Object.keys(state.personalData).find(k => k.split('|')[0] === itemNum);
          if (matchKey) existing = state.personalData[matchKey];
        }
      } else if (d._attachToBox) {
        // Adding new item â€” find the box-only row by item number
        // Box-only rows have hasBox=Yes but no meaningful item condition/price
        const boxKey = Object.keys(state.personalData).find(k => {
          const pd = state.personalData[k];
          const noCondition = !pd.condition || pd.condition === '' || pd.condition === 'N/A';
          const noItemPrice = !pd.priceItem || pd.priceItem === '' || pd.priceItem === 'N/A';
          return k.split('|')[0] === itemNum && pd.hasBox === 'Yes' && noCondition && noItemPrice;
        });
        if (boxKey) existing = state.personalData[boxKey];
        console.log('_attachToBox lookup â€” boxKey:', boxKey, 'existing row:', existing?.row);
      }
      let row;
      if (d.boxOnly) {
        const ex = existing || {};
        const itemExists = !!existing;
        // Compute item+box complete price if we have both
        const itemPrice = parseFloat(ex.priceItem && ex.priceItem !== 'N/A' ? ex.priceItem : 0) || 0;
        const boxPrice  = parseFloat(d.priceBox) || 0;
        const completePrice = (itemPrice > 0 && boxPrice > 0)
          ? (itemPrice + boxPrice).toFixed(2)
          : boxPrice > 0 ? d.priceBox  // just the box price when no item price
          : (ex.priceComplete || '');
        row = [
          itemNum,
          itemExists ? (ex.variation || variation) : variation,
          ex.condition || (itemExists ? '' : 'N/A'),
          'Yes',  // box-only rows always set all original to Yes
          ex.priceItem || (itemExists ? '' : 'N/A'),
          d.priceBox || '',
          completePrice,
          'Yes',
          d.boxCond || '',
          ex.photoItem || '',
          boxPhotos[0] || '',
          ( d.notes || ex.notes || '' ).trim(),
          d.purchaseDate || ex.datePurchased || '',
          d.userEstWorth || ex.userEstWorth || '',
        ];
      } else {
        const calcComplete = (parseFloat(d.priceItem)||0) + (parseFloat(d.priceBox)||0);
        row = [
          itemNum, variation,
          d.condition || '',
          d.allOriginal || '',
          d.priceItem || '',
          d.priceBox || '',
          calcComplete > 0 ? calcComplete.toFixed(2) : '',
          d.hasBox || 'No',
          d.boxCond || '',
          photos[0] || '',
          boxPhotos[0] || '',
          ( d.notes || '' ).trim(),
          d.datePurchased || '',
          d.userEstWorth || '',
        ];
      }
      if (d._fillItemMode && existing?.row) {
        // Preserve ALL box fields, update only item fields
        row[5]  = existing.priceBox    || row[5];
        row[7]  = existing.hasBox      || 'Yes';
        row[8]  = existing.boxCond     || row[8];
        row[10] = existing.photoBox    || row[10];
        row[12] = existing.datePurchased || row[12];
        row[13] = d.userEstWorth || existing.userEstWorth || '';
        const fp = parseFloat(row[4]) || 0;
        const bp = parseFloat(row[5]) || 0;
        row[6] = fp > 0 && bp > 0 ? (fp + bp).toFixed(2) : (existing.priceComplete || '');
        const newNote = row[11] || '';
        const exNote  = existing.notes || '';
        const itemLabel = newNote.trim() ? `Item: ${newNote.trim()}` : '';
        const boxLabel  = exNote.trim()  ? `Box: ${exNote.trim()}`   : '';
        row[11] = [boxLabel, itemLabel].filter(Boolean).join(' | ');
        await sheetsUpdate(state.personalSheetId, `My Collection!A${existing.row}:N${existing.row}`, [row]);
      } else if (d._attachToBox && existing?.row) {
        // Attaching item to existing box row â€” preserve box data, merge notes
        row[2]  = d.condition || row[2];           // always use entered condition
        row[5]  = existing.priceBox    || row[5];  // keep box price
        row[7]  = existing.hasBox      || 'Yes';
        row[8]  = existing.boxCond     || row[8];  // keep box condition
        row[10] = existing.photoBox    || row[10]; // keep box photo
        row[12] = existing.datePurchased || row[12]; // keep date
        row[13] = d.userEstWorth || existing.userEstWorth || row[13];
        const fp2 = parseFloat(row[4]) || 0;
        const bp2 = parseFloat(row[5]) || 0;
        row[6] = fp2 > 0 && bp2 > 0 ? (fp2 + bp2).toFixed(2) : (existing.priceComplete || '');
        const newNote2 = row[11] || '';
        const exNote2  = existing.notes || '';
        const itemLabel2 = newNote2.trim() ? `Item: ${newNote2.trim()}` : '';
        const boxLabel2  = exNote2.trim()  ? `Box: ${exNote2.trim()}`   : '';
        row[11] = [boxLabel2, itemLabel2].filter(Boolean).join(' | ');
        await sheetsUpdate(state.personalSheetId, `My Collection!A${existing.row}:N${existing.row}`, [row]);
      } else {
        // Always append for a plain new collection add â€” never overwrite existing rows
        await sheetsAppend(state.personalSheetId, 'My Collection!A:N', [row]);
      }

    } else if (tab === 'sold') {
      // If user picked a collection row, pull its data and clear it from My Collection
      const collectionEntry = d.selectedSoldKey ? state.personalData[d.selectedSoldKey] : null;
      const soldVariation = collectionEntry ? (collectionEntry.variation || '') : variation;
      const soldCondition = d.condition || (collectionEntry?.condition !== 'N/A' ? collectionEntry?.condition : '') || '';
      const soldPricePaid = d.priceItem || (collectionEntry?.priceItem !== 'N/A' ? collectionEntry?.priceItem : '') || '';

      const row = [
        itemNum, soldVariation, '1',
        soldCondition,
        soldPricePaid,
        d.salePrice || '',
        d.dateSold || '',
        ( d.notes || '' ).trim(),
      ];
      const soldKey = `${itemNum}|${soldVariation}`;
      const existingSold = state.soldData[soldKey];
      if (existingSold?.row) {
        await sheetsUpdate(state.personalSheetId, `Sold!A${existingSold.row}:H${existingSold.row}`, [row]);
      } else {
        await sheetsAppend(state.personalSheetId, 'Sold!A:H', [row]);
      }
      // Delete the row from My Collection
      if (collectionEntry?.row) {
        await sheetsDeleteRow(state.personalSheetId, 'My Collection', collectionEntry.row);
      }
      // Move photo folder to Sold in Drive
      if (collectionEntry?.itemNum) {
        try { await driveMoveToSold(collectionEntry.itemNum); } catch(e) { console.warn('Drive move failed:', e); }
      }

    } else if (tab === 'want') {
      const row = [
        itemNum, variation,
        d.priority || 'Medium',
        d.expectedPrice || '',
        ( d.notes || '' ).trim(),
      ];
      const existing = state.wantData[key];
      if (existing?.row) {
        await sheetsUpdate(state.personalSheetId, `Want List!A${existing.row}:E${existing.row}`, [row]);
      } else {
        await sheetsAppend(state.personalSheetId, 'Want List!A:E', [row]);
      }
    }

    closeWizard();
    // Small delay to ensure Google Sheets has committed the data
    await new Promise(r => setTimeout(r, 800));
    await loadPersonalData();
    console.log('After reload - personalData keys:', Object.keys(state.personalData));
    console.log('After reload - soldData keys:', Object.keys(state.soldData));
    console.log('After reload - wantData keys:', Object.keys(state.wantData));
    resetFilters();
    buildDashboard();
    buildSoldPage();
    renderBrowse();
    showToast(`âœ“ Item ${itemNum} added to ${tab === 'collection' ? 'My Collection' : tab === 'sold' ? 'Sold' : 'Want List'}!`);

  } catch(e) {
    console.error('Save error:', e);
    alert('Error saving: ' + e.message);
  }
}

function showToast(msg) {
  let toast = document.getElementById('toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'toast';
    toast.style.cssText = `position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);
      background:var(--green);color:white;padding:0.75rem 1.5rem;border-radius:8px;
      font-size:0.9rem;font-weight:500;z-index:999;opacity:0;transition:opacity 0.3s;
      font-family:var(--font-body);box-shadow:0 4px 20px rgba(0,0,0,0.3)`;
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.style.opacity = '1';
  setTimeout(() => { toast.style.opacity = '0'; }, 3000);
}

</script>
