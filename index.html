<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
  <meta name="theme-color" content="#111624">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Merriweather+Sans:ital,wght@0,300;0,400;0,600;0,700;1,400&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://sheets.googleapis.com">
  <link rel="preconnect" href="https://www.googleapis.com">
  <link rel="dns-prefetch" href="https://apis.google.com">
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADnElEQVR4nO3V22tcVRTH8e/e+5yZM+ecmckkTpKmaSbSXGqbYm1jqqEI3kBBsCha8G9QaavgPyRSr+iDgrS0UjShLQbENNS2YtJJWpuk40znei77bB+KKaU+CCLxYdb73vvDWj/WFrl8wbCNJbfz8S6gC+gCuoD/BcACqFUr/+oSrTVax1iWjZQSrTVKKQCiKMS2UwAYYxBCbJ3L9/TeA1y/doUfL8yBEERRhFIS1/OxbZtMxmNgcAgpFZsbt7l0aZ7Jycc4NH0YYwzrG7eZO38O20oRRAHPvfAS5fINBncMUatU+OrLL5h56mlmjzzDzuGRhxAily+YleXr3CyX+e7caW7fuonnZgiCkCjWpFIWxoAAwiik2WyQ9XOknDRSSOI4pt1qEScGJQW2rbBTDnEcY1kWiU4IwgDP83nn5Adks7ktRL6n9x7grxF8/skpdo+PMf/9eX6/tYrr+ijLwnddGq0mQgiUEOjE0O60MVrjZDLEiSGJY1zXw1ISEFRrVYwx5PN5LEtRrdUYGi5x9LU36OkpANBT6Ls3AmMMSZJwp7LO8ulfCdotUmmH8totLCVp1OvEWpPNZomThK2WGIPnutiWotVuI6XEtmxSKZsgDNnY3MRSCs/1ABgp7cb3/YdDKIRAKcUflSrXr17B9VyiOCbohCBASmjVW+TzOXJOBs/PkpiETquFlAJLSYyOCMKEgIDeQoFmo8n6+iZRFFLs7SXSGj+XY+nyElP792+FdKsDQgiCIGKlvMrQ0CBSSNJOGq01pV0lDLC6tkYUhgyXHqXQ18fF+R8QgOv77J7Yy7Wrv5DohFY74NnnX2RpaRHbStFo1Fm8vMjJE8fZu2+Kr7/5FmPM/RDWqhXOnj3NuTNn8N0Mm5UKCwsLgMSyFHsmJxBC0gma9PX1AgrHcYiigM07d/A8HyUlnU7Axvo62VyW8bFxJAmWnUYD5eVlUo6DTgyHpp/kzWNvPZiB2dkj5HN5Pj31IWHQYmpqH3EU0t9fxHFcqtW7jI6O0Go2MAgsSyEw7OgfBClQQuI6aQb6iziOw/BwidLoKGGkGZuYYKB/ACEEa2urHH/3bR4/8MSDGXCcDIemZ1hZ+Y16rcbR14/x2ccfUSw+wsuvvMrNtVUWf/6JTrvNgYMH8f08Fy/MEXQ6TEzuYXhklIVLF6jX77Jz1wgzh2f/dmn1FYuceO990inn/gj+4cL7T2rb/4IuoAvoArqAbQf8CZNpfAzhVv5mAAAAAElFTkSuQmCC">
    <link rel="apple-touch-icon" href="data:image/png;base64,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">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="My Collection App">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0e0f11">
  <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;My Collection App&quot;,&quot;short_name&quot;:&quot;My Collection&quot;,&quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%230e0f11&quot;,&quot;theme_color&quot;:&quot;%230e0f11&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230e0f11'/><text y='0.9em' font-size='80'>ðŸš‚</text></svg>&quot;,&quot;sizes&quot;:&quot;any&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>My Collection App â€” Postwar Lionel 1945â€“1969</title>

<style>
  /* â”€â”€ Reset & Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  /* Prevent iOS auto-zoom on inputs */
  @media (max-width: 640px) {
    input, select, textarea { font-size: 16px !important; }
  }

  :root {
    /* My Collection App â€” Lionel Box Palette */
    --bg:        #111624;
    --surface:   #181f38;
    --surface2:  #1e2848;
    --surface3:  #243060;
    --border:    #2a3560;
    --border-hi: #3a4880;
    --accent:    #e04028;
    --accent-dk: #b83018;
    --accent2:   #d4a843;
    --accent3:   #8b5cf6;
    --text:      #f2ddb0;
    --text-dim:  #6a5e48;
    --text-mid:  #c8b88a;
    --green:     #3a9e68;
    --green-light:#4dc880;
    --red:       #e04028;
    --gold:      #d4a843;
    --gold-light:#e8c060;
    --navy:      #1e2448;
    --cream:     #f2ddb0;
    --radius:    8px;
    --font-head: 'Oswald', 'Barlow Condensed', sans-serif;
    --font-body: 'Merriweather Sans', 'Helvetica Neue', sans-serif;
    --font-mono: 'IBM Plex Mono', 'Courier New', monospace;
    --sidebar-w: 260px;
    --header-h:  60px;
  }

  html, body { height: 100%; font-family: var(--font-body); background: var(--bg); color: var(--text); font-size: 14px; }

  /* â”€â”€ Auth Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #auth-screen {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 100vh; padding: 2rem;
    background: radial-gradient(ellipse at 30% 20%, #1a1f3a 0%, var(--bg) 60%),
                radial-gradient(ellipse at 80% 80%, #2a1008 0%, transparent 50%);
  }

  .auth-logo {
    font-family: var(--font-head); font-size: clamp(3rem, 10vw, 6rem);
    letter-spacing: 0.05em; line-height: 1;
    background: linear-gradient(135deg, #fff 0%, var(--accent2) 50%, var(--accent) 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    margin-bottom: 0.25rem;
  }
  .auth-sub {
    font-size: 0.8rem; letter-spacing: 0.3em; text-transform: uppercase;
    color: var(--text-dim); margin-bottom: 3rem;
  }
  .auth-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 2.5rem; width: 100%; max-width: 400px;
    text-align: center;
  }
  .auth-card h2 { font-size: 1.1rem; font-weight: 500; margin-bottom: 0.5rem; }
  .auth-card p { color: var(--text-dim); font-size: 0.85rem; margin-bottom: 2rem; line-height: 1.6; }

  .btn-google {
    display: flex; align-items: center; justify-content: center; gap: 0.75rem;
    width: 100%; padding: 0.85rem 1.5rem;
    background: #fff; color: #333; border: none; border-radius: 8px;
    font-family: var(--font-body); font-size: 0.95rem; font-weight: 500;
    cursor: pointer; transition: all 0.2s;
  }
  .btn-google:hover { background: #f0f0f0; transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .btn-google svg { width: 20px; height: 20px; flex-shrink: 0; }

  .auth-note {
    margin-top: 1.5rem; font-size: 0.75rem; color: var(--text-dim); line-height: 1.5;
  }

  /* â”€â”€ App Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #app { display: none; height: 100vh; flex-direction: column; }
  #app.active { display: flex; }

  /* Header */
  .header {
    height: var(--header-h); background: var(--navy,#1e2448);
    border-bottom: 2px solid var(--accent);
    display: flex; align-items: center; padding: 0 1.25rem;
    gap: 1rem; flex-shrink: 0; z-index: 100;
  }
  .header-logo { font-family: var(--font-head); flex-shrink: 0; line-height: 1.2; }
  .sidebar { background: var(--surface); }
  .sidebar .nav-label { color: var(--text-dim); }
  /* Lionel box-style brand header in sidebar */
  .sidebar-logo-wrap { background: var(--navy,#1e2448); border-bottom: 2px solid var(--accent); padding: 1.2rem 1rem; }
  .header-search {
    flex: 1; max-width: 480px;
    display: flex; align-items: center; gap: 0.5rem;
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; padding: 0.4rem 0.75rem;
  }
  .header-search input {
    flex: 1; background: none; border: none; outline: none;
    color: var(--text); font-family: var(--font-body); font-size: 0.9rem;
  }
  .header-search input::placeholder { color: var(--text-dim); }
  .header-search svg { color: var(--text-dim); flex-shrink: 0; }
  .header-right { margin-left: auto; display: flex; align-items: center; gap: 0.75rem; }
  .user-chip {
    display: flex; align-items: center; gap: 0.5rem;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 20px; padding: 0.3rem 0.75rem 0.3rem 0.3rem;
    font-size: 0.8rem;
  }
  .user-avatar {
    width: 26px; height: 26px; border-radius: 50%; background: var(--accent);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem; font-weight: 600; color: white;
  }
  .btn-sign-out {
    background: none; border: 1px solid var(--border); border-radius: 6px;
    padding: 0.3rem 0.6rem; color: var(--text-dim); cursor: pointer;
    font-size: 0.75rem; font-family: var(--font-body); transition: all 0.2s;
  }
  .btn-sign-out:hover { border-color: var(--accent); color: var(--accent); }

  /* Body layout */
  .app-body { display: flex; flex: 1; overflow: hidden; }

  /* Sidebar Nav */
  .sidebar {
    width: var(--sidebar-w); background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column; flex-shrink: 0;
    overflow-y: auto;
  }
  .nav-section { padding: 1.25rem 0.75rem 0.5rem; }
  .nav-label { font-family: var(--font-head); font-size: 0.58rem; letter-spacing: 0.2em; text-transform: uppercase;
    color: var(--text-dim); padding: 0 0.5rem; margin-bottom: 0.4rem; }
  .nav-item {
    display: flex; align-items: center; gap: 0.65rem;
    padding: 0.55rem 0.75rem; border-radius: 7px; cursor: pointer;
    color: var(--text-mid); font-size: 0.875rem; font-weight: 400;
    transition: all 0.15s; border: none; background: none; width: 100%; text-align: left;
  }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { background: rgba(200,16,46,0.12); color: var(--accent); font-family: var(--font-body); font-weight: 500; }
  .nav-item svg { flex-shrink: 0; opacity: 0.8; }
  .nav-badge {
    margin-left: auto; background: var(--accent); color: white;
    border-radius: 10px; padding: 0.1rem 0.45rem; font-size: 0.7rem; font-weight: 600;
  }
  .nav-badge.green { background: var(--green); }

  /* Main content */
  .main { flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }

  /* â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .page { display: none; }
  .page.active { display: contents; }

  .page-title {
    font-family: var(--font-head); font-size: 1.4rem; letter-spacing: 0.04em;
    display: flex; align-items: baseline; gap: 0.75rem;
  }
  .page-title span { font-family: var(--font-body); font-size: 0.8rem;
    color: var(--text-dim); font-weight: 400; letter-spacing: 0; }

  /* Stat cards */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1rem; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 1.25rem; position: relative; overflow: hidden;
    transition: border-color 0.2s, transform 0.15s;
  }
  .stat-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:var(--card-accent,var(--accent)); }
  .stat-card:hover { border-color: var(--border-light,#354870); transform: translateY(-1px); }
  .stat-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: var(--accent-color, var(--accent));
  }
  .stat-label { font-family: var(--font-head); font-size: 0.6rem; font-weight: 600; letter-spacing: 0.18em; text-transform: uppercase; color: var(--text-dim); margin-bottom: 0.4rem; }
  .stat-value { font-family: var(--font-head); font-size: 2.2rem; font-weight: 700; letter-spacing: 0.02em;
    line-height: 1; color: var(--text); }
  .stat-sub { font-size: 0.75rem; color: var(--text-dim); margin-top: 0.3rem; }

  .section-title { font-family: var(--font-head); font-size: 0.68rem; font-weight: 600;
    letter-spacing: 0.18em; text-transform: uppercase;
    color: var(--text-dim); margin-bottom: 0.75rem; padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.45rem;
  }
  .section-title::before { content: ''; width: 3px; height: 11px; background: var(--accent); border-radius: 2px; flex-shrink: 0; }

  .cat-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 1rem; display: flex; align-items: center; gap: 0.75rem;
    cursor: pointer; transition: all 0.15s;
  }
  .cat-card:hover { border-color: var(--accent); transform: translateY(-1px); }
  .cat-icon { width: 36px; height: 36px; border-radius: 8px; background: var(--surface2);
    display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
  .cat-info { flex: 1; min-width: 0; }
  .cat-name { font-weight: 500; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .cat-count { font-size: 0.75rem; color: var(--text-dim); }
  .cat-bar { height: 3px; background: var(--border); border-radius: 2px; margin-top: 0.4rem; }
  .cat-bar-fill { height: 100%; border-radius: 2px; background: var(--accent); transition: width 0.8s ease; }

  /* Recent / want list */
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  @media (max-width: 700px) { .two-col { grid-template-columns: 1fr; } }

  .panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; max-height: 420px; overflow-y: auto; }

  /* â”€â”€ Browse / Search Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .filter-bar {
    display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;
  }
  .filter-select {
    background: var(--surface); border: 1px solid var(--border); border-radius: 7px;
    padding: 0.45rem 0.75rem; color: var(--text); font-family: var(--font-body); font-size: 0.85rem;
    outline: none; cursor: pointer; transition: border-color 0.15s;
  }
  .filter-select:focus { border-color: var(--accent); }
  .filter-toggle {
    padding: 0.45rem 0.75rem; border-radius: 7px; border: 1px solid var(--border);
    background: var(--surface); color: var(--text-mid); font-size: 0.85rem;
    font-family: var(--font-body); cursor: pointer; transition: all 0.15s;
  }
  .filter-toggle.on { background: rgba(232,64,28,0.15); border-color: var(--accent); color: var(--accent); }

  /* Item table */
  .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
  .item-table { width: 100%; border-collapse: collapse; }
  .item-table th {
    background: var(--surface); padding: 0.55rem 0.85rem; text-align: left;
    font-family: var(--font-head); font-size: 0.6rem; font-weight: 600; letter-spacing: 0.16em; text-transform: uppercase;
    color: var(--text-dim); border-bottom: 2px solid var(--border);
  }
  .item-table td {
    padding: 0.75rem 1rem; border-bottom: 1px solid var(--border);
    font-size: 0.85rem; vertical-align: middle;
  }
  .item-table tr:last-child td { border-bottom: none; }
  .item-table tr:hover td { background: var(--surface2); cursor: pointer; }

  .item-num { font-family: var(--font-mono); font-size: 0.82rem; color: var(--accent2); font-weight: 600; }
  .item-road { color: var(--text-dim); font-size: 0.8rem; }
  .owned-badge {
    display: inline-flex; align-items: center; gap: 0.3rem;
    padding: 0.2rem 0.55rem; border-radius: 12px; font-size: 0.72rem; font-weight: 500;
  }
  .owned-badge.yes  { background: rgba(58,158,104,0.15); color: #4dc880; border: 1px solid rgba(58,158,104,0.3); font-family: var(--font-head); font-size: 0.62rem; font-weight: 600; letter-spacing: 0.07em; text-transform: uppercase; }
  .owned-badge.no   { background: var(--surface2); color: var(--text-dim); font-family: var(--font-head); font-size: 0.62rem; font-weight: 600; letter-spacing: 0.07em; text-transform: uppercase; }
  .owned-badge.want { background: rgba(212,168,67,0.15); color: #e8c060; border: 1px solid rgba(212,168,67,0.3); font-family: var(--font-head); font-size: 0.62rem; font-weight: 600; letter-spacing: 0.07em; text-transform: uppercase; }
  .condition-pip {
    display: inline-block; width: 8px; height: 8px; border-radius: 50%;
    margin-right: 0.25rem;
  }
  .cond-9, .cond-10 { background: #2ecc71; }
  .cond-7, .cond-8  { background: #f1c40f; }
  .cond-5, .cond-6  { background: #e67e22; }
  .cond-low         { background: #e74c3c; }

  .table-pagination {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0.75rem 1rem; border-top: 1px solid var(--border);
    font-size: 0.8rem; color: var(--text-dim);
  }
  .pagination-btns { display: flex; gap: 0.35rem; }
  .page-btn {
    width: 30px; height: 30px; border-radius: 6px; border: 1px solid var(--border);
    background: var(--surface); color: var(--text-mid); cursor: pointer;
    font-size: 0.8rem; font-family: var(--font-body); transition: all 0.15s;
    display: flex; align-items: center; justify-content: center;
  }
  .page-btn:hover { border-color: var(--accent); color: var(--accent); }
  .page-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
  .page-btn:disabled { opacity: 0.3; cursor: default; }

  /* â”€â”€ Item Detail Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200;
    display: flex; align-items: center; justify-content: center; padding: 1rem;
    opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
    width: 100%; max-width: 680px; max-height: 90vh; overflow-y: auto;
    transform: translateY(20px); transition: transform 0.2s;
  }
  #wizard-modal .modal {
    overflow: hidden; display: flex; flex-direction: column;
    transition: background 0.3s, border-color 0.3s;
  }
  /* Wizard tab themes */
  #wizard-modal .modal.wiz-collection {
    background: #1a0e08;
    border-color: rgba(232,64,28,0.4);
  }
  #wizard-modal .modal.wiz-collection .modal-header {
    background: #1a0e08;
    border-bottom-color: rgba(232,64,28,0.25);
  }
  #wizard-modal .modal.wiz-collection #wizard-progress { background: var(--accent); }
  #wizard-modal .modal.wiz-collection .modal-footer {
    background: #1a0e08;
    border-top-color: rgba(232,64,28,0.25);
  }
  #wizard-modal .modal.wiz-want {
    background: #08101a;
    border-color: rgba(41,128,185,0.4);
  }
  #wizard-modal .modal.wiz-want .modal-header {
    background: #08101a;
    border-bottom-color: rgba(41,128,185,0.25);
  }
  #wizard-modal .modal.wiz-want #wizard-progress { background: #2980b9; }
  #wizard-modal .modal.wiz-want .modal-footer {
    background: #08101a;
    border-top-color: rgba(41,128,185,0.25);
  }
  #wizard-modal .modal.wiz-sold {
    background: #081a0e;
    border-color: rgba(46,204,113,0.4);
  }
  #wizard-modal .modal.wiz-sold .modal-header {
    background: #081a0e;
    border-bottom-color: rgba(46,204,113,0.25);
  }
  #wizard-modal .modal.wiz-sold #wizard-progress { background: #2ecc71; }
  #wizard-modal .modal.wiz-sold .modal-footer {
    background: #081a0e;
    border-top-color: rgba(46,204,113,0.25);
  }
  .modal-overlay.open .modal { transform: translateY(0); }

  .modal-header {
    display: flex; align-items: flex-start; justify-content: space-between;
    padding: 1.5rem 1.5rem 1rem; border-bottom: 1px solid var(--border);
    position: sticky; top: 0; background: var(--surface); z-index: 1;
  }
  .modal-item-num { font-family: var(--font-mono); font-size: 0.8rem; color: var(--accent2); margin-bottom: 0.25rem; }
  .modal-title { font-size: 1.1rem; font-weight: 600; }
  .modal-subtitle { font-size: 0.82rem; color: var(--text-dim); margin-top: 0.2rem; }
  .btn-close {
    width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border);
    background: var(--surface2); color: var(--text-dim); cursor: pointer;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    font-size: 1rem; transition: all 0.15s;
  }
  .btn-close:hover { border-color: var(--accent); color: var(--accent); }

  .modal-body { padding: 1.25rem 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }

  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
  @media (max-width: 480px) { .info-grid { grid-template-columns: 1fr; } }
  .info-field { }
  .info-field label { font-size: 0.68rem; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--text-dim); display: block; margin-bottom: 0.25rem; }
  .info-field .info-val { font-size: 0.875rem; color: var(--text); }
  .info-field a { color: var(--accent2); text-decoration: none; font-size: 0.8rem; }
  .info-field a:hover { text-decoration: underline; }

  .desc-block { background: var(--surface2); border-radius: 8px; padding: 0.85rem;
    font-size: 0.82rem; line-height: 1.6; color: var(--text-mid); }

  /* Form fields */
  .form-section-title {
    font-size: 0.68rem; letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--accent); font-weight: 600; padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(232,64,28,0.2);
  }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
  @media (max-width: 480px) { .form-grid { grid-template-columns: 1fr; } }
  .form-field label { font-size: 0.72rem; letter-spacing: 0.08em; text-transform: uppercase;
    color: var(--text-dim); display: block; margin-bottom: 0.3rem; }
  .form-field input, .form-field select, .form-field textarea {
    width: 100%; background: var(--bg); border: 1px solid var(--border);
    border-radius: 7px; padding: 0.55rem 0.75rem; color: var(--text);
    font-family: var(--font-body); font-size: 0.875rem; outline: none;
    transition: border-color 0.15s;
  }
  .form-field input:focus, .form-field select:focus, .form-field textarea:focus { border-color: var(--accent); }
  .form-field textarea { resize: vertical; min-height: 70px; }
  .form-field.full { grid-column: 1 / -1; }

  /* Toggle switch */
  .toggle-row { display: flex; align-items: center; gap: 0.75rem; }
  .toggle-label { font-size: 0.875rem; }
  .toggle {
    position: relative; width: 40px; height: 22px;
    background: var(--border); border-radius: 11px; cursor: pointer;
    transition: background 0.2s; flex-shrink: 0;
  }
  .toggle.on { background: var(--green); }
  .toggle::after {
    content: ''; position: absolute; top: 3px; left: 3px;
    width: 16px; height: 16px; border-radius: 50%; background: white;
    transition: transform 0.2s;
  }
  .toggle.on::after { transform: translateX(18px); }

  /* Condition slider */
  .condition-display { display: flex; align-items: center; gap: 0.75rem; }
  .condition-num { font-family: var(--font-head); font-size: 2rem; width: 2rem; color: var(--accent2); }
  input[type=range] { flex: 1; accent-color: var(--accent); }

  /* Price row */
  .price-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; }
  @media (max-width: 480px) { .price-row { grid-template-columns: 1fr; } }

  .modal-footer {
    display: flex; gap: 0.75rem; justify-content: flex-end;
    padding: 1rem 1.5rem; border-top: 1px solid var(--border);
    position: sticky; bottom: 0; background: var(--surface);
  }
  .btn { padding: 0.55rem 1.15rem; border-radius: 6px; font-family: var(--font-head);
    font-size: 0.82rem; font-weight: 600; letter-spacing: 0.07em; text-transform: uppercase;
    cursor: pointer; transition: all 0.15s; border: none; touch-action: manipulation; }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: #d63518; }
  .btn-secondary { background: var(--surface2); color: var(--text-mid); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--accent); color: var(--text); }

  /* â”€â”€ Reports Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .report-controls { display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; }
  .btn-export {
    display: flex; align-items: center; gap: 0.5rem;
    padding: 0.55rem 1rem; border-radius: 8px; border: 1px solid var(--border);
    background: var(--surface); color: var(--text-mid); font-family: var(--font-body);
    font-size: 0.85rem; cursor: pointer; transition: all 0.15s;
  }
  .btn-export:hover { border-color: var(--accent2); color: var(--accent2); }

  .report-table { width: 100%; border-collapse: collapse; }
  .report-table th {
    text-align: left; padding: 0.6rem 1rem; font-size: 0.7rem;
    letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim);
    background: var(--surface2); border-bottom: 1px solid var(--border);
  }
  .report-table td { padding: 0.65rem 1rem; border-bottom: 1px solid var(--border); font-size: 0.83rem; }
  .report-table tr:last-child td { border-bottom: none; }

  /* â”€â”€ Loading & Empty States â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .loading {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 3rem; gap: 1rem; color: var(--text-dim);
  }
  .spinner {
    width: 32px; height: 32px; border: 3px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner { will-change: transform; }
  .modal { will-change: transform; }
  .nav-item, .btn { will-change: opacity; }

  .empty-state { text-align: center; padding: 3rem; color: var(--text-dim); }
  .empty-state .empty-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
  .empty-state p { font-size: 0.875rem; }

  /* â”€â”€ Setup Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #setup-screen {
    display: none; flex-direction: column; align-items: center; justify-content: center;
    min-height: 100vh; padding: 2rem;
  }
  #setup-screen.active { display: flex; }
  .setup-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
    padding: 2.5rem; width: 100%; max-width: 500px;
  }
  .setup-card h2 { font-family: var(--font-head); font-size: 1.8rem; margin-bottom: 0.5rem; }
  .setup-card p { color: var(--text-dim); font-size: 0.875rem; margin-bottom: 1.5rem; line-height: 1.6; }
  .setup-step { display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 1rem; }
  .setup-num {
    width: 24px; height: 24px; border-radius: 50%; background: var(--accent);
    color: white; font-size: 0.75rem; font-weight: 700; display: flex;
    align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px;
  }
  .setup-step p { color: var(--text-mid); font-size: 0.85rem; margin: 0; }
  .input-group { margin-top: 1.25rem; }
  .input-group label { display: block; font-size: 0.72rem; letter-spacing: 0.08em;
    text-transform: uppercase; color: var(--text-dim); margin-bottom: 0.4rem; }
  .input-group input {
    width: 100%; background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; padding: 0.65rem 0.9rem; color: var(--text);
    font-family: var(--font-mono); font-size: 0.85rem; outline: none; transition: border-color 0.15s;
  }
  .input-group input:focus { border-color: var(--accent); }

  /* â”€â”€ Mobile nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .mobile-nav {
    display: none; background: var(--surface); border-top: 1px solid var(--border);
    padding: 0.5rem 0; flex-shrink: 0;
  }
  .mobile-nav-items { display: flex; justify-content: space-around; }
  .mobile-nav-item {
    display: flex; flex-direction: column; align-items: center; gap: 0.2rem;
    padding: 0.4rem 0.75rem; color: var(--text-dim); cursor: pointer;
    font-size: 0.62rem; border: none; background: none; font-family: var(--font-head); letter-spacing: 0.06em; text-transform: uppercase;
    transition: color 0.15s; border-radius: 8px;
  }
  .mobile-nav-item.active { color: var(--accent); }
  .mobile-add-btn { color: var(--text-dim) !important; padding-top: 0 !important; }

  @media (max-width: 640px) {
    /* Layout */
    .sidebar { display: none; }
    .mobile-nav { display: block; }
    .app-layout { padding-bottom: 64px; } /* room for bottom nav */
    .main { padding: 0.75rem 0.75rem 1rem; }
    .stats-grid { grid-template-columns: 1fr 1fr; }

    /* Browse â€” switch from table to cards on mobile */
    .browse-table-wrap { overflow-x: visible !important; }
    .item-table { display: none; }
    #browse-cards { display: flex; flex-direction: column; gap: 0.5rem; }
    .browse-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: background 0.15s;
    }
    .browse-card:active { background: var(--surface2); }
    .browse-card-left { flex: 1; min-width: 0; }
    .browse-card-num { font-family: var(--font-head); font-size: 1.1rem; color: var(--accent); }
    .browse-card-name { font-size: 0.85rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .browse-card-sub { font-size: 0.72rem; color: var(--text-dim); margin-top: 0.15rem; }
    .browse-card-right { display: flex; flex-direction: column; align-items: flex-end; gap: 0.25rem; flex-shrink: 0; }

    /* Filters bar on mobile */
    .filter-bar { gap: 0.4rem; flex-wrap: wrap; }
    .filter-bar input { font-size: 16px !important; } /* prevent iOS zoom */

    /* Wizard modal â€” full screen on mobile */
    .wizard-modal-inner {
      width: 100% !important;
      max-width: 100% !important;
      height: 100dvh !important;
      max-height: 100dvh !important;
      border-radius: 0 !important;
      margin: 0 !important;
    }

    /* Photo grid â€” single column on small screens */
    #photo-grid { grid-template-columns: 1fr 1fr 1fr !important; gap: 0.4rem !important; }

    /* Buttons â€” bigger tap targets */
    .btn { min-height: 44px; }
    .page-btn { min-width: 40px; min-height: 40px; }

    /* Modal full screen */
    .modal-inner { width: 100% !important; max-width: 100% !important;
      margin: 0 !important; border-radius: 0 !important;
      max-height: 100dvh !important; height: 100dvh !important; }

    /* Fix safe areas for notched phones */
    .mobile-nav {
      padding-bottom: max(0.5rem, env(safe-area-inset-bottom));
      height: calc(60px + env(safe-area-inset-bottom));
    }
    .app-layout { padding-bottom: calc(60px + env(safe-area-inset-bottom)); }
    .main {
      padding-top: 0.75rem;
      padding-left: max(0.75rem, env(safe-area-inset-left));
      padding-right: max(0.75rem, env(safe-area-inset-right));
    }
    /* Bigger stat cards on mobile */
    .stat-card { padding: 1rem; }
    .stat-val { font-size: 1.6rem; }
    /* Search bar full width */
    #search-input { width: 100%; }
    /* Dashboard recent items as cards */
    .two-col { gap: 0.75rem; }
  }

  /* â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tag {
    display: inline-block; padding: 0.15rem 0.5rem; border-radius: 4px;
    font-family: var(--font-head); font-size: 0.62rem; letter-spacing: 0.06em; text-transform: uppercase; font-weight: 500; background: var(--surface2); color: var(--text-dim);
  }
  .market-val { font-family: var(--font-mono); color: var(--accent2); }
  .dash-row-hover:hover { background: var(--surface2); }
  .eph-tab {
    padding: 0.4rem 0.9rem; border-radius: 20px; border: 1.5px solid var(--border);
    background: var(--surface2); color: var(--text-dim); cursor: pointer;
    font-family: var(--font-body); font-size: 0.82rem; transition: all 0.15s;
  }
  .eph-tab.active { border-color: #e67e22; color: #e67e22; background: rgba(230,126,34,0.12); }
  .eph-row { display:flex;align-items:center;gap:0.75rem;padding:0.55rem 0;border-bottom:1px solid var(--border);cursor:pointer; }
  .eph-row:hover { background: var(--surface2); }
  .eph-title { font-size:0.9rem;font-weight:500;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap }
  .eph-year  { font-size:0.75rem;color:var(--text-dim);flex-shrink:0 }
  .eph-val   { font-size:0.78rem;color:var(--accent2);font-family:var(--font-mono);flex-shrink:0 }
  .text-dim { color: var(--text-dim); }
  .text-accent { color: var(--accent); }
  .mt-sm { margin-top: 0.5rem; }
  .link-btn {
    background: none; border: none; color: var(--accent2); cursor: pointer;
    font-size: 0.8rem; font-family: var(--font-body); text-decoration: underline; padding: 0;
  }

  /* â”€â”€ Photo Source Picker (camera vs library) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #photo-picker-sheet {
    position: fixed; inset: 0; z-index: 9500;
    background: rgba(0,0,0,0.55);
    display: none; align-items: flex-end; justify-content: center;
    padding-bottom: env(safe-area-inset-bottom, 0px);
  }
  #photo-picker-sheet.open { display: flex; }
  #photo-picker-inner {
    background: var(--surface);
    border-radius: 18px 18px 0 0;
    border-top: 3px solid var(--accent);
    width: 100%; max-width: 480px;
    padding: 1.25rem 1rem 1.5rem;
    display: flex; flex-direction: column; gap: 0.6rem;
  }
  .picker-btn {
    width: 100%; padding: 0.9rem 1rem;
    border-radius: 12px; border: 1.5px solid var(--border);
    background: var(--surface2); color: var(--text);
    font-family: var(--font-head); font-size: 0.92rem;
    font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase;
    cursor: pointer; display: flex; align-items: center;
    gap: 0.75rem; transition: background 0.15s;
  }
  .picker-btn:hover { background: rgba(224,64,40,0.08); border-color: var(--accent); }
  .picker-btn .picker-icon { font-size: 1.4rem; line-height: 1; }

  /* â”€â”€ Identify Item Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #identify-modal {
    position: fixed; inset: 0; z-index: 8000;
    background: rgba(8,10,18,0.88);
    display: none; align-items: center; justify-content: center;
    padding: 1rem;
  }
  #identify-modal.open { display: flex; }
  #identify-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-top: 3px solid var(--accent);
    border-radius: 14px;
    width: 100%; max-width: 520px;
    max-height: 90vh; overflow-y: auto;
    padding: 1.5rem;
    display: flex; flex-direction: column; gap: 1rem;
  }
  .identify-drop {
    border: 2px dashed var(--border);
    border-radius: 10px;
    padding: 2rem 1rem;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    background: var(--surface2);
    position: relative;
  }
  .identify-drop:hover, .identify-drop.dragover {
    border-color: var(--accent);
    background: rgba(224,64,40,0.06);
  }
  .identify-drop input[type=file] {
    position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
  }
  .identify-preview {
    width: 100%; border-radius: 8px; max-height: 260px;
    object-fit: contain; background: #000; display: none;
  }
  .identify-candidate {
    display: flex; align-items: center; gap: 0.75rem;
    padding: 0.75rem; border-radius: 8px;
    border: 2px solid var(--border);
    background: var(--surface2);
    cursor: pointer; transition: all 0.15s;
  }
  .identify-candidate:hover { border-color: var(--accent); background: rgba(224,64,40,0.07); }
  .identify-candidate.selected { border-color: var(--accent); background: rgba(224,64,40,0.12); }
  .identify-num {
    font-family: var(--font-mono); font-size: 1.1rem; font-weight: 700;
    color: var(--gold); min-width: 64px;
  }
  .identify-desc { flex: 1; font-size: 0.82rem; color: var(--text-mid); line-height: 1.4; }
  .identify-conf {
    font-family: var(--font-head); font-size: 0.62rem; font-weight: 600;
    letter-spacing: 0.1em; text-transform: uppercase;
    padding: 2px 7px; border-radius: 4px;
  }
  .identify-conf.high { background: rgba(58,158,104,0.2); color: #4dc880; }
  .identify-conf.med  { background: rgba(212,168,67,0.2); color: #e8c060; }
  .identify-conf.low  { background: rgba(224,64,40,0.15); color: #f08070; }
  .gemini-setup {
    background: rgba(212,168,67,0.08);
    border: 1px solid rgba(212,168,67,0.25);
    border-radius: 8px; padding: 1rem;
    font-size: 0.82rem; color: var(--text-mid); line-height: 1.6;
  }
</style>
</head>
<body>

<!-- â•â• AUTH SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-screen">
  <div class="auth-logo" style="line-height:1.1">
    <div style="font-family:var(--font-head);font-size:2.4rem;font-weight:700;color:var(--cream);letter-spacing:0.07em;text-transform:uppercase">My <span style="color:var(--accent)">Collection</span> App</div>
    <div style="font-size:0.62rem;letter-spacing:0.22em;color:var(--text-dim);margin-top:7px;text-transform:uppercase;font-family:var(--font-head);font-weight:400">Postwar Lionel Collector&rsquo;s Inventory</div>
  </div>
  <div class="auth-sub">Postwar Lionel Collector's Inventory</div>
  <div style="display:flex;flex-direction:column;gap:0.6rem;margin:1.25rem 0;max-width:340px;text-align:left">
    <div style="display:flex;align-items:flex-start;gap:0.75rem;background:rgba(200,16,46,0.06);border-radius:10px;padding:0.75rem 1rem">
      <span style="font-size:1.3rem;flex-shrink:0">ðŸ“‹</span>
      <div style="font-size:0.88rem;color:var(--text-mid);line-height:1.5"><strong style="color:#fff">Catalog every item you own</strong><br>Condition, price paid, box, photos â€” all in one place.</div>
    </div>
    <div style="display:flex;align-items:flex-start;gap:0.75rem;background:rgba(200,16,46,0.06);border-radius:10px;padding:0.75rem 1rem">
      <span style="font-size:1.3rem;flex-shrink:0">ðŸ“¸</span>
      <div style="font-size:0.88rem;color:var(--text-mid);line-height:1.5"><strong style="color:#fff">Store photos to Google Drive</strong><br>Every view, every box â€” organized automatically.</div>
    </div>
    <div style="display:flex;align-items:flex-start;gap:0.75rem;background:rgba(200,16,46,0.06);border-radius:10px;padding:0.75rem 1rem">
      <span style="font-size:1.3rem;flex-shrink:0">ðŸš‚</span>
      <div style="font-size:0.88rem;color:var(--text-mid);line-height:1.5"><strong style="color:#fff">Built for postwar Lionel</strong><br>Pre-loaded master catalog of every item 1945â€“1969.</div>
    </div>
  </div>
  <div class="auth-card">
    <h2>Sign in to get started</h2>
    <p>Your collection is stored in your own Google account â€” private, secure, and accessible on any device.</p>
    <button class="btn-google" onclick="handleSignIn()">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
      </svg>
      Continue with Google
    </button>
    <p class="auth-note">Your personal collection data is stored in your own Google Sheet. The master inventory is shared read-only.</p>
  </div>
</div>

<!-- â•â• FIRST-TIME SETUP SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="setup-screen" style="display:none!important">
  <div class="setup-card">
    <h2>Welcome!</h2>
    <p>One-time setup â€” just two steps to connect your inventory.</p>
    <div class="setup-step">
      <div class="setup-num">1</div>
      <p>Enter the Master Inventory Sheet ID (get this from whoever shared the app with you).</p>
    </div>
    <div class="setup-step">
      <div class="setup-num">2</div>
      <p>Create a blank Google Sheet for your personal collection, then paste its ID below. Go to <a href="https://sheets.google.com" target="_blank" style="color:var(--accent2)">sheets.google.com</a>, create a blank sheet, name it "My Collection App", and copy the ID from the URL.</p>
    </div>
    <div class="input-group">
      <label>Master Sheet ID</label>
      <input id="master-sheet-input" type="text" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgVE2upms" />
    </div>
    <div class="input-group" style="margin-top:0.75rem">
      <label>Your Personal Collection Sheet ID</label>
      <input id="personal-sheet-input" type="text" placeholder="Paste your blank sheet ID here" />
    </div>
    <div style="margin-top:1.25rem">
      <button class="btn btn-primary" style="width:100%" onclick="completeSetup()">Set Up My Collection</button>
    </div>
  </div>
</div>

<!-- â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">

  <!-- Header -->
  <header class="header">
    <div class="header-logo">
      <div style="font-family:var(--font-head);font-size:1.4rem;font-weight:700;color:var(--cream);letter-spacing:0.06em;text-transform:uppercase;line-height:1">My <span style="color:var(--accent)">Collection</span> App</div>
      <div style="font-size:0.58rem;letter-spacing:0.2em;color:var(--text-dim);margin-top:4px;text-transform:uppercase;font-family:var(--font-head);font-weight:400">Postwar Lionel &nbsp;Â·&nbsp; 1945â€“1969</div>
    </div>

    <div class="header-right">
      <div class="user-chip">
        <div class="user-avatar" id="user-avatar">?</div>
        <span id="user-name">Loadingâ€¦</span>
      </div>
      <button class="btn-sign-out" onclick="handleSignOut()">Sign out</button>
    </div>
  </header>

  <div class="app-body">

    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-logo-wrap">
        <div style="font-family:var(--font-head);font-size:1.3rem;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;color:var(--cream);line-height:1">My <span style="color:var(--accent)">Collection</span> App</div>
        <div style="font-family:var(--font-head);font-size:0.55rem;font-weight:400;letter-spacing:0.22em;text-transform:uppercase;color:var(--text-dim);margin-top:5px">Postwar &nbsp;Â·&nbsp; 1945â€“1969</div>
      </div>
      <div class="nav-section">
        <div class="nav-label">Overview</div>
        <button class="nav-item active" onclick="showPage('dashboard', this)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
          Dashboard
        </button>
      </div>
      <div class="nav-section">
        <div class="nav-label">Inventory</div>
        <button class="nav-item" onclick="showPage('browse', this); resetFilters(); renderBrowse();">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
          Postwar Item List
          <span class="nav-badge" id="nav-total">â€”</span>
        </button>
        <button class="nav-item" onclick="showPage('browse', this); filterOwned()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
          My Collection
          <span class="nav-badge green" id="nav-owned">â€”</span>
        </button>
        <button class="nav-item" id="nav-quickentry-btn" onclick="showPage('quickentry', this); buildQuickEntryList();">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          Quick Entry List
          <span class="nav-badge" id="nav-qe-count" style="background:#27ae60">â€”</span>
        </button>

        <button class="nav-item" onclick="showPage('want', this); buildWantPage();">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21.593c-5.63-5.539-11-10.297-11-14.402 0-3.791 3.068-5.191 5.281-5.191 1.312 0 4.151.501 5.719 4.457 1.59-3.968 4.464-4.447 5.726-4.447 2.54 0 5.274 1.621 5.274 5.181 0 4.069-5.136 8.625-11 14.402z"/></svg>
          Want List
          <span class="nav-badge" id="nav-wanted2" style="background:var(--accent2);color:#000">â€”</span>
        </button>
        <button class="nav-item" onclick="showPage('sold', this)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          Sold Items
          <span class="nav-badge" id="nav-sold" style="background:#9b59b6">â€”</span>
        </button>
        <button class="nav-item" id="nav-photos-btn" onclick="showPage('photos', this); buildPhotosPage();">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 0 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
          View Pictures
        </button>
      </div>
      <div class="nav-section">
        <div class="nav-label">Reports</div>
        <button class="nav-item" onclick="showPage('reports', this)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
          Reports
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main" id="main-content">

      <!-- â”€â”€ Dashboard â”€â”€ -->
      <script>function startWizardFor(tab){if(typeof openWizard==="function"){openWizard(tab);}else{setTimeout(function(){startWizardFor(tab);},100);}}
// Passive scroll listeners for mobile performance
document.addEventListener('touchstart', function(){}, {passive: true});
document.addEventListener('touchmove', function(){}, {passive: true});
</script>
      <div class="page active" id="page-dashboard">

        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.75rem">
          <div class="page-title"><span id="dash-greeting"></span></div>
          <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
            <button class="btn" onclick="startWizardFor('collection')" style="display:flex;align-items:center;gap:0.4rem;font-size:0.85rem;padding:0.6rem 1rem;border:1.5px solid var(--accent);color:var(--accent);background:rgba(232,64,28,0.12);font-weight:600">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add to Collection
            </button>
            <button class="btn" onclick="startWizardFor('want')" style="display:flex;align-items:center;gap:0.4rem;font-size:0.85rem;padding:0.6rem 1rem;border:1.5px solid #2980b9;color:#2980b9;background:rgba(41,128,185,0.12);font-weight:600">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 21.593c-5.63-5.539-11-10.297-11-14.402 0-3.791 3.068-5.191 5.281-5.191 1.312 0 4.151.501 5.719 4.457 1.59-3.968 4.464-4.447 5.726-4.447 2.54 0 5.274 1.621 5.274 5.181 0 4.069-5.136 8.625-11 14.402z"/></svg>
              Want List
            </button>
            <button class="btn" onclick="startWizardFor('sold')" style="display:flex;align-items:center;gap:0.4rem;font-size:0.85rem;padding:0.6rem 1rem;border:1.5px solid #2ecc71;color:#2ecc71;background:rgba(46,204,113,0.12);font-weight:600">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
              Sell Item
            </button>
          </div>
        </div>

        <div class="stats-grid" id="stats-grid">
          <div class="stat-card" style="--card-accent: var(--green-light,#3aad70)">
            <div class="stat-label">Items I Own</div>
            <div class="stat-value" id="stat-owned">â€”</div>
            <div class="stat-sub" id="stat-owned-pct">â€” of catalog</div>
          </div>
          <div class="stat-card" style="--card-accent: var(--gold,#c9922a)">
            <div class="stat-label">Collection Value</div>
            <div class="stat-value" id="stat-value">â€”</div>
            <div class="stat-sub">per user</div>
          </div>
          <div class="stat-card" style="--card-accent: #8b5cf6">
            <div class="stat-label">Est. Market Value</div>
            <div class="stat-value" id="stat-market-value">â€”</div>
            <div class="stat-sub">est. value mined from auction sites</div>
          </div>
        </div>

        <div class="two-col">
          <div class="panel">
            <div class="section-title">Recent Additions</div>
            <div id="recent-list">
              <div style="padding:1rem 0"><div style="font-size:2rem;margin-bottom:0.5rem">ðŸ‘‹</div><div style="font-weight:600;font-size:0.95rem;margin-bottom:0.4rem">Welcome to My Collection App!</div><div style="font-size:0.82rem;color:var(--text-dim);line-height:1.6;margin-bottom:1rem">Start building your collection record. Tap Add Item to log your first piece.</div><button onclick="startWizardFor('collection')" style="width:100%;padding:0.75rem;border-radius:10px;border:none;background:var(--accent);color:white;font-family:var(--font-body);font-size:0.95rem;font-weight:600;cursor:pointer">+ Add My First Item</button></div>
            </div>
          </div>
          <div class="panel">
            <div class="section-title">Top Want List Items</div>
            <div id="want-preview">
              <div class="loading"><div class="spinner"></div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Quick Entry List â”€â”€ -->
      <div class="page" id="page-quickentry">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.75rem;margin-bottom:1rem">
          <div>
            <div class="page-title" style="margin-bottom:0.15rem">âš¡ Quick Entry List</div>
            <div style="font-size:0.82rem;color:var(--text-dim)">Items you logged quickly â€” tap any one to fill in the details.</div>
          </div>
          <button onclick="startWizardFor('collection')" class="btn" style="display:flex;align-items:center;gap:0.4rem;border:1.5px solid #27ae60;color:#27ae60;background:rgba(39,174,96,0.1);font-weight:600;font-size:0.85rem;padding:0.5rem 0.9rem">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
            Add Item
          </button>
        </div>
        <div id="qe-list-container">
          <div class="empty-state"><div class="spinner"></div></div>
        </div>
      </div>

      <!-- â”€â”€ Browse â”€â”€ -->
      <div class="page" id="page-browse">
        <div class="page-title" style="display:flex;align-items:center;justify-content:space-between;gap:0.5rem">
          <span>Master Catalog</span>
          <div style="display:flex;gap:0.5rem;align-items:center">
            <button class="btn" onclick="openIdentify(null)" style="display:flex;align-items:center;gap:0.4rem;border:1.5px solid var(--gold);color:var(--gold);background:rgba(212,168,67,0.1);font-weight:600;font-size:0.82rem;padding:0.5rem 0.9rem" title="Identify an unlabeled item by photo">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 0 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
              Identify
            </button>
            <button class="btn" onclick="startWizardFor('collection')" style="display:flex;align-items:center;gap:0.4rem;border:1.5px solid var(--accent);color:var(--accent);background:rgba(232,64,28,0.12);font-weight:600;font-size:0.85rem;padding:0.5rem 0.9rem">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
              Add to Collection
            </button>
          </div>
        </div>

        <div class="filter-bar">
          <select class="filter-select" id="filter-type" onchange="applyFilters()">
            <option value="">All Types</option>
          </select>

          <select class="filter-select" id="filter-road" onchange="applyFilters()">
            <option value="">All Roads</option>
          </select>
          <div style="display:flex;align-items:center;gap:0.4rem;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.35rem 0.65rem;flex:1;max-width:320px">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            <input id="browse-search" type="text" placeholder="Search item #, road, descriptionâ€¦" oninput="onPageSearch(this.value,'browse')" style="border:none;background:none;color:var(--text);font-family:var(--font-body);font-size:0.85rem;outline:none;width:100%">
          </div>
          <span style="margin-left:auto;font-size:0.8rem;color:var(--text-dim)" id="result-count"></span>
        </div>

        <div class="table-wrap" style="max-height:calc(100vh - 220px);overflow-y:auto">
          <table class="item-table">
            <thead>
              <tr>
                <th>Item #</th>
                <th>Type</th>
                <th>Road / Name</th>
                <th>Var.</th>
                <th>Var. Descr.</th>
                <th>Year</th>
                <th>Owned</th>
                <th>Cond.</th>
                <th>Market Value</th>
              </tr>
            </thead>
            <tbody id="browse-tbody"></tbody>
          </table>
          <div id="browse-cards" style="display:none"></div>
          <div class="table-pagination">
            <span id="page-info"></span>
            <div class="pagination-btns" id="pagination-btns"></div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Sold â”€â”€ -->
      <div class="page" id="page-sold">
        <div class="page-title" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem">
          <span>Items I've Sold</span>
          <button class="btn" onclick="startWizardFor('sold')" style="display:flex;align-items:center;gap:0.4rem;border:1.5px solid #2ecc71;color:#2ecc71;background:rgba(46,204,113,0.12);font-weight:600;font-size:0.85rem;padding:0.5rem 0.9rem">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            Record a Sale
          </button>
        </div>
        <!-- Sold Summary Panel -->
        <div id="sold-summary-wrap" style="margin-bottom:0.85rem">
          <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap">
            <div id="sold-summary-box" style="display:flex;gap:1.25rem;background:var(--surface);border:1px solid rgba(46,204,113,0.35);border-radius:12px;padding:0.75rem 1.25rem;align-items:center">
              <div style="text-align:center">
                <div style="font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-dim);margin-bottom:2px">Items Sold</div>
                <div id="sold-stat-count" style="font-family:var(--font-head);font-size:1.6rem;color:#2ecc71;line-height:1">â€”</div>
              </div>
              <div style="width:1px;height:36px;background:var(--border)"></div>
              <div style="text-align:center">
                <div style="font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-dim);margin-bottom:2px">Total Sold For</div>
                <div id="sold-stat-total" style="font-family:var(--font-head);font-size:1.6rem;color:#2ecc71;line-height:1">â€”</div>
              </div>
            </div>
            <button id="sold-summary-toggle" onclick="toggleSoldSummary()" style="font-size:0.72rem;color:var(--text-dim);background:none;border:1px solid var(--border);border-radius:6px;padding:0.3rem 0.6rem;cursor:pointer;white-space:nowrap">Hide Summary</button>
          </div>
        </div>

        <div style="margin-bottom:0.75rem">
          <div style="display:flex;align-items:center;gap:0.4rem;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.35rem 0.65rem;flex:1;max-width:320px">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            <input id="sold-search" type="text" placeholder="Search item #, road, typeâ€¦" oninput="onPageSearch(this.value,'sold')" style="border:none;background:none;color:var(--text);font-family:var(--font-body);font-size:0.85rem;outline:none;width:100%">
          </div>
        </div>
        <div id="sold-cards" style="display:none;flex-direction:column;gap:0.6rem"></div>
        <div class="table-wrap" id="sold-table-wrap">
          <table class="item-table">
            <thead>
              <tr>
                <th>Item #</th>
                <th>Type</th>
                <th>Road / Name</th>
                <th>Variation</th>
                <th>Condition</th>
                <th>Sale Price</th>
                <th>Date Sold</th>
              </tr>
            </thead>
            <tbody id="sold-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- â”€â”€ Want List â”€â”€ -->
      <div class="page" id="page-want">
        <div class="page-title">Want List</div>
        <div style="display:flex;justify-content:flex-end;margin-bottom:0.75rem">
          <button class="btn btn-primary" onclick="startWizardFor('want')" style="display:flex;align-items:center;gap:0.4rem">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
            Add to Want List
          </button>
        </div>
        <div style="margin-bottom:0.75rem">
          <div style="display:flex;align-items:center;gap:0.4rem;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.35rem 0.65rem;flex:1;max-width:320px">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            <input id="want-search" type="text" placeholder="Search item #, road, notesâ€¦" oninput="onPageSearch(this.value,'want')" style="border:none;background:none;color:var(--text);font-family:var(--font-body);font-size:0.85rem;outline:none;width:100%">
          </div>
        </div>
        <div id="want-cards" style="display:flex;flex-direction:column;gap:0.6rem"></div>
        <div class="table-wrap" style="margin-top:0">
          <table class="item-table" id="want-table">
            <thead>
              <tr>
                <th>Item #</th>
                <th>Road / Name</th>
                <th>Var.</th>
                <th>Var. Description</th>
                <th>Priority</th>
                <th>Est. Price</th>
              </tr>
            </thead>
            <tbody id="want-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- â”€â”€ Reports â”€â”€ -->
      <!-- â”€â”€ Ephemera â”€â”€ -->
      <div class="page" id="page-reports">
        <div class="page-title">Reports</div>

        <div class="report-controls">
          <select class="filter-select" id="report-type" onchange="buildReport()">
            <option value="wantlist">Want List</option>
            <option value="collection">Full Collection</option>
            <option value="value">Value Summary by Category</option>
            <option value="missing-box">Owned â€” Missing Box</option>
          </select>
          <button class="btn-export" onclick="exportReport()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export CSV
          </button>
          <button class="btn-export" onclick="window.print()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6,9 6,2 18,2 18,9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
            Print
          </button>
        </div>

        <div class="table-wrap" style="margin-top:0">
          <table class="report-table">
            <thead id="report-thead"></thead>
            <tbody id="report-tbody"></tbody>
          </table>
        </div>
      </div>

    </main>
  </div>

  <!-- Mobile nav -->
  <nav class="mobile-nav">
    <div class="mobile-nav-items">
      <button class="mobile-nav-item active" id="mnav-dashboard" onclick="showPage('dashboard', this)">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        Dashboard
      </button>
      <button class="mobile-nav-item" id="mnav-quickentry" onclick="showPage('quickentry', this); buildQuickEntryList();" style="position:relative">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span id="mnav-qe-badge" style="display:none;position:absolute;top:2px;right:4px;background:#27ae60;color:white;border-radius:50%;width:16px;height:16px;font-size:0.6rem;font-weight:700;align-items:center;justify-content:center"></span>
        <span>Quick Entry</span>
      </button>
      <button class="mobile-nav-item" id="mnav-browse" onclick="showPage('browse', this); resetFilters(); renderBrowse();">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        Browse
      </button>
      <button class="mobile-nav-item mobile-add-btn" onclick="startWizardFor(null)">
        <div style="width:44px;height:44px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:-8px;box-shadow:0 4px 12px rgba(232,64,28,0.5)">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
        </div>
        Add
      </button>
      <button class="mobile-nav-item" id="mnav-want" onclick="showPage('want', this); buildWantPage();">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21.593c-5.63-5.539-11-10.297-11-14.402 0-3.791 3.068-5.191 5.281-5.191 1.312 0 4.151.501 5.719 4.457 1.59-3.968 4.464-4.447 5.726-4.447 2.54 0 5.274 1.621 5.274 5.181 0 4.069-5.136 8.625-11 14.402z"/></svg>
        Want List
      </button>
      <button class="mobile-nav-item" id="mnav-photos" onclick="showPage('photos', this); buildPhotosPage();">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 0 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        Pictures
      </button>
      <button class="mobile-nav-item" id="mnav-sold" onclick="showPage('sold', this)">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        Sold
      </button>
    </div>
  </nav>
</div>

<!-- â•â• ITEM DETAIL MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="item-modal" onclick="closeModalOnOverlay(event)">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-item-num" id="modal-item-num"></div>
        <div class="modal-title" id="modal-title"></div>
        <div class="modal-subtitle" id="modal-subtitle"></div>
      </div>
      <button class="btn-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">

      <!-- Box-only prompt banner -->
      <div id="box-only-prompt" style="display:none;background:rgba(201,146,42,0.1);border:1px solid var(--accent2);border-radius:10px;padding:0.85rem 1rem;display:flex;align-items:center;justify-content:space-between;gap:1rem">
        <div>
          <div style="font-weight:600;font-size:0.875rem;color:var(--accent2)">ðŸ“¦ Box without item info</div>
          <div style="font-size:0.8rem;color:var(--text-mid);margin-top:0.2rem">This entry has a box but no item details. Want to add the item info?</div>
        </div>
        <button onclick="fillItemFromBoxRow()" class="btn btn-primary" style="font-size:0.8rem;padding:0.5rem 0.9rem;white-space:nowrap">Add Item Info</button>
      </div>

      <!-- Reference Info -->
      <div>
        <div class="section-title" style="margin-bottom:0.75rem">Reference Information</div>
        <div class="info-grid">
          <div class="info-field"><label>Item Type</label><div class="info-val" id="mi-type"></div></div>
          <div class="info-field"><label>Year Produced</label><div class="info-val" id="mi-year"></div></div>
          <div class="info-field"><label>Road Name</label><div class="info-val" id="mi-road"></div></div>
          <div class="info-field"><label>Variation</label><div class="info-val" id="mi-var"></div></div>
          <div class="info-field"><label>Est. Market Value</label><div class="info-val market-val" id="mi-market"></div></div>
          <div class="info-field"><label>COTT Reference</label><div class="info-val" id="mi-ref"></div></div>
        </div>
        <div id="mi-desc-wrap" style="margin-top:0.75rem">
          <div class="desc-block" id="mi-desc"></div>
        </div>
        <div id="mi-varDesc-wrap" style="margin-top:0.5rem;display:none">
          <div style="font-size:0.68rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-dim);margin-bottom:0.3rem">Variation Notes</div>
          <div class="desc-block" id="mi-varDesc"></div>
        </div>
      </div>

      <!-- Collection Form -->
      <div>
        <div class="form-section-title" style="margin-bottom:0.75rem">Your Collection Data</div>

        <div style="margin-bottom:0.85rem">
          <label style="font-size:0.72rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-dim);display:block;margin-bottom:0.4rem">Status</label>
          <div style="display:flex;gap:0.5rem">
            <button class="status-btn" id="status-want" onclick="setStatus('Want')" style="flex:1;padding:0.5rem;border-radius:7px;border:1px solid var(--border);background:var(--surface2);color:var(--text-mid);cursor:pointer;font-family:var(--font-body);font-size:0.85rem;transition:all 0.15s">Want</button>
            <button class="status-btn" id="status-owned" onclick="setStatus('Owned')" style="flex:1;padding:0.5rem;border-radius:7px;border:1px solid var(--border);background:var(--surface2);color:var(--text-mid);cursor:pointer;font-family:var(--font-body);font-size:0.85rem;transition:all 0.15s">Owned</button>
            <button class="status-btn" id="status-sold" onclick="setStatus('Sold')" style="flex:1;padding:0.5rem;border-radius:7px;border:1px solid var(--border);background:var(--surface2);color:var(--text-mid);cursor:pointer;font-family:var(--font-body);font-size:0.85rem;transition:all 0.15s">Sold</button>
          </div>
        </div>

        <div id="sold-fields" style="display:none;margin-bottom:0.75rem">
          <div class="price-row">
            <div class="form-field">
              <label>Sale Price ($)</label>
              <input type="number" id="fc-sale-price" placeholder="0.00" min="0" step="0.01">
            </div>
            <div class="form-field">
              <label>Date Sold</label>
              <input type="date" id="fc-date-sold">
            </div>
          </div>
        </div>
        <div id="want-fields" style="display:none;margin-bottom:0.75rem">
          <div class="form-grid">
            <div class="form-field">
              <label>Priority</label>
              <select id="fc-want-priority">
                <option value="High">High</option>
                <option value="Medium" selected>Medium</option>
                <option value="Low">Low</option>
              </select>
            </div>
            <div class="form-field">
              <label>Expected Price ($)</label>
              <input type="number" id="fc-want-price" placeholder="0.00" min="0" step="0.01">
            </div>
          </div>
          <div class="form-field full" style="margin-top:0.5rem">
            <label>Notes</label>
            <input type="text" id="fc-want-notes" placeholder="Why you want it, where to find itâ€¦">
          </div>
        </div>
        <div id="collection-form" style="display:none">
          <div class="form-grid">
            <div class="form-field">
              <label>Copy #</label>
              <select id="fc-copy">
                <option value="1">1</option><option value="2">2</option>
                <option value="3">3</option><option value="4">4</option><option value="5">5</option>
              </select>
            </div>
            <div class="form-field">
              <label>All Original?</label>
              <select id="fc-original">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
                <option value="Unknown">Unknown</option>
              </select>
            </div>
          </div>

          <div class="form-field" style="margin-top:0.75rem">
            <label>Condition (1â€“10)</label>
            <div class="condition-display">
              <div class="condition-num" id="cond-display">7</div>
              <input type="range" min="1" max="10" value="7" id="fc-condition" oninput="document.getElementById('cond-display').textContent=this.value">
            </div>
          </div>

          <div class="price-row" style="margin-top:0.75rem">
            <div class="form-field">
              <label>Item Only Price ($)</label>
              <input type="number" id="fc-price-item" placeholder="0.00" min="0" step="0.01">
            </div>
            <div class="form-field">
              <label>Box Only Price ($)</label>
              <input type="number" id="fc-price-box" placeholder="0.00" min="0" step="0.01">
            </div>
            <div class="form-field">
              <label>Item+Box Complete ($)</label>
              <input type="number" id="fc-price-complete" placeholder="0.00" min="0" step="0.01">
            </div>
          </div>

          <div class="form-grid" style="margin-top:0.75rem">
            <div class="form-field">
              <label>Has Box?</label>
              <select id="fc-has-box">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="form-field">
              <label>Box Condition (1â€“10)</label>
              <input type="number" id="fc-box-cond" min="1" max="10" placeholder="â€”">
            </div>
          </div>

          <div class="form-field full" style="margin-top:0.75rem">
            <label>Item Photo Link (Google Photos)</label>
            <input type="url" id="fc-photo-item" placeholder="https://photos.google.com/â€¦">
          </div>
          <div class="form-field full" style="margin-top:0.5rem">
            <label>Box Photo Link (Google Photos)</label>
            <input type="url" id="fc-photo-box" placeholder="https://photos.google.com/â€¦">
          </div>
          <div class="form-field full" style="margin-top:0.5rem">
            <label>Notes</label>
            <textarea id="fc-notes" placeholder="Any personal notes about this itemâ€¦"></textarea>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveItem()">Save to Collection</button>
    </div>
  </div>
</div>

<!-- â•â• SOLD MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="sold-modal" onclick="closeSoldModalOnOverlay(event)">
  <div class="modal" style="max-width:420px">
    <div class="modal-header">
      <div>
        <div class="modal-title">Mark as Sold?</div>
        <div class="modal-subtitle" id="sold-modal-subtitle"></div>
      </div>
      <button class="btn-close" onclick="closeSoldModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-field">
        <label>Sale Price ($)</label>
        <input type="number" id="sold-price" placeholder="0.00" min="0" step="0.01">
      </div>
      <div class="form-field" style="margin-top:0.75rem">
        <label>Date Sold</label>
        <input type="date" id="sold-date">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeSoldModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmSold()">Mark as Sold</button>
    </div>
  </div>
</div>


<!-- â•â• ADD ITEM WIZARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="wizard-modal" onclick="closeWizardOnOverlay(event)">
  <div class="modal" style="max-width:520px;height:580px;display:flex;flex-direction:column;overflow:hidden">
    <div class="modal-header">
      <div>
        <div class="modal-item-num" id="wizard-step-label"></div>
        <div class="modal-title" id="wizard-title"></div>
      </div>
      <button class="btn-close" onclick="closeWizard()">âœ•</button>
    </div>

    <!-- Progress bar -->
    <div style="padding:0 1.5rem;padding-top:0.75rem">
      <div style="background:var(--border);border-radius:4px;height:4px">
        <div id="wizard-progress" style="height:100%;border-radius:4px;background:var(--accent);transition:width 0.3s ease;width:0%"></div>
      </div>
    </div>

    <div class="modal-body" id="wizard-body" style="flex:1;overflow-y:auto;min-height:0">
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" id="wizard-back-btn" onclick="wizardBack()" style="display:none">â† Back</button>
      <button class="btn btn-secondary" onclick="closeWizard()">Cancel</button>
      <button class="btn btn-primary" id="wizard-next-btn" onclick="wizardNext()">Next â†’</button>
    </div>
  </div>
</div>

<!-- â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Replace with your actual Google OAuth Client ID after setup
const CLIENT_ID = '161569968813-vrhet7p68vkthkunare60nqr34li5uuh.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';
const API_KEY = 'AIzaSyBjwyQ7qvqrH0goUVidOO0Da9hVQWOzvI8'; // Replace with your Google Cloud API key
// Gemini Vision API key â€” get a free key at https://aistudio.google.com/app/apikey
// Paste your key here to enable photo-based item identification
let GEMINI_KEY = localStorage.getItem('lv_gemini_key') || 'AIzaSyCMECmAvGEED7McHimv7OEl-rY-uY93CSs';
const PERSONAL_SHEET_NAME = 'Lionel Vault â€” My Collection'; // Sheet tab name â€” kept stable for existing users
const PERSONAL_HEADERS = [
  'Item Number','Variation','Condition (1-10)','All Original',
  'Item Only Price','Box Only Price','Item+Box Complete','Has Box',
  'Box Condition (1-10)','Item Photo Link','Box Photo Link','Notes',
  'Date Purchased','User Est. Worth','Matched Tender/Engine','Set ID','Year Made',
  'Is Error','Error Description','Quick Entry'
];
const SOLD_HEADERS = [
  'Item Number','Variation','Copy #','Condition (1-10)','Item Only Price Paid',
  'Sale Price','Date Sold','Notes'
];
const WANT_HEADERS = [
  'Item Number','Variation','Priority','Expected Price','Notes'
];

// Ephemera tab definitions â€” shared structure, one tab per category
const EPHEMERA_TABS = [
  { id: 'catalogs',   label: 'Catalogs',    emoji: 'ðŸ“’', color: '#e67e22' },
  { id: 'paper',      label: 'Paper Items', emoji: 'ðŸ“„', color: '#3498db' },
  { id: 'mockups',    label: 'Mock-Ups',    emoji: 'ðŸ”©', color: '#9b59b6' },
  { id: 'other',      label: 'Other Lionel',emoji: 'ðŸ“¦', color: '#27ae60' },
];
const EPHEMERA_HEADERS = [
  'Item ID','Title','Description','Year','Manufacturer','Condition (1-10)',
  'Quantity','Est. Value','Photo Link','Notes','Date Acquired'
];
const CATALOG_HEADERS = [
  'Item ID','Type','Year','Has Envelope/Mailer','Condition (1-10)',
  'Est. Value','Date Acquired','Notes','Photo Link'
];
// Mock-ups get extra columns
const IS_HEADERS = [
  'Sheet #','Linked Item #','Year/Date Printed','Condition (1-10)','Notes','Photo Link'
];
const MOCKUP_HEADERS = [
  'Title','Item Number Ref','Description','Year','Manufacturer',
  'Condition (1-10)','Production Status','Material','Dimensions',
  'Provenance','Lionel Verified','Est. Value','Photo Link','Notes','Date Acquired'
];

// â”€â”€ TENDER / LOCOMOTIVE RELATIONSHIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TENDER_TO_LOCOS = {"1872T":["1872"],"1882T":["1882"],"2020W":["2020"],"2046W":["726RR","637","646","2056","675","736","2055","2046","2065","665"],"2046WX":["671RR","682","681"],"2426W":["773","726"],"2466T":["224","1666"],"2466W":["224","1666"],"2466WX":["675","224","1666"],"2671W":["681","671"],"4424W":["671R"],"4671W":["671R"],"6001T":["6110"],"6020W":["2020"],"6026T":["2018","2037"],"6026W":["2037","685","2055","2018","2065","665","2016"],"6066T":["2026","1130","2034","2037"],"6403B":["1656"],"6466W":["2026","2036","2025","2035"],"6466WX":["2026","2025","675"],"6654T":["1655"],"250T":["250","249"],"671W":["671"],"736W":["637","665","773","736"],"746W":["746"],"773W":["773"],"1001T":["1101","1120","1001","1110"],"1050T":["235","1060","1050","236"],"1060T":["237","242","1060","2029","1062","1061"],"1130T":["244","248","236","245","2037","2018","1130","235","246"],"1130T-500":["2037-500"],"1625T":["1625"],"1654T":["1654"],"1654W":["1654"],"1862T":["1862"]};
const LOCO_TO_TENDERS = {"1872":["1872T"],"1882":["1882T"],"2020":["2020W","6020W"],"726RR":["2046W"],"637":["2046W","736W"],"646":["2046W"],"2056":["2046W"],"675":["2046W","2466WX","6466WX"],"736":["2046W","736W"],"2055":["2046W","6026W"],"2046":["2046W"],"2065":["2046W","6026W"],"665":["2046W","6026W","736W"],"671RR":["2046WX"],"682":["2046WX"],"681":["2046WX","2671W"],"773":["2426W","736W","773W"],"726":["2426W"],"224":["2466T","2466W","2466WX"],"1666":["2466T","2466W","2466WX"],"671":["2671W","671W"],"671R":["4424W","4671W"],"6110":["6001T"],"2018":["6026T","6026W","1130T"],"2037":["6026T","6026W","6066T","1130T"],"685":["6026W"],"2016":["6026W"],"2026":["6066T","6466W","6466WX"],"1130":["6066T","1130T"],"2034":["6066T"],"1656":["6403B"],"2036":["6466W"],"2025":["6466W","6466WX"],"2035":["6466W"],"1655":["6654T"],"250":["250T"],"249":["250T"],"746":["746W"],"1101":["1001T"],"1120":["1001T"],"1001":["1001T"],"1110":["1001T"],"235":["1050T","1130T"],"1060":["1050T","1060T"],"1050":["1050T"],"236":["1050T","1130T"],"237":["1060T"],"242":["1060T"],"2029":["1060T"],"1062":["1060T"],"1061":["1060T"],"244":["1130T"],"248":["1130T"],"245":["1130T"],"246":["1130T"],"2037-500":["1130T-500"],"1625":["1625T"],"1654":["1654T","1654W"],"1862":["1862T"]};

// â”€â”€ DIESEL SET HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isSetUnit(itemNum) {
  const num = normalizeItemNum(itemNum);
  if (num.endsWith('C')) return true;
  return state.masterData.some(m => normalizeItemNum(m.itemNum) === num + 'C');
}
function getBUnit(itemNum) {
  const num = normalizeItemNum(itemNum);
  const bNum = num + 'C';
  return state.masterData.some(m => normalizeItemNum(m.itemNum) === bNum) ? bNum : null;
}
function getAUnit(itemNum) {
  const num = normalizeItemNum(itemNum);
  if (!num.endsWith('C')) return null;
  const aNum = num.slice(0, -1);
  return state.masterData.some(m => normalizeItemNum(m.itemNum) === aNum) ? aNum : null;
}
function getSetPartner(itemNum) {
  const num = normalizeItemNum(itemNum);
  if (num.endsWith('C')) return getAUnit(num);
  return getBUnit(num);
}
function normalizeItemNum(n) {
  // Strip trailing .0 from numbers stored as floats e.g. "2343.0" -> "2343"
  const s = (n || '').toString().trim();
  return s.match(/^\d+\.0$/) ? s.slice(0, -2) : s;
}
function isF3AlcoUnit(itemNum) {
  const num = normalizeItemNum(itemNum).replace(/C$/i, '');
  return state.masterData.some(m =>
    normalizeItemNum(m.itemNum) === num &&
    m.itemType === 'Diesel Locomotive' &&
    (m.description || '').match(/F-3|F3|Alco FA|FA No\.|FA-/)
  );
}
function genSetId(baseNum) {
  return 'SET-' + baseNum + '-' + Date.now();
}

function isTender(itemNum) { return !!TENDER_TO_LOCOS[itemNum?.toString().trim().toUpperCase()] || !!TENDER_TO_LOCOS[itemNum?.toString().trim()]; }
function isLocomotive(itemNum) { return !!LOCO_TO_TENDERS[itemNum?.toString().trim()]; }
function getMatchingTenders(itemNum) { return LOCO_TO_TENDERS[itemNum?.toString().trim()] || []; }
function getMatchingLocos(tenderNum) { return TENDER_TO_LOCOS[tenderNum?.toString().trim()] || []; }

function findOwnedMatch(itemNum) {
  // Given an item number, find if the user owns the matching tender or engine
  const tenders = getMatchingTenders(itemNum);
  const locos   = getMatchingLocos(itemNum);
  const candidates = [...tenders, ...locos];
  for (const num of candidates) {
    const owned = Object.values(state.personalData).find(pd => pd.itemNum === num);
    if (owned) return { itemNum: num, pd: owned };
  }
  return null;
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = {
  user: null,
  masterSheetId: null,
  ephemeraData: {},   // keyed by tab name â†’ { rowKey: record }
  userDefinedTabs: [], // array of { id, label } for user-created custom tabs
  isError: false,
  personalSheetId: null,
  masterData: [],      // all rows from master sheet
  personalData: {},    // keyed by "itemNum|variation" -> personal row (owned items)
  soldData: {},        // keyed by "itemNum|variation" -> sold row
  wantData: {},        // keyed by "itemNum|variation" -> want list row
  filteredData: [],
  currentPage: 1,
  pageSize: 50,
  filters: { owned: false, unowned: false, boxed: false, wantList: false, type: '', road: '', search: '', quickEntry: '' },
  currentItem: null,
};

// â”€â”€ GOOGLE IDENTITY / AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tokenClient;

function initGoogle() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: onTokenReceived,
  });

  // Check for existing session â€” master ID is hardcoded, just need saved user
  const savedUser = localStorage.getItem('lv_user');
  const savedPersonalId = localStorage.getItem('lv_personal_id');
  state.masterSheetId = '1cLmCcI4Ekao2gn-TntAGjhsPrIYe39-cX6rV1WAyDCM';
  localStorage.setItem('lv_master_id', state.masterSheetId);

  if (savedUser) {
    state.user = JSON.parse(savedUser);
    state.personalSheetId = savedPersonalId;
    showApp();
    showLoading(); // show spinner â€” onTokenReceived will call loadAllData once token is ready
    const savedEmail = state.user?.email || '';
    tokenClient.requestAccessToken({ prompt: '', login_hint: savedEmail });
  }
}

function handleSignIn() {
  tokenClient.requestAccessToken({ prompt: 'consent' });
}

function onGoogleSignIn(response) {
  const payload = parseJwt(response.credential);
  state.user = { name: payload.given_name, email: payload.email, picture: payload.picture };
  localStorage.setItem('lv_user', JSON.stringify(state.user));
}

let accessToken = null;

// Track whether this is the first token receipt (triggers full load) or a background refresh (just updates token)
let _tokenIsInitial = true;

function onTokenReceived(resp) {
  if (resp.error) {
    console.error('Token error:', resp);
    // If silent token refresh failed, prompt user to sign in again
    if (resp.error === 'interaction_required' || resp.error === 'login_required') {
      const hint = state.user?.email || '';
      _tokenIsInitial = true; // next token will be a fresh sign-in
      tokenClient.requestAccessToken({ prompt: 'consent', login_hint: hint });
    }
    return;
  }

  const isInitial = _tokenIsInitial;
  _tokenIsInitial = false; // all subsequent tokens are background refreshes

  accessToken = resp.access_token;

  // Schedule next silent refresh 55 min from now (tokens last 1 hour)
  setTimeout(() => {
    if (accessToken) {
      const hint = state.user?.email || '';
      tokenClient.requestAccessToken({ prompt: '', login_hint: hint });
    }
  }, 55 * 60 * 1000);

  // Background refresh â€” just update the token, don't reload data
  if (!isInitial) {
    return;
  }

  // â”€â”€ Initial sign-in / app startup path â”€â”€

  // Fetch user info from Google if we don't have it yet
  if (!state.user) {
    fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
      headers: { Authorization: 'Bearer ' + accessToken }
    })
    .then(r => r.json())
    .then(info => {
      state.user = { name: info.given_name || info.name || 'User', email: info.email };
      localStorage.setItem('lv_user', JSON.stringify(state.user));
      updateUserUI();
    });
  } else {
    updateUserUI();
  }

  // Master sheet is hardcoded
  state.masterSheetId = '1cLmCcI4Ekao2gn-TntAGjhsPrIYe39-cX6rV1WAyDCM';
  localStorage.setItem('lv_master_id', state.masterSheetId);

  // Always sync from Drive config to ensure correct sheet ID across devices
  driveReadConfig().then(config => {
    if (config && config.personalSheetId) {
      // Always use Drive config as source of truth
      state.personalSheetId = config.personalSheetId;
      localStorage.setItem('lv_personal_id', config.personalSheetId);
      if (config.vaultId)      { driveCache.vaultId = config.vaultId;           localStorage.setItem('lv_vault_id', config.vaultId); }
      if (config.photosId)     { driveCache.photosId = config.photosId;         localStorage.setItem('lv_photos_id', config.photosId); }
      if (config.soldPhotosId) { driveCache.soldPhotosId = config.soldPhotosId; localStorage.setItem('lv_sold_photos_id', config.soldPhotosId); }
      loadAllData();
    } else {
      // No config yet â€” check localStorage then create if needed
      state.personalSheetId = localStorage.getItem('lv_personal_id');
      if (!state.personalSheetId) {
        createPersonalSheet().then(loadAllData);
      } else {
        driveEnsureSetup().catch(e => console.warn('Drive setup:', e));
        loadAllData();
      }
    }
  }).catch(() => {
    // Drive read failed â€” fall back to localStorage
    state.personalSheetId = localStorage.getItem('lv_personal_id');
    if (!state.personalSheetId) {
      createPersonalSheet().then(loadAllData);
    } else {
      loadAllData();
    }
  });
}

function handleSignOut() {
  google.accounts.oauth2.revoke(localStorage.getItem('lv_token'), () => {});
  localStorage.removeItem('lv_user');
  localStorage.removeItem('lv_token');
  state.user = null;
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('app').classList.remove('active');
}

function closeOnboarding() { var o = document.getElementById("onboarding-overlay"); if (o) o.remove(); }

function showOnboarding() {
  if (localStorage.getItem('lv_onboarded')) return;
  localStorage.setItem('lv_onboarded', '1');
  const ov = document.createElement('div');
  ov.id = 'onboarding-overlay';
  ov.style.cssText = 'position:fixed;inset:0;background:rgba(10,14,20,0.92);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1.5rem';
  ov.innerHTML = '<div style="background:var(--surface);border-radius:18px;max-width:380px;width:100%;padding:2rem;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.5)">'
    + '<div style="font-size:3rem;margin-bottom:0.75rem">ðŸš‚</div>'
    + '<div style="font-family:var(--font-head);font-size:1.5rem;font-weight:700;margin-bottom:0.5rem;color:var(--text)">Welcome to <span style=\"color:var(--accent)\">My Collection App</span></div>'
    + '<div style="font-size:0.88rem;color:var(--text-mid);line-height:1.7;margin-bottom:1.5rem">Your personal postwar Lionel collection manager. Here\'s how it works:</div>'
    + '<div style="display:flex;flex-direction:column;gap:0.75rem;text-align:left;margin-bottom:1.5rem">'
    + '<div style="display:flex;gap:0.75rem;align-items:flex-start"><div style="background:var(--accent);color:white;border-radius:50%;width:26px;height:26px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.85rem">1</div><div style="font-size:0.88rem;color:var(--text-mid);line-height:1.5"><strong style="color:var(--text)">Browse the Master Catalog</strong><br>Over 2,000 postwar items pre-loaded â€” engines, cars, accessories and more.</div></div>'
    + '<div style="display:flex;gap:0.75rem;align-items:flex-start"><div style="background:var(--accent);color:white;border-radius:50%;width:26px;height:26px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.85rem">2</div><div style="font-size:0.88rem;color:var(--text-mid);line-height:1.5"><strong style="color:var(--text)">Add items you own</strong><br>Tap Add Item, enter the number, and answer a few simple questions.</div></div>'
    + '<div style="display:flex;gap:0.75rem;align-items:flex-start"><div style="background:var(--accent);color:white;border-radius:50%;width:26px;height:26px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.85rem">3</div><div style="font-size:0.88rem;color:var(--text-mid);line-height:1.5"><strong style="color:var(--text)">Track your collection</strong><br>Photos, condition, value, want list â€” all saved to your Google account.</div></div>'
    + '</div>'
    + '<button onclick="closeOnboarding()" style="width:100%;padding:0.9rem;border-radius:12px;border:none;background:var(--accent);color:white;font-family:var(--font-body);font-size:1rem;font-weight:700;cursor:pointer">Get Started â†’</button>'
    + '<div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.75rem">Tip: Use Quick Entry to log items fast, then fill in details later.</div>'
    + '</div>';
  document.body.appendChild(ov);
}

function showApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('setup-screen').classList.remove('active');
  const _appEl = document.getElementById('app');
  _appEl.style.opacity = '0';
  _appEl.classList.add('active');
  requestAnimationFrame(() => { _appEl.style.transition = 'opacity 0.3s ease'; _appEl.style.opacity = '1'; });
  updateUserUI();
  const hr = new Date().getHours();
  const _greet = hr < 12 ? 'Good Morning' : hr < 17 ? 'Good Afternoon' : 'Good Evening';
  const _name = (state.userName || '').split(' ')[0] || 'Collector';
  document.getElementById('dash-greeting').innerHTML = _greet + ', <span style="color:var(--accent)">' + _name + '</span>';
}

function showSetup() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').classList.remove('active');
  document.getElementById('setup-screen').classList.add('active');
}

function updateUserUI() {
  if (!state.user) return;
  document.getElementById('user-name').textContent = state.user.name;
  document.getElementById('user-avatar').textContent = state.user.name[0].toUpperCase();
}

async function completeSetup() {
  let rawMaster = document.getElementById('master-sheet-input').value.trim();
  let rawPersonal = document.getElementById('personal-sheet-input').value.trim();
  if (!rawMaster) { showToast('Please enter the Master Sheet ID.', 3000, true); return; }
  if (!rawPersonal) { showToast('Please enter your Personal Collection Sheet ID.', 3000, true); return; }

  // Extract IDs if full URLs were pasted
  const masterMatch = rawMaster.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
  const personalMatch = rawPersonal.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
  const masterId = masterMatch ? masterMatch[1] : rawMaster;
  const personalId = personalMatch ? personalMatch[1] : rawPersonal;

  state.masterSheetId = masterId;
  state.personalSheetId = personalId;
  localStorage.setItem('lv_master_id', masterId);
  localStorage.setItem('lv_personal_id', personalId);

  // Initialize personal sheet headers
  try {
    await initPersonalSheet(personalId);
    showApp();
    loadAllData();
  } catch(e) {
    console.error('Setup error:', e);
    showToast('Could not connect to sheet. Make sure you\'re signed in and the sheet exists.', 4000, true);
  }
}

async function initPersonalSheet(sheetId) {
  // Write My Collection title + headers if empty
  const res = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/My%20Collection!A1:M2`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  );
  const data = await res.json();
  const rows = data.values || [];
  if (rows.length === 0 || !rows[0] || rows[0].length === 0) {
    // Brand new sheet â€” write title row 1 and headers row 2
    await sheetsUpdate(sheetId, 'My Collection!A1:A1', [['My Collection']]);
    await sheetsUpdate(sheetId, 'My Collection!A2:T2', [PERSONAL_HEADERS]);
  } else if (rows.length === 1 || !rows[1] || rows[1].length < 13) {
    // Has title but missing/old headers â€” rewrite row 2
    await sheetsUpdate(sheetId, 'My Collection!A2:T2', [PERSONAL_HEADERS]);
  }
  // Get existing sheet tab names
  const metaRes = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?fields=sheets.properties.title`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  );
  const meta = await metaRes.json();
  const existingTabs = (meta.sheets || []).map(s => s.properties.title);

  // Build list of tabs to create
  const toCreate = [];
  if (!existingTabs.includes('Sold'))      toCreate.push({ addSheet: { properties: { title: 'Sold' } } });
  if (!existingTabs.includes('Want List')) toCreate.push({ addSheet: { properties: { title: 'Want List' } } });

  if (toCreate.length > 0) {
    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}:batchUpdate`, {
      method: 'POST',
      headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ requests: toCreate }),
    });
  }

  // Write headers to all tabs
  await sheetsUpdate(sheetId, 'Sold!A1:A1',      [['Sold']]);
  await sheetsUpdate(sheetId, 'Sold!A2:H2',      [SOLD_HEADERS]);
  await sheetsUpdate(sheetId, 'Want List!A1:A1', [['Want List']]);
  await sheetsUpdate(sheetId, 'Want List!A2:E2', [WANT_HEADERS]);

  // Ephemera tabs
  await ensureEphemeraSheets(sheetId);
}

let _ensureEphemDone = false;
async function ensureEphemeraSheets(sheetId) {
  if (_ensureEphemDone) return;  // Only run once per session â€” tabs and headers don't change
  const metaRes = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?fields=sheets.properties.title`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  );
  const meta = await metaRes.json();
  const existingTabs = (meta.sheets || []).map(s => s.properties.title);
  const tabNames = { catalogs:'Catalogs', paper:'Paper Items', mockups:'Mock-Ups', other:'Other Lionel' };
  const toCreate = [];
  Object.values(tabNames).forEach(t => {
    if (!existingTabs.includes(t)) toCreate.push({ addSheet: { properties: { title: t } } });
  });
  if (toCreate.length > 0) {
    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}:batchUpdate`, {
      method: 'POST',
      headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ requests: toCreate }),
    });
  }
  // Write headers â€” clear extra columns first to fix any stale headers
  // Clear row 1 and row 2 across all ephemera tabs (A1:P covers any previous wide headers)
  const _clearReqs = ['Catalogs','Paper Items','Mock-Ups','Other Lionel'].map(t => ({
    updateCells: {
      range: { sheetId: 0, startRowIndex: 0, endRowIndex: 2, startColumnIndex: 0, endColumnIndex: 16 },
      fields: 'userEnteredValue',
    }
  }));
  // Use values API to clear then rewrite cleanly
  await sheetsUpdate(sheetId, 'Catalogs!A1:P1',    [['Catalogs','','','','','','','','','','','','','','','']]);
  await sheetsUpdate(sheetId, 'Catalogs!A2:P2',    [CATALOG_HEADERS.concat(['','','','','','',''])]);
  await sheetsUpdate(sheetId, 'Paper Items!A1:P1', [['Paper Items','','','','','','','','','','','','','','','']]);
  await sheetsUpdate(sheetId, 'Paper Items!A2:P2', [EPHEMERA_HEADERS.concat(['','','','',''])]);
  await sheetsUpdate(sheetId, 'Mock-Ups!A1:P1',    [['Mock-Ups','','','','','','','','','','','','','','','']]);
  await sheetsUpdate(sheetId, 'Mock-Ups!A2:P2',    [MOCKUP_HEADERS.concat([''])]);
  await sheetsUpdate(sheetId, 'Other Lionel!A1:P1',[['Other Lionel','','','','','','','','','','','','','','','']]);
  await sheetsUpdate(sheetId, 'Other Lionel!A2:P2',[EPHEMERA_HEADERS.concat(['','','','',''])]);
  _ensureEphemDone = true;  // Don't run again this session
  // Instruction Sheets tab
  if (!existingTabs.includes('Instruction Sheets')) {
    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}:batchUpdate`, {
      method:'POST', headers:{Authorization:`Bearer ${accessToken}`,'Content-Type':'application/json'},
      body: JSON.stringify({ requests:[{ addSheet:{ properties:{ title:'Instruction Sheets' } } }] }),
    });
  }
  await sheetsUpdate(sheetId, 'Instruction Sheets!A1:A1', [['Instruction Sheets']]);
  await sheetsUpdate(sheetId, 'Instruction Sheets!A2:F2', [IS_HEADERS]);
}


// â”€â”€ GOOGLE DRIVE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const ITEM_VIEWS = [
  { key: 'RSV', label: 'Right Side View', abbr: 'Right Side' },
  { key: 'TV',  label: 'Top View',        abbr: 'Top'        },
  { key: 'BV',  label: 'Bottom View',     abbr: 'Bottom'     },
  { key: 'BKV', label: 'Back View',       abbr: 'Back'       },
  { key: 'FV',  label: 'Front View',      abbr: 'Front'      },
  { key: 'LSV', label: 'Left Side View',  abbr: 'Left Side'  },
];
// Error car close-up photo views
const ERROR_VIEWS = [
  { key: 'ERR-1', label: 'Error Close-up 1', abbr: 'ERR-1' },
  { key: 'ERR-2', label: 'Error Close-up 2', abbr: 'ERR-2' },
  { key: 'ERR-3', label: 'Error Close-up 3', abbr: 'ERR-3' },
  { key: 'ERR-4', label: 'Error Close-up 4', abbr: 'ERR-4' },
];

// Returns a human-friendly label for the item type (for wizard questions)
function getItemLabel(d) {
  // Try master data lookup first
  const itemNum = (d.itemNum || '').trim().replace(/-[PD]$/, '');
  const master = state.masterData.find(m => m.itemNum === itemNum || m.itemNum === d.itemNum);
  const t = (master && master.itemType) ? master.itemType.toLowerCase() : '';
  if (t.includes('steam') || t.includes('diesel') || t.includes('electric')) return 'locomotive';
  if (t.includes('freight') || t.includes('car')) return 'car';
  if (t.includes('passenger')) return 'car';
  if (t.includes('accessory') || t.includes('accessories')) return 'accessory';
  if (t.includes('track')) return 'track section';
  if (t.includes('set')) return 'set';
  return 'item';
}

const BOX_VIEWS = [
  { key: 'BOX-RSV', label: 'Box Right Side', abbr: 'Right Side' },
  { key: 'BOX-TV',  label: 'Box Top',        abbr: 'Top'        },
  { key: 'BOX-BV',  label: 'Box Bottom',     abbr: 'Bottom'     },
  { key: 'BOX-BKV', label: 'Box Back',       abbr: 'Back'       },
  { key: 'BOX-FV',  label: 'Box Front',      abbr: 'Front'      },
  { key: 'BOX-LSV', label: 'Box Left Side',  abbr: 'Left Side'  },
];

// Folder structure:
//  My Collection App - Drive Folder/         (vault root â€” stores sheet + photo subfolders)
//    My Collection Photos/               (item photo folders)
//      726/
//        726 FV.jpg, 726 RSV.jpg ...
//    My Sold Collection Photos/          (sold item photo folders â€” moved here on sale)

const driveCache = {
  vaultId: null,       // "My Collection App - Drive Folder" root
  photosId: null,      // "My Collection Photos"
  catalogsId: localStorage.getItem('lv_catalogs_id') || null,
  isPhotosId: localStorage.getItem('lv_is_id') || null,
  soldPhotosId: null,  // "My Sold Collection Photos"
  itemFolders: {},     // itemNum -> folderId
};

async function driveRequest(method, endpoint, body) {
  const res = await fetch('https://www.googleapis.com/drive/v3' + endpoint, {
    method,
    headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
    body: body !== undefined ? JSON.stringify(body) : undefined,
  });
  return res.json();
}

async function driveUploadFile(file, name, folderId) {
  const metadata = { name, parents: [folderId], mimeType: file.type };
  const form = new FormData();
  form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
  form.append('file', file);
  const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink,webContentLink', {
    method: 'POST',
    headers: { Authorization: 'Bearer ' + accessToken },
    body: form,
  });
  return res.json();
}

async function driveFindOrCreateFolder(name, parentId) {
  const q = encodeURIComponent(`name='${name}' and mimeType='application/vnd.google-apps.folder' and '${parentId}' in parents and trashed=false`);
  const res = await driveRequest('GET', `/files?q=${q}&fields=files(id,name)&spaces=drive`);
  if (res.files && res.files.length > 0) return res.files[0].id;
  const created = await driveRequest('POST', '/files?fields=id', {
    name, mimeType: 'application/vnd.google-apps.folder', parents: [parentId],
  });
  return created.id;
}

async function driveUploadPhoto(file, fileName, folderId) {
  const meta = JSON.stringify({ name: fileName, parents: [folderId] });
  const form = new FormData();
  form.append('metadata', new Blob([meta], { type: 'application/json' }));
  form.append('file', file);
  const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
    method: 'POST',
    headers: { Authorization: `Bearer ${accessToken}` },
    body: form,
  });
  return res.json();
}

async function driveMoveFileToFolder(fileId, fromFolderId, toFolderId) {
  await driveRequest('PATCH', `/files/${fileId}?addParents=${toFolderId}&removeParents=${fromFolderId}&fields=id`, {});
}

// Called once on first run â€” creates the full vault folder structure
async function driveSetupVault() {
  // Find or create root vault folder
  const rootRes = await driveRequest('GET', '/files/root?fields=id');
  const rootId = rootRes.id;
  driveCache.vaultId = await driveFindOrCreateFolder('Lionel Vault - My Collection', rootId);
  localStorage.setItem('lv_vault_id', driveCache.vaultId);

  // Find or create both photo subfolders (always, so nothing is missing)
  driveCache.photosId     = await driveFindOrCreateFolder('My Collection Photos',      driveCache.vaultId);
  driveCache.soldPhotosId = await driveFindOrCreateFolder('My Sold Collection Photos', driveCache.vaultId);
  localStorage.setItem('lv_photos_id',      driveCache.photosId);
  localStorage.setItem('lv_sold_photos_id', driveCache.soldPhotosId);

  // Move the personal sheet into the vault folder if we have its ID
  const sheetId = localStorage.getItem('lv_personal_id');
  if (sheetId) {
    try { await driveMoveSheetToVault(sheetId); } catch(e) { console.warn('Sheet move:', e); }
  }

  // Save config so other devices can discover these IDs
  if (state.personalSheetId) {
    driveWriteConfig({
      personalSheetId: state.personalSheetId,
      vaultId: driveCache.vaultId,
      photosId: driveCache.photosId,
      soldPhotosId: driveCache.soldPhotosId,
    }).catch(e => console.warn('Config write:', e));
  }
  return driveCache.vaultId;
}

async function driveEnsureSetup() {
  if (driveCache.vaultId && driveCache.photosId && driveCache.soldPhotosId) return;
  // Try from localStorage first (fast path)
  const vId = localStorage.getItem('lv_vault_id');
  const pId = localStorage.getItem('lv_photos_id');
  const sId = localStorage.getItem('lv_sold_photos_id');
  if (vId && pId && sId) {
    driveCache.vaultId      = vId;
    driveCache.photosId     = pId;
    driveCache.soldPhotosId = sId;
  } else {
    // Always run full setup so any missing folders get created
    await driveSetupVault();
  }
}

async function driveEnsureItemFolder(itemNum) {
  await driveEnsureSetup();
  const key = String(itemNum);
  if (driveCache.itemFolders[key]) return driveCache.itemFolders[key];
  const folderId = await driveFindOrCreateFolder(key, driveCache.photosId);
  driveCache.itemFolders[key] = folderId;
  return folderId;
}

async function driveGetFolderPhotos(folderLink) {
  const match = (folderLink || '').match(/folders\/([a-zA-Z0-9_-]+)/);
  if (!match) return null;
  const folderId = match[1];
  if (!accessToken) return null;
  try {
    const q = encodeURIComponent(`'${folderId}' in parents and mimeType contains 'image/' and trashed=false`);
    const res = await driveRequest('GET', `/files?q=${q}&fields=files(id,name)&orderBy=name`);
    if (res.error) { console.warn('Drive photo fetch error:', res.error); return null; }
    return (res.files || []).map(function(f) {
      return {
        id: f.id,
        name: f.name,
        // Use authenticated media download URL â€” fetch as blob in loadThumb()
        mediaUrl: 'https://www.googleapis.com/drive/v3/files/' + f.id + '?alt=media',
        view: 'https://drive.google.com/file/d/' + f.id + '/view',
      };
    });
  } catch(e) { console.error('driveGetFolderPhotos:', e); return null; }
}

// Fetch a Drive file as an authenticated blob URL for use in <img loading="lazy" src>
const _blobCache = {};
async function loadDriveThumb(fileId, imgEl, containerEl) {
  const cacheKey = fileId;
  if (_blobCache[cacheKey]) { imgEl.src = _blobCache[cacheKey]; return; }
  try {
    // Use thumbnail endpoint with size parameter (requires auth)
    const thumbUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&acknowledgeAbuse=true`;
    const res = await fetch(thumbUrl, {
      headers: { Authorization: 'Bearer ' + accessToken }
    });
    if (!res.ok) {
      containerEl.innerHTML = '<span style="font-size:0.65rem;color:var(--text-dim)">âš  ' + res.status + '</span>';
      return;
    }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    _blobCache[cacheKey] = url;
    imgEl.src = url;
  } catch(e) {
    containerEl.innerHTML = '<span style="font-size:0.65rem;color:var(--text-dim)">âš  err</span>';
  }
}

function driveFolderLink(folderId) {
  return `https://drive.google.com/drive/folders/${folderId}`;
}

async function driveUploadItemPhoto(file, itemNum, viewAbbr) {
  await driveEnsureSetup();
  const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
  const fileName = `${itemNum} ${viewAbbr}.${ext}`;
  const folderId = await driveEnsureItemFolder(itemNum);
  await driveUploadFile(file, fileName, folderId);
  // Return folder link (not individual photo link)
  return driveFolderLink(folderId);
}

async function driveMoveToSold(itemNum) {
  await driveEnsureSetup();
  const key = String(itemNum);
  // Find item folder in My Collection Photos
  const q = encodeURIComponent(`name='${key}' and mimeType='application/vnd.google-apps.folder' and '${driveCache.photosId}' in parents and trashed=false`);
  const res = await driveRequest('GET', `/files?q=${q}&fields=files(id)`);
  if (res.files && res.files.length > 0) {
    const fId = res.files[0].id;
    await driveMoveFileToFolder(fId, driveCache.photosId, driveCache.soldPhotosId);
    delete driveCache.itemFolders[key];
  }
}

// â”€â”€ DRIVE CONFIG FILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Stores personalSheetId in a small JSON file in Drive root
// so any device can find the right sheet after signing in

const CONFIG_FILENAME = 'lionel-vault-config.json';

async function driveReadConfig() {
  try {
    // Search for config file in Drive root
    const q = encodeURIComponent(`name='${CONFIG_FILENAME}' and trashed=false`);
    const res = await driveRequest('GET', `/files?q=${q}&fields=files(id,name)&spaces=drive`);
    if (!res.files || res.files.length === 0) return null;
    // Read file contents
    const fileId = res.files[0].id;
    const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
      headers: { Authorization: 'Bearer ' + accessToken }
    });
    return await r.json();
  } catch(e) { console.warn('driveReadConfig error:', e); return null; }
}

async function driveWriteConfig(data) {
  try {
    const json = JSON.stringify(data);
    const blob = new Blob([json], { type: 'application/json' });
    // Check if file already exists
    const q = encodeURIComponent(`name='${CONFIG_FILENAME}' and trashed=false`);
    const res = await driveRequest('GET', `/files?q=${q}&fields=files(id)&spaces=drive`);
    if (res.files && res.files.length > 0) {
      // Update existing file
      const fileId = res.files[0].id;
      await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
        method: 'PATCH',
        headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
        body: blob,
      });
    } else {
      // Create new file
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify({ name: CONFIG_FILENAME, mimeType: 'application/json' })], { type: 'application/json' }));
      form.append('file', blob);
      await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + accessToken },
        body: form,
      });
    }
  } catch(e) { console.warn('driveWriteConfig error:', e); }
}

// Move sheet into vault folder after creation
async function driveMoveSheetToVault(sheetId) {
  await driveEnsureSetup();
  // Get current parents of the sheet file
  const meta = await driveRequest('GET', `/files/${sheetId}?fields=parents`);
  const currentParents = (meta.parents || []).join(',');
  await fetch(`https://www.googleapis.com/drive/v3/files/${sheetId}?addParents=${driveCache.vaultId}&removeParents=${currentParents}&fields=id`, {
    method: 'PATCH',
    headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
    body: JSON.stringify({}),
  });
}

// â”€â”€ SHEETS API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sheetsGet(spreadsheetId, range) {
  // Use API key for master sheet (public), OAuth token for personal sheet
  const isMaster = spreadsheetId === state.masterSheetId;
  const url = isMaster && API_KEY !== 'YOUR_API_KEY'
    ? `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}?key=${API_KEY}`
    : `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}`;
  const headers = isMaster && API_KEY !== 'YOUR_API_KEY'
    ? {}
    : { Authorization: `Bearer ${accessToken}` };
  const res = await fetch(url, { headers });
  return res.json();
}

// â”€â”€ Token refresh helper â€” silently refreshes expired token then retries â”€â”€
// On mobile, tokens expire and the silent refresh sometimes doesn't fire in time.
// This wraps any fetch so a 401 triggers a fresh token request before retrying once.
async function _withTokenRetry(fetchFn) {
  const res = await fetchFn();
  if (res.status === 401 || res.status === 403) {
    // Token is expired or invalid â€” request a fresh one and wait up to 8s
    await new Promise((resolve, reject) => {
      const hint = state.user?.email || '';
      const prevCallback = tokenClient.callback;
      tokenClient.callback = (resp) => {
        tokenClient.callback = prevCallback; // restore
        if (resp.error) { reject(new Error('Token refresh failed: ' + resp.error)); return; }
        accessToken = resp.access_token;
        resolve();
      };
      tokenClient.requestAccessToken({ prompt: '', login_hint: hint });
      setTimeout(() => reject(new Error('Token refresh timed out')), 8000);
    });
    // Retry with fresh token
    const retryRes = await fetchFn();
    if (!retryRes.ok) {
      const errBody = await retryRes.json().catch(() => ({}));
      throw new Error(`Sheets API error ${retryRes.status}: ${errBody?.error?.message || retryRes.statusText}`);
    }
    return retryRes;
  }
  if (!res.ok) {
    const errBody = await res.json().catch(() => ({}));
    throw new Error(`Sheets API error ${res.status}: ${errBody?.error?.message || res.statusText}`);
  }
  return res;
}

async function sheetsUpdate(spreadsheetId, range, values) {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}?valueInputOption=USER_ENTERED`;
  const body = JSON.stringify({ range, majorDimension: 'ROWS', values });
  const res = await _withTokenRetry(() => fetch(url, {
    method: 'PUT',
    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
    body,
  }));
  return res.json();
}

async function sheetsAppend(spreadsheetId, range, values) {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`;
  const body = JSON.stringify({ values });
  const res = await _withTokenRetry(() => fetch(url, {
    method: 'POST',
    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
    body,
  }));
  return res.json();
}

async function sheetsDeleteRow(spreadsheetId, sheetName, rowNumber) {
  // First get the sheetId (numeric) for the named tab
  const metaRes = await _withTokenRetry(() => fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?fields=sheets.properties`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  ));
  const meta = await metaRes.json();
  const sheet = meta.sheets.find(s => s.properties.title === sheetName);
  if (!sheet) return;
  const sheetId = sheet.properties.sheetId;

  // Delete the row (0-indexed, startIndex = rowNumber-1)
  await _withTokenRetry(() => fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`, {
    method: 'POST',
    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({
      requests: [{
        deleteDimension: {
          range: {
            sheetId,
            dimension: 'ROWS',
            startIndex: rowNumber - 1,
            endIndex: rowNumber
          }
        }
      }]
    })
  }));
}

async function createPersonalSheet() {
  // 1. Set up Drive vault folders first
  await driveSetupVault();

  // 2. Create new spreadsheet
  const res = await fetch('https://sheets.googleapis.com/v4/spreadsheets', {
    method: 'POST',
    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({
      properties: { title: PERSONAL_SHEET_NAME },
      sheets: [{ properties: { title: 'My Collection' } }]
    })
  });
  const data = await res.json();
  state.personalSheetId = data.spreadsheetId;
  localStorage.setItem('lv_personal_id', state.personalSheetId);

  // 3. Write headers and create all tabs
  await sheetsUpdate(state.personalSheetId, 'My Collection!A1:A1', [['My Collection']]);
  await sheetsUpdate(state.personalSheetId, 'My Collection!A2:T2', [PERSONAL_HEADERS]);
  await initPersonalSheet(state.personalSheetId);

  // 4. Move the sheet file into the vault folder
  try { await driveMoveSheetToVault(state.personalSheetId); } catch(e) { console.warn('Could not move sheet to vault:', e); }

  // 5. Write config to Drive so other devices can find this sheet
  await driveWriteConfig({
    personalSheetId: state.personalSheetId,
    vaultId: driveCache.vaultId,
    photosId: driveCache.photosId,
    soldPhotosId: driveCache.soldPhotosId,
  });

  return state.personalSheetId;
}

// â”€â”€ LOAD DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Load/save user-defined tab names
function loadUserDefinedTabs() {
  try {
    state.userDefinedTabs = JSON.parse(localStorage.getItem('lv_user_tabs') || '[]');
  } catch(e) { state.userDefinedTabs = []; }
}
function saveUserDefinedTabs() {
  localStorage.setItem('lv_user_tabs', JSON.stringify(state.userDefinedTabs));
}

async function loadAllData() {
  showLoading();
  try {
    loadUserDefinedTabs();
    // Load master data (uses cache if fresh) and personal data in parallel
    await Promise.all([loadMasterData(), loadPersonalData()]);
    buildApp();
    showOnboarding();
  } catch(e) {
    showToast('Load error: ' + e.message);
    const tb = document.getElementById('browse-tbody');
    if (tb) tb.innerHTML = '<tr><td colspan="9" style="padding:2rem;color:var(--red);text-align:center">Error loading data. Please refresh.<br><small>' + e.message + '</small></td></tr>';
  }
}

async function loadMasterData() {
  // Use cached master data for instant load, refresh in background
  const _CACHE_VER = '2';
  if (localStorage.getItem('lv_cache_ver') !== _CACHE_VER) {
    localStorage.removeItem('lv_master_cache');
    localStorage.removeItem('lv_personal_cache');
    localStorage.setItem('lv_cache_ver', _CACHE_VER);
  }
  const cached = localStorage.getItem('lv_master_cache');
  const cachedAt = parseInt(localStorage.getItem('lv_master_cache_ts') || '0');
  const cacheAge = Date.now() - cachedAt;
  const CACHE_TTL = 24 * 60 * 60 * 1000; // 24 hours

  if (cached && cacheAge < CACHE_TTL) {
    try {
      state.masterData = JSON.parse(cached);
      // Refresh in background without blocking
      sheetsGet(state.masterSheetId, 'Master Inventory!A3:V').then(res => {
        if (!res.values) return sheetsGet(state.masterSheetId, 'Sheet1!A3:V');
        return res;
      }).then(res => {
        if (res && res.values) {
          parseMasterRows(res.values);
          localStorage.setItem('lv_master_cache', JSON.stringify(state.masterData));
          localStorage.setItem('lv_master_cache_ts', Date.now().toString());
          if (typeof renderBrowse === 'function') renderBrowse();
        }
      }).catch(() => {});
      return;
    } catch(e) {}
  }

  // Fetch through col V to include Est. Market Value (col V = index 21)
  let res = await sheetsGet(state.masterSheetId, 'Master Inventory!A3:V');
  if (!res.values) {
    res = await sheetsGet(state.masterSheetId, 'Sheet1!A3:V');
  }
  const rows = res.values || [];
  parseMasterRows(rows);
  localStorage.setItem('lv_master_cache', JSON.stringify(state.masterData));
  localStorage.setItem('lv_master_cache_ts', Date.now().toString());
}

function parseMasterRows(rows) {
  state.masterData = rows.map(r => ({
    itemNum:    r[0]  || '',
    itemType:   r[1]  || '',
    subType:    r[2]  || '',
    wheelArr:   r[3]  || '',
    tenderNum:  r[4]  || '',
    roadName:   r[5]  || '',
    description:r[6]  || '',
    yearProd:   r[7]  || '',
    variation:  r[8]  || '',
    varDesc:    r[9]  || '',
    refLink:    r[10] || '',
    ebayAvg:    r[18] || '',
    ebaySample: r[19] || '',
    ebayUpdated:r[20] || '',
    marketVal:  r[21] || '',
  }));
}

async function loadPersonalData() {
  if (!state.personalSheetId) {
    state.personalSheetId = localStorage.getItem('lv_personal_id');
  }
  if (!state.personalSheetId) return;

  // Use cached personal data for instant load (15 min TTL)
  const _pcache = localStorage.getItem('lv_personal_cache');
  const _ptime  = parseInt(localStorage.getItem('lv_personal_cache_ts') || '0');
  const _PAGE_TTL = 15 * 60 * 1000;
  if (_pcache && (Date.now() - _ptime) < _PAGE_TTL) {
    try {
      const _pd = JSON.parse(_pcache);
      state.personalData  = _pd.personalData  || {};
      state.soldData      = _pd.soldData      || {};
      state.wantData      = _pd.wantData      || {};
      state.isData        = _pd.isData        || {};
      state.ephemeraData  = _pd.ephemeraData  || { catalogs:{}, paper:{}, mockups:{}, other:{} };
      // Refresh in background
      _loadPersonalFromSheets(state.personalSheetId).then(() => {
        _cachePersonalData();
        buildDashboard();
        renderBrowse();
      }).catch(() => {});
      return;
    } catch(e) {}
  }

  ensureEphemeraSheets(state.personalSheetId).catch(() => {});
  await _loadPersonalFromSheets(state.personalSheetId);
  _cachePersonalData();
}

function _cachePersonalData() {
  try {
    const _snap = {
      personalData: state.personalData,
      soldData: state.soldData,
      wantData: state.wantData,
      isData: state.isData,
      ephemeraData: state.ephemeraData,
    };
    localStorage.setItem('lv_personal_cache', JSON.stringify(_snap));
    localStorage.setItem('lv_personal_cache_ts', Date.now().toString());
  } catch(e) {}
}

async function _loadPersonalFromSheets(sheetId) {
  state.personalData = {};
  state.soldData = {};
  state.wantData = {};

  // Fetch all tabs in parallel
  const [collRes, soldRes, wantRes,
         catRes, paperRes, mockRes, otherRes, isRes] = await Promise.all([
    sheetsGet(sheetId, 'My Collection!A3:T').catch(() => ({values:[]})),
    sheetsGet(sheetId, 'Sold!A3:H').catch(() => ({values:[]})),
    sheetsGet(sheetId, 'Want List!A3:E').catch(() => ({values:[]})),
    sheetsGet(sheetId, 'Catalogs!A3:I').catch(() => ({values:[]})),
    sheetsGet(sheetId, 'Paper Items!A3:J').catch(() => ({values:[]})),
    sheetsGet(sheetId, 'Mock-Ups!A3:O').catch(() => ({values:[]})),
    sheetsGet(sheetId, 'Other Lionel!A3:J').catch(() => ({values:[]})),
    sheetsGet(sheetId, 'Instruction Sheets!A3:F').catch(() => ({values:[]})),
  ]);

  // My Collection
  (collRes.values || []).forEach((r, idx) => {
    if (!r[0] || r[0] === 'Item Number') return;
    const rowNum = idx + 3;
    const key = `${r[0]}|${r[1] || ''}|${rowNum}`;
    state.personalData[key] = {
      row: rowNum, itemNum: r[0]||'', variation: r[1]||'',
      status: 'Owned', owned: true,
      condition: r[2]||'', allOriginal: r[3]||'',
      priceItem: r[4]||'', priceBox: r[5]||'', priceComplete: r[6]||'',
      hasBox: r[7]||'', boxCond: r[8]||'',
      photoItem: r[9]||'', photoBox: r[10]||'',
      notes: r[11]||'', datePurchased: r[12]||'',
      userEstWorth: r[13]||'', matchedTo: r[14]||'',
      setId: r[15]||'', yearMade: r[16]||'',
      isError: r[17]||'', errorDesc: r[18]||'',
      quickEntry: r[19] === 'Yes',
    };
  });

  // Sold
  (soldRes.values || []).forEach((r, idx) => {
    if (!r[0] || r[0] === 'Item Number') return;
    const key = `${r[0]}|${r[1]||''}`;
    state.soldData[key] = {
      row: idx+3, itemNum: r[0]||'', variation: r[1]||'',
      copy: r[2]||'1', condition: r[3]||'', priceItem: r[4]||'',
      salePrice: r[5]||'', dateSold: r[6]||'', notes: r[7]||'',
    };
  });

  // Want List
  (wantRes.values || []).forEach((r, idx) => {
    if (!r[0] || r[0] === 'Item Number') return;
    const key = `${r[0]}|${r[1]||''}`;
    state.wantData[key] = {
      row: idx+3, itemNum: r[0]||'', variation: r[1]||'',
      priority: r[2]||'Medium', expectedPrice: r[3]||'', notes: r[4]||'',
    };
  });

  // Instruction Sheets
  state.isData = {};
  const _isRows = (isRes && isRes.values) || [];
  _isRows.forEach((r, idx) => {
    if (!r[0] || r[0] === 'Sheet #' || r[0] === 'Instruction Sheets') return;
    const key = idx + 3;
    state.isData[key] = {
      row: key, sheetNum: r[0]||'', linkedItem: r[1]||'', year: r[2]||'',
      condition: r[3]||'', notes: r[4]||'', photoLink: r[5]||'',
    };
  });

  // Ephemera tabs
  state.ephemeraData = { catalogs:{}, paper:{}, mockups:{}, other:{} };
  // Initialize user-defined tab buckets
  (state.userDefinedTabs||[]).forEach(t => { state.ephemeraData[t.id] = {}; });

  function parseEphemeraRows(rows, bucket) {
    (rows || []).forEach((r, idx) => {
      if (!r[0] || r[0] === 'Item ID' || r[0] === 'Title') return;
      const key = idx + 3;
      // Detect old format (no Item ID): if r[0] looks like a title (not a system ID like 8157-PAP)
      const hasItemId = /^\d{4}-[A-Z]+/.test(r[0]);
      if (hasItemId) {
        bucket[key] = {
          row: key, itemNum: r[0]||'', title: r[1]||'', description: r[2]||'', year: r[3]||'',
          manufacturer: r[4]||'Lionel', condition: r[5]||'', quantity: r[6]||'1',
          estValue: r[7]||'', photoLink: r[8]||'', notes: r[9]||'', dateAcquired: r[10]||'',
        };
      } else {
        // Legacy row without Item ID
        bucket[key] = {
          row: key, itemNum: '', title: r[0]||'', description: r[1]||'', year: r[2]||'',
          manufacturer: r[3]||'Lionel', condition: r[4]||'', quantity: r[5]||'1',
          estValue: r[6]||'', photoLink: r[7]||'', notes: r[8]||'', dateAcquired: r[9]||'',
        };
      }
    });
  }
  // Catalogs have their own column layout
  (catRes.values || []).forEach((r, idx) => {
    // Skip header rows: first cell is 'Item ID', 'Type', or 'Catalogs'
    if (!r[0] || r[0] === 'Item ID' || r[0] === 'Type' || r[0] === 'Catalogs') return;
    const key = idx + 3;
    // Columns: ItemID(0) Type(1) Year(2) HasMailer(3) Condition(4) EstValue(5) DateAcq(6) Notes(7) PhotoLink(8)
    const catType = r[1]||'';
    const year = r[2]||'';
    const title = [year, catType, 'Catalog'].filter(Boolean).join(' ');
    state.ephemeraData.catalogs[key] = {
      row: key, itemNum: r[0]||'', title,
      catType, year, hasMailer: r[3]||'No',
      condition: r[4]||'', estValue: r[5]||'', dateAcquired: r[6]||'',
      notes: r[7]||'', photoLink: r[8]||'',
    };
  });
  parseEphemeraRows(paperRes.values, state.ephemeraData.paper);
  parseEphemeraRows(otherRes.values, state.ephemeraData.other);
  // Re-populate type filter now that ephemera data is loaded (only if already populated)
  if (typeof populateFilters === 'function' && document.getElementById('filter-type') &&
      document.getElementById('filter-type').options.length > 1) {
    document.getElementById('filter-type').innerHTML = '<option value="">All Types</option>';
    document.getElementById('filter-road').innerHTML = '<option value="">All Roads</option>';
    populateFilters();
  }

  // User-defined tabs â€” load their sheet data
  const _utPromises = (state.userDefinedTabs||[]).map(ut =>
    sheetsGet(sheetId, ut.label + '!A3:J').catch(() => ({values:[]}))
      .then(utRes => parseEphemeraRows(utRes.values, state.ephemeraData[ut.id]))
      .catch(() => {})
  );
  await Promise.all(_utPromises);

  // Mock-ups have extra fields
  (mockRes.values || []).forEach((r, idx) => {
    if (!r[0] || r[0] === 'Title') return;
    const key = idx + 3;
    state.ephemeraData.mockups[key] = {
      row: key, title: r[0]||'', itemNumRef: r[1]||'', description: r[2]||'',
      year: r[3]||'', manufacturer: r[4]||'Lionel', condition: r[5]||'',
      productionStatus: r[6]||'', material: r[7]||'', dimensions: r[8]||'',
      provenance: r[9]||'', lionelVerified: r[10]||'', estValue: r[11]||'',
      photoLink: r[12]||'', notes: r[13]||'', dateAcquired: r[14]||'',
    };
  });
}

// â”€â”€ BUILD APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildApp() {
  showApp();
  populateFilters();
  buildDashboard();
  buildBrowse();
  buildSoldPage();
  buildWantPage();
  buildReport();
  buildQuickEntryList();
}

function showLoading() {
  const tb = document.getElementById('browse-tbody');
  if (tb) tb.innerHTML = '<tr><td colspan="9"><div class="loading" style="padding:3rem;flex-direction:column;gap:0.75rem"><div class="spinner" style="width:36px;height:36px;border-width:3px"></div><div style="font-size:0.9rem;color:var(--text-dim)">Loading My Collection Appâ€¦</div><div style="font-size:0.75rem;color:var(--text-dim);opacity:0.7">Fetching master inventory</div></div></td></tr>';
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function buildDashboard() {
  const total = state.masterData.length;

  // Count ALL owned entries including box-only rows
  const allOwned = Object.values(state.personalData).filter(pd => {
    if (!pd.owned) return false;
    // Exclude pure box-only rows (has box but NO item condition AND NO item price)
    const condVal = pd.condition?.toString().trim();
    const priceVal = pd.priceItem?.toString().trim();
    const noCondition = !condVal || condVal === '' || condVal === 'N/A';
    const noItemPrice = !priceVal || priceVal === '' || priceVal === 'N/A';
    const isBoxOnly = pd.hasBox === 'Yes' && noCondition && noItemPrice;
    return !isBoxOnly; // count everything except pure box-only rows
  });
  const owned = allOwned.length;
  const pct = total > 0 ? Math.round((owned / total) * 100) : 0;

  let totalValue = 0, condSum = 0, condCount = 0, boxedCount = 0, origCount = 0;
  // Count value across ALL owned rows (items + boxes)
  const allOwnedEntries = Object.values(state.personalData).filter(pd => pd.owned);
  allOwnedEntries.forEach(pd => {
    if (pd.priceComplete) totalValue += parseFloat(pd.priceComplete) || 0;
    else if (pd.priceItem && pd.priceItem !== 'N/A') totalValue += parseFloat(pd.priceItem) || 0;
    else if (pd.priceBox) totalValue += parseFloat(pd.priceBox) || 0;
  });
  // Add ephemera values
  let ephemeraCount = 0;
  Object.values(state.ephemeraData || {}).forEach(bucket => {
    Object.values(bucket).forEach(item => {
      ephemeraCount++;
      if (item.estValue) totalValue += parseFloat(item.estValue) || 0;
    });
  });

  allOwned.forEach(pd => {
    if (pd.condition && pd.condition !== 'N/A') { const c = parseInt(pd.condition); if (!isNaN(c)) { condSum += c; condCount++; } }
    if (pd.hasBox === 'Yes') boxedCount++;
    if (pd.allOriginal === 'Yes') origCount++;
  });

  const totalOwned = owned + ephemeraCount;
  document.getElementById('stat-owned').textContent = totalOwned.toLocaleString();
  document.getElementById('stat-owned-pct').textContent = `${pct}% of catalog${ephemeraCount > 0 ? ' + ' + ephemeraCount + ' other' : ''}`;
  document.getElementById('stat-value').textContent = totalValue > 0 ? `$${Math.round(totalValue).toLocaleString()}` : 'â€”';

  // Market value â€” sum from master sheet marketVal for all owned items
  let totalMarketVal = 0;
  allOwnedEntries.forEach(function(pd) {
    const masterItem = state.masterData.find(function(m) {
      return m.itemNum === pd.itemNum && (!pd.variation || m.variation === pd.variation);
    }) || state.masterData.find(function(m) { return m.itemNum === pd.itemNum; });
    if (masterItem && masterItem.marketVal) {
      totalMarketVal += parseFloat(masterItem.marketVal) || 0;
    }
  });
  const mvEl = document.getElementById('stat-market-value');
  if (mvEl) mvEl.textContent = totalMarketVal > 0 ? '$' + Math.round(totalMarketVal).toLocaleString() : 'â€”';

  const soldCount = Object.keys(state.soldData).length;
  const wantCount = total - owned - soldCount;
  document.getElementById('nav-total').textContent = total.toLocaleString();
  document.getElementById('nav-owned').textContent = owned.toLocaleString();
  const wantListCount = Object.keys(state.wantData).length;
  document.getElementById('nav-wanted2').textContent = wantListCount.toLocaleString();
  // Quick Entry badge count
  const _qeCount = Object.values(state.personalData).filter(pd => pd.owned && pd.quickEntry).length;
  const _qeBadge = document.getElementById('nav-qe-count');
  if (_qeBadge) _qeBadge.textContent = _qeCount > 0 ? _qeCount : '0';
  const _mnavQeBadge = document.getElementById('mnav-qe-badge');
  if (_mnavQeBadge) { if (_qeCount > 0) { _mnavQeBadge.style.display='flex'; _mnavQeBadge.textContent=_qeCount; } else { _mnavQeBadge.style.display='none'; } }
  if (document.getElementById('nav-sold')) document.getElementById('nav-sold').textContent = soldCount;


  // Recent Additions â€” last 5 owned items including ephemera, by row order
  const _recentTrains = Object.values(state.personalData)
    .filter(pd => pd.owned)
    .map(pd => ({ ...pd, _src: 'train' }));
  const _recentEph = [];
  const _ephEmojiMap = { catalogs:'ðŸ“’', paper:'ðŸ“„', mockups:'ðŸ”©', other:'ðŸ“¦' };
  Object.entries(state.ephemeraData || {}).forEach(([tabId, bucket]) => {
    Object.values(bucket).forEach(it => {
      const emoji = _ephEmojiMap[tabId] || 'â­';
      const label = it.catType ? it.catType + ' Catalog' : tabId;
      _recentEph.push({ ...it, _src:'eph', tabId, _ephEmoji: emoji, _ephLabel: label });
    });
  });
  const _recentOwned = [..._recentTrains, ..._recentEph]
    .sort((a, b) => (b.row || 0) - (a.row || 0))
    .slice(0, 5);
  const _recentEl = document.getElementById('recent-list');
  if (_recentEl) {
    _recentEl.innerHTML = _recentOwned.length ? _recentOwned.map(function(pd) {
      if (pd._src === 'eph') {
        const val = pd.estValue ? '$' + parseFloat(pd.estValue).toLocaleString() : '';
        const meta = [pd.year, val].filter(Boolean).join(' Â· ');
        return '<div onclick="goToMyCollection()" class="dash-row-hover" style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0;border-bottom:1px solid var(--border);cursor:pointer">'
          + '<span style="font-size:1.1rem;flex-shrink:0">' + pd._ephEmoji + '</span>'
          + '<div style="flex:1;min-width:0">'
          + '<div style="font-size:0.85rem;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + (pd.title || 'â€”') + '</div>'
          + (meta ? '<div style="font-size:0.7rem;color:var(--text-dim);margin-top:1px">' + meta + '</div>' : '')
          + '</div>'
          + '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--text-dim)" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>'
          + '</div>';
      }
      const master = state.masterData.find(function(m) {
        return normalizeItemNum(m.itemNum) === normalizeItemNum(pd.itemNum);
      });
      const name = master ? (master.roadName || master.itemType || pd.itemNum) : pd.itemNum;
      const price = pd.priceItem ? '$' + parseFloat(pd.priceItem).toLocaleString() : '';
      const date = pd.datePurchased || '';
      const meta = [date, price].filter(Boolean).join(' Â· ');
      return '<div onclick="goToMyCollection()" style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.1s" '
        + 'class="dash-row-hover">'
        + '<div style="flex:1;min-width:0">'
        + '<div style="display:flex;align-items:center;gap:0.4rem">'
        + '<span class="item-num">' + pd.itemNum + (pd.variation ? ' <span style="font-size:0.7rem;color:var(--text-dim)">' + pd.variation + '</span>' : '') + '</span>'
        + '<span style="font-size:0.8rem;color:var(--text-mid);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + name + '</span>'
        + '</div>'
        + (meta ? '<div style="font-size:0.7rem;color:var(--text-dim);margin-top:1px">' + meta + '</div>' : '')
        + '</div>'
        + '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--text-dim)" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>'
        + '</div>';
    }).join('')
    : '<div style="padding:1rem 0"><div style="font-size:2rem;margin-bottom:0.5rem">&#128075;</div><div style="font-weight:600;font-size:0.95rem;margin-bottom:0.4rem">Welcome to My Collection App!</div><div style="font-size:0.82rem;color:var(--text-dim);line-height:1.6;margin-bottom:1rem">Start building your collection record. Tap Add Item to log your first piece.</div><button onclick="startWizardFor(\'collection\')" style="width:100%;padding:0.75rem;border-radius:10px;border:none;background:var(--accent);color:white;font-family:var(--font-body);font-size:0.95rem;font-weight:600;cursor:pointer">+ Add My First Item</button></div>';
  }

  // Want list preview â€” built from wantData directly to avoid master-data duplicates
  const _wPriOrder = { High: 0, Medium: 1, Low: 2 };
  const _wEntries = Object.values(state.wantData)
    .sort((a, b) => (_wPriOrder[a.priority] ?? 1) - (_wPriOrder[b.priority] ?? 1))
    .slice(0, 6);
  const _wPriColor = { High: 'var(--accent)', Medium: 'var(--accent2)', Low: 'var(--text-dim)' };
  document.getElementById('want-preview').innerHTML = _wEntries.length ? _wEntries.map(function(w) {
    const master = state.masterData.find(function(m) { return m.itemNum === w.itemNum; });
    const name = master ? (master.roadName || master.itemType || w.itemNum) : w.itemNum;
    const pc = _wPriColor[w.priority] || 'var(--text-dim)';
    const price = w.expectedPrice ? '$' + parseFloat(w.expectedPrice).toLocaleString() : '';
    return '<div onclick="goToWantList()" style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.1s" '
      + 'class="dash-row-hover">'
      + '<div style="flex:1;min-width:0">'
      + '<div style="display:flex;align-items:center;gap:0.4rem">'
      + '<span class="item-num">' + w.itemNum + (w.variation ? ' <span style="font-size:0.7rem;color:var(--text-dim)">' + w.variation + '</span>' : '') + '</span>'
      + '<span style="font-size:0.8rem;color:var(--text-mid);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1">' + name + '</span>'
      + '</div>'
      + (price ? '<div style="font-size:0.7rem;color:var(--text-dim);margin-top:1px">' + price + '</div>' : '')
      + '</div>'
      + '<span style="font-size:0.62rem;font-weight:600;color:' + pc + ';border:1px solid ' + pc + ';border-radius:3px;padding:0.1rem 0.3rem;flex-shrink:0">' + (w.priority||'Med') + '</span>'
      + '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--text-dim)" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>'
      + '</div>';
  }).join('') : '<div class="empty-state"><p>Want list is empty</p></div>';
}

// â”€â”€ BROWSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function populateFilters() {
  const types = [...new Set(state.masterData.map(i => i.itemType).filter(Boolean))].sort();
  const roads = [...new Set(state.masterData.map(i => i.roadName).filter(Boolean))].sort();

  const typeEl = document.getElementById('filter-type');
  types.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; typeEl.appendChild(o); });

  // Add ephemera types as a group
  const ephemeraTypes = ['Catalog','Paper Item','Mock-Up','Other Lionel'];
  // Also add catalog sub-types actually present in data
  const catSubTypes = [...new Set(
    Object.values(state.ephemeraData.catalogs||{}).map(it=>it.catType).filter(Boolean)
  )].sort();
  const hasCatalogs = Object.keys(state.ephemeraData.catalogs||{}).length > 0;
  const hasOtherEph = ['paper','mockups','other'].some(k => Object.keys(state.ephemeraData[k]||{}).length > 0);
  const userEph = (state.userDefinedTabs||[]).filter(t => Object.keys(state.ephemeraData[t.id]||{}).length > 0);

  // Always add a separator then ephemera/collection categories
  const sep = document.createElement('option');
  sep.disabled = true; sep.textContent = 'â”€â”€ My Collection â”€â”€';
  typeEl.appendChild(sep);
  // Catalog with subtypes
  const oCat = document.createElement('option'); oCat.value = 'Catalog'; oCat.textContent = 'ðŸ“’ Catalogs (all)'; typeEl.appendChild(oCat);
  catSubTypes.forEach(ct => {
    const o2 = document.createElement('option'); o2.value = ct; o2.textContent = '  ' + ct + ' Catalog'; typeEl.appendChild(o2);
  });
  const oPaper = document.createElement('option'); oPaper.value = 'Paper Item'; oPaper.textContent = 'ðŸ“„ Paper Items'; typeEl.appendChild(oPaper);
  const oMock = document.createElement('option'); oMock.value = 'Mock-Up'; oMock.textContent = 'ðŸ”© Mock-Ups'; typeEl.appendChild(oMock);
  const oOther = document.createElement('option'); oOther.value = 'Other Lionel'; oOther.textContent = 'ðŸ“¦ Other Lionel'; typeEl.appendChild(oOther);
  const oIS = document.createElement('option'); oIS.value = 'Instruction Sheet'; oIS.textContent = 'ðŸ“‹ Instruction Sheets'; typeEl.appendChild(oIS);
  userEph.forEach(t => {
    const o = document.createElement('option'); o.value = t.label; o.textContent = 'â­ ' + t.label; typeEl.appendChild(o);
  });

  const roadEl = document.getElementById('filter-road');
  roads.slice(0, 80).forEach(r => { const o = document.createElement('option'); o.value = r; o.textContent = r; roadEl.appendChild(o); });
}

function applyFilters() {
  state.filters.type = document.getElementById('filter-type').value;
  state.filters.quickEntry = ''; // QE filter only applies in My Collection view
  state.filters.road = document.getElementById('filter-road').value;
  state.filters.wantList = false;
  state.currentPage = 1;
  renderBrowse();
}

function toggleFilter(name) {
  state.filters[name] = !state.filters[name];
  document.getElementById('toggle-' + name).classList.toggle('on', state.filters[name]);
  state.currentPage = 1;
  renderBrowse();
}

function resetFilters() {
  removeQEFilter();
  state.filters.owned = false;
  state.filters.unowned = false;
  state.filters.boxed = false;
  state.filters.wantList = false;
  state.filters.type = '';
  state.filters.road = '';
  state.filters.quickEntry = '';
  state.currentPage = 1;
  document.getElementById('filter-type').value = '';
  document.getElementById('filter-road').value = '';
}

function filterOwned(qe) {
  resetFilters();
  state.filters.owned = true;
  if (qe) state.filters.quickEntry = qe;
  renderBrowse();
  // Show QE filter toggle in filter bar when in My Collection
  setTimeout(function() {
    var existing = document.getElementById('filter-quick-inline');
    if (!existing) {
      var fb = document.querySelector('.filter-bar');
      if (!fb) return;
      var sel = document.createElement('select');
      sel.id = 'filter-quick-inline';
      sel.className = 'filter-select';
      sel.title = 'Quick Entry filter';
      sel.innerHTML = '<option value="">All Items</option>'
        + '<option value="quick">&#9889; Quick Entry</option>'
        + '<option value="complete">&#10003; Complete</option>';
      sel.value = state.filters.quickEntry || '';
      sel.onchange = function() { state.filters.quickEntry = this.value; renderBrowse(); };
      // Insert after first child (type filter)
      var typeFilter = fb.querySelector('#filter-type');
      if (typeFilter && typeFilter.nextSibling) {
        fb.insertBefore(sel, typeFilter.nextSibling);
      } else {
        fb.appendChild(sel);
      }
    }
  }, 50);
}

function removeQEFilter() {
  var el = document.getElementById('filter-quick-inline');
  if (el) el.remove();
  state.filters.quickEntry = '';
}

function buildQuickEntryList() {
  const container = document.getElementById('qe-list-container');
  if (!container) return;

  const qeItems = Object.values(state.personalData)
    .filter(pd => pd.owned && pd.quickEntry)
    .sort((a, b) => (b.row || 0) - (a.row || 0));

  if (qeItems.length === 0) {
    container.innerHTML = '<div class="empty-state" style="padding:3rem 1rem">'
      + '<div style="font-size:3rem;margin-bottom:0.75rem">&#9889;</div>'
      + '<div style="font-weight:600;font-size:1rem;margin-bottom:0.4rem">No quick entries yet</div>'
      + '<div style="font-size:0.85rem;color:var(--text-dim);line-height:1.6">When you add an item using Quick Entry, it will appear here so you can come back and fill in the details.</div>'
      + '</div>';
    return;
  }

  // Update badge
  const badge = document.getElementById('nav-qe-count');
  if (badge) badge.textContent = qeItems.length;

  var gridEl = document.createElement('div');
  gridEl.style.cssText = 'display:flex;flex-direction:column;gap:0.5rem';
    qeItems.forEach(function(pd) {
    var master = state.masterData.find(function(m) {
      return m.itemNum === pd.itemNum && (!pd.variation || m.variation === pd.variation);
    }) || state.masterData.find(function(m) { return m.itemNum === pd.itemNum; });
    var itemName = master ? (master.roadName || master.description || master.itemType || '') : '';
    var itemType = master ? (master.itemType || '') : '';
    var itemYear = master ? (master.yearProd || '') : '';
    var variation = pd.variation || '';
    var meta = [itemType, itemYear].filter(Boolean).join(' Â· ');

    var row = document.createElement('div');
    row.style.cssText = 'display:flex;align-items:center;gap:0.85rem;padding:0.9rem 1rem;background:var(--surface);border:1.5px solid rgba(39,174,96,0.3);border-radius:12px;cursor:pointer;transition:all 0.15s';
    row.onmouseenter = function() { this.style.borderColor='#27ae60'; this.style.background='rgba(39,174,96,0.06)'; };
    row.onmouseleave = function() { this.style.borderColor='rgba(39,174,96,0.3)'; this.style.background='var(--surface)'; };
    row.onclick = (function(num, vari) { return function() {
      // Find the pdKey for this item and open its detail panel
      var prefix = num + '|' + vari + '|';
      var exact = Object.keys(state.personalData).find(function(k) { return k.startsWith(prefix); });
      if (!exact) { exact = Object.keys(state.personalData).find(function(k) { return k.startsWith(num + '|'); }); }
      if (exact) { showOwnedItemMenu(-1, exact); }
    }; })(pd.itemNum, variation);

    var icon = document.createElement('div');
    icon.style.cssText = 'background:rgba(39,174,96,0.12);border-radius:8px;padding:0.5rem;flex-shrink:0';
    icon.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#27ae60" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';

    var info = document.createElement('div');
    info.style.cssText = 'flex:1;min-width:0';

    var topRow = document.createElement('div');
    topRow.style.cssText = 'display:flex;align-items:baseline;gap:0.5rem;flex-wrap:wrap';
    var numSpan = document.createElement('span');
    numSpan.style.cssText = 'font-family:var(--font-mono);font-weight:700;color:var(--accent2);font-size:1rem';
    numSpan.textContent = pd.itemNum;
    topRow.appendChild(numSpan);
    if (variation) {
      var varSpan = document.createElement('span');
      varSpan.style.cssText = 'font-size:0.75rem;color:var(--text-dim);background:var(--surface2);padding:0.1rem 0.4rem;border-radius:4px';
      varSpan.textContent = variation;
      topRow.appendChild(varSpan);
    }
    info.appendChild(topRow);

    if (itemName) {
      var nameEl = document.createElement('div');
      nameEl.style.cssText = 'font-size:0.85rem;color:var(--text-mid);margin-top:0.15rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis';
      nameEl.textContent = itemName;
      info.appendChild(nameEl);
    }
    if (meta) {
      var metaEl = document.createElement('div');
      metaEl.style.cssText = 'font-size:0.75rem;color:var(--text-dim);margin-top:0.1rem';
      metaEl.textContent = meta;
      info.appendChild(metaEl);
    }

    var right = document.createElement('div');
    right.style.cssText = 'flex-shrink:0;text-align:right';
    right.innerHTML = '<div style="font-size:0.72rem;color:#27ae60;font-weight:600;background:rgba(39,174,96,0.1);padding:0.25rem 0.5rem;border-radius:5px;margin-bottom:0.3rem;white-space:nowrap">Needs info</div>'
      + '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-dim)" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>';

    row.appendChild(icon);
    row.appendChild(info);
    row.appendChild(right);
    gridEl.appendChild(row);
  });
  var footer = document.createElement('div');
  footer.style.cssText = 'margin-top:1rem;padding:0.75rem 1rem;background:rgba(39,174,96,0.06);border-radius:10px;border:1px solid rgba(39,174,96,0.2);font-size:0.82rem;color:var(--text-dim);text-align:center';
  footer.textContent = qeItems.length + ' item' + (qeItems.length !== 1 ? 's' : '') + ' waiting for details â€” tap any item to open and complete it.';

  container.innerHTML = '';
  container.appendChild(gridEl);
  container.appendChild(footer);
}

function goToMyCollection() {
  const navBtn = document.querySelector('.nav-item[onclick*="filterOwned"]');
  showPage('browse', navBtn);
  filterOwned();
  // mobile
  const mNav = document.getElementById('mnav-browse');
  if (mNav && window.innerWidth <= 640) { showPage('browse', mNav); filterOwned(); }
}
function goToWantList() {
  const navBtn = document.querySelector('.nav-item[onclick*="buildWantPage"]');
  showPage('want', navBtn);
  buildWantPage();
  const mNav = document.getElementById('mnav-want');
  if (mNav && window.innerWidth <= 640) { showPage('want', mNav); buildWantPage(); }
}

function renderOwnedItems() {
  // Build a unified list: masterData matches + personal-only items (e.g. 2343-P)
  const masterOwned = state.masterData.filter(item => {
    const pd = findPD(item.itemNum, item.variation);
    return pd?.owned;
  });
  // Personal items with no master match
  const masterNums = new Set(state.masterData.map(m => m.itemNum + '|' + (m.variation||'')));
  const personalOnly = Object.values(state.personalData).filter(pd => {
    if (!pd.owned) return false;
    return !masterNums.has(pd.itemNum + '|' + (pd.variation||''));
  });
  return { masterOwned, personalOnly };
}
function filterWanted() {
  resetFilters();
  state.filters.wantList = true;
  renderBrowse();
}
function filterByType(type) { document.getElementById('filter-type').value = type; showPage('browse'); applyFilters(); }

function onPageSearch(val, page) {
  const q = val.toLowerCase();
  if (page === 'browse') {
    state.filters.search = q;
    state.currentPage = 1;
    renderBrowse();
  } else if (page === 'sold') {
    state._soldSearch = q;
    buildSoldPage();
  } else if (page === 'want') {
    state._wantSearch = q;
    buildWantPage();
  }
}

function buildBrowse() { renderBrowse(); }

let _lastBrowseHash = '';

function renderBrowse() {
  const { type, road, owned, unowned, boxed, search } = state.filters;
  // Base list: masterData + any personal-only items (e.g. 2343-P not in master)
  const masterNums = new Set(state.masterData.map(m => m.itemNum + '|' + (m.variation||'')));
  const personalOnlyItems = Object.values(state.personalData)
    .filter(pd => pd.owned && !masterNums.has(pd.itemNum + '|' + (pd.variation||'')))
    .map(pd => ({
      itemNum: pd.itemNum, variation: pd.variation || '', itemType: pd.itemType || 'Diesel Locomotive',
      roadName: pd.roadName || '', description: pd.notes || '', yearProd: pd.datePurchased || '',
      marketVal: '', refLink: '', _personalOnly: true // market value from master sheet only
    }));
  const baseList = owned ? [...state.masterData, ...personalOnlyItems] : state.masterData;

  state.filteredData = baseList.filter(item => {
    const pd = findPD(item.itemNum, item.variation) || (item._personalOnly ? item : null);
    const isOwned = item._personalOnly ? true : (pd?.owned || false);
    const hasBox = pd?.hasBox === 'Yes';
    const isSold = !!state.soldData[`${item.itemNum}|${item.variation}`];
    if (isSold) return false;
    const isWanted = !!state.wantData[`${item.itemNum}|${item.variation}`];
    if (state.filters.wantList && !isWanted) return false;
    if (owned && !isOwned) return false;
    if (unowned && (isOwned || isWanted)) return false;
    if (boxed && !hasBox) return false;
    // Quick Entry filter â€” only applies when item is owned
    if (isOwned && pd) {
      const _qf = state.filters.quickEntry || '';
      if (_qf === 'quick' && !pd.quickEntry) return false;
      if (_qf === 'complete' && pd.quickEntry) return false;
    }
    // If type filter is an ephemera category, hide train rows
    if (type) {
      const _ephTypeKeys = ['Catalog','Paper Item','Mock-Up','Other Lionel',
        ...(state.userDefinedTabs||[]).map(t=>t.label)];
      // Check for catalog subtype match too (e.g. "Advance")
      const _isEphFilter = _ephTypeKeys.some(k=>k.toLowerCase()===type.toLowerCase())
        || type.toLowerCase() === 'instruction sheet'
        || Object.values(state.ephemeraData.catalogs||{}).some(it=>(it.catType||'').toLowerCase()===type.toLowerCase());
      if (_isEphFilter) return false; // hide all train rows when filtering to ephemera
      if (item.itemType !== type) return false;
    }
    if (road && item.roadName !== road) return false;
    if (search) {
      const haystack = `${item.itemNum} ${item.roadName||''} ${item.description||''} ${item.itemType||''}`.toLowerCase();
      if (!haystack.includes(search)) return false;
    }
    return true;
  });

  const total = state.filteredData.length;
  const pages = Math.ceil(total / state.pageSize);
  const start = (state.currentPage - 1) * state.pageSize;
  const pageData = state.filteredData.slice(start, start + state.pageSize);

  // Ephemera items â€” shown when owned filter is on OR search has text OR type filter matches an ephemera category
  const _ephemeraRows = [];
  const _ephLabels = { catalogs:'Catalog', paper:'Paper Item', mockups:'Mock-Up', other:'Other Lionel' };
  const _ephEmojis = { catalogs:'ðŸ“’', paper:'ðŸ“„', mockups:'ðŸ”©', other:'ðŸ“¦' };
  const _ephColors = { catalogs:'#e67e22', paper:'#3498db', mockups:'#9b59b6', other:'#27ae60' };
  const _ephTypeMap = { 'Catalog':'catalogs', 'Paper Item':'paper', 'Mock-Up':'mockups', 'Other Lionel':'other' };
  const sq = (state.filters.search||'').toLowerCase();
  const tf = (state.filters.type||'').toLowerCase();
  // Show ephemera if: owned view, searching, or type filter is an ephemera category
  const _showEph = state.filters.owned || sq || Object.keys(_ephTypeMap).some(k => k.toLowerCase() === tf);
  // Instruction Sheets in browse
  if (_showEph || tf === 'instruction sheet') {
    const isItems = Object.values(state.isData || {});
    const isFiltered = isItems.filter(it => {
      if (sq && !`${it.sheetNum||''} ${it.linkedItem||''} ${it.year||''} ${it.notes||''}`.toLowerCase().includes(sq)) return false;
      if (tf && tf !== 'instruction sheet' && tf !== 'catalog') {
        // Check linked item match
        if (!(it.linkedItem||'').toLowerCase().includes(tf) && !(it.sheetNum||'').toLowerCase().includes(tf)) return false;
      }
      return true;
    });
    if (isFiltered.length) {
      _ephemeraRows.push({ _divider: true, label: 'ðŸ“‹ Instruction Sheets', color: '#16a085' });
      isFiltered.sort((a,b)=>(a.linkedItem||'').localeCompare(b.linkedItem||'')).forEach(it => {
        _ephemeraRows.push({ _is: true, item: it, label:'Instruction Sheet', emoji:'ðŸ“‹', color:'#16a085' });
      });
    }
  }
  if (_showEph) {
    Object.entries(state.ephemeraData || {}).forEach(([tabId, bucket]) => {
      const items = Object.values(bucket);
      if (!items.length) return;
      const label = _ephLabels[tabId] || ((state.userDefinedTabs||[]).find(t=>t.id===tabId)||{}).label || tabId;
      const emoji = _ephEmojis[tabId] || 'â­';
      const color = _ephColors[tabId] || '#f39c12';
      // Type filter: if a specific ephemera type is selected, only show that bucket
      if (tf && Object.keys(_ephTypeMap).some(k=>k.toLowerCase()===tf) && label.toLowerCase() !== tf) return;
      // Also filter by catType if type filter matches a subtype like "Advance", "Consumer"
      const filtered = items.filter(it => {
        // Search filter across all fields
        if (sq && !`${it.title||''} ${it.year||''} ${it.notes||''} ${it.catType||''} ${label}`.toLowerCase().includes(sq)) return false;
        // Type dropdown filter â€” match label (Catalog) or catType (Advance/Consumer/Dealer)
        if (tf) {
          const matchesLabel = label.toLowerCase().includes(tf);
          const matchesCatType = (it.catType||'').toLowerCase().includes(tf);
          if (!matchesLabel && !matchesCatType) return false;
        }
        return true;
      });
      if (!filtered.length) return;
      _ephemeraRows.push({ _divider: true, label: emoji + ' ' + label + 's', color });
      filtered.sort((a,b)=>(b.row||0)-(a.row||0)).forEach(it => {
        _ephemeraRows.push({ _eph: true, tabId, item: it, label, emoji, color });
      });
    });
  }
  const ephTotal = _ephemeraRows.filter(r=>r._eph).length;
  const displayTotal = total + ephTotal;
  document.getElementById('result-count').textContent = `${displayTotal.toLocaleString()} items`;
  document.getElementById('page-info').textContent = `Showing ${start+1}â€“${Math.min(start+state.pageSize, total)} of ${total.toLocaleString()} trains${ephTotal ? ' + ' + ephTotal + ' other' : ''}`;

  // Rows
  const tbody = document.getElementById('browse-tbody');
  const isMobile = window.innerWidth <= 640;
  const cardsEl = document.getElementById('browse-cards');
  const tableEl = document.querySelector('.item-table');
  let _ephRowsHtml = '';
  if (_ephemeraRows.length) {
    _ephRowsHtml = _ephemeraRows.map(r => {
      if (r._divider) return `<tr><td colspan="9" style="padding:0.5rem 0.75rem;background:var(--surface2);font-size:0.72rem;font-weight:600;letter-spacing:0.1em;color:${r.color};text-transform:uppercase;border-top:2px solid ${r.color}33">${r.label}</td></tr>`;
      const it = r.item;
      const cond = it.condition ? parseInt(it.condition) : null;
      const condClass = cond >= 9 ? 'cond-9' : cond >= 7 ? 'cond-7' : cond >= 5 ? 'cond-5' : cond ? 'cond-low' : '';
      if (r._is) {
        return `<tr onclick="openISDetail(${it.row})" style="cursor:pointer">
          <td><span style="font-family:var(--font-mono);font-size:0.85rem;color:#16a085;font-weight:600">${it.sheetNum}</span></td>
          <td><span class="tag" style="border-color:#16a085;color:#16a085;background:#16a08518">Instr. Sheet</span></td>
          <td>For item #${it.linkedItem || 'â€”'}</td>
          <td>${it.year || 'â€”'}</td>
          <td></td><td></td>
          <td><span class="owned-badge badge-owned">âœ“ Owned</span></td>
          <td>${cond ? `<span class="condition-pip ${condClass}"></span>${cond}` : '<span class="text-dim">â€”</span>'}</td>
          <td class="market-val">â€”</td>
        </tr>`;
      }
      const val = it.estValue ? '$' + parseFloat(it.estValue).toLocaleString() : 'â€”';
      const _itmId = it.itemNum ? `<span style="font-family:var(--font-mono);font-size:0.78rem;color:${r.color};opacity:0.75;font-style:italic">${it.itemNum}</span>` : r.emoji;
      return `<tr onclick="openEphemeraDetail('${r.tabId}',${it.row})" style="cursor:pointer">
        <td>${_itmId}</td>
        <td><span class="tag" style="border-color:${r.color};color:${r.color};background:${r.color}18">${r.label}</span></td>
        <td>${it.title || 'â€”'}</td>
        <td>${it.catType || it.year || 'â€”'}</td>
        <td style="color:var(--text-dim);font-size:0.8rem">${it.year || 'â€”'}</td>
        <td>${it.year || 'â€”'}</td>
        <td><span class="owned-badge badge-owned">âœ“ Owned</span></td>
        <td>${cond ? `<span class="condition-pip ${condClass}"></span>${cond}` : '<span class="text-dim">â€”</span>'}</td>
        <td class="market-val">${val}</td>
      </tr>`;
    }).join('');
  }

  if (isMobile) {
    if (tableEl) tableEl.style.display = 'none';
    if (cardsEl) cardsEl.style.display = 'flex';
  } else {
    if (tableEl) tableEl.style.display = '';
    if (cardsEl) cardsEl.style.display = 'none';
  }

  const rowsHtml = pageData.map((item, i) => {
    const pd = item._personalOnly ? item : findPD(item.itemNum, item.variation);
    const isOwned = item._personalOnly ? true : (pd?.owned || false);
    const isWanted = !!state.wantData[`${item.itemNum}|${item.variation}`];
    const cond = pd?.condition ? parseInt(pd.condition) : null;
    const condClass = cond >= 9 ? 'cond-9' : cond >= 7 ? 'cond-7' : cond >= 5 ? 'cond-5' : cond ? 'cond-low' : '';
    let globalIdx = state.masterData.indexOf(item);
    // For _personalOnly items not in masterData, use negative index via global array
    if (globalIdx < 0 && item._personalOnly) {
      const poKey = findPDKey(item.itemNum, item.variation);
      if (poKey) {
        if (!window._poKeys) window._poKeys = [];
        let poIdx = window._poKeys.indexOf(poKey);
        if (poIdx < 0) poIdx = window._poKeys.push(poKey) - 1;
        globalIdx = -(poIdx + 1000);
      }
    }
    const badgeClass = isOwned ? 'yes' : isWanted ? 'want' : 'no';
    const badgeText  = isOwned ? 'âœ“ Owned' : isWanted ? 'â˜… Want' : 'â€”';
    const marketVal  = item.marketVal ? '$' + parseFloat(item.marketVal).toLocaleString() : '';

    if (isMobile) {
      return `<div class="browse-card" onclick="browseRowClick(event,${globalIdx})">
        <div class="browse-card-left">
          <div class="browse-card-num">${item.itemNum}${item.variation ? ' <span style="font-size:0.75rem;color:var(--text-dim)">${item.variation}</span>' : ''}</div>
          <div class="browse-card-name">${item.roadName || item.itemType || 'â€”'}</div>
          <div class="browse-card-sub">${[item.itemType, item.yearProd].filter(Boolean).join(' Â· ')}${pd?.matchedTo ? ' Â· <span style="color:var(--accent2)">' + (isTender(item.itemNum)?'ðŸš‚':'ðŸšƒ') + ' ' + pd.matchedTo + '</span>' : ''}${pd?.setId ? ' Â· <span style="color:#a855f7;font-size:0.7rem">ðŸ”— ' + pd.setId.split('-').slice(0,2).join('-') + '</span>' : ''}</div>
        </div>
        <div class="browse-card-right">
          <span class="owned-badge ${badgeClass}">${badgeText}</span>
          ${cond ? `<span style="font-size:0.75rem"><span class="condition-pip ${condClass}"></span>${cond}</span>` : ''}
          ${marketVal ? `<span class="market-val" style="font-size:0.78rem">${marketVal}</span>` : ''}
          <span id="cam-${item.itemNum}-${item.variation||''}-m" style="font-size:0.85rem;display:none" onclick="event.stopPropagation();openPhotoFolder('${item.itemNum}','${pd&&pd.photoItem?pd.photoItem:''}')">ðŸ“·</span>
        </div>
      </div>`;
    } else {
      const vdShort = item.varDesc ? (item.varDesc.length > 28 ? item.varDesc.substring(0,28)+'â€¦' : item.varDesc) : '';
      const vdCell = vdShort
        ? `<span style="cursor:pointer;border-bottom:1px dashed var(--border);color:var(--text-mid)" onclick="event.stopPropagation();showVarDescPopup(${globalIdx})">${vdShort}</span>`
        : '<span class="text-dim">â€”</span>';
      const _isErrCar = pd && pd.isError;
      const _isQuick = pd && pd.quickEntry;
      return `<tr onclick="browseRowClick(event, ${globalIdx})" style="cursor:pointer${_isQuick ? ';opacity:0.78' : ''}" title="${_isErrCar ? 'âš  Error car: ' + (pd.errorDesc||'see notes') : _isQuick ? 'âš¡ Quick Entry â€” details not yet filled in' : ''}">
        <td>
          <span class="item-num">${item.itemNum}${_isErrCar ? '<sup style="color:var(--accent);font-size:0.65rem">*</sup>' : ''}${_isQuick ? ' <span style="font-size:0.6rem;background:#27ae60;color:#fff;border-radius:3px;padding:1px 4px;vertical-align:middle;font-weight:600">âš¡</span>' : ''}</span>
          <span id="cam-${item.itemNum}-${item.variation||''}" style="margin-left:5px;font-size:0.85rem;cursor:pointer;display:none" onclick="event.stopPropagation();openPhotoFolder('${item.itemNum}','${pd&&pd.photoItem?pd.photoItem:''}')" title="Open photo folder">ðŸ“·</span>
        </td>
        <td><span class="tag">${item.itemType || 'â€”'}</span></td>
        <td>${item.roadName || '<span class="text-dim">â€”</span>'}</td>
        <td>${item.variation || '<span class="text-dim">â€”</span>'}</td>
        <td>${vdCell}</td>
        <td class="text-dim">${item.yearProd || 'â€”'}</td>
        <td><span class="owned-badge ${badgeClass}">${badgeText}</span></td>
        <td>${cond ? `<span class="condition-pip ${condClass}"></span>${cond}` : '<span class="text-dim">â€”</span>'}</td>
        <td class="market-val">${item.marketVal ? '$' + parseFloat(item.marketVal).toLocaleString() : '<span class="text-dim">â€”</span>'}</td>
      </tr>`;
    }
  });

  const emptyHtml = isMobile
    ? '<div style="text-align:center;padding:3rem 1rem;color:var(--text-dim)"><div style="font-size:2.5rem;margin-bottom:0.5rem">ðŸ”</div><p>No items match your filters</p></div>'
    : '<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">ðŸ”</div><p>No items match your filters</p><p style="font-size:0.8rem;color:var(--text-dim);margin-top:0.25rem">Try clearing some filters</p></div></td></tr>';

  if (isMobile) {
    let _ephCardsHtml = '';
    if (_ephemeraRows.length) {
      _ephCardsHtml = _ephemeraRows.map(r => {
        if (r._divider) return '<div style="font-size:0.72rem;font-weight:600;letter-spacing:0.1em;color:'+r.color+';text-transform:uppercase;padding:0.6rem 0 0.2rem;border-top:2px solid '+r.color+'33;margin-top:0.5rem">'+r.label+'</div>';
        const it = r.item;
        const val = it.estValue ? '$'+parseFloat(it.estValue).toLocaleString() : '';
        return '<div class="browse-card" onclick="openEphemeraDetail(\"'+r.tabId+'\",'+it.row+')" style="border-left:3px solid '+r.color+';cursor:pointer">'
          +'<div class="browse-card-row"><span style="font-size:0.9rem">'+r.emoji+'</span>'
          +'<span class="browse-card-num" style="color:'+r.color+'">'+it.title+'</span>'
          +'<span class="owned-badge badge-owned" style="margin-left:auto">âœ“</span></div>'
          +'<div class="browse-card-sub">'+r.label+(it.year?' Â· '+it.year:'')+(val?' Â· '+val:'')+'</div>'
          +'</div>';
      }).join('');
    }
    if (cardsEl) cardsEl.innerHTML = (rowsHtml.join('') || emptyHtml) + _ephCardsHtml;
  } else {
    tbody.innerHTML = (rowsHtml.join('') || emptyHtml) + _ephRowsHtml;
  }
  // Async: check which owned items have photos and reveal their camera icons
  if (state.filters.owned) {
    pageData.forEach(function(item) {
      const pd2 = item._personalOnly ? item : findPD(item.itemNum, item.variation);
      if (!pd2 || !pd2.owned) return;
      const camEl = document.getElementById('cam-' + item.itemNum + '-' + (item.variation || ''));
      if (!camEl) return;
      if (pd2.photoItem) {
        driveGetFolderPhotos(pd2.photoItem).then(function(photos) {
          if (photos && photos.length > 0) {
            const c1 = document.getElementById('cam-' + item.itemNum + '-' + (item.variation || ''));
            const c2 = document.getElementById('cam-' + item.itemNum + '-' + (item.variation || '') + '-m');
            if (c1) c1.style.display = 'inline';
            if (c2) c2.style.display = 'inline';
          }
        });
      }
    });
  }

  // Pagination
  const paginEl = document.getElementById('pagination-btns');
  let btns = '';
  if (state.currentPage > 1) btns += `<button class="page-btn" onclick="goPage(${state.currentPage-1})">â€¹</button>`;
  const range = [1, ...Array.from({length: pages}, (_,i)=>i+1).filter(p => Math.abs(p - state.currentPage) <= 2), pages];
  [...new Set(range)].sort((a,b)=>a-b).forEach((p, i, arr) => {
    if (i > 0 && arr[i-1] < p - 1) btns += `<span style="padding:0 4px;color:var(--text-dim)">â€¦</span>`;
    btns += `<button class="page-btn ${p === state.currentPage ? 'active' : ''}" onclick="goPage(${p})">${p}</button>`;
  });
  if (state.currentPage < pages) btns += `<button class="page-btn" onclick="goPage(${state.currentPage+1})">â€º</button>`;
  paginEl.innerHTML = btns;
}

function goPage(p) { state.currentPage = p; renderBrowse(); document.getElementById('main-content').scrollTop = 0; }

// â”€â”€ BROWSE ROW CLICK â€” offer to add or view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPhotoWizard(itemNum, variation, pdKey) {
  // Open wizard on the photo step for an existing item
  const pd = state.personalData[pdKey] || {};
  wizard = {
    step: 0, tab: 'collection',
    data: { tab: 'collection', itemNum: itemNum, variation: variation,
            condition: pd.condition || '', allOriginal: pd.allOriginal || '',
            hasBox: pd.hasBox || '', _updatePdKey: pdKey, _photoOnly: true },
    steps: getSteps('collection'), matchedItem: null
  };
  document.getElementById('wizard-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  // Skip to the photosItem step
  const autoSkip = new Set(['tab','itemNum','variation','entryMode','condition','allOriginal','notOriginalDesc',
    'hasBox','boxCond','hasIS','is_sheetNum','is_condition','pricePaid','datePurchased','userEstWorth','yearMade',
    'tenderAllOriginal','tenderNotOriginalDesc','unit2AllOriginal','unit2NotOriginalDesc',
    'unit3AllOriginal','unit3NotOriginalDesc','wantTenderPhotos','tenderMatch','dieselSetQ','setMatch','setType',
    'unit2ItemNum','unit3ItemNum','setUnit2Num','setUnit3Num',
    'wantTogetherPhotos','photosTogether','boxOnly','wantBoxPhotos',
    'purchaseDate','photosBox']);
  while (wizard.step < wizard.steps.length - 1) {
    const s = wizard.steps[wizard.step];
    if (autoSkip.has(s.id) || (s.skipIf && s.skipIf(wizard.data))) wizard.step++;
    else break;
  }
  renderWizardStep();
}

async function openPhotoFolder(itemNum, storedLink) {
  if (storedLink) { window.open(storedLink, '_blank'); return; }
  try {
    const folderId = await driveEnsureItemFolder(itemNum);
    window.open(driveFolderLink(folderId), '_blank');
  } catch(e) { showToast('Could not open Drive folder'); }
}

function showOwnedItemMenu(idx, pdKey) {
  const pd = state.personalData[pdKey] || {};
  // For personalOnly items, build a minimal item object from pd
  const item = state.masterData[idx] || {
    itemNum: pd.itemNum, variation: pd.variation || '',
    roadName: pd.roadName || '', itemType: pd.itemType || '',
    yearProd: pd.yearMade || '', marketVal: '', // market value comes from master sheet only
  };
  const existing = document.getElementById('owned-action-menu');
  if (existing) existing.remove();

  const overlay = document.createElement('div');
  overlay.id = 'owned-action-menu';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1.5rem';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  const box = document.createElement('div');
  box.style.cssText = 'background:var(--surface);border:1px solid rgba(46,204,113,0.35);border-radius:16px;max-width:420px;width:100%;padding:1.75rem;position:relative';

  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'âœ•';
  closeBtn.style.cssText = 'position:absolute;top:0.75rem;right:0.75rem;background:none;border:none;color:var(--text-dim);font-size:1.1rem;cursor:pointer';
  closeBtn.onclick = function() { overlay.remove(); };
  box.appendChild(closeBtn);

  const hdr = document.createElement('div');
  hdr.style.cssText = 'font-family:var(--font-head);font-size:1rem;color:var(--green);margin-bottom:0.15rem';
  hdr.textContent = 'âœ“ In Your Collection';
  box.appendChild(hdr);
  const itemLbl = document.createElement('div');
  itemLbl.style.cssText = 'font-size:0.85rem;color:var(--text-mid);margin-bottom:0.1rem';
  itemLbl.textContent = 'No. ' + item.itemNum + (item.variation ? ' â€” Var. ' + item.variation : '') + (item.roadName ? ' Â· ' + item.roadName : '');
  box.appendChild(itemLbl);
  const condLbl = document.createElement('div');
  condLbl.style.cssText = 'font-size:0.75rem;color:var(--text-dim);margin-bottom:1.25rem';
  const parts = [];
  if (pd.condition) parts.push('Condition: ' + pd.condition + '/10');
  if (pd.priceItem || pd.priceComplete) parts.push('Paid: $' + (pd.priceComplete || pd.priceItem));
  if (pd.yearMade) parts.push('Year: ' + pd.yearMade);
  condLbl.textContent = parts.join(' Â· ') || item.yearProd || '';
  box.appendChild(condLbl);

  // Action buttons stacked
  const mkBtn = function(label, color, bg, handler) {
    const b = document.createElement('button');
    b.style.cssText = 'width:100%;padding:0.7rem 1rem;border-radius:9px;border:1.5px solid ' + color + ';color:' + color + ';background:' + bg + ';font-family:var(--font-body);font-size:0.9rem;font-weight:600;cursor:pointer;margin-bottom:0.5rem;text-align:left;display:flex;align-items:center;gap:0.5rem';
    b.innerHTML = label;
    b.onclick = handler;
    return b;
  };

  box.appendChild(mkBtn(
    '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg> Record a Sale',
    '#2ecc71', 'rgba(46,204,113,0.1)',
    function() { overlay.remove(); sellFromCollection(idx, pdKey); }
  ));
  box.appendChild(mkBtn(
    '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Update Info',
    '#2980b9', 'rgba(224,64,40,0.08)',
    function() { overlay.remove(); updateCollectionItem(idx, pdKey); }
  ));
  box.appendChild(mkBtn(
    '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg> View Item Details',
    'var(--text-dim)', 'var(--surface2)',
    function() { overlay.remove(); showItemPanel(idx, pdKey, 'view'); }
  ));

  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function sellFromCollection(idx, pdKey) {
  const item = state.masterData[idx];
  const pd = state.personalData[pdKey] || {};
  if (!item) return;
  // Open sell wizard pre-filled with item info
  wizard = { step: 0, tab: 'sold', data: {
    tab: 'sold',
    itemNum: item.itemNum,
    variation: item.variation || '',
    condition: pd.condition || '',
    _collectionPdKey: pdKey,
    _collectionRow: pd.row
  }, steps: getSteps('sold'), matchedItem: item };
  document.getElementById('wizard-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  // Skip tab, itemNum, variation steps
  const autoSkip = new Set(['tab', 'itemNum', 'variation', 'itemCategory']);
  while (wizard.step < wizard.steps.length - 1) {
    const s = wizard.steps[wizard.step];
    if (autoSkip.has(s.id) || (s.skipIf && s.skipIf(wizard.data))) wizard.step++;
    else break;
  }
  renderWizardStep();
}

function updateCollectionItem(idx, pdKey) {
  showItemPanel(idx, pdKey, 'edit');
}

function showItemPanel(idx, pdKey, mode) {
  const pd = state.personalData[pdKey] || {};
  const item = state.masterData[idx] || {
    itemNum: pd.itemNum, variation: pd.variation || '',
    roadName: pd.roadName || '', itemType: pd.itemType || '',
    yearProd: pd.yearMade || '', marketVal: '', // market value comes from master sheet only
    varDesc: '', description: '',
  };

  const existing = document.getElementById('item-panel-overlay');
  if (existing) existing.remove();

  const overlay = document.createElement('div');
  overlay.id = 'item-panel-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };

  const box = document.createElement('div');
  box.style.cssText = 'background:var(--surface);border:1px solid rgba(41,128,185,0.35);border-radius:16px;max-width:500px;width:100%;position:relative;max-height:92vh;display:flex;flex-direction:column;overflow:hidden';

  // Header
  const header = document.createElement('div');
  header.style.cssText = 'padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);flex-shrink:0';
  header.innerHTML = '<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:0.5rem">'
    + '<div>'
    + '<div style="font-family:var(--font-head);font-size:1rem;color:#2980b9">No. ' + item.itemNum + (item.variation ? ' <span style="color:var(--text-dim);font-size:0.75rem">Var. ' + item.variation + '</span>' : '') + '</div>'
    + '<div style="font-size:0.82rem;color:var(--text-mid);margin-top:2px">' + (item.roadName || item.itemType || '') + (item.yearProd ? ' Â· ' + item.yearProd : '') + '</div>'
    + '</div>'
    + '<button id="item-panel-close-btn" style="background:none;border:none;color:var(--text-dim);font-size:1.1rem;cursor:pointer;flex-shrink:0">âœ•</button>'
    + '</div>';
  box.appendChild(header);
  // Wire close btn now that header is in memory
  const _hdrClose = header.querySelector('#item-panel-close-btn');
  if (_hdrClose) _hdrClose.onclick = function() { overlay.remove(); };

  // Scrollable content â€” split into photos (permanent) + fields (re-rendered)
  const body = document.createElement('div');
  body.style.cssText = 'flex:1;overflow-y:auto;padding:0.75rem 1.5rem';
  const photoContainer = document.createElement('div');
  photoContainer.id = 'item-panel-photo-container';
  body.appendChild(photoContainer);
  const fieldsContainer = document.createElement('div');
  fieldsContainer.id = 'item-panel-fields-container';
  body.appendChild(fieldsContainer);

  const fields = [
    { label: 'Condition',     key: 'condition',     val: pd.condition || 'â€”',     type: 'number', min:1, max:10 },
    { label: 'All Original',  key: 'allOriginal',   val: pd.allOriginal || 'â€”',   type: 'select', options: ['Yes','No','Unknown'] },
    { label: 'Has Box',       key: 'hasBox',        val: pd.hasBox || 'â€”',        type: 'select', options: ['Yes','No'] },
    { label: 'Box Condition', key: 'boxCond',       val: pd.boxCond || 'â€”',       type: 'number', min:1, max:10 },
    { label: 'Price Paid ($)',key: 'priceItem',     val: pd.priceItem || 'â€”',     type: 'number' },
    { label: 'Est. Worth ($)',key: 'userEstWorth',  val: pd.userEstWorth || 'â€”',  type: 'number' },
    { label: 'Year Made',     key: 'yearMade',      val: pd.yearMade || 'â€”',      type: 'number', min:1945, max:1969 },
    { label: 'Date Purchased',key: 'datePurchased', val: pd.datePurchased || 'â€”', type: 'date' },
    { label: 'Notes',         key: 'notes',         val: pd.notes || 'â€”',         type: 'text' },
    ...(item.refLink ? [{ label: 'COTT Reference', key: null, val: item.refLink, type: 'link' }] : []),
    ...(item.errorDesc || pd.isError ? [{ label: 'Error', key: null, val: pd.errorDesc || 'â€”', type: 'readonly' }] : []),
  ];

  // â”€â”€ Photos section â”€â”€
  const photoSection = document.createElement('div');
  photoSection.id = 'item-panel-photos';
  photoSection.style.cssText = 'padding:0.75rem 0;border-bottom:1px solid var(--border);margin-bottom:0.25rem';

  // Header row with label + "Add Photos" button
  const photoHdr = document.createElement('div');
  photoHdr.style.cssText = 'display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem';
  photoHdr.innerHTML = '<span style="font-size:0.72rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.08em">Photos</span>';
  const addPhotoBtn = document.createElement('button');
  addPhotoBtn.style.cssText = 'font-size:0.72rem;padding:0.2rem 0.55rem;border-radius:5px;border:1px solid #2980b9;color:#2980b9;background:rgba(224,64,40,0.08);cursor:pointer;display:flex;align-items:center;gap:0.25rem';
  addPhotoBtn.innerHTML = 'ðŸ“· Add Photos';
  addPhotoBtn.onclick = function() {
    // Close this panel and open photo wizard for this item
    document.getElementById('item-panel-overlay').remove();
    openPhotoWizard(item.itemNum, pd.variation || item.variation || '', pdKey);
  };
  photoHdr.appendChild(addPhotoBtn);
  photoSection.appendChild(photoHdr);

  // Thumbnail row
  const thumbRow = document.createElement('div');
  thumbRow.id = 'item-panel-thumb-row';
  thumbRow.style.cssText = 'display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center';
  thumbRow.innerHTML = '<span style="font-size:0.75rem;color:var(--text-dim)">Loadingâ€¦</span>';
  photoSection.appendChild(thumbRow);

  // Folder link
  const folderLinkEl = document.createElement('div');
  folderLinkEl.id = 'item-panel-folder-link';
  folderLinkEl.style.cssText = 'margin-top:0.4rem;min-height:1.2rem';
  photoSection.appendChild(folderLinkEl);

  photoContainer.appendChild(photoSection);

  // Async load photos â€” use direct references (element not in DOM yet when IIFE fires)
  const _thumbRowRef = thumbRow;
  const _folderLinkRef = folderLinkEl;
  (async function() {
    const tr2 = _thumbRowRef;
    const fl2 = _folderLinkRef;
    try {
      // Wait for accessToken to be available (max 5s)
      let waited = 0;
      while (!accessToken && waited < 5000) {
        await new Promise(r => setTimeout(r, 200));
        waited += 200;
      }
      if (!accessToken) {
        if (tr2) tr2.innerHTML = '<span style="font-size:0.75rem;color:var(--text-dim)">Not signed in to Drive</span>';
        return;
      }

      let folderLink = pd.photoItem || '';
      if (!folderLink) {
        try { await driveEnsureSetup(); } catch(e) {}
        try {
          const folderId = await driveEnsureItemFolder(item.itemNum);
          folderLink = driveFolderLink(folderId);
        } catch(e) {}
      }

      // Show folder link
      if (fl2 && folderLink) {
        const a = document.createElement('a');
        a.href = folderLink; a.target = '_blank';
        a.style.cssText = 'font-size:0.72rem;color:#2980b9';
        a.textContent = 'ðŸ“ Open Drive Folder â†—';
        fl2.innerHTML = '';
        fl2.appendChild(a);
      }

      if (!tr2) return;

      const photos = await driveGetFolderPhotos(folderLink);

      if (photos === null) {
        tr2.innerHTML = '<span style="font-size:0.75rem;color:var(--text-dim)">Could not load photos â€” check Drive access</span>';
        return;
      }
      if (photos.length === 0) {
        tr2.innerHTML = '<span style="font-size:0.75rem;color:var(--text-dim);font-style:italic">No photos yet â€” tap Add Photos</span>';
        return;
      }

      // Sort: RSV first, then FV, then others
      const priority = function(name) {
        const n = (name || '').toUpperCase();
        if (n.includes('RSV')) return 0;
        if (n.includes('FV'))  return 1;
        if (n.includes('TV'))  return 2;
        if (n.includes('BV'))  return 3;
        return 9;
      };
      photos.sort(function(a,b) { return priority(a.name) - priority(b.name); });

      tr2.innerHTML = '';
      photos.forEach(function(p) {
        const isRSV = p.name.toUpperCase().includes('RSV');
        const a = document.createElement('a');
        a.href = p.view; a.target = '_blank';
        a.title = p.name.replace(/\.[^.]+$/, '');
        a.style.cssText = 'display:inline-block;border-radius:8px;overflow:hidden;border:2px solid '
          + (isRSV ? '#2980b9' : 'var(--border)') + ';flex-shrink:0';
        const img = document.createElement('img');
        img.style.cssText = 'width:80px;height:80px;object-fit:cover;display:block;background:var(--surface2)';
        img.alt = p.name.replace(/\.[^.]+$/, '').split(' ').pop();
        // Authenticated load using file ID
        loadDriveThumb(p.id, img, a);
        const lbl = document.createElement('div');
        lbl.style.cssText = 'font-size:0.55rem;text-align:center;padding:2px 0;background:var(--surface2);color:var(--text-dim);letter-spacing:0.03em';
        lbl.textContent = p.name.replace(/\.[^.]+$/, '').split(' ').pop();
        a.appendChild(img);
        a.appendChild(lbl);
        tr2.appendChild(a);
      });

    } catch(e) {
      console.error('Photo load error:', e);
      if (tr2) tr2.innerHTML = '<span style="font-size:0.75rem;color:var(--text-dim)">Could not load photos</span>';
    }
  })();

  // Track which field is being edited
  let editingKey = null;

  function renderFields(activeKey) {
    fieldsContainer.innerHTML = '';
    fields.forEach(function(f) {
      const row = document.createElement('div');
      row.style.cssText = 'display:flex;align-items:center;gap:0.75rem;padding:0.65rem 0;border-bottom:1px solid var(--border);min-height:44px';

      const lbl = document.createElement('div');
      lbl.style.cssText = 'font-size:0.75rem;color:var(--text-dim);width:120px;flex-shrink:0';
      lbl.textContent = f.label;

      const valWrap = document.createElement('div');
      valWrap.style.cssText = 'flex:1';

      if (mode === 'edit' && activeKey === f.key) {
        // Show input
        let inp;
        if (f.type === 'select') {
          inp = document.createElement('select');
          inp.style.cssText = 'width:100%;background:var(--bg);border:1px solid #2980b9;border-radius:6px;padding:0.4rem 0.6rem;color:var(--text);font-family:var(--font-body);font-size:0.9rem';
          f.options.forEach(function(o) {
            const opt = document.createElement('option');
            opt.value = o; opt.textContent = o;
            if (o === (pd[f.key] || '')) opt.selected = true;
            inp.appendChild(opt);
          });
        } else {
          inp = document.createElement('input');
          inp.type = f.type === 'text' ? 'text' : f.type;
          inp.value = pd[f.key] || '';
          if (f.min !== undefined) inp.min = f.min;
          if (f.max !== undefined) inp.max = f.max;
          inp.style.cssText = 'width:100%;background:var(--bg);border:1px solid #2980b9;border-radius:6px;padding:0.4rem 0.6rem;color:var(--text);font-family:var(--font-body);font-size:0.9rem;box-sizing:border-box';
        }
        inp.id = 'panel-inp-' + f.key;
        setTimeout(function() { if (inp) inp.focus(); }, 30);

        const doneBtn = document.createElement('button');
        doneBtn.textContent = 'âœ“';
        doneBtn.style.cssText = 'margin-left:0.4rem;padding:0.3rem 0.6rem;border-radius:6px;border:1px solid #2980b9;background:#2980b9;color:#fff;cursor:pointer;font-size:0.85rem;flex-shrink:0';
        doneBtn.onclick = function() {
          pd[f.key] = inp.value;
          f.val = inp.value || 'â€”';
          editingKey = null;
          renderFields(null);
        };

        const cancelInp = document.createElement('button');
        cancelInp.textContent = 'âœ•';
        cancelInp.style.cssText = 'margin-left:0.25rem;padding:0.3rem 0.5rem;border-radius:6px;border:1px solid var(--border);background:none;color:var(--text-dim);cursor:pointer;font-size:0.85rem;flex-shrink:0';
        cancelInp.onclick = function() { editingKey = null; renderFields(null); };

        const inpRow = document.createElement('div');
        inpRow.style.cssText = 'display:flex;align-items:center;gap:0;width:100%';
        inpRow.appendChild(inp);
        inpRow.appendChild(doneBtn);
        inpRow.appendChild(cancelInp);
        valWrap.appendChild(inpRow);

      } else if (f.type === 'link') {
        // External link â€” render as clickable anchor, no edit
        const a = document.createElement('a');
        a.href = f.val;
        a.target = '_blank';
        a.rel = 'noopener';
        a.style.cssText = 'font-size:0.85rem;color:#2980b9;text-decoration:none;display:inline-flex;align-items:center;gap:0.3rem';
        a.innerHTML = 'View on COTT <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15,3 21,3 21,9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>';
        valWrap.appendChild(a);
        row.appendChild(lbl);
        row.appendChild(valWrap);
        fieldsContainer.appendChild(row);
        return;
      } else if (f.type === 'readonly') {
        // Read-only value with accent color, no edit
        const valEl = document.createElement('span');
        valEl.style.cssText = 'font-size:0.85rem;color:var(--accent);font-style:italic';
        valEl.textContent = f.val && f.val !== 'â€”' ? f.val : 'â€”';
        valWrap.appendChild(valEl);
        row.appendChild(lbl);
        row.appendChild(valWrap);
        fieldsContainer.appendChild(row);
        return;
      } else {
        // Show value
        const valEl = document.createElement('span');
        valEl.style.cssText = 'font-size:0.88rem;color:' + (f.val && f.val !== 'â€”' ? 'var(--text)' : 'var(--text-dim)');
        valEl.textContent = f.val && f.val !== 'â€”' ? f.val : 'â€”';
        valWrap.appendChild(valEl);

        if (mode === 'edit') {
          const editBtn = document.createElement('button');
          editBtn.textContent = 'âœï¸';
          editBtn.title = 'Edit';
          editBtn.style.cssText = 'margin-left:0.5rem;padding:0.15rem 0.4rem;border-radius:5px;border:1px solid var(--border);background:none;cursor:pointer;font-size:0.75rem;color:var(--text-dim)';
          editBtn.onclick = function() { editingKey = f.key; renderFields(f.key); };
          valWrap.appendChild(editBtn);
        }
      }

      row.appendChild(lbl);
      row.appendChild(valWrap);
      fieldsContainer.appendChild(row);
    });
  }

  renderFields(null);

  // Instruction Sheets linked to this item
  const _liNum = (item.itemNum || '').replace(/-[PD]$/,'').trim();
  const _linkedIS = Object.values(state.isData || {}).filter(s => {
    const li = (s.linkedItem || '').trim();
    return li === _liNum || li === item.itemNum;
  });
  if (_linkedIS.length) {
    const isSection = document.createElement('div');
    isSection.style.cssText = 'margin-top:0.75rem;padding-top:0.75rem;border-top:2px solid rgba(22,160,133,0.3)';
    isSection.innerHTML = '<div style="font-size:0.72rem;font-weight:600;letter-spacing:0.1em;color:#16a085;text-transform:uppercase;margin-bottom:0.5rem">ðŸ“‹ Instruction Sheets</div>'
      + _linkedIS.map(s => `<div onclick="openISDetail(${s.row})" style="display:flex;align-items:center;gap:0.6rem;padding:0.45rem 0.5rem;border-radius:8px;cursor:pointer;transition:background 0.1s" class="dash-row-hover">
        <span style="font-family:var(--font-mono);font-size:0.85rem;color:#16a085;font-weight:600;min-width:80px">${s.sheetNum}</span>
        <span style="font-size:0.8rem;color:var(--text-mid)">${s.year||''}</span>
        ${s.condition?`<span style="font-size:0.78rem;color:var(--text-dim);margin-left:auto">Cond: ${s.condition}/10</span>`:''}
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="var(--text-dim)" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
      </div>`).join('');
    body.appendChild(isSection);
  }

  box.appendChild(body);

  // Footer buttons
  const footer = document.createElement('div');
  footer.style.cssText = 'padding:1rem 1.5rem;border-top:1px solid var(--border);display:flex;gap:0.6rem;flex-shrink:0';

  if (mode === 'view') {
    const editModeBtn = document.createElement('button');
    editModeBtn.className = 'btn';
    editModeBtn.style.cssText = 'flex:1;border:1.5px solid #2980b9;color:#2980b9;background:rgba(224,64,40,0.08);font-weight:600';
    editModeBtn.innerHTML = 'âœï¸ Edit This Item';
    editModeBtn.onclick = function() { mode = 'edit'; renderFields(null); footer.innerHTML = ''; buildFooter(); };
    footer.appendChild(editModeBtn);
  } else {
    buildFooter();
  }

  function buildFooter() {
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn btn-primary';
    saveBtn.style.cssText = 'flex:1;background:#2980b9;border-color:#2980b9;font-weight:600';
    saveBtn.textContent = 'ðŸ’¾ Save All Changes';
    saveBtn.onclick = async function() {
      saveBtn.textContent = 'Savingâ€¦'; saveBtn.disabled = true;
      // Collect all current pd values (updated in-place during edits)
      const priceItem = pd.priceItem || '';
      const priceBox = pd.priceBox || '';
      const calc = (parseFloat(priceItem)||0) + (parseFloat(priceBox)||0);
      const newRow = [
        item.itemNum, item.variation || '',
        pd.condition || '', pd.allOriginal || '',
        priceItem, priceBox, calc > 0 ? calc.toFixed(2) : '',
        pd.hasBox || '', pd.boxCond || '',
        pd.photoItem || '', pd.photoBox || '',
        pd.notes || '', pd.datePurchased || '',
        pd.userEstWorth || '', pd.matchedTo || '',
        pd.setId || '', pd.yearMade || '',
      ];
      try {
        await sheetsUpdate(state.personalSheetId, 'My Collection!A' + pd.row + ':Q' + pd.row, [newRow]);
        state.personalData[pdKey] = Object.assign({}, pd, { priceComplete: calc > 0 ? calc.toFixed(2) : '' });
        overlay.remove();
        showToast('âœ“ Item updated!');
        buildDashboard();
      } catch(e) {
        saveBtn.textContent = 'ðŸ’¾ Save All Changes'; saveBtn.disabled = false;
        showToast('Error: ' + e.message);
      }
    };

    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'btn btn-secondary';
    cancelBtn.textContent = 'Cancel';
    cancelBtn.onclick = function() { overlay.remove(); };

    footer.innerHTML = '';
    footer.appendChild(saveBtn);
    footer.appendChild(cancelBtn);
  }

  box.appendChild(footer);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}


function openISDetail(rowKey) {
  const it = state.isData[rowKey];
  if (!it) return;
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem';
  overlay.onclick = e => { if(e.target===overlay) overlay.remove(); };
  const box = document.createElement('div');
  box.style.cssText = 'background:var(--surface);border:1px solid rgba(22,160,133,0.4);border-radius:16px;max-width:460px;width:100%;padding:1.75rem;position:relative;max-height:88vh;overflow-y:auto';
  const closeBtn = document.createElement('button');
  closeBtn.innerHTML='âœ•'; closeBtn.style.cssText='position:absolute;top:0.75rem;right:0.75rem;background:none;border:none;color:var(--text-dim);font-size:1.1rem;cursor:pointer';
  closeBtn.onclick=()=>overlay.remove();
  box.appendChild(closeBtn);
  box.innerHTML += `
    <div style="font-family:var(--font-head);font-size:1rem;color:#16a085;margin-bottom:0.15rem">ðŸ“‹ Sheet # ${it.sheetNum}</div>
    <div style="font-size:0.82rem;color:var(--text-mid);margin-bottom:1.25rem">Instruction Sheet${it.linkedItem?' for Lionel No. '+it.linkedItem:''}</div>
    <div style="display:flex;flex-direction:column;gap:0.5rem;font-size:0.85rem">
      ${[
        ['Sheet #',       it.sheetNum||'â€”'],
        ['Linked Item #', it.linkedItem||'â€”'],
        ['Year / Date',   it.year||'â€”'],
        ['Condition',     it.condition ? it.condition+'/10' : 'â€”'],
        ['Notes',         it.notes||'â€”'],
      ].map(([l,v])=>`<div style="display:flex;gap:0.75rem;padding:0.45rem 0;border-bottom:1px solid var(--border)">
        <span style="color:var(--text-dim);min-width:110px;flex-shrink:0">${l}</span>
        <span>${v}</span>
      </div>`).join('')}
      ${it.photoLink?`<div style="margin-top:0.75rem"><a href="${it.photoLink}" target="_blank" rel="noopener" style="font-size:0.82rem;color:#16a085;text-decoration:none">ðŸ“· View Photos â†—</a></div>`:''}
    </div>`;
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function browseRowClick(event, idx) {
  // If click was on the varDesc popup span, don't intercept
  if (event.target.closest && event.target.closest('[onclick*="showVarDescPopup"]')) return;
  // Handle _personalOnly items encoded as negative sentinel
  if (idx <= -1000) {
    const poIdx = Math.abs(idx) - 1000;
    const pdKey = (window._poKeys || [])[poIdx];
    if (pdKey) { showOwnedItemMenu(-1, pdKey); }
    return;
  }
  const item = state.masterData[idx];
  if (!item) return;
  const keyPrefix = item.itemNum + '|' + item.variation + '|';
  const pdKey = Object.keys(state.personalData).find(k => k.startsWith(keyPrefix));
  const alreadyOwned = !!pdKey;
  if (alreadyOwned) {
    showOwnedItemMenu(idx, pdKey);
    return;
  }
  // Not owned â€” show quick prompt
  const existing = document.getElementById('browse-add-prompt');
  if (existing) existing.remove();
  const overlay = document.createElement('div');
  overlay.id = 'browse-add-prompt';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1.5rem';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  const box = document.createElement('div');
  box.style.cssText = 'background:var(--surface);border:1px solid rgba(232,64,28,0.4);border-radius:16px;max-width:440px;width:100%;padding:1.75rem;position:relative';
  // Header
  const hdr = document.createElement('div');
  hdr.style.cssText = 'font-family:var(--font-head);font-size:1.05rem;color:var(--accent);margin-bottom:0.25rem';
  hdr.textContent = 'No. ' + item.itemNum + (item.variation ? ' â€” Var. ' + item.variation : '');
  box.appendChild(hdr);
  const sub = document.createElement('div');
  sub.style.cssText = 'font-size:0.85rem;color:var(--text-mid);margin-bottom:0.25rem';
  sub.textContent = item.roadName || item.itemType || '';
  box.appendChild(sub);
  if (item.yearProd) {
    const yr = document.createElement('div');
    yr.style.cssText = 'font-size:0.75rem;color:var(--text-dim);margin-bottom:1.25rem';
    yr.textContent = item.yearProd + (item.itemType ? ' Â· ' + item.itemType : '');
    box.appendChild(yr);
  } else {
    sub.style.marginBottom = '1.25rem';
  }
  // Question
  const q = document.createElement('div');
  q.style.cssText = 'font-size:0.9rem;color:var(--text);margin-bottom:1.25rem;font-weight:500';
  q.textContent = 'Do you own this item?';
  box.appendChild(q);
  // Buttons
  const btnRow = document.createElement('div');
  btnRow.style.cssText = 'display:flex;gap:0.75rem';
  const yesBtn = document.createElement('button');
  yesBtn.className = 'btn btn-primary';
  yesBtn.style.cssText = 'flex:1;background:var(--accent);border-color:var(--accent);font-weight:600';
  yesBtn.textContent = 'âœ“ Yes â€” Add to Collection';
  yesBtn.onclick = function() { overlay.remove(); addFromBrowse(idx); };
  const viewBtn = document.createElement('button');
  viewBtn.className = 'btn btn-secondary';
  viewBtn.style.cssText = 'flex:1';
  viewBtn.textContent = 'View Details';
  viewBtn.onclick = function() {
    overlay.remove();
    // Show description popup
    const vdOverlay = document.createElement('div');
    vdOverlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1.5rem';
    vdOverlay.onclick = function(e) { if (e.target === vdOverlay) vdOverlay.remove(); };
    const vdBox = document.createElement('div');
    vdBox.style.cssText = 'background:var(--surface);border:1px solid var(--border);border-radius:14px;max-width:520px;width:100%;padding:1.75rem;position:relative;max-height:80vh;overflow-y:auto';
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'âœ•';
    closeBtn.style.cssText = 'position:absolute;top:0.75rem;right:0.75rem;background:none;border:none;color:var(--text-dim);font-size:1.1rem;cursor:pointer';
    closeBtn.onclick = function() { vdOverlay.remove(); };
    vdBox.appendChild(closeBtn);
    const rows = [
      ['Item #', item.itemNum + (item.variation ? ' â€” Var. ' + item.variation : '')],
      ['Type', item.itemType || 'â€”'],
      ['Road / Name', item.roadName || 'â€”'],
      ['Year', item.yearProd || 'â€”'],
      ['Market Value', item.marketVal ? '$' + parseFloat(item.marketVal).toLocaleString() : 'â€”'],
    ];
    rows.forEach(function(r) {
      const row = document.createElement('div');
      row.style.cssText = 'display:flex;gap:0.75rem;margin-bottom:0.4rem;font-size:0.85rem';
      const lbl = document.createElement('span');
      lbl.style.cssText = 'color:var(--text-dim);min-width:90px;flex-shrink:0';
      lbl.textContent = r[0];
      const val = document.createElement('span');
      val.style.cssText = 'color:var(--text)';
      val.textContent = r[1];
      row.appendChild(lbl);
      row.appendChild(val);
      vdBox.appendChild(row);
    });
    if (item.varDesc) {
      const vdSec = document.createElement('div');
      vdSec.style.cssText = 'margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid var(--border);font-size:0.82rem;color:var(--text-mid);line-height:1.6';
      vdSec.innerHTML = '<span style="color:var(--accent2);font-weight:600">Variation: </span>' + item.varDesc;
      vdBox.appendChild(vdSec);
    }
    if (item.description) {
      const descSec = document.createElement('div');
      descSec.style.cssText = 'margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid var(--border);font-size:0.82rem;color:var(--text-mid);line-height:1.6';
      descSec.textContent = item.description;
      vdBox.appendChild(descSec);
    }
    if (item.refLink) {
      const cottRow = document.createElement('div');
      cottRow.style.cssText = 'margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid var(--border)';
      const cottA = document.createElement('a');
      cottA.href = item.refLink;
      cottA.target = '_blank';
      cottA.rel = 'noopener';
      cottA.style.cssText = 'font-size:0.82rem;color:#2980b9;text-decoration:none;display:inline-flex;align-items:center;gap:0.35rem';
      cottA.innerHTML = 'View on COTT <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15,3 21,3 21,9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>';
      cottRow.appendChild(cottA);
      vdBox.appendChild(cottRow);
    }
    // Add to collection button at bottom
    const addBtn = document.createElement('button');
    addBtn.className = 'btn btn-primary';
    addBtn.style.cssText = 'margin-top:1.25rem;width:100%;background:var(--accent);border-color:var(--accent)';
    addBtn.textContent = 'âœ“ Add to My Collection';
    addBtn.onclick = function() { vdOverlay.remove(); addFromBrowse(idx); };
    vdBox.appendChild(addBtn);
    vdOverlay.appendChild(vdBox);
    document.body.appendChild(vdOverlay);
  };
  const cancelBtn = document.createElement('button');
  cancelBtn.className = 'btn btn-secondary';
  cancelBtn.style.cssText = 'padding:0.6rem 0.9rem';
  cancelBtn.textContent = 'âœ•';
  cancelBtn.onclick = function() { overlay.remove(); };
  btnRow.appendChild(yesBtn);
  btnRow.appendChild(viewBtn);
  btnRow.appendChild(cancelBtn);
  box.appendChild(btnRow);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function addFromBrowse(idx) {
  const item = state.masterData[idx];
  if (!item) return;
  // Open the collection wizard with itemNum + variation pre-filled
  wizard = { step: 0, tab: 'collection', data: { tab: 'collection', itemNum: item.itemNum, variation: item.variation || '' }, steps: getSteps('collection'), matchedItem: item };
  document.getElementById('wizard-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  // Skip the tab picker (step 0) and itemNum step â€” advance past any steps
  // whose id is 'itemNum' or 'variation' (already known)
  const autoSkip = new Set(['tab', 'itemNum', 'variation', 'itemCategory']);
  while (wizard.step < wizard.steps.length - 1) {
    const s = wizard.steps[wizard.step];
    if (autoSkip.has(s.id) || (s.skipIf && s.skipIf(wizard.data))) {
      wizard.step++;
    } else {
      break;
    }
  }
  renderWizardStep();
}

// â”€â”€ ITEM MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openItem(idx) {
  const item = state.masterData[idx];
  state.currentItem = { item, idx };
  // Find by prefix since key now includes row number
  const keyPrefix = `${item.itemNum}|${item.variation}|`;
  const pdKey = Object.keys(state.personalData).find(k => k.startsWith(keyPrefix));
  const pd = pdKey ? state.personalData[pdKey] : {};

  const _errPd = findPD(item.itemNum, item.variation);
  const _errSuffix = _errPd && _errPd.isError ? ' âš  Error' : '';
  document.getElementById('modal-item-num').textContent = `No. ${item.itemNum}${item.variation ? ' â€” Variation ' + item.variation : ''}${_errSuffix}`;
  document.getElementById('modal-title').textContent = item.roadName || item.itemType || item.description.substring(0, 60);
  const modalMatchedTo = pd?.matchedTo || '';
  const modalIsTender = isTender(item.itemNum);
  document.getElementById('modal-subtitle').textContent = `${item.itemType}${item.subType ? ' â€” ' + item.subType : ''}${item.yearProd ? ' Â· ' + item.yearProd : ''}`;
  // Set ID badge
  const setIdBadgeEl = document.getElementById('modal-set-badge');
  if (setIdBadgeEl) {
    if (pd?.setId) {
      setIdBadgeEl.style.display = 'inline-flex';
      // Find all other items in this set
      const setMates = Object.values(state.personalData)
        .filter(p => p.setId === pd.setId && p.itemNum !== item.itemNum)
        .map(p => p.itemNum);
      setIdBadgeEl.textContent = 'ðŸ”— Set: ' + pd.setId + (setMates.length ? ' (with ' + setMates.join(', ') + ')' : '');
    } else {
      setIdBadgeEl.style.display = 'none';
    }
  }

  const matchedBadgeEl = document.getElementById('modal-matched-badge');
  if (matchedBadgeEl) {
    if (modalMatchedTo) {
      matchedBadgeEl.style.display = 'inline-flex';
      matchedBadgeEl.innerHTML = `${modalIsTender ? 'ðŸš‚' : 'ðŸšƒ'} Matched ${modalIsTender ? 'Engine' : 'Tender'}: <strong style="margin-left:0.3rem">${modalMatchedTo}</strong>`;
    } else {
      matchedBadgeEl.style.display = 'none';
    }
  }
  document.getElementById('mi-type').textContent = item.itemType || 'â€”';
  document.getElementById('mi-year').textContent = item.yearProd || 'â€”';
  document.getElementById('mi-road').textContent = item.roadName || 'â€”';
  document.getElementById('mi-var').textContent = item.variation || '(no variation)';
  document.getElementById('mi-market').textContent = item.marketVal ? '$' + parseFloat(item.marketVal).toLocaleString() : 'â€”';
  document.getElementById('mi-ref').innerHTML = item.refLink ? `<a href="${item.refLink}" target="_blank">View on COTT â†—</a>` : 'â€”';
  document.getElementById('mi-desc').textContent = item.description || 'No description available.';
  const vd = document.getElementById('mi-varDesc-wrap');
  if (item.varDesc) { document.getElementById('mi-varDesc').textContent = item.varDesc; vd.style.display = 'block'; }
  else { vd.style.display = 'none'; }

  // Personal data - check owned and sold
  const sd = state.soldData[key] || {};
  const wd = state.wantData[key] || {};
  const itemStatus = pd.owned ? 'Owned' : sd.itemNum ? 'Sold' : wd.itemNum ? 'Want' : '';
  currentStatus = itemStatus || '';
  setStatus(itemStatus || 'Want');
  document.getElementById('fc-sale-price').value = sd.salePrice || '';
  document.getElementById('fc-date-sold').value = sd.dateSold || '';
  document.getElementById('fc-want-priority').value = wd.priority || 'Medium';
  document.getElementById('fc-want-price').value = wd.expectedPrice || '';
  document.getElementById('fc-want-notes').value = wd.notes || '';

  // copy field removed
  document.getElementById('fc-original').value = pd.allOriginal || 'Unknown';
  const cond = pd.condition || 7;
  document.getElementById('fc-condition').value = cond;
  document.getElementById('cond-display').textContent = cond;
  const toNum = v => (v && !isNaN(parseFloat(v))) ? v : '';
  document.getElementById('fc-price-item').value = toNum(pd.priceItem);
  document.getElementById('fc-price-box').value = toNum(pd.priceBox);
  document.getElementById('fc-price-complete').value = toNum(pd.priceComplete);
  document.getElementById('fc-has-box').value = ['Yes','No'].includes(pd.hasBox) ? pd.hasBox : 'No';
  document.getElementById('fc-box-cond').value = toNum(pd.boxCond);
  document.getElementById('fc-photo-item').value = pd.photoItem || '';
  document.getElementById('fc-photo-box').value = pd.photoBox || '';
  document.getElementById('fc-notes').value = pd.notes || '';

  // Show box-only prompt if row has box but no item info
  const isBoxOnly = pd.owned && pd.hasBox === 'Yes' && 
    (!pd.condition || pd.condition === 'N/A') && 
    (!pd.priceItem || pd.priceItem === 'N/A');
  const prompt = document.getElementById('box-only-prompt');
  if (prompt) prompt.style.display = isBoxOnly ? 'flex' : 'none';

  document.getElementById('item-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function fillItemFromBoxRow() {
  if (!state.currentItem) return;
  const { item } = state.currentItem;
  closeModal();
  // Start wizard in collection mode, pre-filled with item number, skip to item-info steps
  wizard = {
    step: 0,
    tab: 'collection',
    data: {
      tab: 'collection',
      itemNum: item.itemNum,
      variation: item.variation || '',
      boxOnly: false,
      _fillItemMode: true, // flag so we can pre-set item number
    },
    steps: getSteps('collection'),
    matchedItem: state.masterData.find(i => i.itemNum === item.itemNum) || null,
  };
  // Advance past tab and itemNum steps since we already know them
  wizard.step = 2; // start at condition step
  document.getElementById('wizard-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  renderWizardStep();
}

function closeModal() {
  document.getElementById('item-modal').classList.remove('open');
  document.body.style.overflow = '';
  state.currentItem = null;
}

function closeModalOnOverlay(e) { if (e.target === document.getElementById('item-modal')) closeModal(); }

let currentStatus = 'Want';

function setStatus(status) {
  currentStatus = status;
  // Update button styles
  ['Want','Owned','Sold'].forEach(s => {
    const btn = document.getElementById('status-' + s.toLowerCase());
    if (!btn) return;
    if (s === status) {
      const colors = { Want: 'var(--accent2)', Owned: 'var(--green)', Sold: '#9b59b6' };
      btn.style.background = colors[s] + '22';
      btn.style.borderColor = colors[s];
      btn.style.color = colors[s];
    } else {
      btn.style.background = 'var(--surface2)';
      btn.style.borderColor = 'var(--border)';
      btn.style.color = 'var(--text-mid)';
    }
  });
  document.getElementById('collection-form').style.display = (status === 'Owned' || status === 'Sold') ? 'block' : 'none';
  const soldFields = document.getElementById('sold-fields');
  if (soldFields) soldFields.style.display = status === 'Sold' ? 'block' : 'none';
  const wantFields = document.getElementById('want-fields');
  if (wantFields) wantFields.style.display = status === 'Want' ? 'block' : 'none';
}

async function saveItem() {
  if (!state.currentItem) return;
  const { item } = state.currentItem;
  const key = `${item.itemNum}|${item.variation}`;

  const copy = document.getElementById('fc-copy').value;
  const condition = document.getElementById('fc-condition').value;

  if (currentStatus === 'Owned') {
    // Write/update in My Collection tab
    const _ex = state.personalData[key] || {};
    const ownedRow = [
      item.itemNum, item.variation || '', copy, condition,
      document.getElementById('fc-original').value,
      document.getElementById('fc-price-item').value,
      document.getElementById('fc-price-box').value,
      document.getElementById('fc-price-complete').value,
      document.getElementById('fc-has-box').value,
      document.getElementById('fc-box-cond').value,
      document.getElementById('fc-photo-item').value,
      document.getElementById('fc-photo-box').value,
      document.getElementById('fc-notes').value,
      _ex.datePurchased || '', _ex.userEstWorth || '',
      _ex.matchedTo || '', _ex.setId || '', _ex.yearMade || '',
      _ex.isError || '', _ex.errorDesc || '',
      _ex.quickEntry ? 'Yes' : '',  // preserve Quick Entry flag
    ];
    const existing = state.personalData[key];
    if (existing && existing.row) {
      await sheetsUpdate(state.personalSheetId, `My Collection!A${existing.row}:T${existing.row}`, [ownedRow]);
    } else {
      await sheetsAppend(state.personalSheetId, 'My Collection!A:T', [ownedRow]);
    }
    // Remove from Sold tab if it was there
    const soldEntry = state.soldData[key];
    if (soldEntry && soldEntry.row) {
      await sheetsUpdate(state.personalSheetId, `Sold!A${soldEntry.row}:H${soldEntry.row}`, [['','','','','','','','']]);
    }
    // Remove from Want List if it was there
    const wantEntry = state.wantData[key];
    if (wantEntry && wantEntry.row) {
      await sheetsUpdate(state.personalSheetId, `Want List!A${wantEntry.row}:E${wantEntry.row}`, [['','','','','']]);
    }

  } else if (currentStatus === 'Sold') {
    // Remove from My Collection
    const existing = state.personalData[key];
    if (existing && existing.row) {
      await sheetsUpdate(state.personalSheetId, `My Collection!A${existing.row}:T${existing.row}`, [['','','','','','','','','','','','','','','','','','','','']]);  // 20 cols A-T
    }
    // Write to Sold tab
    const soldRow = [
      item.itemNum, item.variation || '', copy, condition,
      existing?.priceItem || document.getElementById('fc-price-item').value,
      document.getElementById('fc-sale-price').value,
      document.getElementById('fc-date-sold').value,
      document.getElementById('fc-notes').value,
    ];
    const soldEntry = state.soldData[key];
    if (soldEntry && soldEntry.row) {
      await sheetsUpdate(state.personalSheetId, `Sold!A${soldEntry.row}:H${soldEntry.row}`, [soldRow]);
    } else {
      await sheetsAppend(state.personalSheetId, 'Sold!A:H', [soldRow]);
    }

  } else if (currentStatus === 'Want') {
    // Remove from My Collection if present
    const existing = state.personalData[key];
    if (existing && existing.row) {
      await sheetsUpdate(state.personalSheetId, `My Collection!A${existing.row}:T${existing.row}`, [['','','','','','','','','','','','','','','','','','','','']]);  // 20 cols A-T
    }
    // Write/update Want List tab
    const wantRow = [
      item.itemNum,
      item.variation || '',
      document.getElementById('fc-want-priority').value,
      document.getElementById('fc-want-price').value,
      document.getElementById('fc-want-notes').value,
    ];
    const wantEntry = state.wantData[key];
    if (wantEntry && wantEntry.row) {
      await sheetsUpdate(state.personalSheetId, `Want List!A${wantEntry.row}:E${wantEntry.row}`, [wantRow]);
    } else {
      await sheetsAppend(state.personalSheetId, 'Want List!A:E', [wantRow]);
    }
  }

  await loadPersonalData();

  // Reset all filters so the browse view shows everything
  state.filters.wantList = false;
  state.filters.owned = false;
  state.filters.unowned = false;
  state.filters.boxed = false;
  // Reset toggle button visual states


  closeModal();
  buildDashboard();
  buildSoldPage();
  renderBrowse();
}

// â”€â”€ REPORTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildReport() {
  const type = document.getElementById('report-type')?.value || 'wantlist';
  const thead = document.getElementById('report-thead');
  const tbody = document.getElementById('report-tbody');
  if (!thead || !tbody) return;

  if (type === 'wantlist') {
    thead.innerHTML = '<tr><th>Item #</th><th>Type</th><th>Road Name</th><th>Year</th><th>Variation</th><th>Est. Market Value</th><th>COTT Link</th></tr>';
    const wants = state.masterData.filter(i => !state.personalData[`${i.itemNum}|${i.variation}`]?.owned);
    tbody.innerHTML = wants.map(i => `
      <tr>
        <td><span class="item-num">${i.itemNum}</span></td>
        <td><span class="tag">${i.itemType || 'â€”'}</span></td>
        <td>${i.roadName || 'â€”'}</td>
        <td>${i.yearProd || 'â€”'}</td>
        <td>${i.variation || 'â€”'}</td>
        <td class="market-val">${i.marketVal ? '$'+parseFloat(i.marketVal).toLocaleString() : 'â€”'}</td>
        <td>${i.refLink ? `<a href="${i.refLink}" target="_blank" style="color:var(--accent2)">View â†—</a>` : 'â€”'}</td>
      </tr>`).join('') || '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-dim)">All items owned! ðŸŽ‰</td></tr>';

  } else if (type === 'collection') {
    thead.innerHTML = '<tr><th>Item #</th><th>Type</th><th>Road Name</th><th>Variation</th><th>Copy #</th><th>Condition</th><th>Has Box</th><th>All Original</th><th>Item Price</th><th>Item+Box</th></tr>';
    const owned = state.masterData.filter(i => state.personalData[`${i.itemNum}|${i.variation}`]?.owned);
    tbody.innerHTML = owned.map(i => {
      const pd = state.personalData[`${i.itemNum}|${i.variation}`];
      return `<tr>
        <td><span class="item-num">${i.itemNum}</span></td>
        <td><span class="tag">${i.itemType || 'â€”'}</span></td>
        <td>${i.roadName || 'â€”'}</td>
        <td>${i.variation || 'â€”'}</td>
        <td>${pd.copy || '1'}</td>
        <td>${pd.condition || 'â€”'}</td>
        <td>${pd.hasBox || 'â€”'}</td>
        <td>${pd.allOriginal || 'â€”'}</td>
        <td class="market-val">${pd.priceItem ? '$'+parseFloat(pd.priceItem).toLocaleString() : 'â€”'}</td>
        <td class="market-val">${pd.priceComplete ? '$'+parseFloat(pd.priceComplete).toLocaleString() : 'â€”'}</td>
      </tr>`;
    }).join('') || '<tr><td colspan="10" style="text-align:center;padding:2rem;color:var(--text-dim)">No owned items yet</td></tr>';

  } else if (type === 'value') {
    thead.innerHTML = '<tr><th>Category</th><th>Owned</th><th>Total in Master</th><th>% Complete</th><th>Est. Collection Value</th></tr>';
    const cats = {};
    state.masterData.forEach(i => {
      const t = i.itemType || 'Other';
      if (!cats[t]) cats[t] = { total: 0, owned: 0, value: 0 };
      cats[t].total++;
      const pd = state.personalData[`${i.itemNum}|${i.variation}`];
      if (pd?.owned) {
        cats[t].owned++;
        cats[t].value += parseFloat(pd.priceComplete || pd.priceItem || 0);
      }
    });
    tbody.innerHTML = Object.entries(cats).sort((a,b)=>b[1].owned-a[1].owned).map(([name, c]) => `
      <tr>
        <td>${name}</td>
        <td>${c.owned}</td>
        <td>${c.total}</td>
        <td>${c.total > 0 ? Math.round(c.owned/c.total*100) + '%' : 'â€”'}</td>
        <td class="market-val">${c.value > 0 ? '$'+Math.round(c.value).toLocaleString() : 'â€”'}</td>
      </tr>`).join('');

  } else if (type === 'missing-box') {
    thead.innerHTML = '<tr><th>Item #</th><th>Type</th><th>Road Name</th><th>Condition</th><th>Amount Paid</th></tr>';
    const noBox = state.masterData.filter(i => {
      const pd = state.personalData[`${i.itemNum}|${i.variation}`];
      return pd?.owned && pd?.hasBox !== 'Yes';
    });
    tbody.innerHTML = noBox.map(i => {
      const pd = state.personalData[`${i.itemNum}|${i.variation}`];
      return `<tr>
        <td><span class="item-num">${i.itemNum}</span></td>
        <td><span class="tag">${i.itemType || 'â€”'}</span></td>
        <td>${i.roadName || 'â€”'}</td>
        <td>${pd.condition || 'â€”'}</td>
        <td class="market-val">${i.marketVal ? '$'+parseFloat(i.marketVal).toLocaleString() : 'â€”'}</td>
      </tr>`;
    }).join('') || '<tr><td colspan="5" style="text-align:center;padding:2rem;color:var(--text-dim)">All owned items have boxes!</td></tr>';
  }
}

function exportReport() {
  const thead = document.getElementById('report-thead');
  const tbody = document.getElementById('report-tbody');
  const headers = [...thead.querySelectorAll('th')].map(th => th.textContent).join(',');
  const rows = [...tbody.querySelectorAll('tr')].map(tr =>
    [...tr.querySelectorAll('td')].map(td => `"${td.textContent.replace(/"/g,'""')}"`).join(',')
  ).join('\n');
  const csv = headers + '\n' + rows;
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'lionel-report.csv'; a.click();
}

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ EPHEMERA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _ephCurrentTab = 'catalogs';

function buildEphemeraPage() {
  // Rebuild tab buttons to include user-defined tabs
  const tabBar = document.getElementById('ephemera-tabs');
  if (tabBar) {
    const stdTabs = [
      { id:'catalogs', emoji:'ðŸ“’', label:'Catalogs' },
      { id:'paper',    emoji:'ðŸ“„', label:'Paper Items' },
      { id:'mockups',  emoji:'ðŸ”©', label:'Mock-Ups' },
      { id:'other',    emoji:'ðŸ“¦', label:'Other Lionel' },
    ];
    const allTabs = [...stdTabs, ...(state.userDefinedTabs||[]).map(t => ({ id:t.id, emoji:'â­', label:t.label }))];
    tabBar.innerHTML = allTabs.map(t =>
      `<button class="eph-tab${_ephCurrentTab===t.id?' active':''}" data-eph="${t.id}" onclick="switchEphTab('${t.id}',this)">${t.emoji} ${t.label}</button>`
    ).join('');
  }
  switchEphTab(_ephCurrentTab, document.querySelector('.eph-tab.active'));
}

function switchEphTab(tabId, btn) {
  _ephCurrentTab = tabId;
  document.querySelectorAll('.eph-tab').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  if (!state.ephemeraData[tabId]) state.ephemeraData[tabId] = {};
  const bucket = state.ephemeraData[tabId];
  const items = Object.values(bucket);
  const container = document.getElementById('ephemera-content');
  if (!container) return;
  const isMockup = tabId === 'mockups';

  if (items.length === 0) {
    const labels = { catalogs:'Catalogs', paper:'Paper Items', mockups:'Mock-Ups', other:'Other Lionel Items' };
    const emojis = { catalogs:'ðŸ“’', paper:'ðŸ“„', mockups:'ðŸ”©', other:'ðŸ“¦' };
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">${emojis[tabId]}</div><p>No ${labels[tabId]} yet â€” tap Add Item to get started</p></div>`;
    return;
  }

  container.innerHTML = items.sort((a,b) => (b.row||0)-(a.row||0)).map(item => {
    const val = item.estValue ? '$' + parseFloat(item.estValue).toLocaleString() : '';
    const cond = item.condition ? item.condition + '/10' : '';
    const isCatalog2 = tabId === 'catalogs';
    const subtitle = [
      isCatalog2 && item.catType ? item.catType : '',
      isCatalog2 && item.hasMailer === 'Yes' ? 'âœ‰ Has mailer' : '',
      isMockup && item.itemNumRef ? 'Ref: ' + item.itemNumRef : '',
      item.manufacturer && item.manufacturer !== 'Lionel' ? item.manufacturer : '',
      isMockup && item.productionStatus ? item.productionStatus : '',
      !isCatalog2 && item.quantity > 1 ? 'Qty: ' + item.quantity : '',
      cond,
    ].filter(Boolean).join(' Â· ');
    return `<div class="eph-row" onclick="openEphemeraDetail('${tabId}',${item.row})">
      <div style="font-size:1.4rem;width:28px;text-align:center;flex-shrink:0">${{catalogs:'ðŸ“’',paper:'ðŸ“„',mockups:'ðŸ”©',other:'ðŸ“¦'}[tabId]}</div>
      <div style="flex:1;min-width:0">
        <div class="eph-title">${item.title}</div>
        ${subtitle ? `<div style="font-size:0.72rem;color:var(--text-dim);margin-top:1px">${subtitle}</div>` : ''}
      </div>
      ${item.year ? `<span class="eph-year">${item.year}</span>` : ''}
      ${val ? `<span class="eph-val">${val}</span>` : ''}
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--text-dim)" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
    </div>`;
  }).join('');
}

function openEphemeraDetail(tabId, rowKey) {
  const item = (state.ephemeraData[tabId] || {})[rowKey];
  if (!item) return;
  const isMockup = tabId === 'mockups';
  const labels = { catalogs:'Catalog', paper:'Paper Item', mockups:'Mock-Up', other:'Other Item' };

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay open';
  overlay.onclick = e => { if (e.target === overlay) overlay.remove(); };

  const isCatalog3 = tabId === 'catalogs';
  const fields = isCatalog3 ? [
    ['Item ID',           item.itemNum || 'â€”'],
    ['Type',              item.catType || 'â€”'],
    ['Year',              item.year || 'â€”'],
    ['Has Envelope/Mailer', item.hasMailer || 'No'],
    ['Condition',         item.condition ? item.condition + '/10' : 'â€”'],
    ['Est. Value',        item.estValue ? '$' + parseFloat(item.estValue).toLocaleString() : 'â€”'],
    ['Date Acquired',     item.dateAcquired || 'â€”'],
    ['Notes',             item.notes || 'â€”'],
  ] : isMockup ? [
    ['Title', item.title],
    ['Item # Reference', item.itemNumRef],
    ['Description', item.description],
    ['Year', item.year],
    ['Manufacturer', item.manufacturer || 'Lionel'],
    ['Condition', item.condition ? item.condition + '/10' : 'â€”'],
    ['Production Status', item.productionStatus || 'â€”'],
    ['Material', item.material || 'â€”'],
    ['Dimensions', item.dimensions || 'â€”'],
    ['Provenance', item.provenance || 'â€”'],
    ['Lionel Verified', item.lionelVerified || 'â€”'],
    ['Est. Value', item.estValue ? '$' + parseFloat(item.estValue).toLocaleString() : 'â€”'],
    ['Date Acquired', item.dateAcquired || 'â€”'],
    ['Notes', item.notes || 'â€”'],
  ] : [
    ['Title', item.title],
    ['Description', item.description || 'â€”'],
    ['Year', item.year || 'â€”'],
    ['Manufacturer', item.manufacturer || 'Lionel'],
    ['Condition', item.condition ? item.condition + '/10' : 'â€”'],
    ['Quantity', item.quantity || '1'],
    ['Est. Value', item.estValue ? '$' + parseFloat(item.estValue).toLocaleString() : 'â€”'],
    ['Date Acquired', item.dateAcquired || 'â€”'],
    ['Notes', item.notes || 'â€”'],
  ];

  overlay.innerHTML = `
    <div class="modal" style="max-width:480px;max-height:85vh;overflow-y:auto">
      <div class="modal-header" style="background:var(--surface2);border-bottom:1px solid var(--border);padding:1rem 1.25rem;display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-size:0.65rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-dim);margin-bottom:0.2rem">${labels[tabId]}</div>
          <div style="font-weight:600;font-size:1rem">${item.title}</div>
        </div>
        <button onclick="this.closest('.modal-overlay').remove()" style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:1.4rem;line-height:1">âœ•</button>
      </div>
      <div style="padding:1rem 1.25rem">
        ${fields.map(([label, val]) => val && val !== 'â€”' ? `
          <div style="display:flex;justify-content:space-between;align-items:flex-start;padding:0.45rem 0;border-bottom:1px solid var(--border)">
            <span style="font-size:0.78rem;color:var(--text-dim);flex-shrink:0;padding-right:1rem">${label}</span>
            <span style="font-size:0.85rem;color:var(--text);text-align:right">${val}</span>
          </div>` : '').join('')}
        ${item.photoLink ? `<div style="margin-top:1rem"><a href="${item.photoLink}" target="_blank" style="color:#2980b9;font-size:0.82rem">ðŸ“ View Photos â†—</a></div>` : ''}
      </div>
      <div style="padding:0.75rem 1.25rem;border-top:1px solid var(--border);display:flex;gap:0.5rem">
        <button onclick="openEphemeraEdit('${tabId}',${rowKey})" style="flex:1;padding:0.6rem;border-radius:8px;border:1.5px solid #e67e22;color:#e67e22;background:rgba(230,126,34,0.1);cursor:pointer;font-family:var(--font-body);font-weight:600">Edit</button>
        <button onclick="this.closest('.modal-overlay').remove()" style="flex:1;padding:0.6rem;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);cursor:pointer;font-family:var(--font-body)">Close</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
}

function buildWantPage() {
  const isMobile = window.innerWidth <= 640;
  const _wq = (state._wantSearch || '').toLowerCase();
  const entries = Object.values(state.wantData).filter(w => {
    if (!_wq) return true;
    const master = state.masterData.find(m => m.itemNum === w.itemNum && (!w.variation || m.variation === w.variation)) || {};
    return (w.itemNum||'').toLowerCase().includes(_wq)
      || (master.roadName||'').toLowerCase().includes(_wq)
      || (master.itemType||'').toLowerCase().includes(_wq)
      || (w.variation||'').toLowerCase().includes(_wq)
      || (w.notes||'').toLowerCase().includes(_wq);
  });
  // Keep count badge in sync
  const countBadge = document.getElementById('nav-wanted2');
  if (countBadge) countBadge.textContent = entries.length.toLocaleString();
  const cardsEl = document.getElementById('want-cards');
  const tableEl = document.getElementById('want-table');
  const tbody   = document.getElementById('want-tbody');

  // Priority order
  const priorityOrder = { 'High': 0, 'Medium': 1, 'Low': 2 };
  entries.sort((a, b) => (priorityOrder[a.priority] ?? 1) - (priorityOrder[b.priority] ?? 1));

  const priorityColor = { High: 'var(--accent)', Medium: 'var(--accent2)', Low: 'var(--text-dim)' };

  if (entries.length === 0) {
    const empty = `<div style="text-align:center;padding:3rem 1rem;color:var(--text-dim)"><div style="font-size:2.5rem;margin-bottom:0.5rem">â¤ï¸</div><p>Your want list is empty</p><p style="font-size:0.8rem;margin-top:0.5rem">Add items you're looking for</p></div>`;
    if (cardsEl) cardsEl.innerHTML = empty;
    if (tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-dim)">No items on want list</td></tr>';
    return;
  }

  if (isMobile) {
    if (tableEl) tableEl.style.display = 'none';
    if (cardsEl) cardsEl.style.display = 'flex';
    cardsEl.innerHTML = entries.map(w => {
      const master = state.masterData.find(m => m.itemNum === w.itemNum && (!w.variation || m.variation === w.variation));
      const name = master ? (master.roadName || master.description || master.itemType || '') : '';
      const pColor = priorityColor[w.priority] || 'var(--text-dim)';
      const masterIdx2 = master ? state.masterData.indexOf(master) : -1;
      return `<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:0.85rem 1rem;display:flex;align-items:center;gap:0.75rem;cursor:pointer" onclick="${masterIdx2>=0?`openItem(${masterIdx2})`:''}" >
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:0.5rem">
            <span style="font-family:var(--font-head);font-size:1.1rem;color:var(--accent)">${w.itemNum}</span>
            ${w.variation ? `<span style="font-size:0.72rem;color:var(--text-dim)">${w.variation}</span>` : ''}
            <span style="font-size:0.65rem;font-weight:600;color:${pColor};border:1px solid ${pColor};border-radius:4px;padding:0.1rem 0.4rem">${w.priority || 'Medium'}</span>
          </div>
          ${name ? `<div style="font-size:0.82rem;color:var(--text);margin-top:0.15rem">${name}</div>` : ''}
          ${w.notes ? `<div style="font-size:0.72rem;color:var(--text-dim);margin-top:0.15rem">${w.notes}</div>` : ''}
        </div>
        <div style="text-align:right;flex-shrink:0">
          ${w.expectedPrice ? `<div style="font-family:var(--font-mono);color:var(--accent2);font-size:0.9rem">$${parseFloat(w.expectedPrice).toLocaleString()}</div>` : ''}
        </div>
      </div>`;
    }).join('');
  } else {
    if (tableEl) tableEl.style.display = '';
    if (cardsEl) cardsEl.style.display = 'none';
    // Store descriptions in a map to avoid quoting issues in onclick
    window._wantDescs = {};
    tbody.innerHTML = entries.map((w, idx) => {
      const master = state.masterData.find(m => m.itemNum === w.itemNum && (!w.variation || m.variation === w.variation));
      const roadName = master ? (master.roadName || '') : '';
      const varDesc  = master ? (master.varDesc || master.variationDesc || '') : '';
      const fullDesc = master ? (master.description || '') : '';
      window._wantDescs[idx] = { title: roadName || w.itemNum, varDesc, fullDesc };
      const pColor = priorityColor[w.priority] || 'var(--text-dim)';
      const shortVar = varDesc.length > 30 ? varDesc.substring(0, 30) + 'â€¦' : varDesc;
      const varCell = varDesc
        ? `<span style="cursor:pointer;border-bottom:1px dashed var(--border);color:var(--text-mid)" onclick="showWantDesc(${idx})">${shortVar}</span>`
        : (w.variation ? `<span class="text-dim">${w.variation}</span>` : '<span class="text-dim">â€”</span>');
      return `<tr>
        <td><span class="item-num">${w.itemNum}</span></td>
        <td>${roadName || '<span class="text-dim">â€”</span>'}</td>
        <td>${w.variation || '<span class="text-dim">â€”</span>'}</td>
        <td>${varCell}</td>
        <td><span style="color:${pColor};font-weight:500">${w.priority || 'Medium'}</span></td>
        <td class="market-val">${w.expectedPrice ? '$' + parseFloat(w.expectedPrice).toLocaleString() : '<span class="text-dim">â€”</span>'}</td>
      </tr>`;
    }).join('') || '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-dim)">No items on want list</td></tr>';
  }
}

function showVarDescPopup(idx) {
  const item = state.masterData[idx];
  if (!item || !item.varDesc) return;
  const existing = document.getElementById('vardesc-popup');
  if (existing) existing.remove();
  const overlay = document.createElement('div');
  overlay.id = 'vardesc-popup';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1.5rem';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  const box = document.createElement('div');
  box.style.cssText = 'background:var(--surface);border:1px solid var(--border);border-radius:14px;max-width:520px;width:100%;padding:1.5rem;position:relative';
  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'âœ•';
  closeBtn.style.cssText = 'position:absolute;top:0.75rem;right:0.75rem;background:none;border:none;color:var(--text-dim);font-size:1.1rem;cursor:pointer';
  closeBtn.onclick = function() { overlay.remove(); };
  box.appendChild(closeBtn);
  const hdr = document.createElement('div');
  hdr.style.cssText = 'font-family:var(--font-head);color:var(--accent2);margin-bottom:0.5rem;margin-right:2rem';
  hdr.textContent = item.itemNum + (item.variation ? ' â€” Variation ' + item.variation : '') + (item.roadName ? ' Â· ' + item.roadName : '');
  box.appendChild(hdr);
  const varEl = document.createElement('div');
  varEl.style.cssText = 'font-size:0.9rem;color:var(--text);line-height:1.7';
  varEl.textContent = item.varDesc;
  box.appendChild(varEl);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function showWantDesc(idx) {
  const d = (window._wantDescs || {})[idx];
  if (!d) return;
  const existing = document.getElementById('want-desc-modal');
  if (existing) existing.remove();
  const overlay = document.createElement('div');
  overlay.id = 'want-desc-modal';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1.5rem';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  const box = document.createElement('div');
  box.style.cssText = 'background:var(--surface);border:1px solid var(--border);border-radius:14px;max-width:520px;width:100%;padding:1.5rem;position:relative';
  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'âœ•';
  closeBtn.style.cssText = 'position:absolute;top:0.75rem;right:0.75rem;background:none;border:none;color:var(--text-dim);font-size:1.1rem;cursor:pointer';
  closeBtn.onclick = function() { overlay.remove(); };
  box.appendChild(closeBtn);
  const titleEl = document.createElement('div');
  titleEl.style.cssText = 'font-family:var(--font-head);font-size:1rem;color:var(--accent2);margin-bottom:0.75rem;margin-right:2rem';
  titleEl.textContent = d.title;
  box.appendChild(titleEl);
  if (d.varDesc) {
    const varEl = document.createElement('div');
    varEl.style.cssText = 'font-size:0.85rem;color:var(--accent);font-weight:600;margin-bottom:0.5rem';
    varEl.textContent = 'Variation: ' + d.varDesc;
    box.appendChild(varEl);
  }
  const descEl = document.createElement('div');
  descEl.style.cssText = 'font-size:0.85rem;color:var(--text-mid);line-height:1.7';
  descEl.textContent = d.fullDesc || d.title;
  box.appendChild(descEl);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function toggleSoldSummary() {
  const box = document.getElementById('sold-summary-box');
  const btn = document.getElementById('sold-summary-toggle');
  if (!box || !btn) return;
  const hidden = box.style.display === 'none';
  box.style.display = hidden ? 'flex' : 'none';
  btn.textContent = hidden ? 'Hide Summary' : 'Show Summary';
  try { localStorage.setItem('soldSummaryHidden', hidden ? '0' : '1'); } catch(e) {}
}

function buildSoldPage() {
  const _sq = (state._soldSearch || '').toLowerCase();
  const soldEntries = Object.values(state.soldData).filter(sd => {
    if (!_sq) return true;
    const master = state.masterData.find(i => i.itemNum === sd.itemNum && i.variation === sd.variation) || {};
    return (sd.itemNum||'').toLowerCase().includes(_sq)
      || (master.roadName||'').toLowerCase().includes(_sq)
      || (master.itemType||'').toLowerCase().includes(_sq)
      || (sd.variation||'').toLowerCase().includes(_sq);
  });
  const tbody = document.getElementById('sold-tbody');

  // Populate summary stats
  const totalRevenue = soldEntries.reduce((sum, sd) => sum + (parseFloat(sd.salePrice) || 0), 0);
  const countEl = document.getElementById('sold-stat-count');
  const totalEl = document.getElementById('sold-stat-total');
  if (countEl) countEl.textContent = soldEntries.length.toLocaleString();
  if (totalEl) totalEl.textContent = totalRevenue > 0 ? '$' + Math.round(totalRevenue).toLocaleString() : '$0';

  // Restore hidden state from localStorage
  try {
    const box = document.getElementById('sold-summary-box');
    const btn = document.getElementById('sold-summary-toggle');
    if (box && btn && localStorage.getItem('soldSummaryHidden') === '1') {
      box.style.display = 'none';
      btn.textContent = 'Show Summary';
    }
  } catch(e) {}

  const isMobileSold = window.innerWidth <= 640;
  const soldCardsEl = document.getElementById('sold-cards');
  const soldTableWrap = document.getElementById('sold-table-wrap');

  if (isMobileSold) {
    if (soldCardsEl) soldCardsEl.style.display = 'flex';
    if (soldTableWrap) soldTableWrap.style.display = 'none';
    if (soldCardsEl) soldCardsEl.innerHTML = soldEntries.length ? soldEntries.map(sd => {
      const master = state.masterData.find(i => i.itemNum === sd.itemNum && i.variation === sd.variation) || {};
      return `<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:0.85rem 1rem">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <span style="font-family:var(--font-head);font-size:1.1rem;color:var(--accent)">${sd.itemNum}</span>
            ${sd.variation ? `<span style="font-size:0.72rem;color:var(--text-dim);margin-left:0.4rem">${sd.variation}</span>` : ''}
            ${master.roadName ? `<div style="font-size:0.82rem;color:var(--text);margin-top:0.1rem">${master.roadName}</div>` : ''}
            <div style="font-size:0.72rem;color:var(--text-dim);margin-top:0.15rem">${[master.itemType, sd.condition ? 'Cond: '+sd.condition : '', sd.dateSold].filter(Boolean).join(' Â· ')}</div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            ${sd.salePrice ? `<div style="font-family:var(--font-mono);color:#2ecc71;font-size:1.1rem;font-weight:600">$${parseFloat(sd.salePrice).toLocaleString()}</div>` : '<div style="color:var(--text-dim);font-size:0.8rem">No price</div>'}
          </div>
        </div>
      </div>`;
    }).join('') : '<div style="text-align:center;padding:3rem 1rem;color:var(--text-dim)"><div style="font-size:2.5rem;margin-bottom:0.5rem">ðŸ’°</div><p>No sold items yet</p></div>';
  } else {
    if (soldCardsEl) soldCardsEl.style.display = 'none';
    if (soldTableWrap) soldTableWrap.style.display = '';
    tbody.innerHTML = soldEntries.length ? soldEntries.map(sd => {
      const master = state.masterData.find(i => i.itemNum === sd.itemNum && i.variation === sd.variation) || {};
      return `<tr>
        <td><span class="item-num">${sd.itemNum}</span></td>
        <td><span class="tag">${master.itemType || 'â€”'}</span></td>
        <td>${master.roadName || 'â€”'}</td>
        <td>${sd.variation || 'â€”'}</td>
        <td>${sd.condition || 'â€”'}</td>
        <td class="market-val">${sd.salePrice ? '$' + parseFloat(sd.salePrice).toLocaleString() : 'â€”'}</td>
        <td class="text-dim">${sd.dateSold || 'â€”'}</td>
      </tr>`;
    }).join('') : '<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">ðŸ’°</div><p>No sold items yet</p></div></td></tr>';
  }

  document.getElementById('nav-sold').textContent = soldEntries.length;
}

function clearPageSearch(name) {
  const map = { browse: 'browse-search', sold: 'sold-search', want: 'want-search' };
  const el = document.getElementById(map[name]);
  // Don't clear â€” keep search term when returning to same page
}

function showPage(name, clickedEl) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.mobile-nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (clickedEl) clickedEl.classList.add('active');
  if (name === 'browse') renderBrowse();
  if (name === 'reports') buildReport();
  if (name === 'sold') buildSoldPage();
  if (name === 'want') buildWantPage();
  document.getElementById('main-content').scrollTop = 0;
}

// â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseJwt(token) {
  const base64 = token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/');
  return JSON.parse(atob(base64));
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = () => {
  if (typeof google !== 'undefined') initGoogle();
};
</script>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>
<script>
// Picker state â€” declared at top so available to all onclick handlers
var _pickerStepId = null;
var _pickerViewKey = null;

// â”€â”€ ADD ITEM WIZARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let wizard = {
  step: 0,
  tab: null,       // 'collection' | 'sold' | 'want'
  data: {},
  steps: [],
  matchedItem: null,
};

// Step definitions per tab
function getSteps(tab) {
  // User-defined custom tabs â€” same flow as ephemera
  const _allEphTabs = ['catalogs','paper','mockups','other','instrsheet',
    ...(state.userDefinedTabs||[]).map(t => t.id)];
  if (tab && _allEphTabs.includes(tab)) {
    const isMockup  = tab === 'mockups';
    const isCatalog = tab === 'catalogs';
    const _userTabDef = (state.userDefinedTabs||[]).find(t => t.id === tab);

    // â”€â”€ Instruction Sheet flow â”€â”€
    if (tab === 'instrsheet') {
      return [
        { id: 'is_linkedItem', title: 'What Lionel item # does this sheet go with?', type: 'text',
          placeholder: 'e.g. 726, 2046, 6464-1' },
        { id: 'is_sheetNum',   title: 'What is the instruction sheet number?',       type: 'text',
          placeholder: 'e.g. 924-6, 1-1957, 726-13' },
        { id: 'is_year',       title: 'Year or date printed (if known)',              type: 'text',
          placeholder: 'e.g. 1957, 1957-06', optional: true },
        { id: 'is_condition',  title: 'What condition is the sheet?',                type: 'slider', min:1, max:10 },
        { id: 'is_notes',      title: 'Any notes about this sheet?',                 type: 'textarea', optional: true,
          placeholder: 'e.g. Early printing, double-sided, staple holes' },
        { id: 'is_photos',     title: 'Add photos of the instruction sheet',         type: 'drivePhotos', label: 'IS',
          views: [
            { key: 'IS-FRONT', label: 'Front Side',  abbr: 'IS-FRONT' },
            { key: 'IS-BACK',  label: 'Back Side',   abbr: 'IS-BACK'  },
          ], optional: true },
        { id: 'is_confirm',    title: 'Ready to save the instruction sheet!',        type: 'confirm' },
      ];
    }

    // â”€â”€ Catalog-specific flow â”€â”€
    if (isCatalog) {
      return [
        { id: 'cat_type',        title: 'What type of catalog is this?',          type: 'choice3',
          choices: ['Consumer','Dealer','Advance','Other'] },
        { id: 'cat_year',        title: 'What year is the catalog?',              type: 'postwarYear' },
        { id: 'cat_hasMailer',   title: 'Does it have the envelope or mailer?',   type: 'choice2',
          choices: ['Yes','No'] },
        { id: 'cat_condition',   title: 'What condition is the catalog?',         type: 'slider', min:1, max:10 },
        { id: 'cat_estValue',    title: 'Estimated value',                        type: 'money',
          placeholder: '0.00', optional: true },
        { id: 'cat_dateAcquired',title: 'Date acquired',                          type: 'date', optional: true },
        { id: 'cat_notes',       title: 'Any notes?',                             type: 'textarea', optional: true },
        { id: 'cat_photos',      title: 'Add photos of the catalog',              type: 'drivePhotos', label: 'Catalog',
          views: [
            { key: 'COVER',   label: 'Front Cover',  abbr: 'COVER'   },
            { key: 'BACK',    label: 'Back Cover',   abbr: 'BACK'    },
            { key: 'INSIDE',  label: 'Inside Spread',abbr: 'INSIDE'  },
            { key: 'MAILER',  label: 'Envelope/Mailer',abbr:'MAILER' },
          ],
          optional: true },
        { id: 'cat_confirm',     title: 'Ready to save the catalog!',             type: 'confirm' },
      ];
    }

    const steps = [
      { id: 'eph_title', title: isMockup ? 'What is the mock-up title or name?' : ('What is the title of this ' + (_userTabDef ? _userTabDef.label : 'item') + '?'), type: 'text', placeholder: isMockup ? 'e.g. 2344 Santa Fe Prototype' : 'e.g. 1957 Consumer Catalog' },
    ];
    if (isMockup) steps.push(
      { id: 'eph_itemNumRef', title: 'Related item number (if known)', type: 'text', placeholder: 'e.g. 2344', optional: true },
      { id: 'eph_productionStatus', title: 'Production status', type: 'choice3', choices: ['Produced as shown','Modified before production','Never produced'] },
      { id: 'eph_material', title: 'Material', type: 'choice3', choices: ['Wood','Clay/Plaster','Metal','Mixed','Unknown'] },
      { id: 'eph_dimensions', title: 'Dimensions (optional)', type: 'text', placeholder: 'e.g. 12" x 4" x 3"', optional: true },
      { id: 'eph_provenance', title: 'Provenance / history (optional)', type: 'textarea', optional: true },
      { id: 'eph_lionelVerified', title: 'Lionel factory verified?', type: 'choice3', choices: ['Yes','No','Unknown'] },
    );
    steps.push(
      { id: 'eph_description', title: 'Description (optional)', type: 'textarea', optional: true, placeholder: isMockup ? 'e.g. Pre-production body in unpainted wood, hand-lettered' : 'e.g. First edition with red cover, 48 pages' },
      { id: 'eph_year', title: 'Year', type: 'text', placeholder: 'e.g. 1957', optional: true },
      { id: 'eph_condition', title: 'Condition (1-10)', type: 'slider', min:1, max:10 },
    );
    if (!isMockup) steps.push(
      { id: 'eph_quantity', title: 'How many copies?', type: 'text', placeholder: '1', optional: true },
    );
    steps.push(
      { id: 'eph_estValue', title: 'Estimated value', type: 'money', placeholder: '0.00', optional: true },
      { id: 'eph_dateAcquired', title: 'Date acquired', type: 'date', optional: true },
      { id: 'eph_notes', title: 'Notes (optional)', type: 'textarea', optional: true },
      { id: 'eph_confirm', title: (d) => 'Looking good! Ready to save your ' + getItemLabel(d) + '?', type: 'confirm' },
    );
    return steps;
  }

  const base = [
    { id: 'itemNum',    title: 'What is the Lionel item number?',       type: 'text',     placeholder: 'e.g. 726, 2046, 6464-1' },
    { id: 'variation',  title: 'Which variation is it?',                type: 'variation', optional: true },
  ];

  if (tab === 'collection') {
    // If a sub-category was chosen and it's not a Lionel item, redirect to ephemera steps
    if (wizard.data.itemCategory && wizard.data.itemCategory !== 'lionel') {
      const ephTab = wizard.data.itemCategory;
      wizard.tab = ephTab;
      return getSteps(ephTab);
    }
    // Box-only mode: skip item condition/price, only ask box info
    if (wizard.data.boxOnly) {
      return [
        { id: 'itemCategory', title: 'What would you like to add?', type: 'itemCategory' },
        { id: 'itemNum',       title: 'What is the Lionel item number?',    type: 'text',     placeholder: 'e.g. 726, 2046, 6464-1' },
        { id: 'pickRow',       title: 'Which item is this box for?',        type: 'pickRow',  skipIf: (d) => {
          const matches = Object.keys(state.personalData).filter(k => k.split('|')[0] === (d.itemNum||'').trim());
          return matches.length <= 1; // skip if 0 or 1 match â€” no choice needed
        }},
        { id: 'boxCond',       title: (d) => 'What condition is the ' + getItemLabel(d) + ' box?',         type: 'slider',   min:1, max:10 },
        { id: 'priceBox',      title: 'What did you pay for the box?',      type: 'money',    placeholder: '0.00', optional: true },
        { id: 'purchaseDate',  title: 'When did you buy the box?',          type: 'date',     optional: true },
        { id: 'userEstWorth',  title: 'What do you estimate it is worth?',  type: 'money',    placeholder: '0.00', optional: true },
        { id: 'notes',         title: (d) => 'Any notes about this ' + getItemLabel(d) + ' box?',          type: 'textarea', optional: true },
        { id: 'confirm',       title: 'Ready to save box info!',            type: 'confirm' },
      ];
    }
    // Helper: is this a paired engine+tender set?
    const isPaired = (d) => d.tenderMatch && d.tenderMatch !== 'none' && d.tenderMatch !== '';
    const engineLabel = (d) => isPaired(d) ? ' (Engine Only â€” tender added next)' : '';
    const tenderLabel = (d) => ' (Tender: ' + (d.tenderMatch || '') + ')';

    return [
      { id: 'itemCategory', title: 'What would you like to add?', type: 'itemCategory',
        skipIf: (d) => !!d.itemCategory },
      ...base,

      // â”€â”€ ENTRY MODE â”€â”€
      { id: 'entryMode', title: (d) => 'How would you like to add this ' + getItemLabel(d) + '?',
        type: 'entryMode' },

      // â”€â”€ ITEM CONDITION â”€â”€
      { id: 'condition',       title: (d) => 'What condition is the ' + getItemLabel(d) + '?',
        type: 'slider', min:1, max:10 },
      { id: 'allOriginal',     title: (d) => 'Is the ' + getItemLabel(d) + ' all original?',
        type: 'choice3', choices: ['Yes','No','Unknown'] },
      { id: 'notOriginalDesc', title: (d) => 'What has been done to the ' + getItemLabel(d) + '?',
        type: 'textarea', optional: true,
        placeholder: 'e.g. Repaint, touch-ups, reproduction parts, re-wired, replaced wheelsâ€¦',
        note: () => 'Common examples: repaint, partial repaint, touch-ups, reproduction decals, reproduction parts, re-wired, replaced wheels, replaced motor',
        skipIf: (d) => d.allOriginal !== 'No' },

      // â”€â”€ MATCHING / SET â”€â”€
      { id: 'tenderMatch',  title: 'Tender / Engine matching', type: 'tenderMatch',
        skipIf: (d) => {
          const num = (d.itemNum || '').trim();
          return getMatchingTenders(num).length === 0 && getMatchingLocos(num).length === 0;
        }
      },
      { id: 'setMatch',     title: 'Multi-unit diesel set',    type: 'setMatch',
        skipIf: (d) => !isF3AlcoUnit((d.itemNum || '').trim()) },
      { id: 'unitPower',    title: 'Is this a powered or dummy unit?', type: 'choice2',
        choices: ['Powered', 'Dummy'],
        note: () => 'Lionel used the same item number for both. This will be saved as e.g. 2343-P or 2343-D.',
        skipIf: (d) => {
          const num = (d.itemNum || '').trim();
          return num.endsWith('C') || !isF3AlcoUnit(num);
        }
      },

      // â”€â”€ BOX â”€â”€
      { id: 'hasBox',  title: (d) => 'Did the ' + getItemLabel(d) + ' come with a box?',
        type: 'choice2', choices: ['Yes','No'], skipIf: (d) => !!d._attachToBox },
      { id: 'boxCond', title: (d) => 'What condition is the ' + getItemLabel(d) + ' box?',
        type: 'slider', min:1, max:10,
        skipIf: (d) => (d.hasBox !== 'Yes' && !d._attachToBox) || !!d._attachToBox },

      // â”€â”€ ITEM PHOTOS (main item + box) â”€â”€
      { id: 'photosItem', title: (d) => 'Add photos of the ' + getItemLabel(d),
        type: 'drivePhotos', label: 'Item',
        note: (d) => isPaired(d) ? 'Engine photos only â€” tender photos will be added next. Each item is filed in its own Drive folder.' : '' },
      { id: 'photosBox',  title: (d) => 'Add photos of the ' + getItemLabel(d) + ' box',
        type: 'drivePhotos', label: 'Box',
        skipIf: (d) => (d.hasBox !== 'Yes' && !d._attachToBox) || !!d._attachToBox,
        note: (d) => isPaired(d) ? 'Engine box photos only â€” tender box photos will be added next.' : '' },

      // â”€â”€ TOGETHER PHOTOS â€” right after item photos, before tender/set â”€â”€
      { id: 'wantTogetherPhotos', title: (d) => 'Would you like to add photos of the ' + getItemLabel(d) + ' and tender together?',
        type: 'choice2', choices: ['Yes','No'], skipIf: (d) => !isPaired(d) },
      { id: 'photosTogether', title: (d) => 'Add photos of the ' + getItemLabel(d) + ' and tender together',
        type: 'drivePhotos', label: 'Set',
        note: () => 'These photos will be filed under the engine Drive folder.',
        skipIf: (d) => !isPaired(d) || d.wantTogetherPhotos !== 'Yes' },

      // â”€â”€ TENDER section (only shown when paired) â”€â”€
      { id: '_tenderDivider',   title: 'Now for the tender', type: 'divider',
        subtitle: (d) => 'Next we will record details for the matching tender (' + d.tenderMatch + '). It will be saved as a separate item in your collection.',
        skipIf: (d) => !isPaired(d) },
      { id: 'tenderCondition',  title: 'What condition is the tender?',
        type: 'slider', min:1, max:10, skipIf: (d) => !isPaired(d) },
      { id: 'tenderAllOriginal', title: 'Is the tender all original?',
        type: 'choice3', choices: ['Yes','No','Unknown'], skipIf: (d) => !isPaired(d) },
      { id: 'tenderNotOriginalDesc', title: 'What has been done to the tender?',
        type: 'textarea', optional: true,
        placeholder: 'e.g. Repaint, touch-ups, reproduction parts, re-wired, replaced wheelsâ€¦',
        note: () => 'Common examples: repaint, partial repaint, touch-ups, reproduction decals, reproduction parts, re-wired, replaced wheels',
        skipIf: (d) => !isPaired(d) || d.tenderAllOriginal !== 'No' },
      { id: 'tenderHasBox',     title: 'Did the tender come with a box?',
        type: 'choice2', choices: ['Yes','No'], skipIf: (d) => !isPaired(d) },
      { id: 'tenderBoxCond',    title: 'What condition is the tender box?',
        type: 'slider', min:1, max:10, skipIf: (d) => !isPaired(d) || d.tenderHasBox !== 'Yes' },
      { id: 'photosTenderItem', title: 'Add photos of the tender',
        type: 'drivePhotos', label: 'Item', tenderMode: true,
        note: () => "Tender photos only â€” filed under the tender's own Drive folder.",
        skipIf: (d) => !isPaired(d) },
      { id: 'photosTenderBox',  title: 'Add photos of the tender box',
        type: 'drivePhotos', label: 'Box', tenderMode: true,
        note: () => 'Tender box photos only.',
        skipIf: (d) => !isPaired(d) || d.tenderHasBox !== 'Yes' },

      // â”€â”€ SET UNIT 2 section â”€â”€
      { id: '_setDivider',    title: 'Now for the second unit', type: 'divider',
        subtitle: (d) => {
          const partner = getSetPartner((d.itemNum||'').trim()) || ((d.itemNum||'').trim()+'C');
          return 'Next we will record details for the ' + (d.setType||'AB') + ' set partner (' + partner + '). It will be saved as a separate item with the same Set ID.';
        },
        skipIf: (d) => d.setMatch !== 'set-now' },
      { id: 'unit2ItemNum',      title: 'Confirm second unit item number',
        type: 'setUnit2Num', skipIf: (d) => d.setMatch !== 'set-now' },
      { id: 'unit2Condition',    title: (d) => 'What condition is the second unit (' + (d.unit2ItemNum || 'B unit') + ')?',
        type: 'slider', min:1, max:10, skipIf: (d) => d.setMatch !== 'set-now' },
      { id: 'unit2AllOriginal',  title: (d) => 'Is the second unit (' + (d.unit2ItemNum || 'B unit') + ') all original?',
        type: 'choice3', choices: ['Yes','No','Unknown'], skipIf: (d) => d.setMatch !== 'set-now' },
      { id: 'unit2NotOriginalDesc', title: (d) => 'What has been done to the ' + (d.unit2ItemNum || 'B unit') + '?',
        type: 'textarea', optional: true,
        placeholder: 'e.g. Repaint, touch-ups, reproduction parts, re-wiredâ€¦',
        skipIf: (d) => d.setMatch !== 'set-now' || d.unit2AllOriginal !== 'No' },
      { id: 'unit2HasBox',       title: (d) => 'Did the second unit (' + (d.unit2ItemNum || 'B unit') + ') come with a box?',
        type: 'choice2', choices: ['Yes','No'], skipIf: (d) => d.setMatch !== 'set-now' },
      { id: 'unit2BoxCond',      title: (d) => 'What condition is the second unit (' + (d.unit2ItemNum || 'B unit') + ') box?',
        type: 'slider', min:1, max:10, skipIf: (d) => d.setMatch !== 'set-now' || d.unit2HasBox !== 'Yes' },
      { id: 'photosUnit2Item',   title: (d) => 'Add photos of the ' + (d.unit2ItemNum || 'B unit'),
        type: 'drivePhotos', label: 'Item', unit2Mode: true,
        note: () => 'Photos for unit 2 â€” filed under its own Drive folder.',
        skipIf: (d) => d.setMatch !== 'set-now' },
      { id: 'photosUnit2Box',    title: (d) => 'Add photos of the ' + (d.unit2ItemNum || 'B unit') + ' box',
        type: 'drivePhotos', label: 'Box', unit2Mode: true,
        note: () => 'Unit 2 box photos.',
        skipIf: (d) => d.setMatch !== 'set-now' || d.unit2HasBox !== 'Yes' },

      // â”€â”€ SET UNIT 3 section (ABA only) â”€â”€
      { id: '_set3Divider',   title: 'Now for the third unit (A)', type: 'divider',
        subtitle: () => 'Finally, the second A unit to complete the ABA set.',
        skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' },
      { id: 'unit3ItemNum',      title: 'Confirm third unit item number',
        type: 'setUnit2Num', unit3: true, skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' },
      { id: 'unit3Power',        title: 'Is the third unit powered or dummy?',
        type: 'choice2', choices: ['Powered', 'Dummy'],
        note: () => 'Will be saved as e.g. 2343-P or 2343-D.',
        skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' },
      { id: 'unit3Condition',    title: (d) => 'What condition is the third unit (' + (d.unit3ItemNum || 'A unit') + ')?',
        type: 'slider', min:1, max:10, skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' },
      { id: 'unit3AllOriginal',  title: (d) => 'Is the third unit (' + (d.unit3ItemNum || 'A unit') + ') all original?',
        type: 'choice3', choices: ['Yes','No','Unknown'], skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' },
      { id: 'unit3NotOriginalDesc', title: (d) => 'What has been done to the ' + (d.unit3ItemNum || 'A unit') + '?',
        type: 'textarea', optional: true,
        placeholder: 'e.g. Repaint, touch-ups, reproduction parts, re-wiredâ€¦',
        skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' || d.unit3AllOriginal !== 'No' },
      { id: 'unit3HasBox',       title: (d) => 'Did the third unit (' + (d.unit3ItemNum || 'A unit') + ') come with a box?',
        type: 'choice2', choices: ['Yes','No'], skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' },
      { id: 'unit3BoxCond',      title: (d) => 'What condition is the third unit (' + (d.unit3ItemNum || 'A unit') + ') box?',
        type: 'slider', min:1, max:10, skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' || d.unit3HasBox !== 'Yes' },
      { id: 'photosUnit3Item',   title: (d) => 'Add photos of the ' + (d.unit3ItemNum || 'A unit'),
        type: 'drivePhotos', label: 'Item', unit3Mode: true,
        note: () => 'Photos for unit 3 (second A unit).',
        skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' },
      { id: 'photosUnit3Box',    title: (d) => 'Add photos of the ' + (d.unit3ItemNum || 'A unit') + ' box',
        type: 'drivePhotos', label: 'Box', unit3Mode: true,
        note: () => 'Unit 3 box photos.',
        skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' || d.unit3HasBox !== 'Yes' },

      // â”€â”€ INSTRUCTION SHEET â€” after all unit photos, before pricing â”€â”€
      { id: 'hasIS',        title: (d) => 'Does it have an instruction sheet?',
        type: 'choice2', choices: ['Yes','No'] },
      { id: 'is_sheetNum',  title: 'What is the instruction sheet number?',
        type: 'text', placeholder: 'e.g. 924-6, 1-1957, 726-13', optional: true,
        skipIf: d => d.hasIS !== 'Yes' },
      { id: 'is_condition', title: 'What condition is the instruction sheet?',
        type: 'slider', min:1, max:10, skipIf: d => d.hasIS !== 'Yes' },
      { id: 'photosIS',     title: 'Add photos of the instruction sheet',
        type: 'drivePhotos', label: 'IS',
        views: [
          { key: 'IS-FRONT', label: 'Front Side', abbr: 'Front' },
          { key: 'IS-BACK',  label: 'Back Side',  abbr: 'Back'  },
        ],
        optional: true, skipIf: d => d.hasIS !== 'Yes' },

      // â”€â”€ PRICING â”€â”€
      { id: 'pricePaid',     title: 'What did you pay?', type: 'pricePaid',
        note: (d) => isPaired(d) || d.setMatch === 'set-now' ? 'Full price goes to the first unit â€” other units will reference it in their notes.' : '' },
      { id: 'yearMade',      title: 'What year do you think this was made?',
        type: 'yearMade', optional: true },
      { id: 'datePurchased', title: 'When did you purchase?',
        type: 'date', optional: true },
      { id: 'userEstWorth',  title: 'What do you estimate it is worth?',
        type: 'money', placeholder: '0.00', optional: true,
        note: (d) => (isPaired(d) || d.setMatch === 'set-now') ? 'Full estimated value goes to the first unit.' : (d.hasBox === 'Yes' ? 'Include the value of both the item and the box.' : '') },

      // â”€â”€ NOTES & ERROR â”€â”€
      { id: 'notes',           title: (d) => 'Any notes about this ' + (d.itemNum ? d.itemNum + ' ' : '') + getItemLabel(d) + '?',
        type: 'textarea', optional: true },
      { id: 'isError',         title: (d) => 'Is this ' + getItemLabel(d) + ' an error item?',
        type: 'choice2', choices: ['No','Yes'],
        note: () => 'Error items have factory mistakes like double-stamping, missing lettering or decoration, wrong color, etc.' },
      { id: 'errorDesc',       title: 'Describe the error',
        type: 'textarea', optional: true,
        placeholder: 'e.g. Double-stamped road name, missing decoration on left side',
        skipIf: d => d.isError !== 'Yes' },
      { id: 'wantErrorPhotos', title: 'Add close-up photos of the error?',
        type: 'choice2', choices: ['Yes','No'], skipIf: d => d.isError !== 'Yes' },
      { id: 'photosError',     title: 'Add close-up photos of the error',
        type: 'drivePhotos', label: 'Error', views: ERROR_VIEWS,
        note: () => 'Close-ups of the error â€” e.g. double-stamp area, missing lettering. Filed in the same Drive folder.',
        skipIf: d => d.isError !== 'Yes' || d.wantErrorPhotos !== 'Yes' },
      { id: 'confirm',         title: (d) => 'Looking good! Ready to save your ' + getItemLabel(d) + '?', type: 'confirm' },
    ];
  } else if (tab === 'sold') {
    return [
      { id: 'tab',          title: 'What would you like to add?',         type: 'choice' },
      { id: 'itemNum',      title: 'What is the Lionel item number?',      type: 'text',        placeholder: 'e.g. 726, 2046, 6464-1' },
      { id: 'pickSoldItem', title: 'Which item are you selling?',          type: 'pickSoldItem',
        skipIf: (d) => {
          const matches = Object.keys(state.personalData).filter(k => k.split('|')[0] === (d.itemNum||'').trim());
          return matches.length === 0; // not in collection â€” skip picker
        }
      },
      { id: 'condition',    title: 'What condition was the item?',         type: 'slider',      min:1, max:10,
        skipIf: (d) => !!d.selectedSoldKey },
      { id: 'priceItem',    title: 'What did you originally pay for it?',  type: 'money',       placeholder: '0.00', optional: true,
        skipIf: (d) => !!d.selectedSoldKey },
      { id: 'salePrice',    title: 'What did you sell it for?',            type: 'money',       placeholder: '0.00' },
      { id: 'dateSold',     title: 'When did you sell it?',                type: 'date',        optional: true },
      { id: 'notes',        title: 'Any notes about the sale?',            type: 'textarea',    optional: true },
      { id: 'confirm',      title: 'Ready to save!',                       type: 'confirm' },
    ];
  } else { // want
    return [...base,
      { id: 'priority',      title: 'How high is your priority for this item?', type: 'choice3', choices: ['High','Medium','Low'] },
      { id: 'expectedPrice', title: 'What do you expect to pay?',               type: 'money',   placeholder: '0.00', optional: true },
      { id: 'notes',         title: "Any notes about what you're looking for?", type: 'textarea', optional: true },
      { id: 'confirm',       title: 'Ready to add to Want List!',               type: 'confirm' },
    ];
  }
}

function startAddWizard() {
  wizard = { step: 0, tab: null, data: {}, steps: getSteps(null), matchedItem: null };
  document.getElementById('wizard-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  renderWizardStep();
}

function openWizard(tab) {
  // Start wizard pre-set to a specific tab, skipping the tab picker step
  wizard = { step: 0, tab: tab, data: { tab: tab }, steps: getSteps(tab), matchedItem: null };
  document.getElementById('wizard-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  // Skip old-style 'choice' tab picker â€” but NOT itemCategory (we want that shown)
  if (wizard.steps[0] && wizard.steps[0].type === 'choice') {
    wizard.step = 1;
  }
  // Pre-set lionel category if opening collection directly
  if (tab === 'collection' && !wizard.data.itemCategory) {
    // Don't pre-set â€” let user choose category first
  }
  renderWizardStep();
}

function closeWizard() {
  document.getElementById('wizard-modal').classList.remove('open');
  document.body.style.overflow = '';
}

function closeWizardOnOverlay(e) {
  if (e.target === document.getElementById('wizard-modal')) closeWizard();
}

function renderWizardStep() {
  // Always restore Next button (entryMode step hides it)
  const _nb = document.getElementById('wizard-next-btn');
  if (_nb) _nb.style.display = '';

  const steps = wizard.tab ? getSteps(wizard.tab) : getSteps(null);
  wizard.steps = steps;

  // Skip steps based on skipIf
  let step = wizard.step;
  while (step < steps.length - 1 && steps[step].skipIf && steps[step].skipIf(wizard.data)) {
    step++;
    wizard.step = step;
  }

  const s = steps[step];
  const total = steps.filter(st => !st.skipIf || !st.skipIf(wizard.data)).length;
  const current = steps.slice(0, step).filter(st => !st.skipIf || !st.skipIf(wizard.data)).length + 1;
  const pct = Math.round((current / total) * 100);

  // Declare nextBtn first â€” used in theme block below
  const nextBtn = document.getElementById('wizard-next-btn');

  // Apply color theme based on tab
  const wizModal = document.querySelector('#wizard-modal .modal');
  if (wizModal) {
    wizModal.classList.remove('wiz-collection','wiz-want','wiz-sold');
    if (wizard.tab === 'collection') wizModal.classList.add('wiz-collection');
    else if (wizard.tab === 'want')   wizModal.classList.add('wiz-want');
    else if (wizard.tab === 'sold')   wizModal.classList.add('wiz-sold');
  }
  const progBar = document.getElementById('wizard-progress');
  if (progBar) {
    const _ephColors = {catalogs:'#e67e22',paper:'#3498db',mockups:'#9b59b6',other:'#27ae60'};
    if (wizard.tab === 'collection') progBar.style.background = 'var(--accent)';
    else if (wizard.tab === 'want')  progBar.style.background = '#2980b9';
    else if (wizard.tab === 'sold')  progBar.style.background = '#2ecc71';
    else if (_ephColors[wizard.tab]) progBar.style.background = _ephColors[wizard.tab];
    else                             progBar.style.background = 'var(--accent)';
  }
  if (nextBtn) {
    if (wizard.tab === 'want')       { nextBtn.style.background='#2980b9'; nextBtn.style.borderColor='#2980b9'; nextBtn.style.color='#fff'; }
    else if (wizard.tab === 'sold')  { nextBtn.style.background='#2ecc71'; nextBtn.style.borderColor='#2ecc71'; nextBtn.style.color='#081a0e'; }
    else                             { nextBtn.style.background=''; nextBtn.style.borderColor=''; nextBtn.style.color=''; }
  }

  document.getElementById('wizard-step-label').textContent = `Step ${current} of ${total}`;
  document.getElementById('wizard-title').textContent = typeof s.title === 'function' ? s.title(wizard.data) : s.title;
  document.getElementById('wizard-progress').style.width = pct + '%';
  document.getElementById('wizard-back-btn').style.display = step > 0 ? 'inline-flex' : 'none';
  const autoAdvanceTypes = new Set(['choice','choice2','choice3','pickRow','pickSoldItem']); // 'variation' removed â€” Next needed when item has no variations
  // setMatch and setUnit2Num need Next button (user may interact multiple times)
  if (s.type === 'confirm') {
    nextBtn.textContent = 'âœ“ Save';
    nextBtn.style.display = 'inline-flex';
  } else if (autoAdvanceTypes.has(s.type)) {
    nextBtn.style.display = 'none';
  } else {
    nextBtn.textContent = 'Next â†’';
    nextBtn.style.display = 'inline-flex';
  }

  const body = document.getElementById('wizard-body');

  if (s.type === 'itemCategory') {
    const _userTabs = state.userDefinedTabs || [];
    const _cats = [
      { id: 'lionel',   label: 'Lionel Item #',  desc: 'Train, car, accessory with a Lionel catalog number', emoji: 'ðŸš‚', color: 'var(--accent)' },
      { id: 'catalogs', label: 'Catalog',         desc: 'Lionel consumer or dealer catalog',                  emoji: 'ðŸ“’', color: '#e67e22' },
      { id: 'instrsheet', label: 'Instruction Sheet', desc: 'Instruction sheet linked to a specific item #',    emoji: 'ðŸ“‹', color: '#16a085' },
      { id: 'paper',    label: 'Paper Item',       desc: 'Ad, flyer, article, box insert',                    emoji: 'ðŸ“„', color: '#3498db' },
      { id: 'mockups',  label: 'Mock-Up',          desc: 'Pre-production prototype',                          emoji: 'ðŸ”©', color: '#9b59b6' },
      { id: 'other',    label: 'Other Lionel',     desc: 'Accessory, display, anything else',                 emoji: 'ðŸ“¦', color: '#27ae60' },
      ..._userTabs.map(t => ({ id: t.id, label: t.label, desc: 'Your custom category', emoji: 'â­', color: '#f39c12' })),
      { id: '__new__',  label: 'User Defined',     desc: 'Create your own custom category',                   emoji: 'âœï¸', color: '#95a5a6' },
    ];
    const cur = wizard.data.itemCategory || '';
    body.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:0.5rem;padding-top:0.25rem;max-height:60vh;overflow-y:auto">
        ${_cats.map(c => `
          <button onclick="wizardChooseCategory('${c.id}')" style="
            display:flex;align-items:center;gap:0.85rem;padding:0.75rem 1rem;
            border-radius:10px;border:2px solid ${cur===c.id ? c.color : 'var(--border)'};
            background:${cur===c.id ? c.color+'22' : 'var(--surface2)'};
            color:var(--text);cursor:pointer;text-align:left;font-family:var(--font-body);width:100%
          ">
            <span style="font-size:1.3rem;width:28px;text-align:center;flex-shrink:0">${c.emoji}</span>
            <div>
              <div style="font-weight:600;font-size:0.9rem">${c.label}</div>
              <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.1rem">${c.desc}</div>
            </div>
          </button>`).join('')}
      </div>`;

  } else if (s.type === 'choice') {
    // First step - choose tab
    body.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:0.75rem;padding-top:0.5rem">
        ${[['collection','âœ“ My Collection','Add a Lionel train you own','var(--green)'],
           ['sold','$ Sold','Record a sold item','#9b59b6'],
           ['want','â˜… Want List','Add to your wish list','var(--accent2)'],
           ['catalogs','ðŸ“’ Catalogs','Lionel catalogs & publications','#e67e22'],
           ['paper','ðŸ“„ Paper Items','Ads, flyers, box inserts, articles','#3498db'],
           ['mockups','ðŸ”© Mock-Ups','Pre-production prototypes','#9b59b6'],
           ['other','ðŸ“¦ Other Lionel','Accessories, displays & more','#27ae60'],
          ].map(([val,label,desc,color]) => `
          <button onclick="wizardChooseTab('${val}')" style="
            display:flex;align-items:center;gap:1rem;padding:1rem 1.25rem;
            border-radius:10px;border:2px solid ${wizard.tab===val ? color : 'var(--border)'};
            background:${wizard.tab===val ? color+'22' : 'var(--surface2)'};
            color:var(--text);cursor:pointer;text-align:left;font-family:var(--font-body);
            transition:all 0.15s;width:100%
          ">
            <div style="font-size:1.5rem;width:36px;text-align:center">${label.split(' ')[0]}</div>
            <div>
              <div style="font-weight:600;font-size:0.95rem">${label.split(' ').slice(1).join(' ')}</div>
              <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.15rem">${desc}</div>
            </div>
          </button>`).join('')}

      </div>`;

  } else if (s.type === 'variation') {
    // Look up all variations for the entered item number
    const itemNum = wizard.data.itemNum || '';
    const variations = state.masterData.filter(i => i.itemNum === itemNum && i.variation);
    const val = wizard.data.variation || '';
    if (variations.length === 0) {
      // No variations in master - fall back to text input
      body.innerHTML = `
        <div style="padding-top:0.75rem">
          <input type="text" id="wiz-input" value="${val}" placeholder="Leave blank if no variation"
            style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;
            padding:0.75rem 1rem;color:var(--text);font-family:var(--font-body);font-size:1rem;outline:none"
            oninput="wizard.data.variation=this.value"
            onkeydown="if(event.key==='Enter')wizardNext()">
          ${s.note && s.note(wizard.data) ? `<div style="font-size:0.8rem;color:var(--accent2);margin-top:0.6rem;padding:0.5rem 0.75rem;background:rgba(201,146,42,0.1);border-radius:6px">${s.note(wizard.data)}</div>` : ''}
        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>
        ${(() => {
          const singleItem = state.masterData.find(i => i.itemNum === itemNum);
          return singleItem && singleItem.refLink
            ? '<a href="' + singleItem.refLink + '" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:0.4rem;margin-top:0.75rem;font-size:0.82rem;color:var(--accent2);text-decoration:none;padding:0.4rem 0.75rem;border:1px solid rgba(201,146,42,0.3);border-radius:6px;background:rgba(201,146,42,0.08)">View on COTT â†—</a>'
            : '';
        })()}

        </div>`;
      setTimeout(() => { const i = document.getElementById('wiz-input'); if(i) i.focus(); }, 50);
    } else {
      // Show variation cards with description tooltip
      body.innerHTML = `
        <div style="padding-top:0.5rem">
          <div style="display:flex;flex-direction:column;gap:0.5rem" id="var-cards">
            ${[{variation:'', varDesc:'No specific variation / not sure'}, ...variations].map(v => `
              <button onclick="wizardChooseVariation('${v.variation}')" style="
                display:flex;align-items:flex-start;gap:0.75rem;padding:0.85rem 1rem;
                border-radius:10px;text-align:left;width:100%;cursor:pointer;
                font-family:var(--font-body);transition:all 0.15s;
                border:2px solid ${val===v.variation ? 'var(--accent)' : 'var(--border)'};
                background:${val===v.variation ? 'rgba(232,64,28,0.12)' : 'var(--surface2)'};
                color:var(--text);
              ">
                <span style="
                  font-family:var(--font-mono);font-size:1rem;font-weight:600;
                  color:${val===v.variation ? 'var(--accent)' : 'var(--accent2)'};
                  min-width:2rem;padding-top:0.1rem;
                ">${v.variation || 'â€”'}</span>
                <span style="font-size:0.82rem;color:var(--text-mid);line-height:1.5">${v.varDesc || v.description || 'No description available'}</span>
              </button>`).join('')}
          </div>
          <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Selecting a variation will auto-advance</div>
          ${(() => {
            const cottItem = variations.find(v => v.variation === val) || variations[0];
            return cottItem && cottItem.refLink
              ? '<a href="' + cottItem.refLink + '" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:0.4rem;margin-top:0.75rem;font-size:0.82rem;color:var(--accent2);text-decoration:none;padding:0.4rem 0.75rem;border:1px solid rgba(201,146,42,0.3);border-radius:6px;background:rgba(201,146,42,0.08)">View ' + (val ? val : 'item') + ' on COTT â†—</a>'
              : '';
          })()}
        </div>`;
    }

  } else if (s.type === 'text') {
    const val = wizard.data[s.id] || '';
    const showBoxOnly = s.id === 'itemNum' && wizard.tab === 'collection';
    const boxOnlyChecked = wizard.data.boxOnly || false;
    body.innerHTML = `
      <div style="padding-top:0.75rem">
        <input type="text" id="wiz-input" value="${val}" placeholder="${s.placeholder || ''}"
          style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;
          padding:0.75rem 1rem;color:var(--text);font-family:var(--font-body);font-size:1rem;outline:none"
          autocomplete="off"
          oninput="wizard.data['${s.id}']=this.value; if(this.id==='wiz-input' && wizard.steps[wizard.step].id==='itemNum') updateItemSuggestions(this.value)"
          onkeydown="handleSuggestionKey(event)">
        <div id="wiz-suggestions" style="display:none;flex-direction:column;gap:1px;margin-top:4px;max-height:340px;overflow-y:auto;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:4px;-webkit-overflow-scrolling:touch"></div>
        ${s.optional ? '<div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>' : ''}
        <div id="wiz-match" style="margin-top:0.75rem"></div>
        ${s.id === 'itemNum' ? `
        <button onclick="openIdentify('wizard')" style="
          width:100%;margin-top:0.6rem;padding:0.65rem 1rem;
          border-radius:8px;border:1.5px dashed var(--gold);
          background:rgba(212,168,67,0.07);color:var(--gold);
          font-family:var(--font-head);font-size:0.78rem;font-weight:600;
          letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;
          display:flex;align-items:center;justify-content:center;gap:0.5rem;
          transition:all 0.15s
        ">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 0 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
          Don't know the number? Identify by photo
        </button>` : ''}
        ${showBoxOnly ? `
        <label onclick="toggleBoxOnly()" style="
          display:flex;align-items:center;gap:0.75rem;padding:0.85rem 1rem;margin-top:0.75rem;
          border-radius:10px;border:2px solid ${boxOnlyChecked ? 'var(--accent2)' : 'var(--border)'};
          background:${boxOnlyChecked ? 'rgba(201,146,42,0.1)' : 'var(--surface2)'};
          cursor:pointer;transition:all 0.15s;
        ">
          <div style="
            width:20px;height:20px;border-radius:5px;flex-shrink:0;
            border:2px solid ${boxOnlyChecked ? 'var(--accent2)' : 'var(--border)'};
            background:${boxOnlyChecked ? 'var(--accent2)' : 'transparent'};
            display:flex;align-items:center;justify-content:center;
            font-size:0.75rem;color:white;font-weight:700;transition:all 0.15s;
          ">${boxOnlyChecked ? 'âœ“' : ''}</div>
          <div>
            <div style="font-weight:600;font-size:0.9rem;color:var(--text)">Adding box info only</div>
            <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.1rem">I bought a separate box for this item</div>
          </div>
        </label>` : ''}
      </div>`;
    setTimeout(() => {
      const inp = document.getElementById('wiz-input');
      if (inp) {
        inp.focus();
        if (s.id === 'itemNum') {
          inp.addEventListener('input', debounceItemLookup);
          if (inp.value) updateItemSuggestions(inp.value);
        }
      }
    }, 50);

  } else if (s.type === 'entryMode') {
    const lbl = getItemLabel(wizard.data);
    const itemNum = (wizard.data.itemNum || '').trim();
    const wrap = document.createElement('div');
    wrap.style.cssText = 'padding-top:0.75rem;display:flex;flex-direction:column;gap:0.75rem';

    // Full Entry card
    const fullCard = document.createElement('button');
    fullCard.style.cssText = 'width:100%;padding:1.1rem 1.25rem;border-radius:14px;text-align:left;cursor:pointer;font-family:var(--font-body);transition:all 0.15s;border:2px solid var(--border);background:var(--surface2);display:flex;align-items:flex-start;gap:1rem';
    fullCard.innerHTML = '<div style="font-size:2rem;flex-shrink:0;line-height:1">ðŸ“‹</div>'
      + '<div><div style="font-size:1rem;font-weight:700;color:var(--text);margin-bottom:0.2rem">Full Entry</div>'
      + '<div style="font-size:0.82rem;color:var(--text-mid);line-height:1.5">Answer all questions and add photos.<br>Best for a complete record.</div></div>';
    fullCard.onclick = function() {
      wizard.data.entryMode = 'full';
      renderWizardStep();
      setTimeout(function() { wizardNext(); }, 120);
    };

    // Quick Entry card
    const quickCard = document.createElement('button');
    quickCard.style.cssText = 'width:100%;padding:1.1rem 1.25rem;border-radius:14px;text-align:left;cursor:pointer;font-family:var(--font-body);transition:all 0.15s;border:2px solid #27ae60;background:rgba(39,174,96,0.07);display:flex;align-items:flex-start;gap:1rem';
    quickCard.innerHTML = '<div style="font-size:2rem;flex-shrink:0;line-height:1">âš¡</div>'
      + '<div><div style="font-size:1rem;font-weight:700;color:#27ae60;margin-bottom:0.2rem">Quick Entry</div>'
      + '<div style="font-size:0.82rem;color:var(--text-mid);line-height:1.5">Just save the item number now.<br>You can fill in the details later â€” use the âš¡ Quick Entry filter to find it.</div></div>';
    quickCard.onclick = function() {
      wizard.data.entryMode = 'quick';
      quickEntryAdd();
    };

    wrap.appendChild(fullCard);
    wrap.appendChild(quickCard);
    body.innerHTML = '';
    body.appendChild(wrap);
    // Hide the Next button â€” selection is made by tapping a card
    var nb = document.getElementById('wizard-next-btn');
    if (nb) nb.style.display = 'none';

  } else if (s.type === 'slider') {
    const val = wizard.data[s.id] || 7;
    body.innerHTML = `
      <div style="padding-top:1rem">
        <div style="display:flex;align-items:center;gap:1rem">
          <div style="font-family:var(--font-head);font-size:3rem;color:var(--accent2);width:3rem" id="wiz-slider-val">${val}</div>
          <input type="range" min="${s.min}" max="${s.max}" value="${val}" id="wiz-slider" style="flex:1;accent-color:var(--accent)"
            oninput="wizard.data['${s.id}']=parseInt(this.value);document.getElementById('wiz-slider-val').textContent=this.value">
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:var(--text-dim);margin-top:0.25rem">
          <span>1â€“3<br>Fair/Poor</span><span style="text-align:center">4â€“5<br>Good</span><span style="text-align:center">6â€“7<br>Very Good</span><span style="text-align:right">8â€“10<br>Exc/Mint</span>
        </div>
        <div id="wiz-cond-desc" style="margin-top:0.6rem;padding:0.5rem 0.75rem;border-radius:8px;background:var(--surface2);font-size:0.82rem;color:var(--text-mid);text-align:center;min-height:2rem"></div>

      </div>`;
    setTimeout(initCondDesc, 60);

  } else if (s.type === 'choice2' || s.type === 'choice3') {
    const val = wizard.data[s.id] || '';
    body.innerHTML = `
      <div style="display:flex;gap:0.75rem;flex-wrap:wrap;padding-top:0.75rem">
        ${s.choices.map(c => `
          <button onclick="wizardChoose('${s.id}','${c}')" style="
            flex:1;min-width:80px;padding:0.85rem;border-radius:10px;
            border:2px solid ${val===c ? 'var(--accent)' : 'var(--border)'};
            background:${val===c ? 'rgba(232,64,28,0.15)' : 'var(--surface2)'};
            color:${val===c ? 'var(--accent)' : 'var(--text-mid)'};
            font-family:var(--font-body);font-size:0.95rem;font-weight:500;cursor:pointer;transition:all 0.15s
          ">${c}</button>`).join('')}
      </div>`;

  } else if (s.type === 'pricePaid') {
    const itemVal = wizard.data.priceItem || '';
    body.innerHTML = `
      <div style="padding-top:0.75rem">
        <div style="font-size:0.72rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-dim);margin-bottom:0.4rem">What did you pay for the item? ($)</div>
        <div style="display:flex;align-items:center;gap:0.5rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem">
          <span style="color:var(--text-dim);font-size:1.2rem">$</span>
          <input type="number" id="wiz-price-item" value="${itemVal}" placeholder="0.00" min="0" step="0.01"
            style="flex:1;background:none;border:none;outline:none;color:var(--text);font-family:var(--font-body);font-size:1.1rem"
            oninput="wizard.data.priceItem=this.value"
            onkeydown="if(event.key==='Enter')wizardNext()">
        </div>
        ${s.note && s.note(wizard.data) ? `<div style="font-size:0.8rem;color:var(--accent2);margin-top:0.6rem;padding:0.5rem 0.75rem;background:rgba(201,146,42,0.1);border-radius:6px">${s.note(wizard.data)}</div>` : ''}
        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>
      </div>`;
    setTimeout(() => { const i = document.getElementById('wiz-price-item'); if(i) i.focus(); }, 50);

  } else if (s.type === 'money') {
    const val = wizard.data[s.id] || '';
    const moneyNote = s.note ? s.note(wizard.data) : '';
    const moneyNoteHtml = moneyNote ? '<div style="font-size:0.82rem;color:var(--accent2);margin-top:0.6rem;padding:0.5rem 0.75rem;background:rgba(201,146,42,0.12);border:1px solid rgba(201,146,42,0.4);border-radius:6px;line-height:1.4">' + moneyNote + '</div>' : '';
    body.innerHTML = `
      <div style="padding-top:0.75rem">
        <div style="display:flex;align-items:center;gap:0.5rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem">
          <span style="color:var(--text-dim);font-size:1.2rem">$</span>
          <input type="number" id="wiz-input" value="${val}" placeholder="${s.placeholder || '0.00'}" min="0" step="0.01"
            style="flex:1;background:none;border:none;outline:none;color:var(--text);font-family:var(--font-body);font-size:1.1rem"
            oninput="wizard.data['${s.id}']=this.value"
            onkeydown="if(event.key==='Enter')wizardNext()">
        </div>
        ${moneyNoteHtml}
        ${s.optional ? '<div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>' : ''}
      </div>`;
    setTimeout(() => { const i = document.getElementById('wiz-input'); if(i) i.focus(); }, 50);

  } else if (s.type === 'yearMade') {
    var wData = wizard.data;
    var _itmNum  = (wData.itemNum  || '').trim();
    var _vartn = (wData.variation || '').trim();
    var _match = state.masterData.find(function(m) {
        return normalizeItemNum(m.itemNum) === normalizeItemNum(_itmNum) && (!_vartn || m.variation === _vartn);
      }) || state.masterData.find(function(m) { return normalizeItemNum(m.itemNum) === normalizeItemNum(_itmNum); });
    var yearRange = _match ? (_match.yearProd || '') : '';
    var curr = wData.yearMade || '';

    // Parse yearRange into individual year integers
    var rangeYears = [];
    if (yearRange) {
      yearRange.split(/[,;]/).forEach(function(part) {
        part = part.trim();
        var rm = part.match(/^(\d{4})\s*[\-\u2013]\s*(\d{2,4})$/);
        if (rm) {
          var st = parseInt(rm[1]), en = parseInt(rm[2]);
          if (en < 100) en = Math.floor(st/100)*100 + en;
          for (var y = st; y <= Math.min(en, st+25); y++) rangeYears.push(y);
        } else if (/^\d{4}$/.test(part)) {
          rangeYears.push(parseInt(part));
        }
      });
      rangeYears = rangeYears.filter(function(v,i,a){ return a.indexOf(v)===i; }).sort(function(a,b){return a-b;});
    }
    wizard._yearRangeYears = rangeYears;

    var yearWrap = document.createElement('div');
    yearWrap.style.cssText = 'padding-top:0.75rem';

    if (rangeYears.length > 0) {
      var hdr = document.createElement('div');
      hdr.style.cssText = 'font-size:0.78rem;font-weight:600;color:#2980b9;margin-bottom:0.5rem';
      hdr.textContent = 'Known production years â€” tap to select:';
      yearWrap.appendChild(hdr);

      var grid = document.createElement('div');
      grid.id = 'year-btn-grid';
      grid.style.cssText = 'display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:0.85rem';
      rangeYears.forEach(function(yr) {
        var btn = document.createElement('button');
        var isSel = String(yr) === String(curr);
        btn.style.cssText = 'padding:0.45rem 0.8rem;border-radius:8px;font-family:var(--font-mono);font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.15s;'
          + (isSel ? 'border:2px solid var(--accent);background:rgba(232,64,28,0.15);color:var(--accent)'
                   : 'border:1.5px solid var(--border);background:var(--surface2);color:var(--text-mid)');
        btn.textContent = yr;
        btn.onclick = (function(yrVal) { return function() {
          wizard.data.yearMade = String(yrVal);
          var inp2 = document.getElementById('wiz-year-input');
          if (inp2) inp2.value = yrVal;
          document.querySelectorAll('#year-btn-grid button').forEach(function(b) {
            var s2 = b.textContent === String(yrVal);
            b.style.border = s2 ? '2px solid var(--accent)' : '1.5px solid var(--border)';
            b.style.background = s2 ? 'rgba(232,64,28,0.15)' : 'var(--surface2)';
            b.style.color = s2 ? 'var(--accent)' : 'var(--text-mid)';
          });
          var w2 = document.getElementById('year-range-warning');
          if (w2) w2.remove();
          setTimeout(function() { wizardNext(); }, 120);
        }; })(yr);
        grid.appendChild(btn);
      });
      yearWrap.appendChild(grid);
    }

    var manualLbl = document.createElement('div');
    manualLbl.style.cssText = 'font-size:0.75rem;color:var(--text-dim);margin-bottom:0.3rem';
    manualLbl.textContent = rangeYears.length > 0 ? 'Or type a year manually:' : 'Enter the year:';
    yearWrap.appendChild(manualLbl);

    var yearInp = document.createElement('input');
    yearInp.type = 'number'; yearInp.id = 'wiz-year-input';
    yearInp.value = curr; yearInp.placeholder = 'e.g. 1952';
    yearInp.style.cssText = 'width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem;color:var(--text);font-family:var(--font-mono);font-size:1.2rem;outline:none;letter-spacing:0.1em';
    yearInp.oninput = function() { wizard.data.yearMade = yearInp.value; };
    yearInp.onkeydown = function(e) { if (e.key === 'Enter') yearMadeNext(); };
    yearWrap.appendChild(yearInp);

    var skiphint = document.createElement('div');
    skiphint.style.cssText = 'font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem';
    skiphint.textContent = 'Optional â€” press Next to skip.';
    yearWrap.appendChild(skiphint);

    body.innerHTML = '';
    body.appendChild(yearWrap);
    setTimeout(function() { var i = document.getElementById('wiz-year-input'); if(i) i.focus(); }, 50);


  } else if (s.type === 'postwarYear') {
    var _pwCurr = wizard.data[s.id] || '';
    var _pwWrap = document.createElement('div');
    _pwWrap.style.cssText = 'padding-top:0.5rem';
    var _pwHint = document.createElement('div');
    _pwHint.style.cssText = 'font-size:0.78rem;font-weight:600;color:#2980b9;margin-bottom:0.6rem';
    _pwHint.textContent = 'Tap the year:';
    _pwWrap.appendChild(_pwHint);
    var _pwGrid = document.createElement('div');
    _pwGrid.id = 'postwar-year-grid';
    _pwGrid.style.cssText = 'display:flex;flex-wrap:wrap;gap:0.4rem';
    for (var _y = 1945; _y <= 1969; _y++) {
      (function(yr) {
        var _btn = document.createElement('button');
        var _sel = String(yr) === String(_pwCurr);
        _btn.style.cssText = 'padding:0.45rem 0.7rem;border-radius:8px;font-family:var(--font-mono);font-size:0.88rem;font-weight:600;cursor:pointer;transition:all 0.15s;'
          + (_sel ? 'border:2px solid var(--accent);background:rgba(232,64,28,0.15);color:var(--accent)'
                  : 'border:1.5px solid var(--border);background:var(--surface2);color:var(--text-mid)');
        _btn.textContent = yr;
        _btn.onclick = function() {
          wizard.data[s.id] = String(yr);
          document.querySelectorAll('#postwar-year-grid button').forEach(function(b) {
            var isSel = b.textContent === String(yr);
            b.style.border = isSel ? '2px solid var(--accent)' : '1.5px solid var(--border)';
            b.style.background = isSel ? 'rgba(232,64,28,0.15)' : 'var(--surface2)';
            b.style.color = isSel ? 'var(--accent)' : 'var(--text-mid)';
          });
          setTimeout(function() { wizardNext(); }, 120);
        };
        _pwGrid.appendChild(_btn);
      })(_y);
    }
    _pwWrap.appendChild(_pwGrid);
    body.innerHTML = '';
    body.appendChild(_pwWrap);
    // Hide Next â€” year buttons auto-advance
    var _pwNb = document.getElementById('wizard-next-btn');
    if (_pwNb) _pwNb.style.display = 'none';

  } else if (s.type === 'date') {
    const val = wizard.data[s.id] || '';
    body.innerHTML = `
      <div style="padding-top:0.75rem">
        <input type="date" id="wiz-input" value="${val}"
          style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;
          padding:0.75rem 1rem;color:var(--text);font-family:var(--font-body);font-size:1rem;outline:none"
          oninput="wizard.data['${s.id}']=this.value">
        ${s.note && s.note(wizard.data) ? `<div style="font-size:0.8rem;color:var(--accent2);margin-top:0.6rem;padding:0.5rem 0.75rem;background:rgba(201,146,42,0.1);border-radius:6px">${s.note(wizard.data)}</div>` : ''}
        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>
      </div>`;

  } else if (s.type === 'setMatch') {
    const itemNum = (wizard.data.itemNum || '').trim();
    const partner = getSetPartner(itemNum);
    const unitType = itemNum.endsWith('C') ? 'B unit' : 'A unit';
    const current = wizard.data.setMatch || '';

    // Check if user already owns a unit from this set
    const baseNum = itemNum.endsWith('C') ? itemNum.slice(0,-1) : itemNum;
    const ownedPartner = Object.values(state.personalData).find(pd =>
      pd.itemNum === baseNum || pd.itemNum === baseNum + 'C'
    );

    const smContainer = document.createElement('div');
    smContainer.style.cssText = 'padding-top:0.5rem';

    const intro = document.createElement('div');
    intro.style.cssText = 'font-size:0.85rem;color:var(--text-dim);margin-bottom:1rem';
    intro.textContent = 'This is a ' + unitType + ' that can be part of a multi-unit diesel set' + (partner ? ' (partner: ' + partner + ')' : '') + '.';
    smContainer.appendChild(intro);

    const opts = [
      { val: 'set-now',   icon: 'ðŸš‚ðŸš‚', label: 'Adding as a set now',        desc: 'Walk through all units together' },
      { val: 'link',      icon: 'ðŸ”—',   label: 'Link to unit already owned', desc: ownedPartner ? 'Found: ' + ownedPartner.itemNum + ' in your collection' : 'Assign same Set ID as existing unit', disabled: !ownedPartner },
      { val: 'standalone',icon: 'ðŸš‚',   label: 'Standalone / no set',        desc: 'Save this unit by itself' },
    ];

    opts.forEach(function(opt) {
      const btn = document.createElement('button');
      const sel = current === opt.val;
      btn.style.cssText = 'text-align:left;padding:0.85rem 1rem;border-radius:10px;cursor:pointer;width:100%;margin-bottom:0.5rem;'
        + 'border:2px solid ' + (sel ? 'var(--accent)' : 'var(--border)') + ';'
        + 'background:' + (sel ? 'rgba(232,64,28,0.12)' : 'var(--surface2)') + ';'
        + 'color:' + (opt.disabled ? 'var(--text-dim)' : 'var(--text)') + ';font-family:var(--font-body)';
      btn.disabled = opt.disabled;
      btn.onclick = function() {
        wizard.data.setMatch = opt.val;
        if (opt.val === 'set-now') {
          wizard.data._setId = genSetId(baseNum);
          wizard.data.unit2ItemNum = partner || baseNum + 'C';
          wizard.data.unit3ItemNum = wizard.data.itemNum; // ABA: third unit = same A number
        }
        if (opt.val === 'link' && ownedPartner) {
          wizard.data._setId = ownedPartner.setId || genSetId(baseNum);
        }
        renderWizardStep();
      };
      const top = document.createElement('div');
      top.style.cssText = 'display:flex;align-items:center;gap:0.75rem';
      const iconEl = document.createElement('span');
      iconEl.style.cssText = 'font-size:1.3rem';
      iconEl.textContent = opt.icon;
      const labelEl = document.createElement('div');
      labelEl.innerHTML = '<div style="font-weight:600;color:' + (sel?'var(--accent)':'inherit') + '">' + opt.label + '</div>'
        + '<div style="font-size:0.78rem;color:var(--text-dim)">' + opt.desc + '</div>';
      top.appendChild(iconEl);
      top.appendChild(labelEl);
      btn.appendChild(top);
      smContainer.appendChild(btn);
    });

    // Set type selector (AA/AB/ABA) â€” only show when 'set-now' selected
    if (current === 'set-now') {
      const typeDiv = document.createElement('div');
      typeDiv.style.cssText = 'margin-top:0.75rem;padding:0.75rem;background:var(--bg);border-radius:8px;border:1px solid var(--border)';
      typeDiv.innerHTML = '<div style="font-size:0.78rem;color:var(--text-dim);margin-bottom:0.5rem">What type of set?</div>';
      const btnRow = document.createElement('div');
      btnRow.style.cssText = 'display:flex;gap:0.5rem';
      ['AA','AB','ABA'].forEach(function(t) {
        const tb = document.createElement('button');
        const tsel = wizard.data.setType === t;
        tb.style.cssText = 'flex:1;padding:0.5rem;border-radius:7px;font-weight:600;cursor:pointer;font-family:var(--font-head);'
          + 'border:2px solid ' + (tsel?'var(--accent2)':'var(--border)') + ';'
          + 'background:' + (tsel?'rgba(201,146,42,0.15)':'var(--surface2)') + ';'
          + 'color:' + (tsel?'var(--accent2)':'var(--text-mid)');
        tb.textContent = t;
        tb.onclick = function() { wizard.data.setType = t; renderWizardStep(); };
        btnRow.appendChild(tb);
      });
      typeDiv.appendChild(btnRow);
      smContainer.appendChild(typeDiv);
    }

    const hint = document.createElement('div');
    hint.style.cssText = 'font-size:0.75rem;color:var(--text-dim);margin-top:0.75rem';
    hint.textContent = 'Optional â€” press Next to skip';
    smContainer.appendChild(hint);

    body.innerHTML = '';
    body.appendChild(smContainer);

  } else if (s.type === 'setUnit2Num') {
    // Pre-filled unit number â€” let user confirm or change
    const isUnit3 = !!s.unit3;
    const field = isUnit3 ? 'unit3ItemNum' : 'unit2ItemNum';
    const curr = wizard.data[field] || '';
    const label = isUnit3
      ? 'Third unit item number (second A unit â€” edit if needed)'
      : 'Second unit item number (pre-filled from partner â€” edit if needed)';
    body.innerHTML = '<div style="padding-top:0.75rem">'
      + '<div style="font-size:0.82rem;color:var(--text-dim);margin-bottom:0.5rem">' + label + '</div>'
      + '<input type="text" id="wiz-unit-num" value="' + curr + '" autocomplete="off" '
      + 'style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem;color:var(--text);font-family:var(--font-body);font-size:1rem;outline:none" '
      + 'oninput="wizard.data[\'' + field + '\']=this.value; updateUnitNumSuggestions(this.value,\'' + field + '\')" '
      + 'onkeydown="handleUnitNumKey(event)">'
      + '<div id="wiz-unit-suggestions" style="display:none;flex-direction:column;gap:2px;margin-top:4px;max-height:200px;overflow-y:auto;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:4px"></div>'
      + '</div>';
    setTimeout(function() {
      const i = document.getElementById('wiz-unit-num');
      if (i) { i.focus(); if (i.value) updateUnitNumSuggestions(i.value, field); }
    }, 50);

  } else if (s.type === 'divider') {
    const sub = s.subtitle ? s.subtitle(wizard.data) : '';
    body.innerHTML = '<div style="padding-top:1rem;text-align:center">'
      + '<div style="font-size:3rem;margin-bottom:0.75rem">ðŸšƒ</div>'
      + '<div style="font-size:0.95rem;color:var(--text-dim);line-height:1.6;max-width:340px;margin:0 auto">' + sub + '</div>'
      + '</div>';

  } else if (s.type === 'tenderMatch') {
    const tmItemNum = (wizard.data.itemNum || '').trim();
    const tmTenders = getMatchingTenders(tmItemNum);
    const tmLocos   = getMatchingLocos(tmItemNum);
    const tmIsTend  = tmLocos.length > 0;
    const tmCandidates = tmIsTend ? tmLocos : tmTenders;
    const tmRole    = tmIsTend ? 'locomotive' : 'tender';
    const tmCurrent = wizard.data.tenderMatch || '';
    const tmIntro   = tmIsTend
      ? ('This tender (' + tmItemNum + ') pairs with the following locomotive(s):')
      : ('This steam engine (' + tmItemNum + ') pairs with the following tender(s):');

    const tmContainer = document.createElement('div');
    tmContainer.style.cssText = 'padding-top:0.5rem';

    const tmIntroEl = document.createElement('div');
    tmIntroEl.style.cssText = 'font-size:0.85rem;color:var(--text-dim);margin-bottom:1rem';
    tmIntroEl.textContent = tmIntro;
    tmContainer.appendChild(tmIntroEl);

    tmCandidates.forEach(function(num) {
      const masterItem = state.masterData.find(function(m) { return m.itemNum === num; });
      const desc = masterItem ? (masterItem.roadName || masterItem.description || masterItem.itemType || '') : '';
      const owned = Object.values(state.personalData).find(function(pd) { return pd.itemNum === num; });
      const sel = tmCurrent === num;

      const btn = document.createElement('button');
      btn.style.cssText = 'text-align:left;padding:0.85rem 1rem;border-radius:10px;cursor:pointer;width:100%;margin-bottom:0.5rem;'
        + 'border:2px solid ' + (sel ? 'var(--accent)' : 'var(--border)') + ';'
        + 'background:' + (sel ? 'rgba(232,64,28,0.12)' : 'var(--surface2)') + ';'
        + 'color:var(--text);font-family:var(--font-body)';
      btn.onclick = function() { wizard.data.tenderMatch = num; renderWizardStep(); };

      const topRow = document.createElement('div');
      topRow.style.cssText = 'display:flex;align-items:center;justify-content:space-between';

      const numSpan = document.createElement('span');
      numSpan.style.cssText = 'font-family:var(--font-head);font-size:1.2rem;color:' + (sel ? 'var(--accent)' : 'var(--text)');
      numSpan.textContent = (tmIsTend ? 'ðŸš‚ ' : 'ðŸšƒ ') + num;
      topRow.appendChild(numSpan);

      if (owned) {
        const badge = document.createElement('span');
        badge.style.cssText = 'font-size:0.7rem;color:var(--accent2);border:1px solid var(--accent2);padding:0.15rem 0.5rem;border-radius:4px';
        badge.textContent = 'âœ“ In Collection';
        topRow.appendChild(badge);
      }
      btn.appendChild(topRow);

      if (desc) {
        const descEl = document.createElement('div');
        descEl.style.cssText = 'font-size:0.8rem;color:var(--text-dim);margin-top:0.2rem';
        descEl.textContent = desc;
        btn.appendChild(descEl);
      }
      tmContainer.appendChild(btn);
    });

    const noneBtn = document.createElement('button');
    noneBtn.style.cssText = 'text-align:left;padding:0.75rem 1rem;border-radius:10px;cursor:pointer;width:100%;'
      + 'border:2px solid var(--border);background:' + (tmCurrent === 'none' ? 'var(--surface2)' : 'transparent') + ';'
      + 'color:var(--text-dim);font-family:var(--font-body);font-size:0.85rem';
    noneBtn.textContent = 'No matching ' + tmRole + ' / not applicable';
    noneBtn.onclick = function() { wizard.data.tenderMatch = 'none'; renderWizardStep(); };
    tmContainer.appendChild(noneBtn);

    const tmHint = document.createElement('div');
    tmHint.style.cssText = 'font-size:0.75rem;color:var(--text-dim);margin-top:0.75rem';
    tmHint.textContent = 'Optional â€” press Next to skip';
    tmContainer.appendChild(tmHint);

    body.innerHTML = '';
    body.appendChild(tmContainer);

  } else if (s.type === 'drivePhotos') {
    const views = s.views ? s.views : s.label === 'Box' ? BOX_VIEWS : s.label === 'Error' ? ERROR_VIEWS : ITEM_VIEWS;
    const stored = wizard.data[s.id] || {};

    // Build a photo slot element (used for both fixed and extra slots)
    function makePhotoSlot(viewKey, label, abbr, stepId) {
      const url = stored[viewKey] || '';
      const wrapper = document.createElement('div');
      wrapper.style.cssText = 'display:contents';
      wrapper.innerHTML = `<div class="photo-drop-zone" data-view="${viewKey}" data-sid="${stepId}"
        ondragover="event.preventDefault();this.style.borderColor='var(--accent)'"
        ondragleave="this.style.borderColor='var(--border)'"
        ondrop="handlePhotoDrop(event,'${stepId}','${viewKey}')"
        onclick="showPhotoSourcePicker('${stepId}','${viewKey}')"
        style="border:2px dashed var(--border);border-radius:10px;min-height:90px;
        display:flex;flex-direction:column;align-items:center;justify-content:center;
        cursor:pointer;transition:border-color 0.2s;position:relative;overflow:hidden;
        background:var(--surface2)">
        ${url
          ? `<img loading="lazy" src="${url}" style="width:100%;height:100%;object-fit:cover;position:absolute;inset:0" onerror="this.style.display='none'">
             <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.6);
             font-size:0.62rem;color:#fff;padding:2px 4px;text-align:center">${abbr} âœ“</div>`
          : `<div style="font-size:0.7rem;color:var(--text-dim);text-align:center;padding:0.5rem">
             <div style="font-size:1.4rem;margin-bottom:0.2rem">ðŸ“·</div>
             <div style="font-weight:600;color:var(--text-mid)">${abbr}</div>
             <div style="font-size:0.62rem">${label}</div>
             </div>`
        }
        <div id="prog-${stepId}-${viewKey}" style="display:none;position:absolute;inset:0;
          background:rgba(0,0,0,0.7);align-items:center;justify-content:center;flex-direction:column">
          <div style="color:white;font-size:0.75rem">Uploadingâ€¦</div>
        </div>
      </div>
`;
      return wrapper;
    }

    // Count existing extra slots stored in wizard data
    const _existingExtras = Object.keys(stored).filter(k => k.startsWith('EXTRA-'));
    const _extraCount = { val: _existingExtras.length };

    // Show orientation reminder for item/locomotive photo steps only
    const _isItemPhotoStep = (s.label === 'Item' || s.label === 'IS' === false) &&
      !['Box','Error','IS','Catalog'].includes(s.label);

    body.innerHTML = '';
    const wrap = document.createElement('div');
    wrap.style.cssText = 'padding-top:0.25rem';

    // Friendly orientation note for item photos
    if (_isItemPhotoStep) {
      const orientNote = document.createElement('div');
      orientNote.style.cssText = 'background:rgba(200,16,46,0.06);border:1px solid rgba(41,128,185,0.25);border-radius:10px;padding:0.75rem 0.8rem;margin-bottom:0.75rem;text-align:center';
      orientNote.innerHTML = `
        <div style="font-size:0.75rem;font-weight:600;color:#2980b9;margin-bottom:0.6rem;letter-spacing:0.03em">ðŸ“ Orientation tip</div>
        <div style="display:flex;align-items:center;justify-content:center;gap:0.6rem;margin-bottom:0.5rem">
          <div style="font-size:0.72rem;color:var(--text-dim);white-space:nowrap;font-family:var(--font-mono)">â† Rear View</div>
          <div style="display:flex;flex-direction:column;align-items:center;gap:0.3rem">
            <img loading="lazy" src="data:image/png;base64,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" style="width:130px;height:auto;display:block;border-radius:6px;opacity:0.9">
            <div style="font-size:0.7rem;color:#2980b9;font-weight:600;letter-spacing:0.04em">Right Side View</div>
          </div>
          <div style="font-size:0.72rem;color:var(--text-dim);white-space:nowrap;font-family:var(--font-mono)">Front View â†’</div>
        </div>
        <div style="font-size:0.74rem;color:var(--text-mid);text-align:center">Keeping this consistent makes your collection look sharp!</div>`;
      wrap.appendChild(orientNote);
    }

    const introDiv = document.createElement('div');
    introDiv.style.cssText = 'font-size:0.78rem;color:var(--text-dim);margin-bottom:0.5rem';
    introDiv.textContent = 'Drag & drop or click each slot to upload. Photos save to Google Drive automatically.';
    wrap.appendChild(introDiv);

    if (s.note && s.note(wizard.data)) {
      const noteDiv = document.createElement('div');
      noteDiv.style.cssText = 'font-size:0.8rem;color:var(--accent2);margin-bottom:0.75rem;padding:0.5rem 0.75rem;background:rgba(201,146,42,0.1);border-radius:6px';
      noteDiv.textContent = s.note(wizard.data);
      wrap.appendChild(noteDiv);
    }

    const grid = document.createElement('div');
    grid.id = 'photo-grid';
    grid.style.cssText = 'display:grid;grid-template-columns:1fr 1fr;gap:0.6rem';

    // Render fixed views
    views.forEach(v => grid.appendChild(makePhotoSlot(v.key, v.label, v.abbr, s.id)));

    // Re-render any previously added extra slots
    _existingExtras.sort().forEach(k => {
      const n = k.replace('EXTRA-','');
      grid.appendChild(makePhotoSlot(k, 'Extra Photo ' + n, 'EXTRA-' + n, s.id));
    });

    wrap.appendChild(grid);

    // "Add another photo" button
    const addBtn = document.createElement('button');
    addBtn.style.cssText = 'margin-top:0.6rem;display:flex;align-items:center;gap:0.4rem;padding:0.45rem 0.9rem;border-radius:8px;border:1.5px dashed var(--border);background:none;color:var(--text-dim);cursor:pointer;font-family:var(--font-body);font-size:0.82rem;width:100%;justify-content:center;transition:all 0.15s';
    addBtn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg> Add another photo';
    addBtn.onmouseover = () => { addBtn.style.borderColor = 'var(--accent)'; addBtn.style.color = 'var(--accent)'; };
    addBtn.onmouseout  = () => { addBtn.style.borderColor = 'var(--border)'; addBtn.style.color = 'var(--text-dim)'; };
    addBtn.onclick = () => {
      // Ask for a label first so the photo is meaningfully named
      const _extraPrompt = document.createElement('div');
      _extraPrompt.style.cssText = 'margin-top:0.5rem;display:flex;gap:0.4rem;align-items:center';
      _extraPrompt.innerHTML = `
        <input id="extra-photo-title" type="text" maxlength="40"
          placeholder='e.g. "Torn page", "Scratch", "Detail"'
          style="flex:1;padding:0.4rem 0.65rem;border-radius:7px;border:1.5px solid var(--accent);
          background:var(--bg);color:var(--text);font-family:var(--font-body);font-size:0.82rem;outline:none">
        <button id="extra-photo-go" style="padding:0.4rem 0.8rem;border-radius:7px;border:none;
          background:var(--accent);color:white;font-family:var(--font-body);font-size:0.82rem;cursor:pointer;
          white-space:nowrap">Add Photo</button>
        <button id="extra-photo-cancel" style="padding:0.4rem 0.6rem;border-radius:7px;border:1px solid var(--border);
          background:none;color:var(--text-dim);font-family:var(--font-body);font-size:0.82rem;cursor:pointer">âœ•</button>`;

      // Replace button with inline form
      addBtn.style.display = 'none';
      addBtn.parentNode.insertBefore(_extraPrompt, addBtn.nextSibling);

      const titleInp = document.getElementById('extra-photo-title');
      const goBtn    = document.getElementById('extra-photo-go');
      const cancelBtn = document.getElementById('extra-photo-cancel');

      titleInp.focus();

      const doAdd = () => {
        const title = titleInp.value.trim() || ('Extra ' + (_extraCount.val + 1));
        _extraCount.val++;
        // Build file-safe key: EXTRA-N-title (spacesâ†’underscore, strip special chars)
        const safeTitle = title.replace(/[^a-zA-Z0-9 _-]/g,'').replace(/ +/g,'_').substring(0, 30);
        const key = 'EXTRA-' + _extraCount.val + (safeTitle ? '-' + safeTitle : '');
        _extraPrompt.remove();
        addBtn.style.display = '';
        grid.appendChild(makePhotoSlot(key, title, title, s.id));
        setTimeout(() => {
          const inp = document.getElementById('file-' + s.id + '-' + key);
          if (inp) inp.click();
        }, 50);
      };

      goBtn.onclick = doAdd;
      cancelBtn.onclick = () => { _extraPrompt.remove(); addBtn.style.display = ''; };
      titleInp.onkeydown = e => { if (e.key === 'Enter') doAdd(); if (e.key === 'Escape') cancelBtn.onclick(); };
    };
    wrap.appendChild(addBtn);

    const hint = document.createElement('div');
    hint.style.cssText = 'font-size:0.75rem;color:var(--text-dim);margin-top:0.4rem';
    hint.textContent = 'Optional â€” press Next to skip any views';
    wrap.appendChild(hint);

    body.appendChild(wrap);

  } else if (s.type === 'textarea') {
    const val = wizard.data[s.id] || '';
    // Use step-specific placeholder or fall back to a helpful default for notes
    const _notesPlaceholder = s.id === 'notes'
      ? 'e.g. Purchased at train show, minor rust on trucks, runs well'
      : (s.placeholder || '');
    body.innerHTML = `
      <div style="padding-top:0.75rem">
        <textarea id="wiz-input" placeholder="Optional notesâ€¦"
          style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;
          padding:0.75rem 1rem;color:var(--text);font-family:var(--font-body);font-size:0.9rem;
          outline:none;resize:vertical;min-height:100px"
          oninput="wizard.data['${s.id}']=this.value">${val}</textarea>
        ${s.note && s.note(wizard.data) ? `<div style="font-size:0.8rem;color:var(--accent2);margin-top:0.6rem;padding:0.5rem 0.75rem;background:rgba(201,146,42,0.1);border-radius:6px">${s.note(wizard.data)}</div>` : ''}
        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>
      </div>`;
    setTimeout(() => { const i = document.getElementById('wiz-input'); if(i) i.focus(); }, 50);

  } else if (s.type === 'pickSoldItem') {
    const itemNum = (wizard.data.itemNum || '').trim();
    const matchKeys = Object.keys(state.personalData).filter(k => {
      const pd = state.personalData[k];
      // Show all owned rows for this item number
      // Include rows with real item info (condition not N/A or empty)
      return k.split('|')[0] === itemNum && pd.owned;
    });
      const selected = wizard.data.selectedSoldKey || '';
    body.innerHTML = `
      <div style="padding-top:0.5rem;display:flex;flex-direction:column;gap:0.5rem">
        ${matchKeys.length === 0 ? '<div style="color:var(--text-dim);font-size:0.85rem">No owned items found for this number.</div>' : ''}
        ${matchKeys.map(k => {
          const pd = state.personalData[k];
          const isSelected = selected === k;
          return `<button onclick="wizardPickSoldItem('${k}')" style="
            display:flex;align-items:flex-start;gap:0.75rem;padding:0.85rem 1rem;
            border-radius:10px;text-align:left;width:100%;cursor:pointer;
            font-family:var(--font-body);transition:all 0.15s;
            border:2px solid ${isSelected ? 'var(--accent)' : 'var(--border)'};
            background:${isSelected ? 'rgba(232,64,28,0.12)' : 'var(--surface2)'};
          ">
            <div style="flex:1">
              <div style="font-family:var(--font-mono);color:var(--accent2);font-size:0.9rem;font-weight:600">
                ${pd.itemNum}${pd.variation ? ' â€” Var ' + pd.variation : ''}
              </div>
              <div style="font-size:0.8rem;color:var(--text-mid);margin-top:0.3rem;display:flex;gap:1rem;flex-wrap:wrap">
                ${pd.condition ? `<span>Condition: <strong style="color:var(--text)">${pd.condition}</strong></span>` : ''}
                ${pd.hasBox === 'Yes' ? `<span style="color:var(--green)">âœ“ Has box</span>` : ''}
                ${pd.priceItem ? `<span>Paid: <strong style="color:var(--text)">$${parseFloat(pd.priceItem).toLocaleString()}</strong></span>` : ''}
                ${pd.allOriginal === 'Yes' ? `<span style="color:var(--accent2)">All original</span>` : ''}
              </div>
            </div>
            ${isSelected ? '<span style="color:var(--accent);font-size:1.1rem;align-self:center">âœ“</span>' : ''}
          </button>`;
        }).join('')}
        <button onclick="wizardPickSoldItem('__new__')" style="
          padding:0.75rem 1rem;border-radius:10px;text-align:left;width:100%;cursor:pointer;
          font-family:var(--font-body);font-size:0.85rem;transition:all 0.15s;
          border:2px solid ${selected==='__new__' ? 'var(--border)' : 'var(--border)'};
          background:var(--surface2);color:var(--text-dim);
        ">Not in my collection â€” enter details manually</button>
      </div>`;

  } else if (s.type === 'pickRow') {
    const itemNum = (wizard.data.itemNum || '').trim();
    const matchKeys = Object.keys(state.personalData).filter(k => k.split('|')[0] === itemNum);
    const selected = wizard.data.selectedRowKey || '';
    body.innerHTML = `
      <div style="padding-top:0.5rem;display:flex;flex-direction:column;gap:0.5rem">
        ${matchKeys.map(k => {
          const pd = state.personalData[k];
          const hasBoxAlready = pd.hasBox === 'Yes';
          const isSelected = selected === k;
          return `<button onclick="wizardPickRow('${k}')" style="
            display:flex;align-items:center;gap:0.75rem;padding:0.85rem 1rem;
            border-radius:10px;text-align:left;width:100%;cursor:pointer;
            font-family:var(--font-body);transition:all 0.15s;
            border:2px solid ${isSelected ? 'var(--accent)' : 'var(--border)'};
            background:${isSelected ? 'rgba(232,64,28,0.12)' : 'var(--surface2)'};
          ">
            <div style="flex:1">
              <div style="font-family:var(--font-mono);color:var(--accent2);font-size:0.85rem">${pd.itemNum} ${pd.variation ? 'â€” Var ' + pd.variation : ''}</div>
              <div style="font-size:0.8rem;color:var(--text-mid);margin-top:0.2rem">
                Condition: ${pd.condition || 'â€”'} Â· 
                ${hasBoxAlready
                  ? '<span style="color:var(--accent2)">Already has a box â€” will add new row</span>'
                  : '<span style="color:var(--green)">No box yet â€” will update this row</span>'}
              </div>
            </div>
            ${isSelected ? '<span style="color:var(--accent);font-size:1rem">âœ“</span>' : ''}
          </button>`;
        }).join('')}
      </div>`;

  } else if (s.type === 'confirm') {
    const item = wizard.matchedItem;
    const _isEph = ['catalogs','paper','mockups','other',...(state.userDefinedTabs||[]).map(t=>t.id)].includes(wizard.tab);
    // Human-readable key labels for confirm summary
    const _keyLabels = {
      itemCategory:'Category', cat_type:'Type', cat_year:'Year',
      hasIS:'Has Instruction Sheet', is_sheetNum:'Sheet #', is_condition:'Sheet Condition',
      notOriginalDesc:'Modifications', tenderNotOriginalDesc:'Tender Modifications',
      unit2NotOriginalDesc:'Unit 2 Modifications', unit3NotOriginalDesc:'Unit 3 Modifications',
      cat_hasMailer:'Has Envelope/Mailer', cat_condition:'Condition',
      cat_estValue:'Est. Value', cat_dateAcquired:'Date Acquired', cat_notes:'Notes',
      eph_title:'Title', eph_description:'Description', eph_year:'Year',
      eph_condition:'Condition', eph_quantity:'Quantity', eph_estValue:'Est. Value',
      eph_dateAcquired:'Date Acquired', eph_notes:'Notes',
      eph_itemNumRef:'Item # Ref', eph_productionStatus:'Production Status',
      eph_material:'Material', eph_dimensions:'Dimensions',
      eph_lionelVerified:'Lionel Verified',
    };
    const _skipKeys = new Set(['tab','itemCategory','_photoOnly','_attachToBox','_tenderDone','_setDone','tenderMatch','setMatch','setType','unitPower','wantErrorPhotos']);
    const _summaryEntries = Object.entries(wizard.data).filter(([k,v]) =>
      !_skipKeys.has(k) && v && v !== '' && !Array.isArray(v) && typeof v !== 'object'
    );
    body.innerHTML = `
      <div style="padding-top:0.5rem">
        ${!_isEph && item ? `
          <div style="background:var(--surface2);border-radius:8px;padding:0.85rem;margin-bottom:1rem">
            <div style="font-family:var(--font-mono);color:var(--accent2);font-size:0.8rem">No. ${item.itemNum}${item.variation ? ' â€” Var ' + item.variation : ''}</div>
            <div style="font-weight:600;margin-top:0.2rem">${item.roadName || item.itemType || ''}</div>
            <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.1rem">${item.yearProd || ''} Â· ${item.itemType || ''}</div>
          </div>` : !_isEph ? `
          <div style="background:var(--surface2);border-radius:8px;padding:0.85rem;margin-bottom:1rem">
            <div style="font-family:var(--font-mono);color:var(--accent2)">Item ${wizard.data.itemNum || '?'}${wizard.data.variation ? ' Var ' + wizard.data.variation : ''}</div>
            <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.2rem">Not found in master inventory â€” will save with entered data</div>
          </div>` : ''}
        <div style="display:flex;flex-direction:column;gap:0.35rem;font-size:0.83rem">
          ${_summaryEntries.map(([k,v]) => {
            const label = _keyLabels[k] || k.replace(/^(cat_|eph_)/,'').replace(/([A-Z])/g,' $1').replace(/_/g,' ').toLowerCase().replace(/^./,c=>c.toUpperCase());
            const isVal = k.includes('Value') || k.includes('value') || k.includes('Price') || k.includes('price');
            const dispVal = isVal && parseFloat(v) ? '$'+parseFloat(v).toLocaleString() : v;
            return `<div style="display:flex;gap:0.5rem">
              <span style="color:var(--text-dim);min-width:130px;flex-shrink:0">${label}</span>
              <span>${dispVal}</span>
            </div>`;
          }).join('')}
        </div>
      </div>`;
  }
}

function wizardChooseCategory(catId) {
  if (catId === '__new__') {
    // Prompt for custom category name
    const name = prompt('Enter a name for your custom category:');
    if (!name || !name.trim()) return;
    const label = name.trim();
    const id = 'user_' + label.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'');
    // Check if already exists
    if (!state.userDefinedTabs.find(t => t.id === id)) {
      state.userDefinedTabs.push({ id, label });
      saveUserDefinedTabs();
      // Create the sheet tab
      ensureUserDefinedSheet(id, label);
    }
    wizard.data.itemCategory = id;
    wizard.tab = id;
    wizard.steps = getSteps(id);
    wizard.step = 0;
    renderWizardStep();
    return;
  }
  wizard.data.itemCategory = catId;
  if (catId !== 'lionel') {
    wizard.tab = catId;
    wizard.steps = getSteps(catId);
    wizard.step = 0;
    renderWizardStep();
  } else {
    setTimeout(() => wizardNext(), 150);
  }
}

async function ensureUserDefinedSheet(id, label) {
  if (!state.personalSheetId) return;
  try {
    const metaRes = await fetch(
      `https://sheets.googleapis.com/v4/spreadsheets/${state.personalSheetId}?fields=sheets.properties.title`,
      { headers: { Authorization: `Bearer ${accessToken}` } }
    );
    const meta = await metaRes.json();
    const existing = (meta.sheets || []).map(s => s.properties.title);
    if (!existing.includes(label)) {
      await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${state.personalSheetId}:batchUpdate`, {
        method: 'POST',
        headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ requests: [{ addSheet: { properties: { title: label } } }] }),
      });
      await sheetsUpdate(state.personalSheetId, `${label}!A1:A1`, [[label]]);
      await sheetsUpdate(state.personalSheetId, `${label}!A2:J2`, [EPHEMERA_HEADERS]);
    }
    // Initialize in state
    if (!state.ephemeraData[id]) state.ephemeraData[id] = {};
    showToast('âœ“ Created "' + label + '" tab');
  } catch(e) { console.error('Create user tab error:', e); }
}

function wizardChooseTab(tab) {
  wizard.tab = tab;
  wizard.data.tab = tab;
  wizard.steps = getSteps(tab);
  renderWizardStep();
}

function wizardChoose(field, val) {
  wizard.data[field] = val;
  renderWizardStep();
  // Auto-advance for choice2/choice3 but not tenderMatch (user may want to review)
  const s = wizard.steps[wizard.step];
  if (s && s.type !== 'tenderMatch') {
    setTimeout(() => wizardNext(), 200);
  }
}

// Find personalData entry by itemNum|variation prefix (key includes row number)
function findPD(itemNum, variation) {
  const prefix = `${itemNum}|${variation || ''}|`;
  const k = Object.keys(state.personalData).find(k => k.startsWith(prefix));
  return k ? state.personalData[k] : null;
}
function findPDKey(itemNum, variation) {
  const prefix = `${itemNum}|${variation || ''}|`;
  return Object.keys(state.personalData).find(k => k.startsWith(prefix)) || null;
}

// â”€â”€ PHOTO UPLOAD HANDLERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function handlePhotoDrop(event, stepId, viewKey) {
  event.preventDefault();
  event.currentTarget.style.borderColor = 'var(--border)';
  const file = event.dataTransfer.files[0];
  if (file && file.type.startsWith('image/')) {
    await uploadWizardPhoto(file, stepId, viewKey);
  }
}

async function handlePhotoFile(event, stepId, viewKey) {
  const file = event.target.files[0];
  if (file) await uploadWizardPhoto(file, stepId, viewKey);
}

async function uploadWizardPhoto(file, stepId, viewKey) {
  const d = wizard.data;
  // For tender/set photo steps, use the tender or engine item number for the Drive folder
  const isTenderPhotoStep = stepId === 'photosTenderItem' || stepId === 'photosTenderBox';
  const isUnit2PhotoStep = stepId === 'photosUnit2Item' || stepId === 'photosUnit2Box';
  const isUnit3PhotoStep = stepId === 'photosUnit3Item' || stepId === 'photosUnit3Box';
  const isSetPhotoStep = stepId === 'photosTogether';
  const itemNum = isTenderPhotoStep
    ? (d.tenderMatch || d.itemNum || 'unknown').trim()
    : isUnit2PhotoStep
      ? (d.unit2ItemNum || d.itemNum || 'unknown').trim()
      : isUnit3PhotoStep
        ? (d.itemNum || 'unknown').trim()  // unit3 = second A unit, same number
        : (d.itemNum || 'unknown').trim();
  const variation = (d.variation || '').trim();

  // Show progress overlay
  const prog = document.getElementById('prog-' + stepId + '-' + viewKey);
  if (prog) { prog.style.display = 'flex'; }

  try {
    const url = await driveUploadItemPhoto(file, itemNum, viewKey);
    if (!wizard.data[stepId]) wizard.data[stepId] = {};
    wizard.data[stepId][viewKey] = url;
    // Re-render just this zone
    const zone = document.querySelector(`.photo-drop-zone[data-view="${viewKey}"][data-sid="${stepId}"]`);
    if (zone && url) {
      zone.innerHTML = `
        <img loading="lazy" src="${url}" style="width:100%;height:100%;object-fit:cover;position:absolute;inset:0" onerror="this.style.display='none'">
        <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.6);
          font-size:0.62rem;color:#fff;padding:2px 4px;text-align:center">${viewKey} âœ“</div>`;
    }
  } catch(e) {
    console.error('Photo upload failed:', e);
    showToast('Photo upload failed: ' + e.message);
  } finally {
    if (prog) prog.style.display = 'none';
  }
}

function toggleBoxOnly() {
  wizard.data.boxOnly = !wizard.data.boxOnly;
  // Reset the step list so it picks up new boxOnly steps
  wizard.steps = getSteps(wizard.tab);
  renderWizardStep();
}

function wizardChooseAndAdvance(field, val) {
  wizard.data[field] = val;
  // Brief visual flash then advance
  setTimeout(() => wizardNext(), 150);
}

function toggleAttachToBox(itemNum) {
  wizard.data._attachToBox = !wizard.data._attachToBox;
  // Re-trigger lookup to refresh the checkbox display
  lookupItem(itemNum);
}

function wizardPickSoldItem(key) {
  wizard.data.selectedSoldKey = key;
  if (key !== '__new__') {
    const pd = state.personalData[key];
    if (pd) {
      // Pre-fill condition and original price from collection data
      if (pd.condition && pd.condition !== 'N/A') wizard.data.condition = parseInt(pd.condition);
      if (pd.priceItem && pd.priceItem !== 'N/A') wizard.data.priceItem = pd.priceItem;
    }
  }
  setTimeout(() => wizardNext(), 150);
}

function wizardPickRow(key) {
  wizard.data.selectedRowKey = key;
  setTimeout(() => wizardNext(), 150);
}

function wizardChooseVariation(variation) {
  wizard.data.variation = variation;
  setTimeout(() => wizardNext(), 150);
}

function updateWizardPhoto(field, idx, val) {
  // Legacy handler
  if (!wizard.data[field]) wizard.data[field] = {};
}

let itemLookupTimer;
let _suggestionIndex = -1;

function updateUnitNumSuggestions(query, field) {
  const el = document.getElementById('wiz-unit-suggestions');
  if (!el) return;
  const q = (query || '').trim().toLowerCase();
  if (q.length < 1) { el.style.display = 'none'; el.innerHTML = ''; return; }

  // Search master data for matching item numbers
  const seen = new Set();
  const candidates = [];
  state.masterData.forEach(function(m) {
    const num = normalizeItemNum(m.itemNum);
    if (!seen.has(num) && num.toLowerCase().includes(q)) {
      seen.add(num);
      candidates.push({ num: num, sub: (m.roadName || m.description || '').substring(0, 40) });
    }
  });

  candidates.sort(function(a, b) {
    const as = a.num.toLowerCase().startsWith(q);
    const bs = b.num.toLowerCase().startsWith(q);
    if (as && !bs) return -1;
    if (!as && bs) return 1;
    return a.num.localeCompare(b.num);
  });

  if (candidates.length === 0) { el.style.display = 'none'; el.innerHTML = ''; return; }
  const top = candidates;

  el.innerHTML = '';
  top.forEach(function(c) {
    const btn = document.createElement('button');
    btn.style.cssText = 'text-align:left;width:100%;padding:0.65rem 0.75rem;border:none;background:transparent;'
      + 'border-radius:6px;cursor:pointer;color:var(--text);font-family:var(--font-body);display:flex;align-items:baseline;gap:0.5rem;min-height:44px';
    btn.onmouseenter = function() { btn.style.background = 'var(--surface2)'; };
    btn.onmouseleave = function() { btn.style.background = 'transparent'; };
    btn.onclick = function() {
      wizard.data[field] = c.num;
      const inp = document.getElementById('wiz-unit-num');
      if (inp) inp.value = c.num;
      el.style.display = 'none';
    };
    const numSpan = document.createElement('span');
    numSpan.style.cssText = 'font-family:var(--font-mono);font-weight:600;color:var(--accent2);font-size:0.95rem';
    numSpan.textContent = c.num;
    btn.appendChild(numSpan);
    if (c.sub) {
      const sub = document.createElement('span');
      sub.style.cssText = 'font-size:0.75rem;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap';
      sub.textContent = c.sub;
      btn.appendChild(sub);
    }
    el.appendChild(btn);
  });
  el.style.display = 'flex';
}

function handleUnitNumKey(e, field) {
  if (e.key === 'Enter') { wizardNext(); }
  else if (e.key === 'Escape') {
    const el = document.getElementById('wiz-unit-suggestions');
    if (el) el.style.display = 'none';
  }
}

function updateItemSuggestions(query) {
  const el = document.getElementById('wiz-suggestions');
  if (!el) return;
  const q = (query || '').trim().toLowerCase();
  if (q.length < 1) { el.style.display = 'none'; el.innerHTML = ''; return; }

  // Choose source based on tab
  const tab = wizard.tab;
  let candidates = [];

  if (tab === 'sold') {
    // Sell tab: suggest from owned collection
    const seen = new Set();
    Object.values(state.personalData).forEach(pd => {
      const key = pd.itemNum + (pd.variation ? ' (' + pd.variation + ')' : '');
      if (!seen.has(key) && pd.itemNum.toLowerCase().includes(q)) {
        seen.add(key);
        candidates.push({ num: pd.itemNum, label: key, sub: '' });
      }
    });
  } else {
    // Collection + Want: suggest from master list â€” unique item numbers
    const seen = new Set();
    state.masterData.forEach(m => {
      if (!seen.has(m.itemNum) && m.itemNum.toLowerCase().includes(q)) {
        seen.add(m.itemNum);
        const road = m.roadName || m.description || '';
        candidates.push({ num: m.itemNum, label: m.itemNum, sub: road.substring(0, 40) });
      }
    });
  }

  // Sort: starts-with first, then contains
  candidates.sort((a, b) => {
    const aStarts = a.num.toLowerCase().startsWith(q);
    const bStarts = b.num.toLowerCase().startsWith(q);
    if (aStarts && !bStarts) return -1;
    if (!aStarts && bStarts) return 1;
    return a.num.localeCompare(b.num);
  });

  if (candidates.length === 0) { el.style.display = 'none'; el.innerHTML = ''; return; }

  _suggestionIndex = -1;
  el.innerHTML = '';

  // Count header so user knows how many matches exist
  const countBar = document.createElement('div');
  countBar.style.cssText = 'padding:0.3rem 0.75rem 0.4rem;font-size:0.72rem;color:var(--text-dim);border-bottom:1px solid var(--border);margin-bottom:2px;flex-shrink:0';
  countBar.textContent = candidates.length + ' match' + (candidates.length !== 1 ? 'es' : '') + ' â€” tap to select or keep typing to filter';
  el.appendChild(countBar);

  candidates.forEach(function(c, i) {
    const btn = document.createElement('button');
    btn.dataset.idx = i;
    btn.style.cssText = 'text-align:left;width:100%;padding:0.65rem 0.75rem;border:none;background:transparent;'
      + 'border-radius:6px;cursor:pointer;color:var(--text);font-family:var(--font-body);display:flex;align-items:baseline;gap:0.5rem;min-height:44px';
    btn.onmouseenter = function() { highlightSuggestion(i); };
    btn.onclick = function() { selectSuggestion(c.num); };
    const numSpan = document.createElement('span');
    numSpan.style.cssText = 'font-family:var(--font-mono);font-weight:600;color:var(--accent2);font-size:0.95rem';
    numSpan.textContent = c.num;
    btn.appendChild(numSpan);
    if (c.sub) {
      const subSpan = document.createElement('span');
      subSpan.style.cssText = 'font-size:0.75rem;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap';
      subSpan.textContent = c.sub;
      btn.appendChild(subSpan);
    }
    el.appendChild(btn);
  });
  el.style.display = 'flex';
}

function highlightSuggestion(idx) {
  _suggestionIndex = idx;
  const el = document.getElementById('wiz-suggestions');
  if (!el) return;
  el.querySelectorAll('button').forEach(function(btn, i) {
    btn.style.background = i === idx ? 'var(--surface2)' : 'transparent';
  });
}

function selectSuggestion(num) {
  wizard.data.itemNum = num;
  const inp = document.getElementById('wiz-input');
  if (inp) inp.value = num;
  const el = document.getElementById('wiz-suggestions');
  if (el) { el.style.display = 'none'; el.innerHTML = ''; }
  lookupItem(num);
  // Auto-advance to next step after a brief moment so lookupItem can render
  setTimeout(() => wizardNext(), 120);
}

function handleSuggestionKey(e) {
  const el = document.getElementById('wiz-suggestions');
  const btns = el ? el.querySelectorAll('button') : [];
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    highlightSuggestion(Math.min(_suggestionIndex + 1, btns.length - 1));
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    highlightSuggestion(Math.max(_suggestionIndex - 1, 0));
  } else if (e.key === 'Enter') {
    if (_suggestionIndex >= 0 && btns[_suggestionIndex]) {
      e.preventDefault();
      btns[_suggestionIndex].click();
    } else {
      wizardNext();
    }
  } else if (e.key === 'Escape') {
    if (el) { el.style.display = 'none'; }
  }
}

function debounceItemLookup(e) {
  clearTimeout(itemLookupTimer);
  itemLookupTimer = setTimeout(() => lookupItem(e.target.value), 400);
}

function lookupItem(num) {
  const match = state.masterData.find(i => i.itemNum.toLowerCase() === num.trim().toLowerCase());
  wizard.matchedItem = match || null;
  const el = document.getElementById('wiz-match');
  if (!el) return;
  const trimmed = num.trim();
  if (!trimmed) { el.innerHTML = ''; return; }

  if (wizard.tab === 'sold') {
    // Sold mode: check collection first, show what they own
    const collectionKeys = Object.keys(state.personalData).filter(k => k.split('|')[0] === trimmed);
    const inCollection = collectionKeys.length > 0;
    if (inCollection) {
      const count = collectionKeys.length;
      el.innerHTML = `<div style="background:rgba(46,204,113,0.1);border:1px solid var(--green);border-radius:8px;padding:0.65rem 0.85rem;font-size:0.82rem">
        <span style="color:var(--green)">âœ“ Found in your collection</span> â€” ${count} item${count>1?'s':''} Â· select which one on the next step
      </div>`;
    } else {
      // Not in collection â€” show master catalog info if available
      if (match) {
        el.innerHTML = `<div style="background:rgba(201,146,42,0.1);border:1px solid var(--accent2);border-radius:8px;padding:0.65rem 0.85rem;font-size:0.82rem">
          <span style="color:var(--accent2)">Not in your collection</span> Â· ${match.roadName || match.itemType || ''} Â· ${match.yearProd || ''}<br>
          <span style="color:var(--text-dim)">You can still enter sale details manually</span>
        </div>`;
      } else {
        el.innerHTML = `<div style="font-size:0.8rem;color:var(--text-dim)">Not found in collection or catalog â€” enter details manually</div>`;
      }
    }
  } else if (wizard.data.boxOnly) {
    // Box-only mode: show collection status
    const collectionKey = Object.keys(state.personalData).find(k => k.startsWith(trimmed + '|'));
    const inCollection = !!collectionKey;
    const pd = inCollection ? state.personalData[collectionKey] : null;
    if (match) {
      el.innerHTML = `<div style="border-radius:8px;padding:0.65rem 0.85rem;font-size:0.82rem;
        background:rgba(46,204,113,0.1);border:1px solid var(--green)">
        <div><span style="color:var(--green)">âœ“ Found in catalog:</span> ${match.roadName || match.itemType || ''} Â· ${match.yearProd || ''}</div>
        <div style="margin-top:0.4rem;padding-top:0.4rem;border-top:1px solid rgba(255,255,255,0.08)">
          ${inCollection
            ? `<span style="color:var(--green)">âœ“ In your collection</span> Â· Condition: ${pd.condition || '?'} Â· Has box: ${pd.hasBox || 'No'}`
            : `<span style="color:var(--accent2)">âš  Box will be listed under Lionel Number ${trimmed}</span>`}
        </div>
      </div>`;
    } else {
      el.innerHTML = `<div style="background:rgba(201,146,42,0.1);border:1px solid var(--accent2);border-radius:8px;padding:0.65rem 0.85rem;font-size:0.82rem">
        <span style="color:var(--accent2)">âš  Not found in catalog</span> â€” will save box info anyway
        ${inCollection ? '<br><span style="color:var(--green)">âœ“ Found in your collection</span>' : ''}
      </div>`;
    }
  } else {
    // Normal mode: show catalog match + check for existing box-only row
    const boxOnlyKeys = Object.keys(state.personalData).filter(k => {
      const pd = state.personalData[k];
      return k.split('|')[0] === trimmed && pd.hasBox === 'Yes' &&
        (!pd.condition || pd.condition === 'N/A') && (!pd.priceItem || pd.priceItem === 'N/A');
    });
    const hasBoxOnlyRow = boxOnlyKeys.length > 0;

    if (match) {
      el.innerHTML = `<div style="background:rgba(46,204,113,0.1);border:1px solid var(--green);border-radius:8px;padding:0.65rem 0.85rem;font-size:0.82rem">
        <span style="color:var(--green)">âœ“ Found:</span> ${match.roadName || match.itemType || ''} Â· ${match.yearProd || ''} Â· ${match.itemType || ''}
        ${match.variation ? '<br><span style="color:var(--text-dim)">Note: multiple variations exist â€” select on next step</span>' : ''}
        ${hasBoxOnlyRow ? `<div style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid rgba(255,255,255,0.08)">
          <span style="color:var(--accent2)">ðŸ“¦ A box is already logged for this item.</span>
          <label onclick="toggleAttachToBox('${trimmed}')" style="display:inline-flex;align-items:center;gap:0.4rem;margin-left:0.5rem;cursor:pointer">
            <span id="attach-box-check" style="
              display:inline-flex;align-items:center;justify-content:center;
              width:16px;height:16px;border-radius:3px;font-size:0.65rem;font-weight:700;color:white;
              background:${wizard.data._attachToBox ? 'var(--accent2)' : 'transparent'};
              border:2px solid ${wizard.data._attachToBox ? 'var(--accent2)' : 'var(--text-dim)'}
            ">${wizard.data._attachToBox ? 'âœ“' : ''}</span>
            <span style="color:var(--text-dim);font-size:0.8rem">Add item info to that box row</span>
          </label>
        </div>` : ''}
      </div>`;
    } else {
      el.innerHTML = `<div style="font-size:0.8rem;color:var(--text-dim)">Not found in master inventory â€” will save anyway</div>`;
    }
  }
}

function wizardBack() {
  if (wizard.step > 0) {
    wizard.step--;
    // Skip back over skipIf steps
    while (wizard.step > 0 && wizard.steps[wizard.step].skipIf && wizard.steps[wizard.step].skipIf(wizard.data)) {
      wizard.step--;
    }
    renderWizardStep();
  }
}

function wizardNextWithYearCheck() {
  const yr = parseInt(wizard.data.yearMade);
  const rangeYears = wizard._yearRangeYears || [];
  if (yr && rangeYears.length > 0 && !rangeYears.includes(yr)) {
    const min = rangeYears[0], max = rangeYears[rangeYears.length - 1];
    // Show inline warning
    const existing = document.getElementById('year-range-warning');
    if (existing) existing.remove();
    const warn = document.createElement('div');
    warn.id = 'year-range-warning';
    warn.style.cssText = 'margin-top:0.75rem;padding:0.75rem 1rem;border-radius:10px;background:rgba(201,146,42,0.12);border:1px solid rgba(201,146,42,0.5);font-size:0.82rem;color:var(--text)';
    warn.innerHTML = '<div style="font-weight:600;color:var(--accent2);margin-bottom:0.4rem">âš ï¸ Just a heads up!</div>'
      + '<div style="color:var(--text-mid);margin-bottom:0.65rem">The known production range for this item is <strong>' + min + 'â€“' + max + '</strong>. '
      + 'The year <strong>' + yr + '</strong> is outside that range â€” no problem if you know something we don\'t!</div>'
      + '<div style="display:flex;gap:0.5rem">'
      + '<button onclick="wizardNext()" style="flex:1;padding:0.5rem;border-radius:8px;border:none;background:var(--accent);color:white;font-family:var(--font-body);font-size:0.85rem;font-weight:600;cursor:pointer">Yes, continue</button>'
      + '<button onclick="(function(){var w=document.getElementById(\'year-range-warning\');if(w)w.remove();wizard.data.yearMade=\'\';var i=document.getElementById(\'wiz-year-input\');if(i){i.value=\'\';i.focus();}})()" style="flex:1;padding:0.5rem;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-family:var(--font-body);font-size:0.85rem;cursor:pointer">No, re-enter</button>'
      + '</div>';
    const body = document.getElementById('wizard-body');
    if (body) body.appendChild(warn);
    return;
  }
  wizardNext();
}

function initCondDesc() {
  var _descs = {1:'Heavily worn, broken or missing parts',2:'Very rough, significant damage',3:'Worn, chipping or rust present',4:'Good â€” visible play wear',5:'Good plus â€” light wear throughout',6:'Very Good â€” minor wear only',7:'Very Good plus â€” light marks, sharp detail',8:'Excellent â€” near perfect, very light handling',9:'Excellent plus â€” virtually no flaws',10:'Mint â€” appears unrun, like new'};
  function _upd() { var v=document.getElementById('wiz-slider'); var d=document.getElementById('wiz-cond-desc'); if(v&&d) d.textContent=_descs[parseInt(v.value)]||''; }
  _upd();
  var sl = document.getElementById('wiz-slider');
  if (sl) sl.addEventListener('input', _upd);
}

function yearMadeReenter() {
  var w = document.getElementById("year-range-warning"); if (w) w.remove();
  wizard.data.yearMade = "";
  var i = document.getElementById("wiz-year-input"); if (i) { i.value = ""; i.focus(); }
}

function yearMadeNext() {
  var yr = parseInt(wizard.data.yearMade);
  var rangeYears = wizard._yearRangeYears || [];
  var warn = document.getElementById('year-range-warning');
  if (warn) warn.remove();
  if (yr && rangeYears.length > 0 && rangeYears.indexOf(yr) === -1) {
    var min = rangeYears[0], max = rangeYears[rangeYears.length - 1];
    var warnDiv = document.createElement('div');
    warnDiv.id = 'year-range-warning';
    warnDiv.style.cssText = 'margin-top:0.75rem;padding:0.75rem 1rem;border-radius:10px;background:rgba(201,146,42,0.1);border:1px solid rgba(201,146,42,0.45);font-size:0.82rem';
    warnDiv.innerHTML = '<div style="font-weight:600;color:var(--accent2);margin-bottom:0.35rem">Just a heads up!</div>'
      + '<div style="color:var(--text-mid);line-height:1.5;margin-bottom:0.65rem">The known production years for this item are <strong>' + min + '\u2013' + max + '</strong>. '
      + 'You entered <strong>' + yr + '</strong> \u2014 that\'s outside the suggested range. Want to continue anyway?</div>'
      + '<div style="display:flex;gap:0.5rem">'
      + '<button onclick="wizardAdvance()" style="flex:1;padding:0.5rem;border-radius:8px;border:none;background:var(--accent);color:white;font-family:var(--font-body);font-size:0.85rem;font-weight:600;cursor:pointer">Yes, continue</button>'
      + '<button onclick="yearMadeReenter()" style="flex:1;padding:0.5rem;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-family:var(--font-body);font-size:0.85rem;cursor:pointer">No, re-enter</button>'
      + '</div>';
    var bdy = document.getElementById('wizard-body');
    if (bdy) bdy.appendChild(warnDiv);
    return;
  }
  // Year is fine â€” advance directly without going through the yearMade check again
  wizardAdvance();
}

// Advances wizard without triggering yearMade intercept â€” called by yearMadeNext
async function wizardAdvance() {
  const _nextBtn = document.getElementById('wizard-next-btn');
  if (_nextBtn && _nextBtn.disabled) return;
  const _warn = document.getElementById('year-range-warning');
  if (_warn) _warn.remove();
  await _wizardNextCore();
}

async function wizardNext() {
  // Prevent double-save from rapid clicks
  const _nextBtn = document.getElementById('wizard-next-btn');
  if (_nextBtn && _nextBtn.disabled) return;

  const steps = wizard.steps;
  const s = steps[wizard.step];

  // yearMade step: hand off to yearMadeNext for range check; it calls wizardAdvance when done
  if (s && s.type === 'yearMade') {
    yearMadeNext();
    return;
  }

  await _wizardNextCore();
}

async function _wizardNextCore() {
  const _nextBtn = document.getElementById('wizard-next-btn');
  if (_nextBtn && _nextBtn.disabled) return;
  const steps = wizard.steps;
  const s = steps[wizard.step];
// Validate required fields
  if (s.type === 'choice' && !wizard.tab) {
    showToast('Please select where to add the item.'); return;
  }
  if (s.type === 'text' && !s.optional && !wizard.data[s.id]?.trim()) {
    showToast('This field is required.'); return;
  }
  if (s.type === 'money' && !s.optional && !wizard.data[s.id]) {
    showToast('Please enter a price.'); return;
  }
  if ((s.type === 'choice2' || s.type === 'choice3') && !wizard.data[s.id]) {
    showToast('Please make a selection.'); return;
  }

  // Photo-only mode: after completing a drivePhotos step, save the link and close
  if (wizard.data._photoOnly && s.type === 'drivePhotos') {
    await savePhotoOnlyUpdate();
    return;
  }

  // Instruction Sheet confirm
  if (s.id === 'is_confirm') {
    if (_nextBtn) { _nextBtn.disabled = true; _nextBtn.textContent = 'Savingâ€¦'; }
    try { await saveInstructionSheet(); } catch(e) { showToast('Error: '+e.message); }
    if (_nextBtn) { _nextBtn.disabled = false; _nextBtn.textContent = 'Save â†’'; }
    return;
  }

  // Catalog confirm â€” must be checked BEFORE generic confirm
  if (s.id === 'cat_confirm') {
    if (_nextBtn) { _nextBtn.disabled = true; _nextBtn.textContent = 'Savingâ€¦'; }
    try { await saveCatalogItem(); } catch(e) { showToast('Error: '+e.message); }
    if (_nextBtn) { _nextBtn.disabled = false; _nextBtn.textContent = 'Save â†’'; }
    return;
  }

  // Ephemera confirm â€” must be checked BEFORE generic confirm
  const _ephTabIds = ['paper','mockups','other',...(state.userDefinedTabs||[]).map(t=>t.id)];
  if (s.id === 'eph_confirm' || (s.type === 'confirm' && _ephTabIds.includes(wizard.tab))) {
    if (_nextBtn) { _nextBtn.disabled = true; _nextBtn.textContent = 'Savingâ€¦'; }
    try { await saveEphemeraItem(); } catch(e) { showToast('Error: '+e.message); }
    if (_nextBtn) { _nextBtn.disabled = false; _nextBtn.textContent = 'Save â†’'; }
    return;
  }

  // Generic confirm â€” train/collection/sold/want items
  if (s.type === 'confirm') {
    if (_nextBtn) { _nextBtn.disabled = true; _nextBtn.textContent = 'Savingâ€¦'; }
    try { await saveWizardItem(); } catch(e) { showToast('Error: '+e.message); }
    if (_nextBtn) { _nextBtn.disabled = false; _nextBtn.textContent = 'Save â†’'; }
    return;
  }

  // Commit slider default if user never moved it
  if (s.type === 'slider' && (wizard.data[s.id] === undefined || wizard.data[s.id] === null)) {
    wizard.data[s.id] = 7;
  }

  // Advance
  wizard.step++;

  // Skip steps based on skipIf
  while (wizard.step < steps.length - 1 && steps[wizard.step].skipIf && steps[wizard.step].skipIf(wizard.data)) {
    wizard.step++;
  }

  renderWizardStep();
}

// Generate a system item number for ephemera/non-train items
// Catalogs:  80YY-CON/ADV/DLR/OTH
// Paper:     81YY-PAP
// Mock-Ups:  82YY-MU
// Other:     82YY-OTH
// User tabs: 83YY-USR
function generateEphemeraItemNum(tabId, year, catType) {
  const yy = year ? String(year).slice(-2).padStart(2,'0') : '00';
  const prefixMap = { catalogs:'80', paper:'81', mockups:'82', other:'82' };
  const prefix = prefixMap[tabId] || '83';
  const base = prefix + yy;

  // Suffix by tab
  let suffix = 'OTH';
  if (tabId === 'catalogs') {
    const catMap = { Consumer:'CON', Advance:'ADV', Dealer:'DLR', Other:'OTH' };
    suffix = catMap[catType] || 'OTH';
  } else if (tabId === 'paper')   { suffix = 'PAP'; }
  else if (tabId === 'mockups')   { suffix = 'MU';  }
  else if (tabId === 'other')     { suffix = 'OTH'; }
  else { suffix = 'USR'; }

  // Return the base number â€” collectors can own multiples of the same item
  // and they all share the same item number (like real Lionel catalog numbers)
  return base + '-' + suffix;
}

async function saveInstructionSheet() {
  const d = wizard.data;
  const sheetNum = (d.is_sheetNum || '').trim();
  const linkedItem = (d.is_linkedItem || '').trim();
  if (!sheetNum) { showToast('Sheet number is required'); return; }

  // Photo handling
  let photoLink = '';
  const photoObj = d.is_photos || {};
  if (Object.keys(photoObj).some(k => photoObj[k]?.file)) {
    try {
      await driveEnsureSetup();
      if (!driveCache.isPhotosId) {
        driveCache.isPhotosId = await driveFindOrCreateFolder('Instruction Sheet Photos', driveCache.vaultId);
      }
      const folderName = linkedItem ? linkedItem + ' - ' + sheetNum : sheetNum;
      const isFolderId = await driveFindOrCreateFolder(folderName, driveCache.isPhotosId);
      photoLink = 'https://drive.google.com/drive/folders/' + isFolderId;
      for (const [viewKey, fileObj] of Object.entries(photoObj)) {
        if (!fileObj?.file) continue;
        const fname = folderName + ' ' + viewKey + '.' + (fileObj.file.name.split('.').pop() || 'jpg');
        await driveUploadPhoto(fileObj.file, fname, isFolderId).catch(e => console.warn(e));
      }
    } catch(e) { console.warn('IS photo folder:', e); }
  }

  const row = [sheetNum, linkedItem, d.is_year||'', d.is_condition||'', d.is_notes||'', photoLink];
  try {
    await ensureEphemeraSheets(state.personalSheetId);
    await sheetsAppend(state.personalSheetId, 'Instruction Sheets!A:F', [row]);
    const newKey = Date.now();
    state.isData[newKey] = {
      row: newKey, sheetNum, linkedItem, year: d.is_year||'',
      condition: d.is_condition||'', notes: d.is_notes||'', photoLink,
    };
    showToast('âœ“ Instruction Sheet ' + sheetNum + ' saved!');
    closeWizard();
    buildDashboard();
    renderBrowse();
  } catch(e) {
    showToast('Error saving: ' + e.message);
  }
}

async function saveCatalogItem() {
  const d = wizard.data;
  // Title = "Year Type Catalog" e.g. "1957 Consumer Catalog"
  const typeLabel = d.cat_type || '';
  const yearLabel = d.cat_year || '';
  const folderName = [yearLabel, typeLabel, 'Catalog'].filter(Boolean).join(' ');
  const title = folderName;
  const itemNum = generateEphemeraItemNum('catalogs', yearLabel, typeLabel);

  // Create photo folder and upload photos if any
  let photoFolderLink = '';
  const photoObj = d.cat_photos || {};
  if (Object.keys(photoObj).length > 0 || true) {
    try {
      await driveEnsureSetup();
      // Create "Catalogs" subfolder under vault if needed
      if (!driveCache.catalogsId) {
        driveCache.catalogsId = await driveFindOrCreateFolder('Catalog Photos', driveCache.vaultId);
        localStorage.setItem('lv_catalogs_id', driveCache.catalogsId);
      }
      const catFolderId = await driveFindOrCreateFolder(folderName, driveCache.catalogsId);
      photoFolderLink = 'https://drive.google.com/drive/folders/' + catFolderId;
      // Upload any photos
      for (const [viewKey, fileObj] of Object.entries(photoObj)) {
        if (!fileObj || !fileObj.file) continue;
        try {
          const fname = folderName + ' ' + viewKey + '.' + (fileObj.file.name.split('.').pop() || 'jpg');
          await driveUploadPhoto(fileObj.file, fname, catFolderId);
        } catch(e) { console.warn('Photo upload:', e); }
      }
    } catch(e) { console.warn('Drive folder:', e); }
  }

  const row = [
    itemNum,
    d.cat_type || '',
    d.cat_year || '',
    d.cat_hasMailer || 'No',
    d.cat_condition || '',
    d.cat_estValue || '',
    d.cat_dateAcquired || '',
    d.cat_notes || '',
    photoFolderLink,
  ];
  try {
    // Ensure Catalogs tab exists with proper headers before appending
    await ensureEphemeraSheets(state.personalSheetId);
    const appendResult = await sheetsAppend(state.personalSheetId, 'Catalogs!A:I', [row]);
    // Reload catalog rows from sheet to get accurate row numbers
    if (!state.ephemeraData.catalogs) state.ephemeraData.catalogs = {};
    try {
      const freshCat = await sheetsGet(state.personalSheetId, 'Catalogs!A3:I');
      state.ephemeraData.catalogs = {};
      (freshCat.values || []).forEach((r, idx) => {
        if (!r[0] || r[0] === 'Item ID' || r[0] === 'Type' || r[0] === 'Catalogs') return;
        const key = idx + 3;
        const catType2 = r[1]||''; const year2 = r[2]||'';
        const t = [year2, catType2, 'Catalog'].filter(Boolean).join(' ');
        state.ephemeraData.catalogs[key] = {
          row: key, itemNum: r[0]||'', title: t,
          catType: catType2, year: year2, hasMailer: r[3]||'No',
          condition: r[4]||'', estValue: r[5]||'', dateAcquired: r[6]||'',
          notes: r[7]||'', photoLink: r[8]||'',
        };
      });
    } catch(e) {
      // Fallback: add optimistically
      const newKey = Date.now();
      state.ephemeraData.catalogs[newKey] = {
        row: newKey, itemNum, title,
        catType: d.cat_type || '', year: d.cat_year || '',
        hasMailer: d.cat_hasMailer || 'No', condition: d.cat_condition || '',
        estValue: d.cat_estValue || '', dateAcquired: d.cat_dateAcquired || '',
        notes: d.cat_notes || '', photoLink: photoFolderLink,
      };
    }
    showToast('âœ“ ' + title + ' saved!');
    closeWizard();
    buildDashboard(); // refresh stats
    populateFilters(); // refresh type dropdown to include new catalog type
    renderBrowse();    // always refresh so it appears immediately
  } catch(e) {
    showToast('Error saving: ' + e.message);
  }
}

async function saveEphemeraItem() {
  const d = wizard.data;
  const tab = wizard.tab;
  const tabNames = { catalogs:'Catalogs', paper:'Paper Items', mockups:'Mock-Ups', other:'Other Lionel' };
  const _userTab = (state.userDefinedTabs||[]).find(t => t.id === tab);
  const sheetName = tabNames[tab] || (_userTab && _userTab.label) || null;
  if (!sheetName) { closeWizard(); return; }

  const ephItemNum = generateEphemeraItemNum(tab, d.eph_year || '', '');

  let row;
  if (tab === 'mockups') {
    row = [
      ephItemNum,
      d.eph_title||'', d.eph_itemNumRef||'', d.eph_description||'',
      d.eph_year||'', d.eph_manufacturer||'Lionel', d.eph_condition||'',
      d.eph_productionStatus||'', d.eph_material||'', d.eph_dimensions||'',
      d.eph_provenance||'', d.eph_lionelVerified||'', d.eph_estValue||'',
      '', // photo link
      d.eph_notes||'', d.eph_dateAcquired||'',
    ];
  } else {
    row = [
      ephItemNum,
      d.eph_title||'', d.eph_description||'', d.eph_year||'',
      d.eph_manufacturer||'Lionel', d.eph_condition||'',
      d.eph_quantity||'1', d.eph_estValue||'',
      '', // photo link
      d.eph_notes||'', d.eph_dateAcquired||'',
    ];
  }

  try {
    await sheetsAppend(state.personalSheetId, sheetName + '!A:P', [row]);
    // Add to local state
    const bucket = state.ephemeraData[tab] || {};
    const newKey = Date.now();
    if (tab === 'mockups') {
      bucket[newKey] = {
        row: newKey, itemNum: ephItemNum, title: d.eph_title||'', itemNumRef: d.eph_itemNumRef||'',
        description: d.eph_description||'', year: d.eph_year||'',
        manufacturer: d.eph_manufacturer||'Lionel', condition: d.eph_condition||'',
        productionStatus: d.eph_productionStatus||'', material: d.eph_material||'',
        dimensions: d.eph_dimensions||'', provenance: d.eph_provenance||'',
        lionelVerified: d.eph_lionelVerified||'', estValue: d.eph_estValue||'',
        photoLink: '', notes: d.eph_notes||'', dateAcquired: d.eph_dateAcquired||'',
      };
    } else {
      bucket[newKey] = {
        row: newKey, itemNum: ephItemNum, title: d.eph_title||'', description: d.eph_description||'',
        year: d.eph_year||'', manufacturer: d.eph_manufacturer||'Lionel',
        condition: d.eph_condition||'', quantity: d.eph_quantity||'1',
        estValue: d.eph_estValue||'', photoLink: '', notes: d.eph_notes||'',
        dateAcquired: d.eph_dateAcquired||'',
      };
    }
    state.ephemeraData[tab] = bucket;
    showToast('âœ“ ' + (d.eph_title||'Item') + ' saved!');
    closeWizard();
    // Refresh ephemera page if visible
    // Ephemera integrated into My Collection â€” refresh browse if active
    if (state.filters.owned) renderBrowse();
  } catch(e) {
    showToast('Error saving: ' + e.message);
  }
}

async function savePhotoOnlyUpdate() {
  const d = wizard.data;
  const pdKey = d._updatePdKey;
  if (!pdKey || !state.personalData[pdKey]) {
    closeWizard(); return;
  }
  const pd = state.personalData[pdKey];
  // Get the folder link from whichever photo step just ran
  const photoObj = d.photosItem || d.photosBox || {};
  const folderLink = Object.values(photoObj).find(v => v) || '';
  if (folderLink && pd.row) {
    // Write folder link to col J (index 9) of the existing row
    try {
      await sheetsUpdate(state.personalSheetId, 'My Collection!J' + pd.row, [[folderLink]]);
      pd.photoItem = folderLink;
      showToast('âœ“ Photos saved!');
    } catch(e) {
      showToast('Photos uploaded but link save failed: ' + e.message);
    }
  } else {
    showToast('âœ“ Photos uploaded!');
  }
  closeWizard();
  // Refresh camera icons on current browse view
  if (folderLink) {
    const itemNum = pd.itemNum;
    const variation = pd.variation || '';
    const c1 = document.getElementById('cam-' + itemNum + '-' + variation);
    const c2 = document.getElementById('cam-' + itemNum + '-' + variation + '-m');
    if (c1) c1.style.display = 'inline';
    if (c2) c2.style.display = 'inline';
  }
}

async function saveWizardItem() {
  const d = wizard.data;
  const tab = wizard.tab;
  // Apply powered/dummy suffix to A units (B units ending in C are never powered)
  const _rawItemNum = (d.itemNum || '').trim();
  const _pdSuffix = (raw, power) => {
    if (!power || raw.endsWith('C')) return raw;
    return raw + (power === 'Powered' ? '-P' : '-D');
  };
  const itemNum = _pdSuffix(_rawItemNum, d.unitPower);
  const variation = (d.variation || '').trim();
  const key = `${itemNum}|${variation}`;
  // Photos are now Drive URL objects keyed by view
  const photoObj = d.photosItem || {};
  const boxPhotoObj = d.photosBox || {};
  const errorPhotoObj = d.photosError || {};
  // Primary display photo = Front View, fallback to first available
  // All views return the same folder link â€” just grab the first one found
  const anyItemLink = Object.values(photoObj).find(v => v) || '';
  const anyBoxLink  = Object.values(boxPhotoObj).find(v => v) || '';
  const photos    = [anyItemLink];
  const boxPhotos = [anyBoxLink];

  try {
    if (tab === 'collection') {
      // Find existing by row-keyed lookup (key includes row number now)
      let existing = Object.keys(state.personalData)
        .map(k => state.personalData[k])
        .find(pd => pd.itemNum === itemNum && pd.variation === variation) || null;
      if (d.boxOnly) {
        // Use explicitly selected row if user picked one
        if (d.selectedRowKey && state.personalData[d.selectedRowKey]) {
          existing = state.personalData[d.selectedRowKey];
        } else if (!existing) {
          // Fall back to first match by item number
          const matchKey = Object.keys(state.personalData).find(k => k.split('|')[0] === itemNum);
          if (matchKey) existing = state.personalData[matchKey];
        }
      } else if (d._attachToBox) {
        // Adding new item â€” find the box-only row by item number
        // Box-only rows have hasBox=Yes but no meaningful item condition/price
        const boxKey = Object.keys(state.personalData).find(k => {
          const pd = state.personalData[k];
          const noCondition = !pd.condition || pd.condition === '' || pd.condition === 'N/A';
          const noItemPrice = !pd.priceItem || pd.priceItem === '' || pd.priceItem === 'N/A';
          return k.split('|')[0] === itemNum && pd.hasBox === 'Yes' && noCondition && noItemPrice;
        });
        if (boxKey) existing = state.personalData[boxKey];
        }
      let row;
      if (d.boxOnly) {
        const ex = existing || {};
        const itemExists = !!existing;
        // Compute item+box complete price if we have both
        const itemPrice = parseFloat(ex.priceItem && ex.priceItem !== 'N/A' ? ex.priceItem : 0) || 0;
        const boxPrice  = parseFloat(d.priceBox) || 0;
        const completePrice = (itemPrice > 0 && boxPrice > 0)
          ? (itemPrice + boxPrice).toFixed(2)
          : boxPrice > 0 ? d.priceBox  // just the box price when no item price
          : (ex.priceComplete || '');
        row = [
          itemNum,
          itemExists ? (ex.variation || variation) : variation,
          ex.condition || (itemExists ? '' : 'N/A'),
          'Yes',  // box-only rows always set all original to Yes
          ex.priceItem || (itemExists ? '' : 'N/A'),
          d.priceBox || '',
          completePrice,
          'Yes',
          d.boxCond || '',
          ex.photoItem || '',
          boxPhotos[0] || '',
          ( d.notes || ex.notes || '' ).trim(),
          d.purchaseDate || ex.datePurchased || '',
          d.userEstWorth || ex.userEstWorth || '',
        ];
      } else {
        const _paired = d.tenderMatch && d.tenderMatch !== 'none';
        const enginePrice = _paired
          ? (d.priceItem ? (parseFloat(d.priceItem)/2).toFixed(2) : '')
          : (d.priceItem || '');
        const engineWorth = _paired
          ? (d.userEstWorth ? (parseFloat(d.userEstWorth)/2).toFixed(2) : '')
          : (d.userEstWorth || '');
        const calcComplete = _paired
          ? (enginePrice ? parseFloat(enginePrice) : 0)
          : ((parseFloat(d.priceItem)||0) + (parseFloat(d.priceBox)||0));
        row = [
          itemNum, variation,
          d.condition || '',
          d.allOriginal || '',
          enginePrice,
          d.priceBox || '',
          calcComplete > 0 ? calcComplete.toFixed(2) : '',
          d.hasBox || 'No',
          d.boxCond || '',
          photos[0] || '',
          boxPhotos[0] || '',
          [d.notOriginalDesc ? 'Modifications: ' + d.notOriginalDesc.trim() : '', (d.notes || '').trim()].filter(Boolean).join(' | '),
          d.datePurchased || '',
          engineWorth,
          d.tenderMatch && d.tenderMatch !== 'none' ? d.tenderMatch : '',
          '',  // Set ID â€” filled in after save if set unit
          d.yearMade || '',  // Year Made (col Q)
        d.isError === 'Yes' ? 'Yes' : 'No',  // Is Error (col R)
        d.isError === 'Yes' ? (d.errorDesc || '') : '',  // Error Description (col S)
        '',  // Quick Entry (col T) â€” blank = normal full entry
        ];
      }
      // â”€â”€ SET UNIT SAVE: if diesel set, save unit2 (and unit3) rows with shared Set ID â”€â”€
  const isSetSave = d.setMatch === 'set-now';
  const setId = d._setId || '';

  if (isSetSave && d.unit2ItemNum) {
    const u2Num = (d.unit2ItemNum || '').trim();
    // Unit 1 keeps full price/worth; other units get $0 with a note pointing to unit 1
    const setPriceNote = (baseNote, leadNum) => {
      const ref = 'Set price on item ' + leadNum;
      return baseNote ? baseNote + '; ' + ref : ref;
    };

    const u2Row = [
      u2Num, '',
      d.unit2Condition || '',
      d.unit2AllOriginal || '',
      '', '', '',   // $0 â€” price is on unit 1
      d.unit2HasBox || 'No',
      d.unit2BoxCond || '',
      '', '',
      setPriceNote((d.notes || '').trim(), itemNum),
      d.datePurchased || '',
      '',           // $0 worth â€” worth is on unit 1
      itemNum,      // matchedTo = suffixed A unit
      setId,
    ];
    await sheetsAppend(state.personalSheetId, 'My Collection', [u2Row]);

    // Unit 3 (ABA second A unit)
    if (d.setType === 'ABA') {
      const u3Num = _pdSuffix((d.unit3ItemNum || _rawItemNum).trim(), d.unit3Power);
      const u3Row = [
        u3Num, '',
        d.unit3Condition || '',
        d.unit3AllOriginal || '',
        '', '', '',   // $0 â€” price is on unit 1
        d.unit3HasBox || 'No',
        d.unit3BoxCond || '',
        '', '',
        setPriceNote((d.notes || '').trim(), itemNum),
        d.datePurchased || '',
        '',           // $0 worth â€” worth is on unit 1
        u2Num,        // matchedTo = B unit
        setId,
      ];
      await sheetsAppend(state.personalSheetId, 'My Collection', [u3Row]);
      // Update u2Row matchedTo to also reference u3Num

    }

    // Update unit 1 row to include setId
    row[15] = setId;
    row[14] = row[14] || u2Num; // matchedTo
  }

  // Link-to-existing: just tag unit 1 with the existing set's setId
  if (d.setMatch === 'link' && d._setId) {
    row[15] = d._setId;
    // Update the existing unit's setId if it doesn't have one
    const existingUnit = Object.values(state.personalData).find(pd =>
      pd.itemNum === (itemNum.endsWith('C') ? itemNum.slice(0,-1) : itemNum+'C')
    );
    if (existingUnit && existingUnit.row && !existingUnit.setId) {
      sheetsUpdate(state.personalSheetId, 'My Collection!P' + existingUnit.row, [[d._setId]])
        .catch(e => console.warn('Set ID backfill:', e));
    }
  }

  // â”€â”€ PAIRED SAVE: if engine+tender together, save a second row for the tender â”€â”€
  const isPairedSave = d.tenderMatch && d.tenderMatch !== 'none';
  if (isPairedSave) {
    const tNum = d.tenderMatch.trim();
    const tVariation = '';
    const tenderNote = (() => {
      const ref = 'Set price on item ' + itemNum;
      return d.notes ? d.notes.trim() + '; ' + ref : ref;
    })();
    const tRow = [
      tNum, tVariation,
      d.tenderCondition || '',
      d.tenderAllOriginal || '',
      '', '',  '',  // $0 â€” full price is on the engine row
      d.tenderHasBox || 'No',
      d.tenderBoxCond || '',
      '',          // photo â€” filed separately under tender folder
      '',          // box photo
      tenderNote,
      d.datePurchased || '',
      '',          // $0 worth â€” worth is on the engine row
      itemNum,     // matchedTo = engine number
    ];
    await sheetsAppend(state.personalSheetId, 'My Collection', [tRow]);
    // Update engine row matchedTo to point to tender
    row[14] = tNum;
  }

  // Cross-link: if a tender/engine was matched, update that item's matchedTo column too
  const matchedNum = (!isPairedSave && d.tenderMatch && d.tenderMatch !== 'none') ? d.tenderMatch : null;
  if (matchedNum) {
    const matchedEntry = Object.values(state.personalData).find(pd => pd.itemNum === matchedNum);
    if (matchedEntry && matchedEntry.row) {
      // Update col O (index 14) of the matched row
      sheetsUpdate(state.personalSheetId, `My Collection!O${matchedEntry.row}`, [[itemNum]]).catch(e => console.warn('Cross-link update:', e));
      matchedEntry.matchedTo = itemNum;
    }
  }

  if (d._fillItemMode && existing?.row) {
        // Preserve ALL box fields, update only item fields
        row[5]  = existing.priceBox    || row[5];
        row[7]  = existing.hasBox      || 'Yes';
        row[8]  = existing.boxCond     || row[8];
        row[10] = existing.photoBox    || row[10];
        row[12] = existing.datePurchased || row[12];
        row[13] = d.userEstWorth || existing.userEstWorth || '';
        const fp = parseFloat(row[4]) || 0;
        const bp = parseFloat(row[5]) || 0;
        row[6] = fp > 0 && bp > 0 ? (fp + bp).toFixed(2) : (existing.priceComplete || '');
        const newNote = row[11] || '';
        const exNote  = existing.notes || '';
        const itemLabel = newNote.trim() ? `Item: ${newNote.trim()}` : '';
        const boxLabel  = exNote.trim()  ? `Box: ${exNote.trim()}`   : '';
        row[11] = [boxLabel, itemLabel].filter(Boolean).join(' | ');
        await sheetsUpdate(state.personalSheetId, `My Collection!A${existing.row}:N${existing.row}`, [row]);
      } else if (d._attachToBox && existing?.row) {
        // Attaching item to existing box row â€” preserve box data, merge notes
        row[2]  = d.condition || row[2];           // always use entered condition
        row[5]  = existing.priceBox    || row[5];  // keep box price
        row[7]  = existing.hasBox      || 'Yes';
        row[8]  = existing.boxCond     || row[8];  // keep box condition
        row[10] = existing.photoBox    || row[10]; // keep box photo
        row[12] = existing.datePurchased || row[12]; // keep date
        row[13] = d.userEstWorth || existing.userEstWorth || row[13];
        const fp2 = parseFloat(row[4]) || 0;
        const bp2 = parseFloat(row[5]) || 0;
        row[6] = fp2 > 0 && bp2 > 0 ? (fp2 + bp2).toFixed(2) : (existing.priceComplete || '');
        const newNote2 = row[11] || '';
        const exNote2  = existing.notes || '';
        const itemLabel2 = newNote2.trim() ? `Item: ${newNote2.trim()}` : '';
        const boxLabel2  = exNote2.trim()  ? `Box: ${exNote2.trim()}`   : '';
        row[11] = [boxLabel2, itemLabel2].filter(Boolean).join(' | ');
        await sheetsUpdate(state.personalSheetId, `My Collection!A${existing.row}:N${existing.row}`, [row]);
      } else {
        // Always append for a plain new collection add â€” never overwrite existing rows
        await sheetsAppend(state.personalSheetId, 'My Collection!A:T', [row]);
      }

    } else if (tab === 'sold') {
      // If user picked a collection row, pull its data and clear it from My Collection
      const collectionEntry = d.selectedSoldKey ? state.personalData[d.selectedSoldKey] : null;
      const soldVariation = collectionEntry ? (collectionEntry.variation || '') : variation;
      const soldCondition = d.condition || (collectionEntry?.condition !== 'N/A' ? collectionEntry?.condition : '') || '';
      const soldPricePaid = d.priceItem || (collectionEntry?.priceItem !== 'N/A' ? collectionEntry?.priceItem : '') || '';

      const row = [
        itemNum, soldVariation, '1',
        soldCondition,
        soldPricePaid,
        d.salePrice || '',
        d.dateSold || '',
        ( d.notes || '' ).trim(),
      ];
      const soldKey = `${itemNum}|${soldVariation}`;
      const existingSold = state.soldData[soldKey];
      if (existingSold?.row) {
        await sheetsUpdate(state.personalSheetId, `Sold!A${existingSold.row}:H${existingSold.row}`, [row]);
      } else {
        await sheetsAppend(state.personalSheetId, 'Sold!A:H', [row]);
      }
      // Delete the row from My Collection
      if (collectionEntry?.row) {
        await sheetsDeleteRow(state.personalSheetId, 'My Collection', collectionEntry.row);
      }
      // Move photo folder to Sold in Drive
      if (collectionEntry?.itemNum) {
        try { await driveMoveToSold(collectionEntry.itemNum); } catch(e) { console.warn('Drive move failed:', e); }
      }

    } else if (tab === 'want') {
      const row = [
        itemNum, variation,
        d.priority || 'Medium',
        d.expectedPrice || '',
        ( d.notes || '' ).trim(),
      ];
      const existing = state.wantData[key];
      if (existing?.row) {
        await sheetsUpdate(state.personalSheetId, `Want List!A${existing.row}:E${existing.row}`, [row]);
      } else {
        await sheetsAppend(state.personalSheetId, 'Want List!A:E', [row]);
      }
    }

    // â”€â”€ Save instruction sheet if user said they have one â”€â”€
    if (d.hasIS === 'Yes' && tab === 'collection') {
      try {
        const isSheetNum = (d.is_sheetNum || '').trim() || itemNum + '-IS';
        const isPhotoObj = d.photosIS || {};
        let isPhotoLink = '';
        if (Object.keys(isPhotoObj).some(k => isPhotoObj[k]?.file)) {
          await driveEnsureSetup();
          if (!driveCache.isPhotosId) {
            driveCache.isPhotosId = await driveFindOrCreateFolder('Instruction Sheet Photos', driveCache.vaultId);
          }
          const isFolderName = itemNum + ' - ' + isSheetNum;
          const isFolderId = await driveFindOrCreateFolder(isFolderName, driveCache.isPhotosId);
          isPhotoLink = 'https://drive.google.com/drive/folders/' + isFolderId;
          for (const [viewKey, fileObj] of Object.entries(isPhotoObj)) {
            if (!fileObj?.file) continue;
            const fname = isFolderName + ' ' + viewKey + '.' + (fileObj.file.name.split('.').pop() || 'jpg');
            await driveUploadPhoto(fileObj.file, fname, isFolderId).catch(e => console.warn(e));
          }
        }
        const isRow = [isSheetNum, itemNum, '', d.is_condition || '', '', isPhotoLink];
        await sheetsAppend(state.personalSheetId, 'Instruction Sheets!A:F', [isRow]);
        const newISKey = Date.now();
        state.isData[newISKey] = {
          row: newISKey, sheetNum: isSheetNum, linkedItem: itemNum,
          year: '', condition: d.is_condition || '', notes: '', photoLink: isPhotoLink,
        };
      } catch(e) { console.warn('IS save error:', e); }
    }

    closeWizard();
    // Small delay to ensure Google Sheets has committed the data
    await new Promise(r => setTimeout(r, 800));
    await loadPersonalData();
    resetFilters();
    buildDashboard();
    buildSoldPage();
    renderBrowse();
    showToast(`âœ“ Item ${itemNum} added to ${tab === 'collection' ? 'My Collection' : tab === 'sold' ? 'Sold' : 'Want List'}!`);

  } catch(e) {
    console.error('Save error:', e);
    showToast('Error saving: ' + e.message, 4000, true);
  }
}

async function quickEntryAdd() {
  const d = wizard.data;
  const itemNum = (d.itemNum || '').trim();
  if (!itemNum) { showToast('Please enter an item number first'); return; }
  const variation = (d.variation || '').trim();

  // Cols: ItemNum, Variation, Cond, AllOrig, PriceItem, PriceBox, Complete,
  //       HasBox, BoxCond, PhotoItem, PhotoBox, Notes, DatePurch, EstWorth,
  //       MatchedTo, SetId, YearMade, IsError, ErrDesc, QuickEntry
  const row = [
    itemNum, variation,
    '','','','','','','','','',
    '','','','','','',
    '','',
    'Yes'  // col T â€” Quick Entry flag
  ];
  try {
    const _nextBtn = document.getElementById('wizard-next-btn');
    if (_nextBtn) { _nextBtn.disabled = true; }
    await ensureEphemeraSheets(state.personalSheetId);
    await sheetsAppend(state.personalSheetId, 'My Collection!A:T', [row]);
    // Add to local state immediately
    const rowNum = Date.now();
    const key = `${itemNum}|${variation}|${rowNum}`;
    state.personalData[key] = {
      row: rowNum, itemNum, variation,
      status: 'Owned', owned: true,
      condition: '', allOriginal: '', priceItem: '', priceBox: '', priceComplete: '',
      hasBox: '', boxCond: '', photoItem: '', photoBox: '',
      notes: '', datePurchased: '', userEstWorth: '', matchedTo: '',
      setId: '', yearMade: '', isError: '', errorDesc: '',
      quickEntry: true,
    };
    closeWizard();
    showToast('âš¡ ' + itemNum + ' added (Quick Entry)');
    buildDashboard();
    renderBrowse();
    if (_nextBtn) { _nextBtn.disabled = false; }
  } catch(e) {
    showToast('Error: ' + e.message);
  }
}

function showToast(msg, duration, isError) {
  let t = document.getElementById('toast');
  if (t) t.remove();
  t = document.createElement('div');
  t.id = 'toast';
  const err = isError || /error|failed|invalid|required/i.test(msg);
  t.style.cssText = 'position:fixed;bottom:88px;left:50%;transform:translateX(-50%) translateY(8px);'
    + 'background:' + (err ? '#c0392b' : '#1a2e3d') + ';color:#fff;padding:0.7rem 1.4rem;'
    + 'border-radius:10px;font-size:0.88rem;font-weight:500;z-index:99999;'
    + 'font-family:var(--font-body);box-shadow:0 4px 20px rgba(0,0,0,0.35);'
    + 'max-width:88vw;text-align:center;opacity:0;transition:opacity 0.2s,transform 0.2s';
  t.textContent = msg;
  document.body.appendChild(t);
  requestAnimationFrame(() => { t.style.opacity = '1'; t.style.transform = 'translateX(-50%) translateY(0)'; });
  const _timer = setTimeout(() => {
    t.style.opacity = '0'; t.style.transform = 'translateX(-50%) translateY(4px)';
    setTimeout(() => { if (t.parentNode) t.remove(); }, 220);
  }, duration || 2400);
  t.onclick = () => { clearTimeout(_timer); t.remove(); };
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IDENTIFY BY PHOTO â€” Gemini Vision AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _identifyCallerContext = null; // 'wizard' | null (browse)
let _identifyImageBase64 = null;
let _identifySelectedNum = null;

function openIdentify(context) {
  _identifyCallerContext = context;
  _identifyImageBase64 = null;
  _identifySelectedNum = null;
  const modal = document.getElementById('identify-modal');
  modal.classList.add('open');
  // Show setup or ready state
  showIdentifyReady();
}

function closeIdentify() {
  document.getElementById('identify-modal').classList.remove('open');
  resetIdentify();
}

function showGeminiSetup() {
  document.getElementById('identify-setup').style.display = 'block';
  document.getElementById('identify-ready').style.display = 'none';
}

function showIdentifyReady() {
  document.getElementById('identify-setup').style.display = 'none';
  const ready = document.getElementById('identify-ready');
  ready.style.display = 'flex';
  ready.style.flexDirection = 'column';
  resetIdentify();
}

function saveGeminiKey() {
  const key = (document.getElementById('gemini-key-input').value || '').trim();
  if (!key) { showToast('Please paste your Gemini API key', 3000, true); return; }
  GEMINI_KEY = key;
  localStorage.setItem('lv_gemini_key', key);
  showToast('âœ“ Gemini API key saved!');
  showIdentifyReady();
}

function resetIdentify() {
  _identifyImageBase64 = null;
  _identifySelectedNum = null;
  const preview = document.getElementById('identify-preview');
  if (preview) { preview.style.display = 'none'; preview.src = ''; }
  const hint = document.getElementById('identify-drop-hint');
  if (hint) hint.style.display = 'block';
  const analyzeBtn = document.getElementById('identify-analyze-btn');
  if (analyzeBtn) analyzeBtn.style.display = 'none';
  const status = document.getElementById('identify-status');
  if (status) status.style.display = 'none';
  const desc = document.getElementById('identify-description');
  if (desc) desc.style.display = 'none';
  const cands = document.getElementById('identify-candidates');
  if (cands) { cands.style.display = 'none'; cands.innerHTML = '<div style="font-family:var(--font-head);font-size:0.62rem;font-weight:600;letter-spacing:0.16em;text-transform:uppercase;color:var(--text-dim);margin-bottom:0.1rem">Select the best match:</div>'; }
  const actions = document.getElementById('identify-actions');
  if (actions) actions.style.display = 'none';
}

function handleIdentifyDrop(e) {
  e.preventDefault();
  document.getElementById('identify-drop').classList.remove('dragover');
  const file = e.dataTransfer?.files?.[0];
  if (file && file.type.startsWith('image/')) handleIdentifyFile(file);
}

function handleIdentifyFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const dataUrl = e.target.result;
    _identifyImageBase64 = dataUrl.split(',')[1]; // strip data:image/...;base64,
    // Show preview
    const preview = document.getElementById('identify-preview');
    preview.src = dataUrl;
    preview.style.display = 'block';
    document.getElementById('identify-drop-hint').style.display = 'none';
    document.getElementById('identify-analyze-btn').style.display = 'flex';
    document.getElementById('identify-analyze-btn').style.width = '100%';
    document.getElementById('identify-analyze-btn').style.justifyContent = 'center';
    // Reset previous results
    document.getElementById('identify-status').style.display = 'none';
    document.getElementById('identify-description').style.display = 'none';
    document.getElementById('identify-candidates').style.display = 'none';
    document.getElementById('identify-actions').style.display = 'none';
  };
  reader.readAsDataURL(file);
}

async function runGeminiIdentify() {
  if (!_identifyImageBase64) { showToast('Please select a photo first', 3000, true); return; }
  if (!GEMINI_KEY) { showGeminiSetup(); return; }

  // Show spinner
  document.getElementById('identify-analyze-btn').style.display = 'none';
  const statusEl = document.getElementById('identify-status');
  statusEl.style.display = 'block';
  document.getElementById('identify-status-msg').textContent = 'Analyzing with Gemini Visionâ€¦';
  document.getElementById('identify-description').style.display = 'none';
  document.getElementById('identify-candidates').style.display = 'none';
  document.getElementById('identify-actions').style.display = 'none';

  try {
    // Build catalog context â€” top item numbers for Gemini to reference
    const catalogSample = (state.masterData || []).slice(0, 800).map(i =>
      `${i.itemNum}|${i.type || ''}|${i.roadName || ''}|${i.description || ''}`
    ).join('\n');

    const prompt = `You are an expert on Lionel postwar electric trains (1945â€“1969 era). 
Examine this photo carefully and identify the Lionel item shown.

Provide your response as JSON only (no markdown, no explanation outside JSON):
{
  "description": "2-3 sentence description of what you see: type, color scheme, road name/markings, distinctive features, era",
  "candidates": [
    {"itemNum": "665", "confidence": "high", "reason": "Pennsylvania steam loco, smoke unit, correct color"},
    {"itemNum": "2046", "confidence": "medium", "reason": "similar but different tender style"},
    {"itemNum": "736", "confidence": "low", "reason": "possible match if lighting obscures details"}
  ],
  "googleQuery": "Lionel postwar 665 steam locomotive Pennsylvania"
}

Rules:
- List 1â€“5 candidates, most likely first
- confidence: "high" | "medium" | "low"  
- itemNum must be a real Lionel postwar catalog number
- If you cannot identify it at all, still give your best 1â€“2 guesses based on visible features
- For googleQuery, give the best search string to find this item on Google Images

Here are some real catalog items for reference (item|type|road|description):
${catalogSample}`;

    const body = {
      contents: [{
        parts: [
          { text: prompt },
          { inline_data: { mime_type: 'image/jpeg', data: _identifyImageBase64 } }
        ]
      }],
      generationConfig: { temperature: 0.2, maxOutputTokens: 512 }
    };

    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`,
      { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }
    );

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      const msg = err?.error?.message || res.statusText;
      if (res.status === 400 && msg.includes('API_KEY')) throw new Error('Invalid Gemini API key â€” please check and re-enter.');
      if (res.status === 429) throw new Error('Gemini rate limit hit â€” wait a moment and try again.');
      throw new Error('Gemini API error: ' + msg);
    }

    const data = await res.json();
    const rawText = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';

    // Parse JSON from response (strip any markdown fences)
    let parsed;
    try {
      const cleaned = rawText.replace(/```json|```/g, '').trim();
      parsed = JSON.parse(cleaned);
    } catch(e) {
      throw new Error('Could not parse Gemini response. Try a clearer photo.');
    }

    statusEl.style.display = 'none';
    renderIdentifyResults(parsed);

  } catch(err) {
    statusEl.style.display = 'none';
    document.getElementById('identify-analyze-btn').style.display = 'flex';
    document.getElementById('identify-analyze-btn').style.width = '100%';
    document.getElementById('identify-analyze-btn').style.justifyContent = 'center';
    showToast('Identify failed: ' + err.message, 5000, true);
  }
}

function renderIdentifyResults(parsed) {
  // AI description
  const descEl = document.getElementById('identify-description');
  descEl.style.display = 'block';
  descEl.innerHTML = '<span style="color:var(--gold);font-family:var(--font-head);font-size:0.65rem;font-weight:600;letter-spacing:0.1em;text-transform:uppercase">AI Analysis</span><br>' + (parsed.description || 'No description available.');

  // Candidates
  const cands = document.getElementById('identify-candidates');
  cands.style.display = 'flex';
  cands.style.flexDirection = 'column';
  cands.style.gap = '0.5rem';

  // Keep the label div, re-add candidates
  const label = cands.firstElementChild;
  cands.innerHTML = '';
  cands.appendChild(label);

  const candidates = parsed.candidates || [];
  if (candidates.length === 0) {
    const none = document.createElement('div');
    none.style.cssText = 'color:var(--text-dim);font-size:0.82rem;padding:0.5rem 0';
    none.textContent = 'No specific item identified. Try a closer or clearer photo.';
    cands.appendChild(none);
  } else {
    candidates.forEach((c, i) => {
      // Try to find in master catalog
      const masterMatch = (state.masterData || []).find(m => m.itemNum === c.itemNum);
      const card = document.createElement('div');
      card.className = 'identify-candidate';
      if (i === 0) { card.classList.add('selected'); _identifySelectedNum = c.itemNum; }
      const confClass = c.confidence === 'high' ? 'high' : c.confidence === 'medium' ? 'med' : 'low';
      card.innerHTML = `
        <div class="identify-num">${c.itemNum}</div>
        <div class="identify-desc">
          <div style="color:var(--text);font-weight:600;font-size:0.85rem;margin-bottom:0.15rem">
            ${masterMatch ? (masterMatch.type || '') + (masterMatch.roadName ? ' Â· ' + masterMatch.roadName : '') : c.itemNum}
          </div>
          ${masterMatch?.description ? '<div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:0.15rem">' + masterMatch.description + '</div>' : ''}
          <div style="font-size:0.75rem;color:var(--text-dim)">${c.reason || ''}</div>
        </div>
        <span class="identify-conf ${confClass}">${c.confidence}</span>`;
      card.onclick = function() {
        document.querySelectorAll('.identify-candidate').forEach(el => el.classList.remove('selected'));
        card.classList.add('selected');
        _identifySelectedNum = c.itemNum;
      };
      cands.appendChild(card);
    });
  }

  // Store google query for the button
  window._identifyGoogleQuery = parsed.googleQuery || '';

  // Show action buttons
  const actions = document.getElementById('identify-actions');
  actions.style.display = 'flex';
  actions.style.flexWrap = 'wrap';
  actions.style.gap = '0.5rem';
}

function useIdentifiedItem() {
  if (!_identifySelectedNum) { showToast('Please select a candidate first', 3000, true); return; }
  closeIdentify();
  if (_identifyCallerContext === 'wizard') {
    // Fill in the wizard itemNum field and trigger lookup
    const inp = document.getElementById('wiz-input');
    if (inp) {
      inp.value = _identifySelectedNum;
      wizard.data.itemNum = _identifySelectedNum;
      updateItemSuggestions(_identifySelectedNum);
      inp.focus();
    }
  } else {
    // Fill the browse search box and filter
    const search = document.getElementById('browse-search');
    if (search) {
      search.value = _identifySelectedNum;
      onPageSearch(_identifySelectedNum, 'browse');
    }
    showPage('browse');
  }
  showToast('âœ“ Item ' + _identifySelectedNum + ' loaded â€” confirm the match below');
}

function openGoogleImageSearch() {
  const query = window._identifyGoogleQuery || ('Lionel postwar train ' + (_identifySelectedNum || ''));
  const url = 'https://www.google.com/search?tbm=isch&q=' + encodeURIComponent(query);
  window.open(url, '_blank');
}

// Close on backdrop click â€” deferred so DOM is ready
window.addEventListener('load', function() {
  var m = document.getElementById('identify-modal');
  if (m) m.addEventListener('click', function(e) { if (e.target === this) closeIdentify(); });
  var p = document.getElementById('photo-picker-sheet');
  if (p) p.addEventListener('click', function(e) { if (e.target === this) closePhotoPicker(); });
});


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW PICTURES PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _photosCurrentItem = null;  // { pd, masterItem }
let _photosFiles = [];          // array of { id, name, mediaUrl }
let _photosIdx = 0;             // current photo index
let _photosFolderLink = '';     // Drive folder URL

// â”€â”€ Ticker (scrolling thumbnails) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _tickerItems = [];       // items with photos
let _tickerInterval = null;
let _tickerOffset = 0;
const TICKER_SPEED = 0.5;    // px per frame

function buildPhotosTicker() {
  const ticker = document.getElementById('photos-ticker');
  if (!ticker) return;
  _tickerItems = Object.values(state.personalData).filter(pd => pd.photoItem);
  if (_tickerItems.length === 0) {
    ticker.innerHTML = '<div style="padding:20px 1rem;color:var(--text-dim);font-size:0.78rem;font-family:var(--font-head);letter-spacing:0.1em;text-transform:uppercase">No photos yet â€” add items with photos to see them here</div>';
    return;
  }
  // Duplicate items for seamless loop
  const items = [..._tickerItems, ..._tickerItems, ..._tickerItems];
  ticker.innerHTML = items.map((pd, i) => {
    const has = !!pd.photoItem;
    return `<div class="ticker-thumb" data-idx="${i % _tickerItems.length}"
      style="flex-shrink:0;width:68px;height:68px;border-radius:8px;overflow:hidden;
      background:var(--surface);border:1px solid var(--border);cursor:pointer;position:relative"
      onclick="_tickerClick(${i % _tickerItems.length})">
      <div id="tthumb-${i}" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center">
        <div style="color:var(--text-dim);font-size:1.2rem">ðŸ“·</div>
      </div>
    </div>`;
  }).join('');

  // Load first visible batch of thumbs
  setTimeout(() => loadTickerThumbs(), 100);

  // Animate
  if (_tickerInterval) cancelAnimationFrame(_tickerInterval);
  const wrap = document.getElementById('photos-ticker-wrap');
  const totalWidth = _tickerItems.length * (68 + 6); // thumb + gap
  _tickerOffset = 0;

  function animate() {
    _tickerOffset += TICKER_SPEED;
    if (_tickerOffset >= totalWidth) _tickerOffset -= totalWidth;
    ticker.style.transform = `translateX(-${_tickerOffset}px)`;
    _tickerInterval = requestAnimationFrame(animate);
  }
  _tickerInterval = requestAnimationFrame(animate);
}

async function loadTickerThumbs() {
  // Load thumbnails for the first set of items
  const limit = Math.min(_tickerItems.length, 20);
  for (let i = 0; i < limit; i++) {
    const pd = _tickerItems[i];
    if (!pd.photoItem) continue;
    try {
      const files = await driveGetFolderPhotos(pd.photoItem);
      if (!files || files.length === 0) continue;
      const fileId = files[0].id;
      // Load the same blob into all 3 copies
      const url = await loadDriveThumbUrl(fileId);
      if (!url) continue;
      [i, i + _tickerItems.length, i + _tickerItems.length * 2].forEach(idx => {
        const el = document.getElementById('tthumb-' + idx);
        if (el) el.innerHTML = `<img src="${url}" style="width:100%;height:100%;object-fit:cover">`;
      });
    } catch(e) { /* skip */ }
  }
}

async function loadDriveThumbUrl(fileId) {
  if (_blobCache[fileId]) return _blobCache[fileId];
  try {
    const res = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&acknowledgeAbuse=true`, {
      headers: { Authorization: 'Bearer ' + accessToken }
    });
    if (!res.ok) return null;
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    _blobCache[fileId] = url;
    return url;
  } catch(e) { return null; }
}

function _tickerClick(itemIdx) {
  const pd = _tickerItems[itemIdx];
  if (!pd) return;
  const inp = document.getElementById('photos-search');
  if (inp) {
    inp.value = pd.itemNum;
    onPhotosSearch(pd.itemNum);
    // Select the first suggestion matching this exact item
    setTimeout(() => {
      const key = Object.keys(state.personalData).find(k =>
        state.personalData[k].itemNum === pd.itemNum && state.personalData[k].photoItem
      );
      if (key) openPhotosViewer(key);
    }, 200);
  }
}

// â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onPhotosSearch(val) {
  const sugg = document.getElementById('photos-suggestions');
  const viewer = document.getElementById('photos-viewer');
  if (!val.trim()) {
    sugg.style.display = 'none';
    viewer.style.display = 'none';
    return;
  }
  // Build suggestions from personal collection
  const q = val.trim().toLowerCase();
  const matches = Object.entries(state.personalData)
    .filter(([k, pd]) => pd.itemNum && pd.itemNum.toLowerCase().includes(q))
    .slice(0, 12);

  if (matches.length === 0) {
    sugg.style.display = 'flex';
    sugg.style.flexDirection = 'column';
    sugg.innerHTML = '<div style="padding:0.75rem;color:var(--text-dim);font-size:0.82rem">No items found in your collection</div>';
    return;
  }

  sugg.style.display = 'flex';
  sugg.style.flexDirection = 'column';
  sugg.innerHTML = matches.map(([key, pd]) => {
    const master = (state.masterData || []).find(m => m.itemNum === pd.itemNum);
    const hasPhoto = !!pd.photoItem;
    const desc = master ? (master.roadName ? master.roadName + ' Â· ' : '') + (master.type || '') : '';
    return `<div onclick="openPhotosViewer('${key.replace(/'/g,"\'")}');document.getElementById('photos-suggestions').style.display='none'"
      style="display:flex;align-items:center;gap:0.75rem;padding:0.65rem 0.75rem;border-radius:8px;cursor:pointer;background:var(--surface2);margin-bottom:1px"
      onmouseover="this.style.background='rgba(224,64,40,0.08)'" onmouseout="this.style.background='var(--surface2)'">
      <span style="font-family:var(--font-mono);font-weight:700;color:var(--gold);min-width:52px">${pd.itemNum}</span>
      <span style="flex:1;font-size:0.8rem;color:var(--text-mid)">${desc}${pd.variation ? ' Â· ' + pd.variation : ''}</span>
      ${hasPhoto ? '<span title="Has photos" style="font-size:1rem">ðŸ“·</span>' : '<span style="font-size:0.7rem;color:var(--text-dim)">no photo</span>'}
    </div>`;
  }).join('');
}

// â”€â”€ Viewer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openPhotosViewer(key) {
  const pd = state.personalData[key];
  if (!pd) return;
  _photosCurrentItem = { pd, key };
  _photosFiles = [];
  _photosIdx = 0;

  const viewer = document.getElementById('photos-viewer');
  viewer.style.display = 'block';

  // Show loading state
  const carouselImg = document.getElementById('photos-carousel-img');
  const loading = document.getElementById('photos-carousel-loading');
  const empty = document.getElementById('photos-carousel-empty');
  carouselImg.style.display = 'none';
  loading.style.display = 'flex';
  empty.style.display = 'none';

  renderPhotosDetails(pd);

  // Load photos from Drive
  const folderLink = pd.photoItem || '';
  _photosFolderLink = folderLink;

  if (!folderLink) {
    loading.style.display = 'none';
    empty.style.display = 'flex';
    renderPhotosDots(0, 0);
    document.getElementById('photos-counter').textContent = '';
    document.getElementById('photos-label').textContent = '';
    document.getElementById('photos-prev-btn').style.display = 'none';
    document.getElementById('photos-next-btn').style.display = 'none';
    return;
  }

  try {
    const files = await driveGetFolderPhotos(folderLink);
    if (!files || files.length === 0) {
      loading.style.display = 'none';
      empty.style.display = 'flex';
      renderPhotosDots(0, 0);
      document.getElementById('photos-counter').textContent = '';
      document.getElementById('photos-label').textContent = '';
      document.getElementById('photos-prev-btn').style.display = 'none';
      document.getElementById('photos-next-btn').style.display = 'none';
      return;
    }
    _photosFiles = files;
    const showNav = files.length > 1;
    document.getElementById('photos-prev-btn').style.display = showNav ? 'flex' : 'none';
    document.getElementById('photos-next-btn').style.display = showNav ? 'flex' : 'none';
    renderPhotosDots(0, files.length);
    await loadPhotosFrame(0);
  } catch(e) {
    loading.style.display = 'none';
    empty.style.display = 'flex';
  }

  // Setup swipe on carousel
  setupPhotosSwipe();

  // Scroll viewer into view on mobile
  setTimeout(() => viewer.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
}

async function loadPhotosFrame(idx) {
  const carouselImg = document.getElementById('photos-carousel-img');
  const loading = document.getElementById('photos-carousel-loading');
  const empty = document.getElementById('photos-carousel-empty');

  if (!_photosFiles[idx]) return;
  carouselImg.style.display = 'none';
  loading.style.display = 'flex';
  empty.style.display = 'none';

  const file = _photosFiles[idx];
  const url = await loadDriveThumbUrl(file.id);

  loading.style.display = 'none';
  if (url) {
    carouselImg.src = url;
    carouselImg.style.display = 'block';
  } else {
    empty.style.display = 'flex';
  }

  // Update counter and label
  document.getElementById('photos-counter').textContent = `${idx + 1} / ${_photosFiles.length}`;
  // Parse view label from filename (e.g. "726 Front View.jpg" â†’ "Front View")
  const fname = file.name || '';
  const parts = fname.split('.'); const base = parts.slice(0,-1).join('.') || fname;
  const labelMatch = base.split(' ').slice(1).join(' ');
  document.getElementById('photos-label').textContent = labelMatch || '';
  renderPhotosDots(idx, _photosFiles.length);
}

function photosNav(dir) {
  if (_photosFiles.length === 0) return;
  _photosIdx = (_photosIdx + dir + _photosFiles.length) % _photosFiles.length;
  loadPhotosFrame(_photosIdx);
}

function renderPhotosDots(current, total) {
  const dotsEl = document.getElementById('photos-dots');
  if (total <= 1) { dotsEl.innerHTML = ''; return; }
  dotsEl.innerHTML = Array.from({ length: total }, (_, i) =>
    `<div style="width:${i===current?14:7}px;height:7px;border-radius:4px;background:${i===current?'var(--accent)':'var(--border)'};transition:all 0.2s;cursor:pointer" onclick="photosNavTo(${i})"></div>`
  ).join('');
}

function photosNavTo(idx) {
  _photosIdx = idx;
  loadPhotosFrame(idx);
}

// â”€â”€ Item header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPhotosItemHeader(pd) {
  const master = (state.masterData || []).find(m => m.itemNum === pd.itemNum);
  const el = document.getElementById('photos-item-header');
  if (!el) return;
  el.innerHTML = `<div style="display:flex;align-items:flex-start;gap:0.75rem">
    <div>
      <div style="font-family:var(--font-mono);font-size:1.4rem;font-weight:700;color:var(--gold)">${pd.itemNum}</div>
      ${pd.variation ? `<div style="font-size:0.75rem;color:var(--text-dim);font-family:var(--font-mono)">${pd.variation}</div>` : ''}
    </div>
    <div style="flex:1">
      <div style="font-weight:600;font-size:0.95rem;color:var(--text)">${master ? (master.type || '') + (master.roadName ? ' â€” ' + master.roadName : '') : pd.itemNum}</div>
      ${master?.description ? `<div style="font-size:0.78rem;color:var(--text-mid);margin-top:0.15rem">${master.description}</div>` : ''}
    </div>
  </div>`;
}

// â”€â”€ Collection details â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPhotosDetails(pd) {
  renderPhotosItemHeader(pd);
  const el = document.getElementById('photos-details');
  if (!el) return;
  const condMap = { 10:'10 â€” Like New', 9:'9 â€” Excellent', 8:'8 â€” Very Good', 7:'7 â€” Good', 6:'6 â€” Fair', 5:'5 â€” Poor' };
  const rows = [
    pd.condition      ? ['Condition',    condMap[pd.condition] || pd.condition] : null,
    pd.allOriginal    ? ['All Original', pd.allOriginal] : null,
    pd.hasBox         ? ['Has Box',      pd.hasBox + (pd.boxCond ? ' (Cond: ' + pd.boxCond + ')' : '')] : null,
    pd.priceItem      ? ['Paid (Item)',  '$' + pd.priceItem] : null,
    pd.priceBox       ? ['Paid (Box)',   '$' + pd.priceBox] : null,
    pd.userEstWorth   ? ['Est. Worth',   '$' + pd.userEstWorth] : null,
    pd.yearMade       ? ['Year Made',    pd.yearMade] : null,
    pd.datePurchased  ? ['Purchased',    pd.datePurchased] : null,
    pd.matchedTo      ? ['Matched To',  pd.matchedTo] : null,
    pd.isError === 'Yes' ? ['Error Car', pd.errorDesc || 'Yes'] : null,
    pd.notes          ? ['Notes',        pd.notes] : null,
  ].filter(Boolean);

  if (rows.length === 0) {
    el.innerHTML = '<div style="color:var(--text-dim);font-size:0.82rem">No details recorded yet.</div>';
    return;
  }
  el.innerHTML = rows.map(([label, val]) =>
    `<div style="display:flex;gap:0.5rem;padding:0.2rem 0;border-bottom:1px solid var(--border)">
      <div style="min-width:110px;color:var(--text-dim);font-size:0.78rem;font-family:var(--font-head);letter-spacing:0.05em;text-transform:uppercase;padding-top:0.1rem">${label}</div>
      <div style="flex:1;color:var(--text);font-size:0.84rem">${val}</div>
    </div>`
  ).join('');
}

function photosOpenDrive() {
  if (_photosFolderLink) window.open(_photosFolderLink, '_blank');
}

// â”€â”€ Swipe gesture on carousel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupPhotosSwipe() {
  const wrap = document.getElementById('photos-carousel-wrap');
  if (!wrap || wrap._swipeSetup) return;
  wrap._swipeSetup = true;
  let startX = 0, startY = 0;
  wrap.addEventListener('touchstart', e => {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
  }, { passive: true });
  wrap.addEventListener('touchend', e => {
    const dx = e.changedTouches[0].clientX - startX;
    const dy = e.changedTouches[0].clientY - startY;
    if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 40) {
      photosNav(dx < 0 ? 1 : -1);
    }
  }, { passive: true });
}

// â”€â”€ Page entry point â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPhotosPage() {
  buildPhotosTicker();
  // Clear viewer
  const viewer = document.getElementById('photos-viewer');
  if (viewer) viewer.style.display = 'none';
  const sugg = document.getElementById('photos-suggestions');
  if (sugg) sugg.style.display = 'none';
}

// Pause ticker when navigating away â€” hooked into nav buttons via buildPhotosPage
// (showPage is defined earlier; we patch it here only if not already patched)
if (!window._photosPagePatched) {
  window._photosPagePatched = true;
  const _origShowPage2 = showPage;
  showPage = function(name, btn) {
    if (_tickerInterval && name !== 'photos') {
      cancelAnimationFrame(_tickerInterval);
      _tickerInterval = null;
    }
    _origShowPage2(name, btn);
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHOTO SOURCE PICKER â€” camera vs phone library
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

function showPhotoSourcePicker(stepId, viewKey) {
  _pickerStepId = stepId;
  _pickerViewKey = viewKey;
  // Update button labels based on device type
  const camLabel = document.getElementById('picker-cam-label');
  const libLabel = document.getElementById('picker-lib-label');
  const camBtn   = document.getElementById('picker-btn-cam');
  if (_isTouchDevice) {
    if (camLabel) camLabel.textContent = 'Take Photo';
    if (libLabel) libLabel.textContent = 'Choose from Phone Library';
    if (camBtn)   camBtn.style.display = 'flex';
  } else {
    if (camLabel) camLabel.textContent = 'Take Photo with Webcam';
    if (libLabel) libLabel.textContent = 'Upload from Computer';
    if (camBtn)   camBtn.style.display = 'none'; // most desktops lack useful camera
  }
  document.getElementById('photo-picker-sheet').classList.add('open');
}

function closePhotoPicker() {
  document.getElementById('photo-picker-sheet').classList.remove('open');
  _pickerStepId = null;
  _pickerViewKey = null;
}

function pickerHandleFile(inputEl, isCamera) {
  if (!inputEl.files || !inputEl.files[0]) return;
  // Grab everything synchronously before any async or state changes
  const file = inputEl.files[0];
  const sid = _pickerStepId;
  const vk = _pickerViewKey;
  // Close picker and clear state
  closePhotoPicker();
  // Reset input value so same file can be re-selected later
  setTimeout(() => { try { inputEl.value = ''; } catch(e) {} }, 500);
  // Validate we have a target slot
  if (!sid || !vk) { showToast('Photo slot lost â€” please try again', 3000, true); return; }
  // Call upload directly with the file (bypass event object entirely)
  uploadWizardPhoto(file, sid, vk);
}
</script>
<!-- â•â• IDENTIFY ITEM MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="identify-modal">
  <div id="identify-panel">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="font-family:var(--font-head);font-size:1.1rem;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;color:var(--cream)">
        ðŸ” Identify by Photo
      </div>
      <button onclick="closeIdentify()" style="background:none;border:none;color:var(--text-dim);font-size:1.4rem;cursor:pointer;padding:0 0.25rem;line-height:1">Ã—</button>
    </div>
    <div id="identify-setup" style="display:none">
      <div class="gemini-setup">
        <div style="font-family:var(--font-head);font-size:0.72rem;font-weight:600;letter-spacing:0.12em;text-transform:uppercase;color:var(--gold);margin-bottom:0.5rem">âš™ API Key Required</div>
        <div style="margin-top:0.75rem;display:flex;gap:0.5rem">
          <input id="gemini-key-input" type="password" placeholder="Paste your Gemini API keyâ€¦"
            style="flex:1;padding:0.6rem 0.75rem;background:var(--bg);border:1.5px solid var(--border);border-radius:7px;color:var(--text);font-family:var(--font-mono);font-size:0.82rem">
          <button onclick="saveGeminiKey()" class="btn btn-primary" style="font-size:0.78rem;padding:0.55rem 1rem;white-space:nowrap">Save Key</button>
        </div>
      </div>
    </div>
    <div id="identify-ready" style="display:none;flex-direction:column;gap:1rem">
      <div class="identify-drop" id="identify-drop"
        ondragover="event.preventDefault();this.classList.add('dragover')"
        ondragleave="this.classList.remove('dragover')"
        ondrop="handleIdentifyDrop(event)">
        <input type="file" accept="image/*" onchange="handleIdentifyFile(this.files[0])">
        <div id="identify-drop-hint" style="pointer-events:none">
          <div style="font-size:2.5rem;margin-bottom:0.5rem">ðŸ“·</div>
          <div style="font-family:var(--font-head);font-size:0.85rem;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;color:var(--text-mid)">Tap to take photo or choose from library</div>
          <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.3rem">Locomotive, car, accessory â€” any angle</div>
        </div>
        <img id="identify-preview" class="identify-preview" alt="preview">
      </div>
      <button id="identify-analyze-btn" onclick="runGeminiIdentify()"
        style="display:none;width:100%;padding:0.75rem;border-radius:8px;border:none;background:var(--accent);color:white;font-family:var(--font-head);font-size:0.88rem;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;align-items:center;justify-content:center;gap:0.5rem">
        ðŸ” Identify This Item
      </button>
      <div id="identify-status" style="display:none;text-align:center;padding:1rem">
        <div class="spinner" style="margin:0 auto 0.75rem;width:28px;height:28px;border-width:2px"></div>
        <div style="font-size:0.82rem;color:var(--text-mid)" id="identify-status-msg">Analyzing image with Gemini Visionâ€¦</div>
      </div>
      <div id="identify-description" style="display:none;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:0.85rem;font-size:0.8rem;color:var(--text-mid);line-height:1.6"></div>
      <div id="identify-candidates" style="display:none;flex-direction:column;gap:0.5rem">
        <div style="font-family:var(--font-head);font-size:0.62rem;font-weight:600;letter-spacing:0.16em;text-transform:uppercase;color:var(--text-dim);margin-bottom:0.1rem">Select the best match:</div>
      </div>
      <div id="identify-actions" style="display:none;gap:0.5rem;flex-wrap:wrap">
        <button onclick="useIdentifiedItem()" class="btn btn-primary" style="flex:1;justify-content:center;min-width:140px">Use This Item â†’</button>
        <button onclick="resetIdentify()" class="btn" style="justify-content:center">Try Another Photo</button>
        <button onclick="openGoogleImageSearch()" class="btn" style="justify-content:center;gap:0.35rem">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          Google Images
        </button>
      </div>
      <div style="text-align:center;margin-top:0.25rem">
        <button onclick="showGeminiSetup()" class="link-btn" style="font-size:0.72rem">Change API key</button>
      </div>
    </div>
  </div>
</div>
<!-- â•â• VIEW PICTURES PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-photos">
  <div class="page-title">View Pictures</div>

  <!-- Scrolling thumbnail ticker -->
  <div id="photos-ticker-wrap" style="overflow:hidden;height:80px;position:relative;background:var(--surface2);border-radius:10px;margin-bottom:1rem;border:1px solid var(--border)">
    <div id="photos-ticker" style="display:flex;gap:6px;position:absolute;top:6px;white-space:nowrap;will-change:transform"></div>
    <div style="position:absolute;inset:0;background:linear-gradient(to right,var(--surface2) 0%,transparent 8%,transparent 92%,var(--surface2) 100%);pointer-events:none"></div>
  </div>

  <!-- Search box -->
  <div style="display:flex;align-items:center;gap:0.5rem;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:0.55rem 0.9rem;margin-bottom:0.75rem">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--text-dim);flex-shrink:0"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input id="photos-search" type="text" placeholder="Enter item number from your collectionâ€¦" autocomplete="off"
      style="flex:1;border:none;background:none;color:var(--text);font-family:var(--font-body);font-size:1rem;outline:none"
      oninput="onPhotosSearch(this.value)">
    <button onclick="document.getElementById('photos-search').value='';onPhotosSearch('');" style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:1.1rem;padding:0;line-height:1">Ã—</button>
  </div>

  <!-- Suggestions dropdown -->
  <div id="photos-suggestions" style="display:none;flex-direction:column;gap:1px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:4px;margin-bottom:0.75rem;max-height:260px;overflow-y:auto"></div>

  <!-- Photo viewer -->
  <div id="photos-viewer" style="display:none">
    <!-- Item header -->
    <div id="photos-item-header" style="margin-bottom:0.75rem"></div>

    <!-- Photo carousel -->
    <div id="photos-carousel-wrap" style="position:relative;background:#000;border-radius:12px;overflow:hidden;aspect-ratio:4/3;touch-action:pan-y;user-select:none">
      <img id="photos-carousel-img" style="width:100%;height:100%;object-fit:contain;display:block" alt="Item photo">
      <div id="photos-carousel-loading" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6)">
        <div class="spinner" style="width:32px;height:32px;border-width:2px"></div>
      </div>
      <div id="photos-carousel-empty" style="position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;gap:0.5rem">
        <div style="font-size:3rem">ðŸ“·</div>
        <div style="color:var(--text-dim);font-size:0.85rem">No photos on file</div>
        <button onclick="startWizardFor('collection')" class="btn btn-primary" style="margin-top:0.5rem;font-size:0.78rem">Add Photos</button>
      </div>
      <!-- Prev/Next arrows -->
      <button id="photos-prev-btn" onclick="photosNav(-1)"
        style="position:absolute;left:0;top:50%;transform:translateY(-50%);width:44px;height:64px;background:rgba(0,0,0,0.45);border:none;color:white;font-size:1.6rem;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:0 8px 8px 0;touch-action:manipulation">â€¹</button>
      <button id="photos-next-btn" onclick="photosNav(1)"
        style="position:absolute;right:0;top:50%;transform:translateY(-50%);width:44px;height:64px;background:rgba(0,0,0,0.45);border:none;color:white;font-size:1.6rem;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:8px 0 0 8px;touch-action:manipulation">â€º</button>
      <!-- Photo counter -->
      <div id="photos-counter" style="position:absolute;bottom:8px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.55);color:white;font-family:var(--font-mono);font-size:0.72rem;padding:2px 10px;border-radius:20px"></div>
      <!-- Photo label -->
      <div id="photos-label" style="position:absolute;top:8px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.55);color:white;font-family:var(--font-head);font-size:0.68rem;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;padding:2px 10px;border-radius:20px"></div>
    </div>

    <!-- Dot indicators -->
    <div id="photos-dots" style="display:flex;justify-content:center;gap:5px;margin:0.6rem 0"></div>

    <!-- Collection details -->
    <div id="photos-details" style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:1rem;margin-top:0.5rem;font-size:0.84rem;line-height:1.7"></div>

    <!-- Open in Drive button -->
    <div style="text-align:center;margin-top:0.75rem">
      <button id="photos-drive-btn" onclick="photosOpenDrive()" class="btn" style="font-size:0.78rem;gap:0.4rem;color:var(--text-dim)">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 0 1-2h6"/><polyline points="15,3 21,3 21,9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
        Open folder in Drive
      </button>
    </div>
  </div>

</div>
<!-- â•â• PHOTO SOURCE PICKER SHEET â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="photo-picker-sheet">
  <div id="photo-picker-inner">
    <div style="text-align:center;font-family:var(--font-head);font-size:0.65rem;font-weight:600;
      letter-spacing:0.18em;text-transform:uppercase;color:var(--text-dim);margin-bottom:0.25rem">
      Add Photo
    </div>
    <label class="picker-btn" for="picker-input-cam" id="picker-btn-cam">
      <span class="picker-icon">ðŸ“·</span> <span id="picker-cam-label">Take Photo</span>
    </label>
    <label class="picker-btn" for="picker-input-lib" id="picker-btn-lib">
      <span class="picker-icon">ðŸ–¼ï¸</span> <span id="picker-lib-label">Choose from Library</span>
    </label>
    <button onclick="closePhotoPicker()" style="width:100%;padding:0.75rem;border-radius:12px;
      border:none;background:none;color:var(--text-dim);font-family:var(--font-body);
      font-size:0.9rem;cursor:pointer;margin-top:0.25rem">
      Cancel
    </button>
  </div>
</div>
<input type="file" id="picker-input-cam" accept="image/*" capture="environment"
  style="position:fixed;top:-999px;left:-999px;opacity:0"
  onchange="pickerHandleFile(this, true)">
<input type="file" id="picker-input-lib" accept="image/*"
  style="position:fixed;top:-999px;left:-999px;opacity:0"
  onchange="pickerHandleFile(this, false)">
</body>
</html>
