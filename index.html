<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸš‚</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230e0f11'/><text y='0.9em' font-size='80'>ðŸš‚</text></svg>">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="My Train Collection">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0e0f11">
  <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Lionel Vault&quot;,&quot;short_name&quot;:&quot;Lionel Vault&quot;,&quot;start_url&quot;:&quot;/lionel-vault/&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%230e0f11&quot;,&quot;theme_color&quot;:&quot;%230e0f11&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230e0f11'/><text y='0.9em' font-size='80'>ðŸš‚</text></svg>&quot;,&quot;sizes&quot;:&quot;any&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>My Train Collection â€” Postwar 1945â€“1969</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  /* â”€â”€ Reset & Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  /* Prevent iOS auto-zoom on inputs */
  @media (max-width: 640px) {
    input, select, textarea { font-size: 16px !important; }
  }

  :root {
    --bg:        #0e0f11;
    --surface:   #161820;
    --surface2:  #1e2028;
    --border:    #2a2d38;
    --accent:    #e8401c;
    --accent2:   #f5a623;
    --text:      #e8e9ec;
    --text-dim:  #7c8090;
    --text-mid:  #b0b4c0;
    --green:     #2ecc71;
    --red:       #e74c3c;
    --radius:    10px;
    --font-head: 'Bebas Neue', sans-serif;
    --font-body: 'DM Sans', sans-serif;
    --font-mono: 'DM Mono', monospace;
    --sidebar-w: 260px;
    --header-h:  60px;
  }

  html, body { height: 100%; font-family: var(--font-body); background: var(--bg); color: var(--text); font-size: 14px; }

  /* â”€â”€ Auth Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #auth-screen {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 100vh; padding: 2rem;
    background: radial-gradient(ellipse at 30% 20%, #1a1f3a 0%, var(--bg) 60%),
                radial-gradient(ellipse at 80% 80%, #2a1008 0%, transparent 50%);
  }

  .auth-logo {
    font-family: var(--font-head); font-size: clamp(3rem, 10vw, 6rem);
    letter-spacing: 0.05em; line-height: 1;
    background: linear-gradient(135deg, #fff 0%, var(--accent2) 50%, var(--accent) 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    margin-bottom: 0.25rem;
  }
  .auth-sub {
    font-size: 0.8rem; letter-spacing: 0.3em; text-transform: uppercase;
    color: var(--text-dim); margin-bottom: 3rem;
  }
  .auth-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 2.5rem; width: 100%; max-width: 400px;
    text-align: center;
  }
  .auth-card h2 { font-size: 1.1rem; font-weight: 500; margin-bottom: 0.5rem; }
  .auth-card p { color: var(--text-dim); font-size: 0.85rem; margin-bottom: 2rem; line-height: 1.6; }

  .btn-google {
    display: flex; align-items: center; justify-content: center; gap: 0.75rem;
    width: 100%; padding: 0.85rem 1.5rem;
    background: #fff; color: #333; border: none; border-radius: 8px;
    font-family: var(--font-body); font-size: 0.95rem; font-weight: 500;
    cursor: pointer; transition: all 0.2s;
  }
  .btn-google:hover { background: #f0f0f0; transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .btn-google svg { width: 20px; height: 20px; flex-shrink: 0; }

  .auth-note {
    margin-top: 1.5rem; font-size: 0.75rem; color: var(--text-dim); line-height: 1.5;
  }

  /* â”€â”€ App Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #app { display: none; height: 100vh; flex-direction: column; }
  #app.active { display: flex; }

  /* Header */
  .header {
    height: var(--header-h); background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 1.25rem;
    gap: 1rem; flex-shrink: 0; z-index: 100;
  }
  .header-logo { font-family: var(--font-head); flex-shrink: 0; line-height: 1.2; }
  .header-search {
    flex: 1; max-width: 480px;
    display: flex; align-items: center; gap: 0.5rem;
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; padding: 0.4rem 0.75rem;
  }
  .header-search input {
    flex: 1; background: none; border: none; outline: none;
    color: var(--text); font-family: var(--font-body); font-size: 0.9rem;
  }
  .header-search input::placeholder { color: var(--text-dim); }
  .header-search svg { color: var(--text-dim); flex-shrink: 0; }
  .header-right { margin-left: auto; display: flex; align-items: center; gap: 0.75rem; }
  .user-chip {
    display: flex; align-items: center; gap: 0.5rem;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 20px; padding: 0.3rem 0.75rem 0.3rem 0.3rem;
    font-size: 0.8rem;
  }
  .user-avatar {
    width: 26px; height: 26px; border-radius: 50%; background: var(--accent);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem; font-weight: 600; color: white;
  }
  .btn-sign-out {
    background: none; border: 1px solid var(--border); border-radius: 6px;
    padding: 0.3rem 0.6rem; color: var(--text-dim); cursor: pointer;
    font-size: 0.75rem; font-family: var(--font-body); transition: all 0.2s;
  }
  .btn-sign-out:hover { border-color: var(--accent); color: var(--accent); }

  /* Body layout */
  .app-body { display: flex; flex: 1; overflow: hidden; }

  /* Sidebar Nav */
  .sidebar {
    width: var(--sidebar-w); background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column; flex-shrink: 0;
    overflow-y: auto;
  }
  .nav-section { padding: 1.25rem 0.75rem 0.5rem; }
  .nav-label { font-size: 0.65rem; letter-spacing: 0.15em; text-transform: uppercase;
    color: var(--text-dim); padding: 0 0.5rem; margin-bottom: 0.4rem; }
  .nav-item {
    display: flex; align-items: center; gap: 0.65rem;
    padding: 0.55rem 0.75rem; border-radius: 7px; cursor: pointer;
    color: var(--text-mid); font-size: 0.875rem; font-weight: 400;
    transition: all 0.15s; border: none; background: none; width: 100%; text-align: left;
  }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { background: rgba(232,64,28,0.12); color: var(--accent); font-weight: 500; }
  .nav-item svg { flex-shrink: 0; opacity: 0.8; }
  .nav-badge {
    margin-left: auto; background: var(--accent); color: white;
    border-radius: 10px; padding: 0.1rem 0.45rem; font-size: 0.7rem; font-weight: 600;
  }
  .nav-badge.green { background: var(--green); }

  /* Main content */
  .main { flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }

  /* â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .page { display: none; }
  .page.active { display: contents; }

  .page-title {
    font-family: var(--font-head); font-size: 2rem; letter-spacing: 0.04em;
    display: flex; align-items: baseline; gap: 0.75rem;
  }
  .page-title span { font-family: var(--font-body); font-size: 0.8rem;
    color: var(--text-dim); font-weight: 400; letter-spacing: 0; }

  /* Stat cards */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1rem; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 1.25rem; position: relative; overflow: hidden;
  }
  .stat-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: var(--accent-color, var(--accent));
  }
  .stat-label { font-size: 0.72rem; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--text-dim); margin-bottom: 0.5rem; }
  .stat-value { font-family: var(--font-head); font-size: 2.2rem; letter-spacing: 0.02em;
    line-height: 1; color: var(--text); }
  .stat-sub { font-size: 0.75rem; color: var(--text-dim); margin-top: 0.3rem; }

  .section-title { font-size: 0.72rem; letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--text-dim); margin-bottom: 0.75rem; padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border); }

  .cat-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 1rem; display: flex; align-items: center; gap: 0.75rem;
    cursor: pointer; transition: all 0.15s;
  }
  .cat-card:hover { border-color: var(--accent); transform: translateY(-1px); }
  .cat-icon { width: 36px; height: 36px; border-radius: 8px; background: var(--surface2);
    display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
  .cat-info { flex: 1; min-width: 0; }
  .cat-name { font-weight: 500; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .cat-count { font-size: 0.75rem; color: var(--text-dim); }
  .cat-bar { height: 3px; background: var(--border); border-radius: 2px; margin-top: 0.4rem; }
  .cat-bar-fill { height: 100%; border-radius: 2px; background: var(--accent); transition: width 0.8s ease; }

  /* Recent / want list */
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  @media (max-width: 700px) { .two-col { grid-template-columns: 1fr; } }

  .panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; max-height: 420px; overflow-y: auto; }

  /* â”€â”€ Browse / Search Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .filter-bar {
    display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;
  }
  .filter-select {
    background: var(--surface); border: 1px solid var(--border); border-radius: 7px;
    padding: 0.45rem 0.75rem; color: var(--text); font-family: var(--font-body); font-size: 0.85rem;
    outline: none; cursor: pointer; transition: border-color 0.15s;
  }
  .filter-select:focus { border-color: var(--accent); }
  .filter-toggle {
    padding: 0.45rem 0.75rem; border-radius: 7px; border: 1px solid var(--border);
    background: var(--surface); color: var(--text-mid); font-size: 0.85rem;
    font-family: var(--font-body); cursor: pointer; transition: all 0.15s;
  }
  .filter-toggle.on { background: rgba(232,64,28,0.15); border-color: var(--accent); color: var(--accent); }

  /* Item table */
  .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
  .item-table { width: 100%; border-collapse: collapse; }
  .item-table th {
    background: var(--surface2); padding: 0.65rem 1rem; text-align: left;
    font-size: 0.7rem; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--text-dim); border-bottom: 1px solid var(--border);
    font-weight: 500; white-space: normal; word-break: break-word; line-height: 1.2;
    position: sticky; top: 0; z-index: 2;
  }
  .item-table td {
    padding: 0.75rem 1rem; border-bottom: 1px solid var(--border);
    font-size: 0.85rem; vertical-align: middle;
  }
  .item-table tr:last-child td { border-bottom: none; }
  .item-table tr:hover td { background: var(--surface2); cursor: pointer; }

  .item-num { font-family: var(--font-mono); font-size: 0.8rem; color: var(--accent2); font-weight: 500; }
  .item-road { color: var(--text-dim); font-size: 0.8rem; }
  .owned-badge {
    display: inline-flex; align-items: center; gap: 0.3rem;
    padding: 0.2rem 0.55rem; border-radius: 12px; font-size: 0.72rem; font-weight: 500;
  }
  .owned-badge.yes  { background: rgba(46,204,113,0.12); color: var(--green); }
  .owned-badge.no   { background: var(--surface2); color: var(--text-dim); }
  .owned-badge.want { background: rgba(245,166,35,0.12); color: var(--accent2); }
  .condition-pip {
    display: inline-block; width: 8px; height: 8px; border-radius: 50%;
    margin-right: 0.25rem;
  }
  .cond-9, .cond-10 { background: #2ecc71; }
  .cond-7, .cond-8  { background: #f1c40f; }
  .cond-5, .cond-6  { background: #e67e22; }
  .cond-low         { background: #e74c3c; }

  .table-pagination {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0.75rem 1rem; border-top: 1px solid var(--border);
    font-size: 0.8rem; color: var(--text-dim);
  }
  .pagination-btns { display: flex; gap: 0.35rem; }
  .page-btn {
    width: 30px; height: 30px; border-radius: 6px; border: 1px solid var(--border);
    background: var(--surface); color: var(--text-mid); cursor: pointer;
    font-size: 0.8rem; font-family: var(--font-body); transition: all 0.15s;
    display: flex; align-items: center; justify-content: center;
  }
  .page-btn:hover { border-color: var(--accent); color: var(--accent); }
  .page-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
  .page-btn:disabled { opacity: 0.3; cursor: default; }

  /* â”€â”€ Item Detail Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200;
    display: flex; align-items: center; justify-content: center; padding: 1rem;
    opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
    width: 100%; max-width: 680px; max-height: 90vh; overflow-y: auto;
    transform: translateY(20px); transition: transform 0.2s;
  }
  #wizard-modal .modal {
    overflow: hidden; display: flex; flex-direction: column;
    transition: background 0.3s, border-color 0.3s;
  }
  /* Wizard tab themes */
  #wizard-modal .modal.wiz-collection {
    background: #1a0e08;
    border-color: rgba(232,64,28,0.4);
  }
  #wizard-modal .modal.wiz-collection .modal-header {
    background: #1a0e08;
    border-bottom-color: rgba(232,64,28,0.25);
  }
  #wizard-modal .modal.wiz-collection #wizard-progress { background: #e8401c; }
  #wizard-modal .modal.wiz-collection .modal-footer {
    background: #1a0e08;
    border-top-color: rgba(232,64,28,0.25);
  }
  #wizard-modal .modal.wiz-want {
    background: #08101a;
    border-color: rgba(41,128,185,0.4);
  }
  #wizard-modal .modal.wiz-want .modal-header {
    background: #08101a;
    border-bottom-color: rgba(41,128,185,0.25);
  }
  #wizard-modal .modal.wiz-want #wizard-progress { background: #2980b9; }
  #wizard-modal .modal.wiz-want .modal-footer {
    background: #08101a;
    border-top-color: rgba(41,128,185,0.25);
  }
  #wizard-modal .modal.wiz-sold {
    background: #081a0e;
    border-color: rgba(46,204,113,0.4);
  }
  #wizard-modal .modal.wiz-sold .modal-header {
    background: #081a0e;
    border-bottom-color: rgba(46,204,113,0.25);
  }
  #wizard-modal .modal.wiz-sold #wizard-progress { background: #2ecc71; }
  #wizard-modal .modal.wiz-sold .modal-footer {
    background: #081a0e;
    border-top-color: rgba(46,204,113,0.25);
  }
  .modal-overlay.open .modal { transform: translateY(0); }

  .modal-header {
    display: flex; align-items: flex-start; justify-content: space-between;
    padding: 1.5rem 1.5rem 1rem; border-bottom: 1px solid var(--border);
    position: sticky; top: 0; background: var(--surface); z-index: 1;
  }
  .modal-item-num { font-family: var(--font-mono); font-size: 0.8rem; color: var(--accent2); margin-bottom: 0.25rem; }
  .modal-title { font-size: 1.1rem; font-weight: 600; }
  .modal-subtitle { font-size: 0.82rem; color: var(--text-dim); margin-top: 0.2rem; }
  .btn-close {
    width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border);
    background: var(--surface2); color: var(--text-dim); cursor: pointer;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    font-size: 1rem; transition: all 0.15s;
  }
  .btn-close:hover { border-color: var(--accent); color: var(--accent); }

  .modal-body { padding: 1.25rem 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }

  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
  @media (max-width: 480px) { .info-grid { grid-template-columns: 1fr; } }
  .info-field { }
  .info-field label { font-size: 0.68rem; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--text-dim); display: block; margin-bottom: 0.25rem; }
  .info-field .info-val { font-size: 0.875rem; color: var(--text); }
  .info-field a { color: var(--accent2); text-decoration: none; font-size: 0.8rem; }
  .info-field a:hover { text-decoration: underline; }

  .desc-block { background: var(--surface2); border-radius: 8px; padding: 0.85rem;
    font-size: 0.82rem; line-height: 1.6; color: var(--text-mid); }

  /* Form fields */
  .form-section-title {
    font-size: 0.68rem; letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--accent); font-weight: 600; padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(232,64,28,0.2);
  }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
  @media (max-width: 480px) { .form-grid { grid-template-columns: 1fr; } }
  .form-field label { font-size: 0.72rem; letter-spacing: 0.08em; text-transform: uppercase;
    color: var(--text-dim); display: block; margin-bottom: 0.3rem; }
  .form-field input, .form-field select, .form-field textarea {
    width: 100%; background: var(--bg); border: 1px solid var(--border);
    border-radius: 7px; padding: 0.55rem 0.75rem; color: var(--text);
    font-family: var(--font-body); font-size: 0.875rem; outline: none;
    transition: border-color 0.15s;
  }
  .form-field input:focus, .form-field select:focus, .form-field textarea:focus { border-color: var(--accent); }
  .form-field textarea { resize: vertical; min-height: 70px; }
  .form-field.full { grid-column: 1 / -1; }

  /* Toggle switch */
  .toggle-row { display: flex; align-items: center; gap: 0.75rem; }
  .toggle-label { font-size: 0.875rem; }
  .toggle {
    position: relative; width: 40px; height: 22px;
    background: var(--border); border-radius: 11px; cursor: pointer;
    transition: background 0.2s; flex-shrink: 0;
  }
  .toggle.on { background: var(--green); }
  .toggle::after {
    content: ''; position: absolute; top: 3px; left: 3px;
    width: 16px; height: 16px; border-radius: 50%; background: white;
    transition: transform 0.2s;
  }
  .toggle.on::after { transform: translateX(18px); }

  /* Condition slider */
  .condition-display { display: flex; align-items: center; gap: 0.75rem; }
  .condition-num { font-family: var(--font-head); font-size: 2rem; width: 2rem; color: var(--accent2); }
  input[type=range] { flex: 1; accent-color: var(--accent); }

  /* Price row */
  .price-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; }
  @media (max-width: 480px) { .price-row { grid-template-columns: 1fr; } }

  .modal-footer {
    display: flex; gap: 0.75rem; justify-content: flex-end;
    padding: 1rem 1.5rem; border-top: 1px solid var(--border);
    position: sticky; bottom: 0; background: var(--surface);
  }
  .btn { padding: 0.6rem 1.25rem; border-radius: 8px; font-family: var(--font-body);
    font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.15s; border: none; }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: #d63518; }
  .btn-secondary { background: var(--surface2); color: var(--text-mid); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--accent); color: var(--text); }

  /* â”€â”€ Reports Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .report-controls { display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; }
  .btn-export {
    display: flex; align-items: center; gap: 0.5rem;
    padding: 0.55rem 1rem; border-radius: 8px; border: 1px solid var(--border);
    background: var(--surface); color: var(--text-mid); font-family: var(--font-body);
    font-size: 0.85rem; cursor: pointer; transition: all 0.15s;
  }
  .btn-export:hover { border-color: var(--accent2); color: var(--accent2); }

  .report-table { width: 100%; border-collapse: collapse; }
  .report-table th {
    text-align: left; padding: 0.6rem 1rem; font-size: 0.7rem;
    letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim);
    background: var(--surface2); border-bottom: 1px solid var(--border);
  }
  .report-table td { padding: 0.65rem 1rem; border-bottom: 1px solid var(--border); font-size: 0.83rem; }
  .report-table tr:last-child td { border-bottom: none; }

  /* â”€â”€ Loading & Empty States â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .loading {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 3rem; gap: 1rem; color: var(--text-dim);
  }
  .spinner {
    width: 32px; height: 32px; border: 3px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .empty-state { text-align: center; padding: 3rem; color: var(--text-dim); }
  .empty-state .empty-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
  .empty-state p { font-size: 0.875rem; }

  /* â”€â”€ Setup Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #setup-screen {
    display: none; flex-direction: column; align-items: center; justify-content: center;
    min-height: 100vh; padding: 2rem;
  }
  #setup-screen.active { display: flex; }
  .setup-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
    padding: 2.5rem; width: 100%; max-width: 500px;
  }
  .setup-card h2 { font-family: var(--font-head); font-size: 1.8rem; margin-bottom: 0.5rem; }
  .setup-card p { color: var(--text-dim); font-size: 0.875rem; margin-bottom: 1.5rem; line-height: 1.6; }
  .setup-step { display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 1rem; }
  .setup-num {
    width: 24px; height: 24px; border-radius: 50%; background: var(--accent);
    color: white; font-size: 0.75rem; font-weight: 700; display: flex;
    align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px;
  }
  .setup-step p { color: var(--text-mid); font-size: 0.85rem; margin: 0; }
  .input-group { margin-top: 1.25rem; }
  .input-group label { display: block; font-size: 0.72rem; letter-spacing: 0.08em;
    text-transform: uppercase; color: var(--text-dim); margin-bottom: 0.4rem; }
  .input-group input {
    width: 100%; background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; padding: 0.65rem 0.9rem; color: var(--text);
    font-family: var(--font-mono); font-size: 0.85rem; outline: none; transition: border-color 0.15s;
  }
  .input-group input:focus { border-color: var(--accent); }

  /* â”€â”€ Mobile nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .mobile-nav {
    display: none; background: var(--surface); border-top: 1px solid var(--border);
    padding: 0.5rem 0; flex-shrink: 0;
  }
  .mobile-nav-items { display: flex; justify-content: space-around; }
  .mobile-nav-item {
    display: flex; flex-direction: column; align-items: center; gap: 0.2rem;
    padding: 0.4rem 0.75rem; color: var(--text-dim); cursor: pointer;
    font-size: 0.65rem; border: none; background: none; font-family: var(--font-body);
    transition: color 0.15s; border-radius: 8px;
  }
  .mobile-nav-item.active { color: var(--accent); }
  .mobile-add-btn { color: var(--text-dim) !important; padding-top: 0 !important; }

  @media (max-width: 640px) {
    /* Layout */
    .sidebar { display: none; }
    .mobile-nav { display: block; }
    .app-layout { padding-bottom: 64px; } /* room for bottom nav */
    .main { padding: 0.75rem 0.75rem 1rem; }
    .stats-grid { grid-template-columns: 1fr 1fr; }

    /* Browse â€” switch from table to cards on mobile */
    .browse-table-wrap { overflow-x: visible !important; }
    .item-table { display: none; }
    #browse-cards { display: flex; flex-direction: column; gap: 0.5rem; }
    .browse-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: background 0.15s;
    }
    .browse-card:active { background: var(--surface2); }
    .browse-card-left { flex: 1; min-width: 0; }
    .browse-card-num { font-family: var(--font-head); font-size: 1.1rem; color: var(--accent); }
    .browse-card-name { font-size: 0.85rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .browse-card-sub { font-size: 0.72rem; color: var(--text-dim); margin-top: 0.15rem; }
    .browse-card-right { display: flex; flex-direction: column; align-items: flex-end; gap: 0.25rem; flex-shrink: 0; }

    /* Filters bar on mobile */
    .filter-bar { gap: 0.4rem; flex-wrap: wrap; }
    .filter-bar input { font-size: 16px !important; } /* prevent iOS zoom */

    /* Wizard modal â€” full screen on mobile */
    .wizard-modal-inner {
      width: 100% !important;
      max-width: 100% !important;
      height: 100dvh !important;
      max-height: 100dvh !important;
      border-radius: 0 !important;
      margin: 0 !important;
    }

    /* Photo grid â€” single column on small screens */
    #photo-grid { grid-template-columns: 1fr 1fr 1fr !important; gap: 0.4rem !important; }

    /* Buttons â€” bigger tap targets */
    .btn { min-height: 44px; }
    .page-btn { min-width: 40px; min-height: 40px; }

    /* Modal full screen */
    .modal-inner { width: 100% !important; max-width: 100% !important;
      margin: 0 !important; border-radius: 0 !important;
      max-height: 100dvh !important; height: 100dvh !important; }

    /* Fix safe areas for notched phones */
    .mobile-nav {
      padding-bottom: max(0.5rem, env(safe-area-inset-bottom));
      height: calc(60px + env(safe-area-inset-bottom));
    }
    .app-layout { padding-bottom: calc(60px + env(safe-area-inset-bottom)); }
    .main {
      padding-top: 0.75rem;
      padding-left: max(0.75rem, env(safe-area-inset-left));
      padding-right: max(0.75rem, env(safe-area-inset-right));
    }
    /* Bigger stat cards on mobile */
    .stat-card { padding: 1rem; }
    .stat-val { font-size: 1.6rem; }
    /* Search bar full width */
    #search-input { width: 100%; }
    /* Dashboard recent items as cards */
    .two-col { gap: 0.75rem; }
  }

  /* â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tag {
    display: inline-block; padding: 0.15rem 0.5rem; border-radius: 4px;
    font-size: 0.7rem; font-weight: 500; background: var(--surface2); color: var(--text-dim);
  }
  .market-val { font-family: var(--font-mono); color: var(--accent2); }
  .text-dim { color: var(--text-dim); }
  .text-accent { color: var(--accent); }
  .mt-sm { margin-top: 0.5rem; }
  .link-btn {
    background: none; border: none; color: var(--accent2); cursor: pointer;
    font-size: 0.8rem; font-family: var(--font-body); text-decoration: underline; padding: 0;
  }
</style>
</head>
<body>

<!-- â•â• AUTH SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-screen">
  <div class="auth-logo" style="line-height:1.3">
    <div style="color:#2980b9">My Train Collection</div>
    <div style="font-size:0.9rem;letter-spacing:0.15em;color:#2980b9;opacity:0.75;margin-top:4px">POST WAR &nbsp;1945â€“1969</div>
  </div>
  <div class="auth-sub">Postwar Collector's Inventory</div>
  <div class="auth-card">
    <h2>Sign in to your collection</h2>
    <p>Connect with Google to access the master inventory and manage your personal collection across any device.</p>
    <button class="btn-google" onclick="handleSignIn()">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
      </svg>
      Continue with Google
    </button>
    <p class="auth-note">Your personal collection data is stored in your own Google Sheet. The master inventory is shared read-only.</p>
  </div>
</div>

<!-- â•â• FIRST-TIME SETUP SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="setup-screen" style="display:none!important">
  <div class="setup-card">
    <h2>Welcome!</h2>
    <p>One-time setup â€” just two steps to connect your inventory.</p>
    <div class="setup-step">
      <div class="setup-num">1</div>
      <p>Enter the Master Inventory Sheet ID (get this from whoever shared the app with you).</p>
    </div>
    <div class="setup-step">
      <div class="setup-num">2</div>
      <p>Create a blank Google Sheet for your personal collection, then paste its ID below. Go to <a href="https://sheets.google.com" target="_blank" style="color:var(--accent2)">sheets.google.com</a>, create a blank sheet, name it "My Lionel Collection", and copy the ID from the URL.</p>
    </div>
    <div class="input-group">
      <label>Master Sheet ID</label>
      <input id="master-sheet-input" type="text" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgVE2upms" />
    </div>
    <div class="input-group" style="margin-top:0.75rem">
      <label>Your Personal Collection Sheet ID</label>
      <input id="personal-sheet-input" type="text" placeholder="Paste your blank sheet ID here" />
    </div>
    <div style="margin-top:1.25rem">
      <button class="btn btn-primary" style="width:100%" onclick="completeSetup()">Set Up My Collection</button>
    </div>
  </div>
</div>

<!-- â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">

  <!-- Header -->
  <header class="header">
    <div class="header-logo">
      <div style="font-size:1.4rem;letter-spacing:0.05em;color:#2980b9">My Train Collection</div>
      <div style="font-size:0.65rem;letter-spacing:0.12em;color:#2980b9;opacity:0.8;margin-top:1px">POST WAR &nbsp;1945â€“1969</div>
    </div>
    <div class="header-search">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input id="global-search" type="text" placeholder="Search item number, road name, descriptionâ€¦" oninput="onGlobalSearch(this.value)">
    </div>
    <div class="header-right">
      <div class="user-chip">
        <div class="user-avatar" id="user-avatar">?</div>
        <span id="user-name">Loadingâ€¦</span>
      </div>
      <button class="btn-sign-out" onclick="handleSignOut()">Sign out</button>
    </div>
  </header>

  <div class="app-body">

    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="nav-section">
        <div class="nav-label">Overview</div>
        <button class="nav-item active" onclick="showPage('dashboard', this)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
          Dashboard
        </button>
      </div>
      <div class="nav-section">
        <div class="nav-label">Inventory</div>
        <button class="nav-item" onclick="showPage('browse', this); resetFilters(); renderBrowse();">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
          Postwar Item List
          <span class="nav-badge" id="nav-total">â€”</span>
        </button>
        <button class="nav-item" onclick="showPage('browse', this); filterOwned()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
          My Collection
          <span class="nav-badge green" id="nav-owned">â€”</span>
        </button>

        <button class="nav-item" onclick="showPage('want', this); buildWantPage();">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21.593c-5.63-5.539-11-10.297-11-14.402 0-3.791 3.068-5.191 5.281-5.191 1.312 0 4.151.501 5.719 4.457 1.59-3.968 4.464-4.447 5.726-4.447 2.54 0 5.274 1.621 5.274 5.181 0 4.069-5.136 8.625-11 14.402z"/></svg>
          Want List
          <span class="nav-badge" id="nav-wanted2" style="background:var(--accent2);color:#000">â€”</span>
        </button>
        <button class="nav-item" onclick="showPage('sold', this)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          Sold Items
          <span class="nav-badge" id="nav-sold" style="background:#9b59b6">â€”</span>
        </button>
      </div>
      <div class="nav-section">
        <div class="nav-label">Reports</div>
        <button class="nav-item" onclick="showPage('reports', this)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
          Reports
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main" id="main-content">

      <!-- â”€â”€ Dashboard â”€â”€ -->
      <script>function startWizardFor(tab){if(typeof openWizard==="function"){openWizard(tab);}else{setTimeout(function(){startWizardFor(tab);},100);}}</script>
      <div class="page active" id="page-dashboard">

        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.75rem">
          <div class="page-title">Dashboard <span id="dash-greeting"></span></div>
          <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
            <button class="btn" onclick="startWizardFor('collection')" style="display:flex;align-items:center;gap:0.4rem;font-size:0.85rem;padding:0.6rem 1rem;border:1.5px solid #e8401c;color:#e8401c;background:rgba(232,64,28,0.12);font-weight:600">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add to Collection
            </button>
            <button class="btn" onclick="startWizardFor('want')" style="display:flex;align-items:center;gap:0.4rem;font-size:0.85rem;padding:0.6rem 1rem;border:1.5px solid #2980b9;color:#2980b9;background:rgba(41,128,185,0.12);font-weight:600">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 21.593c-5.63-5.539-11-10.297-11-14.402 0-3.791 3.068-5.191 5.281-5.191 1.312 0 4.151.501 5.719 4.457 1.59-3.968 4.464-4.447 5.726-4.447 2.54 0 5.274 1.621 5.274 5.181 0 4.069-5.136 8.625-11 14.402z"/></svg>
              Want List
            </button>
            <button class="btn" onclick="startWizardFor('sold')" style="display:flex;align-items:center;gap:0.4rem;font-size:0.85rem;padding:0.6rem 1rem;border:1.5px solid #2ecc71;color:#2ecc71;background:rgba(46,204,113,0.12);font-weight:600">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
              Sell Item
            </button>
          </div>
        </div>

        <div class="stats-grid" id="stats-grid">
          <div class="stat-card" style="--accent-color: var(--green)">
            <div class="stat-label">Items I Own</div>
            <div class="stat-value" id="stat-owned">â€”</div>
            <div class="stat-sub" id="stat-owned-pct">â€” of catalog</div>
          </div>
          <div class="stat-card" style="--accent-color: var(--accent2)">
            <div class="stat-label">Collection Value</div>
            <div class="stat-value" id="stat-value">â€”</div>
            <div class="stat-sub">item+box complete</div>
          </div>
        </div>

        <div class="two-col">
          <div class="panel">
            <div class="section-title">Recent Additions</div>
            <div id="recent-list">
              <div class="empty-state"><div class="empty-icon">ðŸ“¦</div><p>No items owned yet</p></div>
            </div>
          </div>
          <div class="panel">
            <div class="section-title">Top Want List Items</div>
            <div id="want-preview">
              <div class="loading"><div class="spinner"></div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Browse â”€â”€ -->
      <div class="page" id="page-browse">
        <div class="page-title" style="display:flex;align-items:center;justify-content:space-between">
          <span>Postwar Item List</span>
          <button class="btn" onclick="startWizardFor('collection')" style="display:flex;align-items:center;gap:0.4rem;border:1.5px solid #e8401c;color:#e8401c;background:rgba(232,64,28,0.12);font-weight:600;font-size:0.85rem;padding:0.5rem 0.9rem">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
            Add to Collection
          </button>
        </div>

        <div class="filter-bar">
          <select class="filter-select" id="filter-type" onchange="applyFilters()">
            <option value="">All Types</option>
          </select>
          <select class="filter-select" id="filter-road" onchange="applyFilters()">
            <option value="">All Roads</option>
          </select>

          <span style="margin-left:auto;font-size:0.8rem;color:var(--text-dim)" id="result-count"></span>
        </div>

        <div class="table-wrap" style="max-height:calc(100vh - 220px);overflow-y:auto">
          <table class="item-table">
            <thead>
              <tr>
                <th>Item #</th>
                <th>Type</th>
                <th>Road / Name</th>
                <th>Var.</th>
                <th>Var. Descr.</th>
                <th>Year</th>
                <th>Owned</th>
                <th>Cond.</th>
                <th>Market Value</th>
              </tr>
            </thead>
            <tbody id="browse-tbody"></tbody>
          </table>
          <div id="browse-cards" style="display:none"></div>
          <div class="table-pagination">
            <span id="page-info"></span>
            <div class="pagination-btns" id="pagination-btns"></div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Sold â”€â”€ -->
      <div class="page" id="page-sold">
        <div class="page-title" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem">
          <span>Sold Items</span>
          <button class="btn" onclick="startWizardFor('sold')" style="display:flex;align-items:center;gap:0.4rem;border:1.5px solid #2ecc71;color:#2ecc71;background:rgba(46,204,113,0.12);font-weight:600;font-size:0.85rem;padding:0.5rem 0.9rem">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            Record a Sale
          </button>
        </div>
        <!-- Sold Summary Panel -->
        <div id="sold-summary-wrap" style="margin-bottom:0.85rem">
          <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap">
            <div id="sold-summary-box" style="display:flex;gap:1.25rem;background:var(--surface);border:1px solid rgba(46,204,113,0.35);border-radius:12px;padding:0.75rem 1.25rem;align-items:center">
              <div style="text-align:center">
                <div style="font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-dim);margin-bottom:2px">Items Sold</div>
                <div id="sold-stat-count" style="font-family:var(--font-head);font-size:1.6rem;color:#2ecc71;line-height:1">â€”</div>
              </div>
              <div style="width:1px;height:36px;background:var(--border)"></div>
              <div style="text-align:center">
                <div style="font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-dim);margin-bottom:2px">Total Sold For</div>
                <div id="sold-stat-total" style="font-family:var(--font-head);font-size:1.6rem;color:#2ecc71;line-height:1">â€”</div>
              </div>
            </div>
            <button id="sold-summary-toggle" onclick="toggleSoldSummary()" style="font-size:0.72rem;color:var(--text-dim);background:none;border:1px solid var(--border);border-radius:6px;padding:0.3rem 0.6rem;cursor:pointer;white-space:nowrap">Hide Summary</button>
          </div>
        </div>

        <div id="sold-cards" style="display:none;flex-direction:column;gap:0.6rem"></div>
        <div class="table-wrap" id="sold-table-wrap">
          <table class="item-table">
            <thead>
              <tr>
                <th>Item #</th>
                <th>Type</th>
                <th>Road / Name</th>
                <th>Variation</th>
                <th>Condition</th>
                <th>Sale Price</th>
                <th>Date Sold</th>
              </tr>
            </thead>
            <tbody id="sold-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- â”€â”€ Want List â”€â”€ -->
      <div class="page" id="page-want">
        <div class="page-title">Want List</div>
        <div style="display:flex;justify-content:flex-end;margin-bottom:0.75rem">
          <button class="btn btn-primary" onclick="startWizardFor('want')" style="display:flex;align-items:center;gap:0.4rem">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
            Add to Want List
          </button>
        </div>
        <div id="want-cards" style="display:flex;flex-direction:column;gap:0.6rem"></div>
        <div class="table-wrap" style="margin-top:0">
          <table class="item-table" id="want-table">
            <thead>
              <tr>
                <th>Item #</th>
                <th>Road / Name</th>
                <th>Var.</th>
                <th>Var. Description</th>
                <th>Priority</th>
                <th>Est. Price</th>
              </tr>
            </thead>
            <tbody id="want-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- â”€â”€ Reports â”€â”€ -->
      <div class="page" id="page-reports">
        <div class="page-title">Reports</div>

        <div class="report-controls">
          <select class="filter-select" id="report-type" onchange="buildReport()">
            <option value="wantlist">Want List</option>
            <option value="collection">Full Collection</option>
            <option value="value">Value Summary by Category</option>
            <option value="missing-box">Owned â€” Missing Box</option>
          </select>
          <button class="btn-export" onclick="exportReport()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export CSV
          </button>
          <button class="btn-export" onclick="window.print()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6,9 6,2 18,2 18,9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
            Print
          </button>
        </div>

        <div class="table-wrap" style="margin-top:0">
          <table class="report-table">
            <thead id="report-thead"></thead>
            <tbody id="report-tbody"></tbody>
          </table>
        </div>
      </div>

    </main>
  </div>

  <!-- Mobile nav -->
  <nav class="mobile-nav">
    <div class="mobile-nav-items">
      <button class="mobile-nav-item active" id="mnav-dashboard" onclick="showPage('dashboard', this)">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        Dashboard
      </button>
      <button class="mobile-nav-item" id="mnav-browse" onclick="showPage('browse', this); resetFilters(); renderBrowse();">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        Browse
      </button>
      <button class="mobile-nav-item mobile-add-btn" onclick="startWizardFor(null)">
        <div style="width:44px;height:44px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:-8px;box-shadow:0 4px 12px rgba(232,64,28,0.5)">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
        </div>
        Add
      </button>
      <button class="mobile-nav-item" id="mnav-want" onclick="showPage('want', this); buildWantPage();">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21.593c-5.63-5.539-11-10.297-11-14.402 0-3.791 3.068-5.191 5.281-5.191 1.312 0 4.151.501 5.719 4.457 1.59-3.968 4.464-4.447 5.726-4.447 2.54 0 5.274 1.621 5.274 5.181 0 4.069-5.136 8.625-11 14.402z"/></svg>
        Want List
      </button>
      <button class="mobile-nav-item" id="mnav-sold" onclick="showPage('sold', this)">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        Sold
      </button>
    </div>
  </nav>
</div>

<!-- â•â• ITEM DETAIL MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="item-modal" onclick="closeModalOnOverlay(event)">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-item-num" id="modal-item-num"></div>
        <div class="modal-title" id="modal-title"></div>
        <div class="modal-subtitle" id="modal-subtitle"></div>
      </div>
      <button class="btn-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">

      <!-- Box-only prompt banner -->
      <div id="box-only-prompt" style="display:none;background:rgba(245,166,35,0.1);border:1px solid var(--accent2);border-radius:10px;padding:0.85rem 1rem;display:flex;align-items:center;justify-content:space-between;gap:1rem">
        <div>
          <div style="font-weight:600;font-size:0.875rem;color:var(--accent2)">ðŸ“¦ Box without item info</div>
          <div style="font-size:0.8rem;color:var(--text-mid);margin-top:0.2rem">This entry has a box but no item details. Want to add the item info?</div>
        </div>
        <button onclick="fillItemFromBoxRow()" class="btn btn-primary" style="font-size:0.8rem;padding:0.5rem 0.9rem;white-space:nowrap">Add Item Info</button>
      </div>

      <!-- Reference Info -->
      <div>
        <div class="section-title" style="margin-bottom:0.75rem">Reference Information</div>
        <div class="info-grid">
          <div class="info-field"><label>Item Type</label><div class="info-val" id="mi-type"></div></div>
          <div class="info-field"><label>Year Produced</label><div class="info-val" id="mi-year"></div></div>
          <div class="info-field"><label>Road Name</label><div class="info-val" id="mi-road"></div></div>
          <div class="info-field"><label>Variation</label><div class="info-val" id="mi-var"></div></div>
          <div class="info-field"><label>Est. Market Value</label><div class="info-val market-val" id="mi-market"></div></div>
          <div class="info-field"><label>COTT Reference</label><div class="info-val" id="mi-ref"></div></div>
        </div>
        <div id="mi-desc-wrap" style="margin-top:0.75rem">
          <div class="desc-block" id="mi-desc"></div>
        </div>
        <div id="mi-varDesc-wrap" style="margin-top:0.5rem;display:none">
          <div style="font-size:0.68rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-dim);margin-bottom:0.3rem">Variation Notes</div>
          <div class="desc-block" id="mi-varDesc"></div>
        </div>
      </div>

      <!-- Collection Form -->
      <div>
        <div class="form-section-title" style="margin-bottom:0.75rem">Your Collection Data</div>

        <div style="margin-bottom:0.85rem">
          <label style="font-size:0.72rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-dim);display:block;margin-bottom:0.4rem">Status</label>
          <div style="display:flex;gap:0.5rem">
            <button class="status-btn" id="status-want" onclick="setStatus('Want')" style="flex:1;padding:0.5rem;border-radius:7px;border:1px solid var(--border);background:var(--surface2);color:var(--text-mid);cursor:pointer;font-family:var(--font-body);font-size:0.85rem;transition:all 0.15s">Want</button>
            <button class="status-btn" id="status-owned" onclick="setStatus('Owned')" style="flex:1;padding:0.5rem;border-radius:7px;border:1px solid var(--border);background:var(--surface2);color:var(--text-mid);cursor:pointer;font-family:var(--font-body);font-size:0.85rem;transition:all 0.15s">Owned</button>
            <button class="status-btn" id="status-sold" onclick="setStatus('Sold')" style="flex:1;padding:0.5rem;border-radius:7px;border:1px solid var(--border);background:var(--surface2);color:var(--text-mid);cursor:pointer;font-family:var(--font-body);font-size:0.85rem;transition:all 0.15s">Sold</button>
          </div>
        </div>

        <div id="sold-fields" style="display:none;margin-bottom:0.75rem">
          <div class="price-row">
            <div class="form-field">
              <label>Sale Price ($)</label>
              <input type="number" id="fc-sale-price" placeholder="0.00" min="0" step="0.01">
            </div>
            <div class="form-field">
              <label>Date Sold</label>
              <input type="date" id="fc-date-sold">
            </div>
          </div>
        </div>
        <div id="want-fields" style="display:none;margin-bottom:0.75rem">
          <div class="form-grid">
            <div class="form-field">
              <label>Priority</label>
              <select id="fc-want-priority">
                <option value="High">High</option>
                <option value="Medium" selected>Medium</option>
                <option value="Low">Low</option>
              </select>
            </div>
            <div class="form-field">
              <label>Expected Price ($)</label>
              <input type="number" id="fc-want-price" placeholder="0.00" min="0" step="0.01">
            </div>
          </div>
          <div class="form-field full" style="margin-top:0.5rem">
            <label>Notes</label>
            <input type="text" id="fc-want-notes" placeholder="Why you want it, where to find itâ€¦">
          </div>
        </div>
        <div id="collection-form" style="display:none">
          <div class="form-grid">
            <div class="form-field">
              <label>Copy #</label>
              <select id="fc-copy">
                <option value="1">1</option><option value="2">2</option>
                <option value="3">3</option><option value="4">4</option><option value="5">5</option>
              </select>
            </div>
            <div class="form-field">
              <label>All Original?</label>
              <select id="fc-original">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
                <option value="Unknown">Unknown</option>
              </select>
            </div>
          </div>

          <div class="form-field" style="margin-top:0.75rem">
            <label>Condition (1â€“10)</label>
            <div class="condition-display">
              <div class="condition-num" id="cond-display">7</div>
              <input type="range" min="1" max="10" value="7" id="fc-condition" oninput="document.getElementById('cond-display').textContent=this.value">
            </div>
          </div>

          <div class="price-row" style="margin-top:0.75rem">
            <div class="form-field">
              <label>Item Only Price ($)</label>
              <input type="number" id="fc-price-item" placeholder="0.00" min="0" step="0.01">
            </div>
            <div class="form-field">
              <label>Box Only Price ($)</label>
              <input type="number" id="fc-price-box" placeholder="0.00" min="0" step="0.01">
            </div>
            <div class="form-field">
              <label>Item+Box Complete ($)</label>
              <input type="number" id="fc-price-complete" placeholder="0.00" min="0" step="0.01">
            </div>
          </div>

          <div class="form-grid" style="margin-top:0.75rem">
            <div class="form-field">
              <label>Has Box?</label>
              <select id="fc-has-box">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="form-field">
              <label>Box Condition (1â€“10)</label>
              <input type="number" id="fc-box-cond" min="1" max="10" placeholder="â€”">
            </div>
          </div>

          <div class="form-field full" style="margin-top:0.75rem">
            <label>Item Photo Link (Google Photos)</label>
            <input type="url" id="fc-photo-item" placeholder="https://photos.google.com/â€¦">
          </div>
          <div class="form-field full" style="margin-top:0.5rem">
            <label>Box Photo Link (Google Photos)</label>
            <input type="url" id="fc-photo-box" placeholder="https://photos.google.com/â€¦">
          </div>
          <div class="form-field full" style="margin-top:0.5rem">
            <label>Notes</label>
            <textarea id="fc-notes" placeholder="Any personal notes about this itemâ€¦"></textarea>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveItem()">Save to Collection</button>
    </div>
  </div>
</div>

<!-- â•â• SOLD MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="sold-modal" onclick="closeSoldModalOnOverlay(event)">
  <div class="modal" style="max-width:420px">
    <div class="modal-header">
      <div>
        <div class="modal-title">Mark as Sold?</div>
        <div class="modal-subtitle" id="sold-modal-subtitle"></div>
      </div>
      <button class="btn-close" onclick="closeSoldModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-field">
        <label>Sale Price ($)</label>
        <input type="number" id="sold-price" placeholder="0.00" min="0" step="0.01">
      </div>
      <div class="form-field" style="margin-top:0.75rem">
        <label>Date Sold</label>
        <input type="date" id="sold-date">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeSoldModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmSold()">Mark as Sold</button>
    </div>
  </div>
</div>


<!-- â•â• ADD ITEM WIZARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="wizard-modal" onclick="closeWizardOnOverlay(event)">
  <div class="modal" style="max-width:520px;height:580px;display:flex;flex-direction:column;overflow:hidden">
    <div class="modal-header">
      <div>
        <div class="modal-item-num" id="wizard-step-label"></div>
        <div class="modal-title" id="wizard-title"></div>
      </div>
      <button class="btn-close" onclick="closeWizard()">âœ•</button>
    </div>

    <!-- Progress bar -->
    <div style="padding:0 1.5rem;padding-top:0.75rem">
      <div style="background:var(--border);border-radius:4px;height:4px">
        <div id="wizard-progress" style="height:100%;border-radius:4px;background:var(--accent);transition:width 0.3s ease;width:0%"></div>
      </div>
    </div>

    <div class="modal-body" id="wizard-body" style="flex:1;overflow-y:auto;min-height:0">
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" id="wizard-back-btn" onclick="wizardBack()" style="display:none">â† Back</button>
      <button class="btn btn-secondary" onclick="closeWizard()">Cancel</button>
      <button class="btn btn-primary" id="wizard-next-btn" onclick="wizardNext()">Next â†’</button>
    </div>
  </div>
</div>

<!-- â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Replace with your actual Google OAuth Client ID after setup
const CLIENT_ID = '161569968813-vrhet7p68vkthkunare60nqr34li5uuh.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';
const API_KEY = 'AIzaSyBjwyQ7qvqrH0goUVidOO0Da9hVQWOzvI8'; // Replace with your Google Cloud API key
const PERSONAL_SHEET_NAME = 'Lionel Vault â€” My Collection';
const PERSONAL_HEADERS = [
  'Item Number','Variation','Condition (1-10)','All Original',
  'Item Only Price','Box Only Price','Item+Box Complete','Has Box',
  'Box Condition (1-10)','Item Photo Link','Box Photo Link','Notes',
  'Date Purchased','User Est. Worth','Matched Tender/Engine','Set ID','Year Made'
];
const SOLD_HEADERS = [
  'Item Number','Variation','Copy #','Condition (1-10)','Item Only Price Paid',
  'Sale Price','Date Sold','Notes'
];
const WANT_HEADERS = [
  'Item Number','Variation','Priority','Expected Price','Notes'
];

// â”€â”€ TENDER / LOCOMOTIVE RELATIONSHIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TENDER_TO_LOCOS = {"1872T":["1872"],"1882T":["1882"],"2020W":["2020"],"2046W":["726RR","637","646","2056","675","736","2055","2046","2065","665"],"2046WX":["671RR","682","681"],"2426W":["773","726"],"2466T":["224","1666"],"2466W":["224","1666"],"2466WX":["675","224","1666"],"2671W":["681","671"],"4424W":["671R"],"4671W":["671R"],"6001T":["6110"],"6020W":["2020"],"6026T":["2018","2037"],"6026W":["2037","685","2055","2018","2065","665","2016"],"6066T":["2026","1130","2034","2037"],"6403B":["1656"],"6466W":["2026","2036","2025","2035"],"6466WX":["2026","2025","675"],"6654T":["1655"],"250T":["250","249"],"671W":["671"],"736W":["637","665","773","736"],"746W":["746"],"773W":["773"],"1001T":["1101","1120","1001","1110"],"1050T":["235","1060","1050","236"],"1060T":["237","242","1060","2029","1062","1061"],"1130T":["244","248","236","245","2037","2018","1130","235","246"],"1130T-500":["2037-500"],"1625T":["1625"],"1654T":["1654"],"1654W":["1654"],"1862T":["1862"]};
const LOCO_TO_TENDERS = {"1872":["1872T"],"1882":["1882T"],"2020":["2020W","6020W"],"726RR":["2046W"],"637":["2046W","736W"],"646":["2046W"],"2056":["2046W"],"675":["2046W","2466WX","6466WX"],"736":["2046W","736W"],"2055":["2046W","6026W"],"2046":["2046W"],"2065":["2046W","6026W"],"665":["2046W","6026W","736W"],"671RR":["2046WX"],"682":["2046WX"],"681":["2046WX","2671W"],"773":["2426W","736W","773W"],"726":["2426W"],"224":["2466T","2466W","2466WX"],"1666":["2466T","2466W","2466WX"],"671":["2671W","671W"],"671R":["4424W","4671W"],"6110":["6001T"],"2018":["6026T","6026W","1130T"],"2037":["6026T","6026W","6066T","1130T"],"685":["6026W"],"2016":["6026W"],"2026":["6066T","6466W","6466WX"],"1130":["6066T","1130T"],"2034":["6066T"],"1656":["6403B"],"2036":["6466W"],"2025":["6466W","6466WX"],"2035":["6466W"],"1655":["6654T"],"250":["250T"],"249":["250T"],"746":["746W"],"1101":["1001T"],"1120":["1001T"],"1001":["1001T"],"1110":["1001T"],"235":["1050T","1130T"],"1060":["1050T","1060T"],"1050":["1050T"],"236":["1050T","1130T"],"237":["1060T"],"242":["1060T"],"2029":["1060T"],"1062":["1060T"],"1061":["1060T"],"244":["1130T"],"248":["1130T"],"245":["1130T"],"246":["1130T"],"2037-500":["1130T-500"],"1625":["1625T"],"1654":["1654T","1654W"],"1862":["1862T"]};

// â”€â”€ DIESEL SET HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isSetUnit(itemNum) {
  const num = normalizeItemNum(itemNum);
  if (num.endsWith('C')) return true;
  return state.masterData.some(m => normalizeItemNum(m.itemNum) === num + 'C');
}
function getBUnit(itemNum) {
  const num = normalizeItemNum(itemNum);
  const bNum = num + 'C';
  return state.masterData.some(m => normalizeItemNum(m.itemNum) === bNum) ? bNum : null;
}
function getAUnit(itemNum) {
  const num = normalizeItemNum(itemNum);
  if (!num.endsWith('C')) return null;
  const aNum = num.slice(0, -1);
  return state.masterData.some(m => normalizeItemNum(m.itemNum) === aNum) ? aNum : null;
}
function getSetPartner(itemNum) {
  const num = normalizeItemNum(itemNum);
  if (num.endsWith('C')) return getAUnit(num);
  return getBUnit(num);
}
function normalizeItemNum(n) {
  // Strip trailing .0 from numbers stored as floats e.g. "2343.0" -> "2343"
  const s = (n || '').toString().trim();
  return s.match(/^\d+\.0$/) ? s.slice(0, -2) : s;
}
function isF3AlcoUnit(itemNum) {
  const num = normalizeItemNum(itemNum).replace(/C$/i, '');
  return state.masterData.some(m =>
    normalizeItemNum(m.itemNum) === num &&
    m.itemType === 'Diesel Locomotive' &&
    (m.description || '').match(/F-3|F3|Alco FA|FA No\.|FA-/)
  );
}
function genSetId(baseNum) {
  return 'SET-' + baseNum + '-' + Date.now();
}

function isTender(itemNum) { return !!TENDER_TO_LOCOS[itemNum?.toString().trim().toUpperCase()] || !!TENDER_TO_LOCOS[itemNum?.toString().trim()]; }
function isLocomotive(itemNum) { return !!LOCO_TO_TENDERS[itemNum?.toString().trim()]; }
function getMatchingTenders(itemNum) { return LOCO_TO_TENDERS[itemNum?.toString().trim()] || []; }
function getMatchingLocos(tenderNum) { return TENDER_TO_LOCOS[tenderNum?.toString().trim()] || []; }

function findOwnedMatch(itemNum) {
  // Given an item number, find if the user owns the matching tender or engine
  const tenders = getMatchingTenders(itemNum);
  const locos   = getMatchingLocos(itemNum);
  const candidates = [...tenders, ...locos];
  for (const num of candidates) {
    const owned = Object.values(state.personalData).find(pd => pd.itemNum === num);
    if (owned) return { itemNum: num, pd: owned };
  }
  return null;
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = {
  user: null,
  masterSheetId: null,
  personalSheetId: null,
  masterData: [],      // all rows from master sheet
  personalData: {},    // keyed by "itemNum|variation" -> personal row (owned items)
  soldData: {},        // keyed by "itemNum|variation" -> sold row
  wantData: {},        // keyed by "itemNum|variation" -> want list row
  filteredData: [],
  currentPage: 1,
  pageSize: 50,
  filters: { owned: false, unowned: false, boxed: false, wantList: false, type: '', road: '', search: '' },
  currentItem: null,
};

// â”€â”€ GOOGLE IDENTITY / AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tokenClient;

function initGoogle() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: onTokenReceived,
  });

  // Check for existing session â€” master ID is hardcoded, just need saved user
  const savedUser = localStorage.getItem('lv_user');
  const savedPersonalId = localStorage.getItem('lv_personal_id');
  state.masterSheetId = '1cLmCcI4Ekao2gn-TntAGjhsPrIYe39-cX6rV1WAyDCM';
  localStorage.setItem('lv_master_id', state.masterSheetId);

  if (savedUser) {
    state.user = JSON.parse(savedUser);
    state.personalSheetId = savedPersonalId;
    showApp();
    showLoading(); // show spinner â€” onTokenReceived will call loadAllData once token is ready
    const savedEmail = state.user?.email || '';
    tokenClient.requestAccessToken({ prompt: '', login_hint: savedEmail });
  }
}

function handleSignIn() {
  tokenClient.requestAccessToken({ prompt: 'consent' });
}

function onGoogleSignIn(response) {
  const payload = parseJwt(response.credential);
  state.user = { name: payload.given_name, email: payload.email, picture: payload.picture };
  localStorage.setItem('lv_user', JSON.stringify(state.user));
}

let accessToken = null;

function onTokenReceived(resp) {
  if (resp.error) {
    console.error('Token error:', resp);
    // If silent token refresh failed, prompt user to sign in again
    if (resp.error === 'interaction_required' || resp.error === 'login_required') {
      const hint = state.user?.email || '';
      tokenClient.requestAccessToken({ prompt: 'consent', login_hint: hint });
    }
    return;
  }
  accessToken = resp.access_token;
  // Auto-refresh token before it expires (tokens last 1 hour)
  setTimeout(() => {
    if (accessToken) {
      const hint = state.user?.email || '';
      tokenClient.requestAccessToken({ prompt: '', login_hint: hint });
    }
  }, 55 * 60 * 1000);

  // Fetch user info from Google if we don't have it yet
  if (!state.user) {
    fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
      headers: { Authorization: 'Bearer ' + accessToken }
    })
    .then(r => r.json())
    .then(info => {
      state.user = { name: info.given_name || info.name || 'User', email: info.email };
      localStorage.setItem('lv_user', JSON.stringify(state.user));
      updateUserUI();
    });
  } else {
    updateUserUI();
  }

  // Master sheet is hardcoded
  state.masterSheetId = '1cLmCcI4Ekao2gn-TntAGjhsPrIYe39-cX6rV1WAyDCM';
  localStorage.setItem('lv_master_id', state.masterSheetId);

  // Always sync from Drive config to ensure correct sheet ID across devices
  driveReadConfig().then(config => {
    if (config && config.personalSheetId) {
      // Always use Drive config as source of truth
      state.personalSheetId = config.personalSheetId;
      localStorage.setItem('lv_personal_id', config.personalSheetId);
      if (config.vaultId)      { driveCache.vaultId = config.vaultId;           localStorage.setItem('lv_vault_id', config.vaultId); }
      if (config.photosId)     { driveCache.photosId = config.photosId;         localStorage.setItem('lv_photos_id', config.photosId); }
      if (config.soldPhotosId) { driveCache.soldPhotosId = config.soldPhotosId; localStorage.setItem('lv_sold_photos_id', config.soldPhotosId); }
      loadAllData();
    } else {
      // No config yet â€” check localStorage then create if needed
      state.personalSheetId = localStorage.getItem('lv_personal_id');
      if (!state.personalSheetId) {
        createPersonalSheet().then(loadAllData);
      } else {
        driveEnsureSetup().catch(e => console.warn('Drive setup:', e));
        loadAllData();
      }
    }
  }).catch(() => {
    // Drive read failed â€” fall back to localStorage
    state.personalSheetId = localStorage.getItem('lv_personal_id');
    if (!state.personalSheetId) {
      createPersonalSheet().then(loadAllData);
    } else {
      loadAllData();
    }
  });
}

function handleSignOut() {
  google.accounts.oauth2.revoke(localStorage.getItem('lv_token'), () => {});
  localStorage.removeItem('lv_user');
  localStorage.removeItem('lv_token');
  state.user = null;
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('app').classList.remove('active');
}

function showApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('setup-screen').classList.remove('active');
  document.getElementById('app').classList.add('active');
  updateUserUI();
  const hr = new Date().getHours();
  document.getElementById('dash-greeting').textContent =
    hr < 12 ? 'Good morning' : hr < 17 ? 'Good afternoon' : 'Good evening';
}

function showSetup() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').classList.remove('active');
  document.getElementById('setup-screen').classList.add('active');
}

function updateUserUI() {
  if (!state.user) return;
  document.getElementById('user-name').textContent = state.user.name;
  document.getElementById('user-avatar').textContent = state.user.name[0].toUpperCase();
}

async function completeSetup() {
  let rawMaster = document.getElementById('master-sheet-input').value.trim();
  let rawPersonal = document.getElementById('personal-sheet-input').value.trim();
  if (!rawMaster) { alert('Please enter the Master Sheet ID.'); return; }
  if (!rawPersonal) { alert('Please enter your Personal Collection Sheet ID.'); return; }

  // Extract IDs if full URLs were pasted
  const masterMatch = rawMaster.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
  const personalMatch = rawPersonal.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
  const masterId = masterMatch ? masterMatch[1] : rawMaster;
  const personalId = personalMatch ? personalMatch[1] : rawPersonal;

  state.masterSheetId = masterId;
  state.personalSheetId = personalId;
  localStorage.setItem('lv_master_id', masterId);
  localStorage.setItem('lv_personal_id', personalId);

  // Initialize personal sheet headers
  try {
    await initPersonalSheet(personalId);
    showApp();
    loadAllData();
  } catch(e) {
    console.error('Setup error:', e);
    alert('Error connecting to your personal sheet: ' + e.message + '\n\nMake sure the sheet exists and you are signed in with the account that owns it.');
  }
}

async function initPersonalSheet(sheetId) {
  // Write My Collection title + headers if empty
  const res = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/My%20Collection!A1:M2`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  );
  const data = await res.json();
  const rows = data.values || [];
  if (rows.length === 0 || !rows[0] || rows[0].length === 0) {
    // Brand new sheet â€” write title row 1 and headers row 2
    await sheetsUpdate(sheetId, 'My Collection!A1:A1', [['My Collection']]);
    await sheetsUpdate(sheetId, 'My Collection!A2:Q2', [PERSONAL_HEADERS]);
  } else if (rows.length === 1 || !rows[1] || rows[1].length < 13) {
    // Has title but missing/old headers â€” rewrite row 2
    await sheetsUpdate(sheetId, 'My Collection!A2:Q2', [PERSONAL_HEADERS]);
  }
  // Get existing sheet tab names
  const metaRes = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?fields=sheets.properties.title`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  );
  const meta = await metaRes.json();
  const existingTabs = (meta.sheets || []).map(s => s.properties.title);

  // Build list of tabs to create
  const toCreate = [];
  if (!existingTabs.includes('Sold'))      toCreate.push({ addSheet: { properties: { title: 'Sold' } } });
  if (!existingTabs.includes('Want List')) toCreate.push({ addSheet: { properties: { title: 'Want List' } } });

  if (toCreate.length > 0) {
    await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}:batchUpdate`, {
      method: 'POST',
      headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ requests: toCreate }),
    });
  }

  // Write headers to all tabs
  await sheetsUpdate(sheetId, 'Sold!A1:A1',      [['Sold']]);
  await sheetsUpdate(sheetId, 'Sold!A2:H2',      [SOLD_HEADERS]);
  await sheetsUpdate(sheetId, 'Want List!A1:A1', [['Want List']]);
  await sheetsUpdate(sheetId, 'Want List!A2:E2', [WANT_HEADERS]);
}


// â”€â”€ GOOGLE DRIVE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const ITEM_VIEWS = [
  { key: 'RSV', label: 'Right Side View', abbr: 'RSV' },
  { key: 'TV',  label: 'Top View',        abbr: 'TV'  },
  { key: 'BV',  label: 'Bottom View',     abbr: 'BV'  },
  { key: 'BKV', label: 'Back View',       abbr: 'BKV' },
  { key: 'FV',  label: 'Front View',      abbr: 'FV'  },
  { key: 'LSV', label: 'Left Side View',  abbr: 'LSV' },
];
const BOX_VIEWS = [
  { key: 'BOX-RSV', label: 'Box Right Side', abbr: 'BOX-RSV' },
  { key: 'BOX-TV',  label: 'Box Top',        abbr: 'BOX-TV'  },
  { key: 'BOX-BV',  label: 'Box Bottom',     abbr: 'BOX-BV'  },
  { key: 'BOX-BKV', label: 'Box Back',       abbr: 'BOX-BKV' },
  { key: 'BOX-FV',  label: 'Box Front',      abbr: 'BOX-FV'  },
  { key: 'BOX-LSV', label: 'Box Left Side',  abbr: 'BOX-LSV' },
];

// Folder structure:
//  Lionel Vault - My Collection/         (vault root â€” stores sheet + photo subfolders)
//    My Collection Photos/               (item photo folders)
//      726/
//        726 FV.jpg, 726 RSV.jpg ...
//    My Sold Collection Photos/          (sold item photo folders â€” moved here on sale)

const driveCache = {
  vaultId: null,       // "Lionel Vault - My Collection" root
  photosId: null,      // "My Collection Photos"
  soldPhotosId: null,  // "My Sold Collection Photos"
  itemFolders: {},     // itemNum -> folderId
};

async function driveRequest(method, endpoint, body) {
  const res = await fetch('https://www.googleapis.com/drive/v3' + endpoint, {
    method,
    headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
    body: body !== undefined ? JSON.stringify(body) : undefined,
  });
  return res.json();
}

async function driveUploadFile(file, name, folderId) {
  const metadata = { name, parents: [folderId], mimeType: file.type };
  const form = new FormData();
  form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
  form.append('file', file);
  const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink,webContentLink', {
    method: 'POST',
    headers: { Authorization: 'Bearer ' + accessToken },
    body: form,
  });
  return res.json();
}

async function driveFindOrCreateFolder(name, parentId) {
  const q = encodeURIComponent(`name='${name}' and mimeType='application/vnd.google-apps.folder' and '${parentId}' in parents and trashed=false`);
  const res = await driveRequest('GET', `/files?q=${q}&fields=files(id,name)&spaces=drive`);
  if (res.files && res.files.length > 0) return res.files[0].id;
  const created = await driveRequest('POST', '/files?fields=id', {
    name, mimeType: 'application/vnd.google-apps.folder', parents: [parentId],
  });
  return created.id;
}

async function driveMoveFileToFolder(fileId, fromFolderId, toFolderId) {
  await driveRequest('PATCH', `/files/${fileId}?addParents=${toFolderId}&removeParents=${fromFolderId}&fields=id`, {});
}

// Called once on first run â€” creates the full vault folder structure
async function driveSetupVault() {
  // Find or create root vault folder
  const rootRes = await driveRequest('GET', '/files/root?fields=id');
  const rootId = rootRes.id;
  driveCache.vaultId = await driveFindOrCreateFolder('Lionel Vault - My Collection', rootId);
  localStorage.setItem('lv_vault_id', driveCache.vaultId);

  // Find or create both photo subfolders (always, so nothing is missing)
  driveCache.photosId     = await driveFindOrCreateFolder('My Collection Photos',      driveCache.vaultId);
  driveCache.soldPhotosId = await driveFindOrCreateFolder('My Sold Collection Photos', driveCache.vaultId);
  localStorage.setItem('lv_photos_id',      driveCache.photosId);
  localStorage.setItem('lv_sold_photos_id', driveCache.soldPhotosId);

  // Move the personal sheet into the vault folder if we have its ID
  const sheetId = localStorage.getItem('lv_personal_id');
  if (sheetId) {
    try { await driveMoveSheetToVault(sheetId); } catch(e) { console.warn('Sheet move:', e); }
  }

  // Save config so other devices can discover these IDs
  if (state.personalSheetId) {
    driveWriteConfig({
      personalSheetId: state.personalSheetId,
      vaultId: driveCache.vaultId,
      photosId: driveCache.photosId,
      soldPhotosId: driveCache.soldPhotosId,
    }).catch(e => console.warn('Config write:', e));
  }
  console.log('Vault ready:', driveCache.vaultId, '| Photos:', driveCache.photosId, '| Sold:', driveCache.soldPhotosId);
  return driveCache.vaultId;
}

async function driveEnsureSetup() {
  if (driveCache.vaultId && driveCache.photosId && driveCache.soldPhotosId) return;
  // Try from localStorage first (fast path)
  const vId = localStorage.getItem('lv_vault_id');
  const pId = localStorage.getItem('lv_photos_id');
  const sId = localStorage.getItem('lv_sold_photos_id');
  if (vId && pId && sId) {
    driveCache.vaultId      = vId;
    driveCache.photosId     = pId;
    driveCache.soldPhotosId = sId;
  } else {
    // Always run full setup so any missing folders get created
    await driveSetupVault();
  }
}

async function driveEnsureItemFolder(itemNum) {
  await driveEnsureSetup();
  const key = String(itemNum);
  if (driveCache.itemFolders[key]) return driveCache.itemFolders[key];
  const folderId = await driveFindOrCreateFolder(key, driveCache.photosId);
  driveCache.itemFolders[key] = folderId;
  return folderId;
}

async function driveGetFolderPhotos(folderLink) {
  const match = (folderLink || '').match(/folders\/([a-zA-Z0-9_-]+)/);
  if (!match) return null; // null = folder link bad
  const folderId = match[1];
  if (!accessToken) return null; // null = not ready
  try {
    const q = encodeURIComponent(`'${folderId}' in parents and mimeType contains 'image/' and trashed=false`);
    const res = await driveRequest('GET', `/files?q=${q}&fields=files(id,name)&orderBy=name`);
    if (res.error) { console.warn('Drive photo fetch error:', res.error); return null; }
    return (res.files || []).map(function(f) {
      return {
        id: f.id,
        name: f.name,
        thumb: 'https://drive.google.com/thumbnail?id=' + f.id + '&sz=w240',
        view:  'https://drive.google.com/file/d/' + f.id + '/view',
      };
    });
  } catch(e) { console.error('driveGetFolderPhotos:', e); return null; }
}

function driveFolderLink(folderId) {
  return `https://drive.google.com/drive/folders/${folderId}`;
}

async function driveUploadItemPhoto(file, itemNum, viewAbbr) {
  await driveEnsureSetup();
  const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
  const fileName = `${itemNum} ${viewAbbr}.${ext}`;
  const folderId = await driveEnsureItemFolder(itemNum);
  await driveUploadFile(file, fileName, folderId);
  // Return folder link (not individual photo link)
  return driveFolderLink(folderId);
}

async function driveMoveToSold(itemNum) {
  await driveEnsureSetup();
  const key = String(itemNum);
  // Find item folder in My Collection Photos
  const q = encodeURIComponent(`name='${key}' and mimeType='application/vnd.google-apps.folder' and '${driveCache.photosId}' in parents and trashed=false`);
  const res = await driveRequest('GET', `/files?q=${q}&fields=files(id)`);
  if (res.files && res.files.length > 0) {
    const fId = res.files[0].id;
    await driveMoveFileToFolder(fId, driveCache.photosId, driveCache.soldPhotosId);
    delete driveCache.itemFolders[key];
  }
}

// â”€â”€ DRIVE CONFIG FILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Stores personalSheetId in a small JSON file in Drive root
// so any device can find the right sheet after signing in

const CONFIG_FILENAME = 'lionel-vault-config.json';

async function driveReadConfig() {
  try {
    // Search for config file in Drive root
    const q = encodeURIComponent(`name='${CONFIG_FILENAME}' and trashed=false`);
    const res = await driveRequest('GET', `/files?q=${q}&fields=files(id,name)&spaces=drive`);
    if (!res.files || res.files.length === 0) return null;
    // Read file contents
    const fileId = res.files[0].id;
    const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
      headers: { Authorization: 'Bearer ' + accessToken }
    });
    return await r.json();
  } catch(e) { console.warn('driveReadConfig error:', e); return null; }
}

async function driveWriteConfig(data) {
  try {
    const json = JSON.stringify(data);
    const blob = new Blob([json], { type: 'application/json' });
    // Check if file already exists
    const q = encodeURIComponent(`name='${CONFIG_FILENAME}' and trashed=false`);
    const res = await driveRequest('GET', `/files?q=${q}&fields=files(id)&spaces=drive`);
    if (res.files && res.files.length > 0) {
      // Update existing file
      const fileId = res.files[0].id;
      await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
        method: 'PATCH',
        headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
        body: blob,
      });
    } else {
      // Create new file
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify({ name: CONFIG_FILENAME, mimeType: 'application/json' })], { type: 'application/json' }));
      form.append('file', blob);
      await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + accessToken },
        body: form,
      });
    }
  } catch(e) { console.warn('driveWriteConfig error:', e); }
}

// Move sheet into vault folder after creation
async function driveMoveSheetToVault(sheetId) {
  await driveEnsureSetup();
  // Get current parents of the sheet file
  const meta = await driveRequest('GET', `/files/${sheetId}?fields=parents`);
  const currentParents = (meta.parents || []).join(',');
  await fetch(`https://www.googleapis.com/drive/v3/files/${sheetId}?addParents=${driveCache.vaultId}&removeParents=${currentParents}&fields=id`, {
    method: 'PATCH',
    headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
    body: JSON.stringify({}),
  });
}

// â”€â”€ SHEETS API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sheetsGet(spreadsheetId, range) {
  // Use API key for master sheet (public), OAuth token for personal sheet
  const isMaster = spreadsheetId === state.masterSheetId;
  const url = isMaster && API_KEY !== 'YOUR_API_KEY'
    ? `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}?key=${API_KEY}`
    : `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}`;
  const headers = isMaster && API_KEY !== 'YOUR_API_KEY'
    ? {}
    : { Authorization: `Bearer ${accessToken}` };
  const res = await fetch(url, { headers });
  return res.json();
}

async function sheetsUpdate(spreadsheetId, range, values) {
  const res = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}?valueInputOption=USER_ENTERED`,
    {
      method: 'PUT',
      headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ range, majorDimension: 'ROWS', values }),
    }
  );
  return res.json();
}

async function sheetsAppend(spreadsheetId, range, values) {
  const res = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`,
    {
      method: 'POST',
      headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ values }),
    }
  );
  const result = await res.json();
  console.log('sheetsAppend result:', JSON.stringify(result));
  return result;
}

async function sheetsDeleteRow(spreadsheetId, sheetName, rowNumber) {
  // First get the sheetId (numeric) for the named tab
  const metaRes = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?fields=sheets.properties`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  );
  const meta = await metaRes.json();
  const sheet = meta.sheets.find(s => s.properties.title === sheetName);
  if (!sheet) return;
  const sheetId = sheet.properties.sheetId;

  // Delete the row (0-indexed, startIndex = rowNumber-1)
  await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`, {
    method: 'POST',
    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({
      requests: [{
        deleteDimension: {
          range: {
            sheetId,
            dimension: 'ROWS',
            startIndex: rowNumber - 1,
            endIndex: rowNumber
          }
        }
      }]
    })
  });
}

async function createPersonalSheet() {
  // 1. Set up Drive vault folders first
  await driveSetupVault();

  // 2. Create new spreadsheet
  const res = await fetch('https://sheets.googleapis.com/v4/spreadsheets', {
    method: 'POST',
    headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({
      properties: { title: PERSONAL_SHEET_NAME },
      sheets: [{ properties: { title: 'My Collection' } }]
    })
  });
  const data = await res.json();
  state.personalSheetId = data.spreadsheetId;
  localStorage.setItem('lv_personal_id', state.personalSheetId);

  // 3. Write headers and create all tabs
  await sheetsUpdate(state.personalSheetId, 'My Collection!A1:A1', [['My Collection']]);
  await sheetsUpdate(state.personalSheetId, 'My Collection!A2:Q2', [PERSONAL_HEADERS]);
  await initPersonalSheet(state.personalSheetId);

  // 4. Move the sheet file into the vault folder
  try { await driveMoveSheetToVault(state.personalSheetId); } catch(e) { console.warn('Could not move sheet to vault:', e); }

  // 5. Write config to Drive so other devices can find this sheet
  await driveWriteConfig({
    personalSheetId: state.personalSheetId,
    vaultId: driveCache.vaultId,
    photosId: driveCache.photosId,
    soldPhotosId: driveCache.soldPhotosId,
  });

  return state.personalSheetId;
}

// â”€â”€ LOAD DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAllData() {
  showLoading();
  try {
    await loadMasterData();
    await loadPersonalData();
    buildApp();

  } catch(e) {
    console.error('Load error:', e.message, e.stack);
    showToast('Error loading data: ' + e.message);
    document.getElementById('browse-tbody').innerHTML =
      '<tr><td colspan="8" style="padding:2rem;color:var(--red);text-align:center">Error loading data: ' + e.message + '<br><small>Pull down to refresh</small></td></tr>';
  }
}

async function loadMasterData() {
  // Try 'Master Inventory' tab first, fall back to 'Sheet1' if renamed during import
  let res = await sheetsGet(state.masterSheetId, 'Master Inventory!A3:O');
  if (!res.values) {
    res = await sheetsGet(state.masterSheetId, 'Sheet1!A3:O');
  }
  const rows = res.values || [];
  state.masterData = rows.map(r => ({
    itemNum:    r[0]  || '',
    itemType:   r[1]  || '',
    subType:    r[2]  || '',
    wheelArr:   r[3]  || '',
    tenderNum:  r[4]  || '',
    roadName:   r[5]  || '',
    description:r[6]  || '',
    yearProd:   r[7]  || '',
    variation:  r[8]  || '',
    varDesc:    r[9]  || '',
    refLink:    r[10] || '',
    ebayAvg:    r[11] || '',
    ebaySample: r[12] || '',
    ebayUpdated:r[13] || '',
    marketVal:  r[14] || '',
  }));
}

async function loadPersonalData() {
  // Always try localStorage as fallback in case state wasn't set yet (mobile timing)
  if (!state.personalSheetId) {
    state.personalSheetId = localStorage.getItem('lv_personal_id');
  }
  if (!state.personalSheetId) return;
  state.personalData = {};
  state.soldData = {};
  state.wantData = {};

  // Load My Collection tab
  try {
  const res = await sheetsGet(state.personalSheetId, 'My Collection!A3:Q');
  console.log('My Collection raw response:', JSON.stringify(res).substring(0, 200));
  const rows = res.values || [];
  console.log('My Collection rows loaded:', rows.length, '| first row:', rows[0]);
  rows.forEach((r, idx) => {
    if (!r[0] || r[0] === 'Item Number') return; // skip header row if present
    const rowNum = idx + 3;
    const key = `${r[0]}|${r[1] || ''}|${rowNum}`;
    state.personalData[key] = {
      row:          rowNum,
      itemNum:      r[0]  || '',
      variation:    r[1]  || '',
      status:       'Owned',
      owned:        true,
      condition:    r[2]  || '',
      allOriginal:  r[3]  || '',
      priceItem:    r[4]  || '',
      priceBox:     r[5]  || '',
      priceComplete:r[6]  || '',
      hasBox:       r[7]  || '',
      boxCond:      r[8]  || '',
      photoItem:    r[9]  || '',
      photoBox:     r[10] || '',
      notes:        r[11] || '',
      datePurchased:r[12] || '',
      userEstWorth: r[13] || '',
      matchedTo:    r[14] || '',
      setId:        r[15] || '',
      yearMade:     r[16] || '',
    };
  });
  } catch(e) { console.error('My Collection load error:', e); }

  // Load Sold tab
  try {
    const soldRes = await sheetsGet(state.personalSheetId, 'Sold!A3:H').catch(() => ({values:[]}));
    const soldRows = soldRes.values || [];
    console.log('Sold rows loaded:', soldRows.length);
    soldRows.forEach((r, idx) => {
      if (!r[0] || r[0] === 'Item Number') return; // skip header row if present
      const key = `${r[0]}|${r[1] || ''}`;
      state.soldData[key] = {
        row:       idx + 3,
        itemNum:   r[0] || '',
        variation: r[1] || '',
        copy:      r[2] || '1',
        condition: r[3] || '',
        priceItem: r[4] || '',
        salePrice: r[5] || '',
        dateSold:  r[6] || '',
        notes:     r[7] || '',
      };
    });
  } catch(e) { console.log('Sold tab error:', e); }

  // Load Want List tab
  try {
    const wantRes = await sheetsGet(state.personalSheetId, 'Want List!A3:E').catch(() => ({values:[]}));
    const wantRows = wantRes.values || [];
    console.log('Want rows loaded:', wantRows.length);
    wantRows.forEach((r, idx) => {
      if (!r[0] || r[0] === 'Item Number') return; // skip header row if present
      const key = `${r[0]}|${r[1] || ''}`;
      state.wantData[key] = {
        row:           idx + 3,
        itemNum:       r[0] || '',
        variation:     r[1] || '',
        priority:      r[2] || 'Medium',
        expectedPrice: r[3] || '',
        notes:         r[4] || '',
      };
    });
  } catch(e) { console.log('Want List tab error:', e); }
}

// â”€â”€ BUILD APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildApp() {
  showApp();
  populateFilters();
  buildDashboard();
  buildBrowse();
  buildSoldPage();
  buildWantPage();
  buildReport();
}

function showLoading() {
  document.getElementById('browse-tbody').innerHTML = '<tr><td colspan="8"><div class="loading"><div class="spinner"></div><span>Loading inventoryâ€¦</span></div></td></tr>';
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function buildDashboard() {
  const total = state.masterData.length;

  // Count ALL owned entries including box-only rows
  const allOwned = Object.values(state.personalData).filter(pd => {
    if (!pd.owned) return false;
    // Exclude pure box-only rows (has box but NO item condition AND NO item price)
    const condVal = pd.condition?.toString().trim();
    const priceVal = pd.priceItem?.toString().trim();
    const noCondition = !condVal || condVal === '' || condVal === 'N/A';
    const noItemPrice = !priceVal || priceVal === '' || priceVal === 'N/A';
    const isBoxOnly = pd.hasBox === 'Yes' && noCondition && noItemPrice;
    return !isBoxOnly; // count everything except pure box-only rows
  });
  const owned = allOwned.length;
  const pct = total > 0 ? Math.round((owned / total) * 100) : 0;

  let totalValue = 0, condSum = 0, condCount = 0, boxedCount = 0, origCount = 0;
  // Count value across ALL owned rows (items + boxes)
  const allOwnedEntries = Object.values(state.personalData).filter(pd => pd.owned);
  allOwnedEntries.forEach(pd => {
    if (pd.priceComplete) totalValue += parseFloat(pd.priceComplete) || 0;
    else if (pd.priceItem && pd.priceItem !== 'N/A') totalValue += parseFloat(pd.priceItem) || 0;
    else if (pd.priceBox) totalValue += parseFloat(pd.priceBox) || 0;
  });

  allOwned.forEach(pd => {
    if (pd.condition && pd.condition !== 'N/A') { const c = parseInt(pd.condition); if (!isNaN(c)) { condSum += c; condCount++; } }
    if (pd.hasBox === 'Yes') boxedCount++;
    if (pd.allOriginal === 'Yes') origCount++;
  });

  document.getElementById('stat-owned').textContent = owned.toLocaleString();
  document.getElementById('stat-owned-pct').textContent = `${pct}% of catalog`;
  document.getElementById('stat-value').textContent = totalValue > 0 ? `$${Math.round(totalValue).toLocaleString()}` : 'â€”';

  const soldCount = Object.keys(state.soldData).length;
  const wantCount = total - owned - soldCount;
  document.getElementById('nav-total').textContent = total.toLocaleString();
  document.getElementById('nav-owned').textContent = owned.toLocaleString();
  const wantListCount = Object.keys(state.wantData).length;
  document.getElementById('nav-wanted2').textContent = wantListCount.toLocaleString();
  if (document.getElementById('nav-sold')) document.getElementById('nav-sold').textContent = soldCount;


  // Recent Additions â€” last 5 owned items by sheet row order (highest row = most recent)
  const _recentOwned = Object.values(state.personalData)
    .filter(pd => pd.owned)
    .sort((a, b) => (b.row || 0) - (a.row || 0))
    .slice(0, 5);
  const _recentEl = document.getElementById('recent-list');
  if (_recentEl) {
    _recentEl.innerHTML = _recentOwned.length ? _recentOwned.map(function(pd) {
      const master = state.masterData.find(function(m) {
        return normalizeItemNum(m.itemNum) === normalizeItemNum(pd.itemNum);
      });
      const name = master ? (master.roadName || master.itemType || pd.itemNum) : pd.itemNum;
      const masterIdx = master ? state.masterData.indexOf(master) : -1;
      const condNum = parseInt(pd.condition);
      const condStr = !isNaN(condNum) ? condNum + '/10' : '';
      return '<div style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0;border-bottom:1px solid var(--border);'
        + (masterIdx >= 0 ? 'cursor:pointer' : '') + '" '
        + (masterIdx >= 0 ? 'onclick="openItem(' + masterIdx + ')"' : '') + '>'
        + '<span class="item-num">' + pd.itemNum + (pd.variation ? ' <span style="font-size:0.7rem;color:var(--text-dim)">' + pd.variation + '</span>' : '') + '</span>'
        + '<span style="font-size:0.8rem;color:var(--text-mid);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + name + '</span>'
        + (condStr ? '<span style="font-size:0.72rem;color:var(--accent2);flex-shrink:0">' + condStr + '</span>' : '')
        + '</div>';
    }).join('')
    : '<div class="empty-state"><div class="empty-icon">ðŸ“¦</div><p>No items owned yet</p></div>';
  }

  // Want list preview â€” built from wantData directly to avoid master-data duplicates
  const _wPriOrder = { High: 0, Medium: 1, Low: 2 };
  const _wEntries = Object.values(state.wantData)
    .sort((a, b) => (_wPriOrder[a.priority] ?? 1) - (_wPriOrder[b.priority] ?? 1))
    .slice(0, 6);
  const _wPriColor = { High: 'var(--accent)', Medium: 'var(--accent2)', Low: 'var(--text-dim)' };
  document.getElementById('want-preview').innerHTML = _wEntries.length ? _wEntries.map(function(w) {
    const master = state.masterData.find(function(m) { return m.itemNum === w.itemNum; });
    const name = master ? (master.roadName || master.itemType || w.itemNum) : w.itemNum;
    const masterIdx = master ? state.masterData.indexOf(master) : -1;
    const pc = _wPriColor[w.priority] || 'var(--text-dim)';
    return '<div style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0;border-bottom:1px solid var(--border);'
      + (masterIdx >= 0 ? 'cursor:pointer' : '') + '" '
      + (masterIdx >= 0 ? 'onclick="openItem(' + masterIdx + ')"' : '') + '>'
      + '<span class="item-num">' + w.itemNum + '</span>'
      + '<span style="font-size:0.8rem;color:var(--text-mid);flex:1">' + name + '</span>'
      + '<span style="font-size:0.65rem;font-weight:600;color:' + pc + ';border:1px solid ' + pc + ';border-radius:3px;padding:0.1rem 0.3rem;flex-shrink:0">' + (w.priority||'Med') + '</span>'
      + '</div>';
  }).join('') : '<div class="empty-state"><p>Want list is empty</p></div>';
}

// â”€â”€ BROWSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function populateFilters() {
  const types = [...new Set(state.masterData.map(i => i.itemType).filter(Boolean))].sort();
  const roads = [...new Set(state.masterData.map(i => i.roadName).filter(Boolean))].sort();

  const typeEl = document.getElementById('filter-type');
  types.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; typeEl.appendChild(o); });

  const roadEl = document.getElementById('filter-road');
  roads.slice(0, 80).forEach(r => { const o = document.createElement('option'); o.value = r; o.textContent = r; roadEl.appendChild(o); });
}

function applyFilters() {
  state.filters.type = document.getElementById('filter-type').value;
  state.filters.road = document.getElementById('filter-road').value;
  state.filters.wantList = false;
  state.currentPage = 1;
  renderBrowse();
}

function toggleFilter(name) {
  state.filters[name] = !state.filters[name];
  document.getElementById('toggle-' + name).classList.toggle('on', state.filters[name]);
  state.currentPage = 1;
  renderBrowse();
}

function resetFilters() {
  state.filters.owned = false;
  state.filters.unowned = false;
  state.filters.boxed = false;
  state.filters.wantList = false;
  state.filters.type = '';
  state.filters.road = '';
  state.currentPage = 1;
  document.getElementById('filter-type').value = '';
  document.getElementById('filter-road').value = '';

}

function filterOwned() { resetFilters(); state.filters.owned = true; renderBrowse(); }

function renderOwnedItems() {
  // Build a unified list: masterData matches + personal-only items (e.g. 2343-P)
  const masterOwned = state.masterData.filter(item => {
    const pd = findPD(item.itemNum, item.variation);
    return pd?.owned;
  });
  // Personal items with no master match
  const masterNums = new Set(state.masterData.map(m => m.itemNum + '|' + (m.variation||'')));
  const personalOnly = Object.values(state.personalData).filter(pd => {
    if (!pd.owned) return false;
    return !masterNums.has(pd.itemNum + '|' + (pd.variation||''));
  });
  return { masterOwned, personalOnly };
}
function filterWanted() {
  resetFilters();
  state.filters.wantList = true;
  renderBrowse();
}
function filterByType(type) { document.getElementById('filter-type').value = type; showPage('browse'); applyFilters(); }

function onGlobalSearch(val) {
  state.filters.search = val.toLowerCase();
  state.currentPage = 1;
  renderBrowse();
}

function buildBrowse() { renderBrowse(); }

function renderBrowse() {
  const { type, road, owned, unowned, boxed, search } = state.filters;
  // Base list: masterData + any personal-only items (e.g. 2343-P not in master)
  const masterNums = new Set(state.masterData.map(m => m.itemNum + '|' + (m.variation||'')));
  const personalOnlyItems = Object.values(state.personalData)
    .filter(pd => pd.owned && !masterNums.has(pd.itemNum + '|' + (pd.variation||'')))
    .map(pd => ({
      itemNum: pd.itemNum, variation: pd.variation || '', itemType: pd.itemType || 'Diesel Locomotive',
      roadName: pd.roadName || '', description: pd.notes || '', yearProd: pd.datePurchased || '',
      marketVal: pd.userEstWorth || '', refLink: '', _personalOnly: true
    }));
  const baseList = owned ? [...state.masterData, ...personalOnlyItems] : state.masterData;

  state.filteredData = baseList.filter(item => {
    const pd = findPD(item.itemNum, item.variation) || (item._personalOnly ? item : null);
    const isOwned = item._personalOnly ? true : (pd?.owned || false);
    const hasBox = pd?.hasBox === 'Yes';
    const isSold = !!state.soldData[`${item.itemNum}|${item.variation}`];
    if (isSold) return false;
    const isWanted = !!state.wantData[`${item.itemNum}|${item.variation}`];
    if (state.filters.wantList && !isWanted) return false;
    if (owned && !isOwned) return false;
    if (unowned && (isOwned || isWanted)) return false;
    if (boxed && !hasBox) return false;
    if (type && item.itemType !== type) return false;
    if (road && item.roadName !== road) return false;
    if (search) {
      const haystack = `${item.itemNum} ${item.roadName||''} ${item.description||''} ${item.itemType||''}`.toLowerCase();
      if (!haystack.includes(search)) return false;
    }
    return true;
  });

  const total = state.filteredData.length;
  const pages = Math.ceil(total / state.pageSize);
  const start = (state.currentPage - 1) * state.pageSize;
  const pageData = state.filteredData.slice(start, start + state.pageSize);

  document.getElementById('result-count').textContent = `${total.toLocaleString()} items`;
  document.getElementById('page-info').textContent = `Showing ${start+1}â€“${Math.min(start+state.pageSize, total)} of ${total.toLocaleString()}`;

  // Rows
  const tbody = document.getElementById('browse-tbody');
  const isMobile = window.innerWidth <= 640;
  const cardsEl = document.getElementById('browse-cards');
  const tableEl = document.querySelector('.item-table');

  if (isMobile) {
    if (tableEl) tableEl.style.display = 'none';
    if (cardsEl) cardsEl.style.display = 'flex';
  } else {
    if (tableEl) tableEl.style.display = '';
    if (cardsEl) cardsEl.style.display = 'none';
  }

  const rowsHtml = pageData.map((item, i) => {
    const pd = item._personalOnly ? item : findPD(item.itemNum, item.variation);
    const isOwned = item._personalOnly ? true : (pd?.owned || false);
    const isWanted = !!state.wantData[`${item.itemNum}|${item.variation}`];
    const cond = pd?.condition ? parseInt(pd.condition) : null;
    const condClass = cond >= 9 ? 'cond-9' : cond >= 7 ? 'cond-7' : cond >= 5 ? 'cond-5' : cond ? 'cond-low' : '';
    let globalIdx = state.masterData.indexOf(item);
    // For _personalOnly items not in masterData, use negative index via global array
    if (globalIdx < 0 && item._personalOnly) {
      const poKey = findPDKey(item.itemNum, item.variation);
      if (poKey) {
        if (!window._poKeys) window._poKeys = [];
        let poIdx = window._poKeys.indexOf(poKey);
        if (poIdx < 0) poIdx = window._poKeys.push(poKey) - 1;
        globalIdx = -(poIdx + 1000);
      }
    }
    const badgeClass = isOwned ? 'yes' : isWanted ? 'want' : 'no';
    const badgeText  = isOwned ? 'âœ“ Owned' : isWanted ? 'â˜… Want' : 'â€”';
    const marketVal  = item.marketVal ? '$' + parseFloat(item.marketVal).toLocaleString() : '';

    if (isMobile) {
      return `<div class="browse-card" onclick="browseRowClick(event,${globalIdx})">
        <div class="browse-card-left">
          <div class="browse-card-num">${item.itemNum}${item.variation ? ' <span style="font-size:0.75rem;color:var(--text-dim)">${item.variation}</span>' : ''}</div>
          <div class="browse-card-name">${item.roadName || item.itemType || 'â€”'}</div>
          <div class="browse-card-sub">${[item.itemType, item.yearProd].filter(Boolean).join(' Â· ')}${pd?.matchedTo ? ' Â· <span style="color:var(--accent2)">' + (isTender(item.itemNum)?'ðŸš‚':'ðŸšƒ') + ' ' + pd.matchedTo + '</span>' : ''}${pd?.setId ? ' Â· <span style="color:#a855f7;font-size:0.7rem">ðŸ”— ' + pd.setId.split('-').slice(0,2).join('-') + '</span>' : ''}</div>
        </div>
        <div class="browse-card-right">
          <span class="owned-badge ${badgeClass}">${badgeText}</span>
          ${cond ? `<span style="font-size:0.75rem"><span class="condition-pip ${condClass}"></span>${cond}</span>` : ''}
          ${marketVal ? `<span class="market-val" style="font-size:0.78rem">${marketVal}</span>` : ''}
          <span id="cam-${item.itemNum}-${item.variation||''}-m" style="font-size:0.85rem;display:none" onclick="event.stopPropagation();openPhotoFolder('${item.itemNum}','${pd&&pd.photoItem?pd.photoItem:''}')">ðŸ“·</span>
        </div>
      </div>`;
    } else {
      const vdShort = item.varDesc ? (item.varDesc.length > 28 ? item.varDesc.substring(0,28)+'â€¦' : item.varDesc) : '';
      const vdCell = vdShort
        ? `<span style="cursor:pointer;border-bottom:1px dashed var(--border);color:var(--text-mid)" onclick="event.stopPropagation();showVarDescPopup(${globalIdx})">${vdShort}</span>`
        : '<span class="text-dim">â€”</span>';
      return `<tr onclick="browseRowClick(event, ${globalIdx})" style="cursor:pointer">
        <td>
          <span class="item-num">${item.itemNum}</span>
          <span id="cam-${item.itemNum}-${item.variation||''}" style="margin-left:5px;font-size:0.85rem;cursor:pointer;display:none" onclick="event.stopPropagation();openPhotoFolder('${item.itemNum}','${pd&&pd.photoItem?pd.photoItem:''}')" title="Open photo folder">ðŸ“·</span>
        </td>
        <td><span class="tag">${item.itemType || 'â€”'}</span></td>
        <td>${item.roadName || '<span class="text-dim">â€”</span>'}</td>
        <td>${item.variation || '<span class="text-dim">â€”</span>'}</td>
        <td>${vdCell}</td>
        <td class="text-dim">${item.yearProd || 'â€”'}</td>
        <td><span class="owned-badge ${badgeClass}">${badgeText}</span></td>
        <td>${cond ? `<span class="condition-pip ${condClass}"></span>${cond}` : '<span class="text-dim">â€”</span>'}</td>
        <td class="market-val">${item.marketVal ? '$' + parseFloat(item.marketVal).toLocaleString() : '<span class="text-dim">â€”</span>'}</td>
      </tr>`;
    }
  });

  const emptyHtml = isMobile
    ? '<div style="text-align:center;padding:3rem 1rem;color:var(--text-dim)"><div style="font-size:2.5rem;margin-bottom:0.5rem">ðŸ”</div><p>No items match your filters</p></div>'
    : '<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">ðŸ”</div><p>No items match your filters</p></div></td></tr>';

  if (isMobile) {
    if (cardsEl) cardsEl.innerHTML = rowsHtml.join('') || emptyHtml;
  } else {
    tbody.innerHTML = rowsHtml.join('') || emptyHtml;
  }
  // Async: check which owned items have photos and reveal their camera icons
  if (state.filters.owned) {
    pageData.forEach(function(item) {
      const pd2 = item._personalOnly ? item : findPD(item.itemNum, item.variation);
      if (!pd2 || !pd2.owned) return;
      const camEl = document.getElementById('cam-' + item.itemNum + '-' + (item.variation || ''));
      if (!camEl) return;
      if (pd2.photoItem) {
        driveGetFolderPhotos(pd2.photoItem).then(function(photos) {
          if (photos && photos.length > 0) {
            const c1 = document.getElementById('cam-' + item.itemNum + '-' + (item.variation || ''));
            const c2 = document.getElementById('cam-' + item.itemNum + '-' + (item.variation || '') + '-m');
            if (c1) c1.style.display = 'inline';
            if (c2) c2.style.display = 'inline';
          }
        });
      }
    });
  }

  // Pagination
  const paginEl = document.getElementById('pagination-btns');
  let btns = '';
  if (state.currentPage > 1) btns += `<button class="page-btn" onclick="goPage(${state.currentPage-1})">â€¹</button>`;
  const range = [1, ...Array.from({length: pages}, (_,i)=>i+1).filter(p => Math.abs(p - state.currentPage) <= 2), pages];
  [...new Set(range)].sort((a,b)=>a-b).forEach((p, i, arr) => {
    if (i > 0 && arr[i-1] < p - 1) btns += `<span style="padding:0 4px;color:var(--text-dim)">â€¦</span>`;
    btns += `<button class="page-btn ${p === state.currentPage ? 'active' : ''}" onclick="goPage(${p})">${p}</button>`;
  });
  if (state.currentPage < pages) btns += `<button class="page-btn" onclick="goPage(${state.currentPage+1})">â€º</button>`;
  paginEl.innerHTML = btns;
}

function goPage(p) { state.currentPage = p; renderBrowse(); document.getElementById('main-content').scrollTop = 0; }

// â”€â”€ BROWSE ROW CLICK â€” offer to add or view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPhotoWizard(itemNum, variation, pdKey) {
  // Open wizard on the photo step for an existing item
  const pd = state.personalData[pdKey] || {};
  wizard = {
    step: 0, tab: 'collection',
    data: { tab: 'collection', itemNum: itemNum, variation: variation,
            condition: pd.condition || '', allOriginal: pd.allOriginal || '',
            hasBox: pd.hasBox || '', _updatePdKey: pdKey, _photoOnly: true },
    steps: getSteps('collection'), matchedItem: null
  };
  document.getElementById('wizard-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  // Skip to the photosItem step
  const autoSkip = new Set(['tab','itemNum','variation','condition','allOriginal','hasBox',
    'boxCond','pricePaid','datePurchased','userEstWorth','yearMade',
    'wantTenderPhotos','tenderMatch','dieselSetQ','setMatch','setType',
    'unit2ItemNum','unit3ItemNum','setUnit2Num','setUnit3Num',
    'wantTogetherPhotos','photosTogether','boxOnly','wantBoxPhotos',
    'purchaseDate','photosBox']);
  while (wizard.step < wizard.steps.length - 1) {
    const s = wizard.steps[wizard.step];
    if (autoSkip.has(s.id) || (s.skipIf && s.skipIf(wizard.data))) wizard.step++;
    else break;
  }
  renderWizardStep();
}

async function openPhotoFolder(itemNum, storedLink) {
  if (storedLink) { window.open(storedLink, '_blank'); return; }
  try {
    const folderId = await driveEnsureItemFolder(itemNum);
    window.open(driveFolderLink(folderId), '_blank');
  } catch(e) { showToast('Could not open Drive folder'); }
}

function showOwnedItemMenu(idx, pdKey) {
  const pd = state.personalData[pdKey] || {};
  // For personalOnly items, build a minimal item object from pd
  const item = state.masterData[idx] || {
    itemNum: pd.itemNum, variation: pd.variation || '',
    roadName: pd.roadName || '', itemType: pd.itemType || '',
    yearProd: pd.yearMade || '', marketVal: pd.userEstWorth || '',
  };
  const existing = document.getElementById('owned-action-menu');
  if (existing) existing.remove();

  const overlay = document.createElement('div');
  overlay.id = 'owned-action-menu';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1.5rem';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  const box = document.createElement('div');
  box.style.cssText = 'background:var(--surface);border:1px solid rgba(46,204,113,0.35);border-radius:16px;max-width:420px;width:100%;padding:1.75rem;position:relative';

  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'âœ•';
  closeBtn.style.cssText = 'position:absolute;top:0.75rem;right:0.75rem;background:none;border:none;color:var(--text-dim);font-size:1.1rem;cursor:pointer';
  closeBtn.onclick = function() { overlay.remove(); };
  box.appendChild(closeBtn);

  const hdr = document.createElement('div');
  hdr.style.cssText = 'font-family:var(--font-head);font-size:1rem;color:var(--green);margin-bottom:0.15rem';
  hdr.textContent = 'âœ“ In Your Collection';
  box.appendChild(hdr);
  const itemLbl = document.createElement('div');
  itemLbl.style.cssText = 'font-size:0.85rem;color:var(--text-mid);margin-bottom:0.1rem';
  itemLbl.textContent = 'No. ' + item.itemNum + (item.variation ? ' â€” Var. ' + item.variation : '') + (item.roadName ? ' Â· ' + item.roadName : '');
  box.appendChild(itemLbl);
  const condLbl = document.createElement('div');
  condLbl.style.cssText = 'font-size:0.75rem;color:var(--text-dim);margin-bottom:1.25rem';
  const parts = [];
  if (pd.condition) parts.push('Condition: ' + pd.condition + '/10');
  if (pd.priceItem || pd.priceComplete) parts.push('Paid: $' + (pd.priceComplete || pd.priceItem));
  if (pd.yearMade) parts.push('Year: ' + pd.yearMade);
  condLbl.textContent = parts.join(' Â· ') || item.yearProd || '';
  box.appendChild(condLbl);

  // Action buttons stacked
  const mkBtn = function(label, color, bg, handler) {
    const b = document.createElement('button');
    b.style.cssText = 'width:100%;padding:0.7rem 1rem;border-radius:9px;border:1.5px solid ' + color + ';color:' + color + ';background:' + bg + ';font-family:var(--font-body);font-size:0.9rem;font-weight:600;cursor:pointer;margin-bottom:0.5rem;text-align:left;display:flex;align-items:center;gap:0.5rem';
    b.innerHTML = label;
    b.onclick = handler;
    return b;
  };

  box.appendChild(mkBtn(
    '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg> Record a Sale',
    '#2ecc71', 'rgba(46,204,113,0.1)',
    function() { overlay.remove(); sellFromCollection(idx, pdKey); }
  ));
  box.appendChild(mkBtn(
    '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Update Info',
    '#2980b9', 'rgba(41,128,185,0.1)',
    function() { overlay.remove(); updateCollectionItem(idx, pdKey); }
  ));
  box.appendChild(mkBtn(
    '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg> View Item Details',
    'var(--text-dim)', 'var(--surface2)',
    function() { overlay.remove(); showItemPanel(idx, pdKey, 'view'); }
  ));

  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function sellFromCollection(idx, pdKey) {
  const item = state.masterData[idx];
  const pd = state.personalData[pdKey] || {};
  if (!item) return;
  // Open sell wizard pre-filled with item info
  wizard = { step: 0, tab: 'sold', data: {
    tab: 'sold',
    itemNum: item.itemNum,
    variation: item.variation || '',
    condition: pd.condition || '',
    _collectionPdKey: pdKey,
    _collectionRow: pd.row
  }, steps: getSteps('sold'), matchedItem: item };
  document.getElementById('wizard-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  // Skip tab, itemNum, variation steps
  const autoSkip = new Set(['tab', 'itemNum', 'variation']);
  while (wizard.step < wizard.steps.length - 1) {
    const s = wizard.steps[wizard.step];
    if (autoSkip.has(s.id) || (s.skipIf && s.skipIf(wizard.data))) wizard.step++;
    else break;
  }
  renderWizardStep();
}

function updateCollectionItem(idx, pdKey) {
  showItemPanel(idx, pdKey, 'edit');
}

function showItemPanel(idx, pdKey, mode) {
  const pd = state.personalData[pdKey] || {};
  const item = state.masterData[idx] || {
    itemNum: pd.itemNum, variation: pd.variation || '',
    roadName: pd.roadName || '', itemType: pd.itemType || '',
    yearProd: pd.yearMade || '', marketVal: pd.userEstWorth || '',
    varDesc: '', description: '',
  };

  const existing = document.getElementById('item-panel-overlay');
  if (existing) existing.remove();

  const overlay = document.createElement('div');
  overlay.id = 'item-panel-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };

  const box = document.createElement('div');
  box.style.cssText = 'background:var(--surface);border:1px solid rgba(41,128,185,0.35);border-radius:16px;max-width:500px;width:100%;position:relative;max-height:92vh;display:flex;flex-direction:column;overflow:hidden';

  // Header
  const header = document.createElement('div');
  header.style.cssText = 'padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);flex-shrink:0';
  header.innerHTML = '<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:0.5rem">'
    + '<div>'
    + '<div style="font-family:var(--font-head);font-size:1rem;color:#2980b9">No. ' + item.itemNum + (item.variation ? ' <span style="color:var(--text-dim);font-size:0.75rem">Var. ' + item.variation + '</span>' : '') + '</div>'
    + '<div style="font-size:0.82rem;color:var(--text-mid);margin-top:2px">' + (item.roadName || item.itemType || '') + (item.yearProd ? ' Â· ' + item.yearProd : '') + '</div>'
    + '</div>'
    + '<button id="item-panel-close-btn" style="background:none;border:none;color:var(--text-dim);font-size:1.1rem;cursor:pointer;flex-shrink:0">âœ•</button>'
    + '</div>';
  box.appendChild(header);
  // Wire close btn now that header is in memory
  const _hdrClose = header.querySelector('#item-panel-close-btn');
  if (_hdrClose) _hdrClose.onclick = function() { overlay.remove(); };

  // Scrollable content â€” split into photos (permanent) + fields (re-rendered)
  const body = document.createElement('div');
  body.style.cssText = 'flex:1;overflow-y:auto;padding:0.75rem 1.5rem';
  const photoContainer = document.createElement('div');
  photoContainer.id = 'item-panel-photo-container';
  body.appendChild(photoContainer);
  const fieldsContainer = document.createElement('div');
  fieldsContainer.id = 'item-panel-fields-container';
  body.appendChild(fieldsContainer);

  const fields = [
    { label: 'Condition',     key: 'condition',     val: pd.condition || 'â€”',     type: 'number', min:1, max:10 },
    { label: 'All Original',  key: 'allOriginal',   val: pd.allOriginal || 'â€”',   type: 'select', options: ['Yes','No','Unknown'] },
    { label: 'Has Box',       key: 'hasBox',        val: pd.hasBox || 'â€”',        type: 'select', options: ['Yes','No'] },
    { label: 'Box Condition', key: 'boxCond',       val: pd.boxCond || 'â€”',       type: 'number', min:1, max:10 },
    { label: 'Price Paid ($)',key: 'priceItem',     val: pd.priceItem || 'â€”',     type: 'number' },
    { label: 'Est. Worth ($)',key: 'userEstWorth',  val: pd.userEstWorth || 'â€”',  type: 'number' },
    { label: 'Year Made',     key: 'yearMade',      val: pd.yearMade || 'â€”',      type: 'number', min:1945, max:1969 },
    { label: 'Date Purchased',key: 'datePurchased', val: pd.datePurchased || 'â€”', type: 'date' },
    { label: 'Notes',         key: 'notes',         val: pd.notes || 'â€”',         type: 'text' },
  ];

  // â”€â”€ Photos section â”€â”€
  const photoSection = document.createElement('div');
  photoSection.id = 'item-panel-photos';
  photoSection.style.cssText = 'padding:0.75rem 0;border-bottom:1px solid var(--border);margin-bottom:0.25rem';

  // Header row with label + "Add Photos" button
  const photoHdr = document.createElement('div');
  photoHdr.style.cssText = 'display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem';
  photoHdr.innerHTML = '<span style="font-size:0.72rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.08em">Photos</span>';
  const addPhotoBtn = document.createElement('button');
  addPhotoBtn.style.cssText = 'font-size:0.72rem;padding:0.2rem 0.55rem;border-radius:5px;border:1px solid #2980b9;color:#2980b9;background:rgba(41,128,185,0.1);cursor:pointer;display:flex;align-items:center;gap:0.25rem';
  addPhotoBtn.innerHTML = 'ðŸ“· Add Photos';
  addPhotoBtn.onclick = function() {
    // Close this panel and open photo wizard for this item
    document.getElementById('item-panel-overlay').remove();
    openPhotoWizard(item.itemNum, pd.variation || item.variation || '', pdKey);
  };
  photoHdr.appendChild(addPhotoBtn);
  photoSection.appendChild(photoHdr);

  // Thumbnail row
  const thumbRow = document.createElement('div');
  thumbRow.id = 'item-panel-thumb-row';
  thumbRow.style.cssText = 'display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center';
  thumbRow.innerHTML = '<span style="font-size:0.75rem;color:var(--text-dim)">Loadingâ€¦</span>';
  photoSection.appendChild(thumbRow);

  // Folder link
  const folderLinkEl = document.createElement('div');
  folderLinkEl.id = 'item-panel-folder-link';
  folderLinkEl.style.cssText = 'margin-top:0.4rem;min-height:1.2rem';
  photoSection.appendChild(folderLinkEl);

  photoContainer.appendChild(photoSection);

  // Async load photos
  (async function() {
    const tr2 = document.getElementById('item-panel-thumb-row');
    const fl2 = document.getElementById('item-panel-folder-link');
    try {
      // Wait for accessToken to be available (max 5s)
      let waited = 0;
      while (!accessToken && waited < 5000) {
        await new Promise(r => setTimeout(r, 200));
        waited += 200;
      }
      if (!accessToken) {
        if (tr2) tr2.innerHTML = '<span style="font-size:0.75rem;color:var(--text-dim)">Not signed in to Drive</span>';
        return;
      }

      let folderLink = pd.photoItem || '';
      if (!folderLink) {
        try { await driveEnsureSetup(); } catch(e) {}
        try {
          const folderId = await driveEnsureItemFolder(item.itemNum);
          folderLink = driveFolderLink(folderId);
        } catch(e) {}
      }

      // Show folder link
      if (fl2 && folderLink) {
        const a = document.createElement('a');
        a.href = folderLink; a.target = '_blank';
        a.style.cssText = 'font-size:0.72rem;color:#2980b9';
        a.textContent = 'ðŸ“ Open Drive Folder â†—';
        fl2.innerHTML = '';
        fl2.appendChild(a);
      }

      if (!tr2) return;

      const photos = await driveGetFolderPhotos(folderLink);

      if (photos === null) {
        tr2.innerHTML = '<span style="font-size:0.75rem;color:var(--text-dim)">Could not load photos â€” check Drive access</span>';
        return;
      }
      if (photos.length === 0) {
        tr2.innerHTML = '<span style="font-size:0.75rem;color:var(--text-dim);font-style:italic">No photos yet â€” tap Add Photos</span>';
        return;
      }

      // Sort: RSV first, then FV, then others
      const priority = function(name) {
        const n = (name || '').toUpperCase();
        if (n.includes('RSV')) return 0;
        if (n.includes('FV'))  return 1;
        if (n.includes('TV'))  return 2;
        if (n.includes('BV'))  return 3;
        return 9;
      };
      photos.sort(function(a,b) { return priority(a.name) - priority(b.name); });

      tr2.innerHTML = '';
      photos.forEach(function(p) {
        const a = document.createElement('a');
        a.href = p.view; a.target = '_blank'; a.title = p.name.replace(/\.[^.]+$/, '');
        a.style.cssText = 'display:inline-block;border-radius:8px;overflow:hidden;border:2px solid ' + (p.name.toUpperCase().includes('RSV') ? '#2980b9' : 'var(--border)') + ';flex-shrink:0;position:relative';
        const img = document.createElement('img');
        img.src = p.thumb;
        img.style.cssText = 'width:80px;height:80px;object-fit:cover;display:block';
        img.onerror = function() { a.style.display = 'none'; };
        // Label below
        const lbl = document.createElement('div');
        lbl.style.cssText = 'font-size:0.55rem;text-align:center;padding:2px 0;background:var(--surface2);color:var(--text-dim);letter-spacing:0.03em';
        lbl.textContent = p.name.replace(/\.[^.]+$/, '').split(' ').pop(); // last word = view abbr
        a.appendChild(img);
        a.appendChild(lbl);
        tr2.appendChild(a);
      });

    } catch(e) {
      console.error('Photo load error:', e);
      if (tr2) tr2.innerHTML = '<span style="font-size:0.75rem;color:var(--text-dim)">Could not load photos</span>';
    }
  })();

  // Track which field is being edited
  let editingKey = null;

  function renderFields(activeKey) {
    fieldsContainer.innerHTML = '';
    fields.forEach(function(f) {
      const row = document.createElement('div');
      row.style.cssText = 'display:flex;align-items:center;gap:0.75rem;padding:0.65rem 0;border-bottom:1px solid var(--border);min-height:44px';

      const lbl = document.createElement('div');
      lbl.style.cssText = 'font-size:0.75rem;color:var(--text-dim);width:120px;flex-shrink:0';
      lbl.textContent = f.label;

      const valWrap = document.createElement('div');
      valWrap.style.cssText = 'flex:1';

      if (mode === 'edit' && activeKey === f.key) {
        // Show input
        let inp;
        if (f.type === 'select') {
          inp = document.createElement('select');
          inp.style.cssText = 'width:100%;background:var(--bg);border:1px solid #2980b9;border-radius:6px;padding:0.4rem 0.6rem;color:var(--text);font-family:var(--font-body);font-size:0.9rem';
          f.options.forEach(function(o) {
            const opt = document.createElement('option');
            opt.value = o; opt.textContent = o;
            if (o === (pd[f.key] || '')) opt.selected = true;
            inp.appendChild(opt);
          });
        } else {
          inp = document.createElement('input');
          inp.type = f.type === 'text' ? 'text' : f.type;
          inp.value = pd[f.key] || '';
          if (f.min !== undefined) inp.min = f.min;
          if (f.max !== undefined) inp.max = f.max;
          inp.style.cssText = 'width:100%;background:var(--bg);border:1px solid #2980b9;border-radius:6px;padding:0.4rem 0.6rem;color:var(--text);font-family:var(--font-body);font-size:0.9rem;box-sizing:border-box';
        }
        inp.id = 'panel-inp-' + f.key;
        setTimeout(function() { if (inp) inp.focus(); }, 30);

        const doneBtn = document.createElement('button');
        doneBtn.textContent = 'âœ“';
        doneBtn.style.cssText = 'margin-left:0.4rem;padding:0.3rem 0.6rem;border-radius:6px;border:1px solid #2980b9;background:#2980b9;color:#fff;cursor:pointer;font-size:0.85rem;flex-shrink:0';
        doneBtn.onclick = function() {
          pd[f.key] = inp.value;
          f.val = inp.value || 'â€”';
          editingKey = null;
          renderFields(null);
        };

        const cancelInp = document.createElement('button');
        cancelInp.textContent = 'âœ•';
        cancelInp.style.cssText = 'margin-left:0.25rem;padding:0.3rem 0.5rem;border-radius:6px;border:1px solid var(--border);background:none;color:var(--text-dim);cursor:pointer;font-size:0.85rem;flex-shrink:0';
        cancelInp.onclick = function() { editingKey = null; renderFields(null); };

        const inpRow = document.createElement('div');
        inpRow.style.cssText = 'display:flex;align-items:center;gap:0;width:100%';
        inpRow.appendChild(inp);
        inpRow.appendChild(doneBtn);
        inpRow.appendChild(cancelInp);
        valWrap.appendChild(inpRow);

      } else {
        // Show value
        const valEl = document.createElement('span');
        valEl.style.cssText = 'font-size:0.88rem;color:' + (f.val && f.val !== 'â€”' ? 'var(--text)' : 'var(--text-dim)');
        valEl.textContent = f.val && f.val !== 'â€”' ? f.val : 'â€”';
        valWrap.appendChild(valEl);

        if (mode === 'edit') {
          const editBtn = document.createElement('button');
          editBtn.textContent = 'âœï¸';
          editBtn.title = 'Edit';
          editBtn.style.cssText = 'margin-left:0.5rem;padding:0.15rem 0.4rem;border-radius:5px;border:1px solid var(--border);background:none;cursor:pointer;font-size:0.75rem;color:var(--text-dim)';
          editBtn.onclick = function() { editingKey = f.key; renderFields(f.key); };
          valWrap.appendChild(editBtn);
        }
      }

      row.appendChild(lbl);
      row.appendChild(valWrap);
      fieldsContainer.appendChild(row);
    });
  }

  renderFields(null);
  box.appendChild(body);

  // Footer buttons
  const footer = document.createElement('div');
  footer.style.cssText = 'padding:1rem 1.5rem;border-top:1px solid var(--border);display:flex;gap:0.6rem;flex-shrink:0';

  if (mode === 'view') {
    const editModeBtn = document.createElement('button');
    editModeBtn.className = 'btn';
    editModeBtn.style.cssText = 'flex:1;border:1.5px solid #2980b9;color:#2980b9;background:rgba(41,128,185,0.1);font-weight:600';
    editModeBtn.innerHTML = 'âœï¸ Edit This Item';
    editModeBtn.onclick = function() { mode = 'edit'; renderFields(null); footer.innerHTML = ''; buildFooter(); };
    footer.appendChild(editModeBtn);
  } else {
    buildFooter();
  }

  function buildFooter() {
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn btn-primary';
    saveBtn.style.cssText = 'flex:1;background:#2980b9;border-color:#2980b9;font-weight:600';
    saveBtn.textContent = 'ðŸ’¾ Save All Changes';
    saveBtn.onclick = async function() {
      saveBtn.textContent = 'Savingâ€¦'; saveBtn.disabled = true;
      // Collect all current pd values (updated in-place during edits)
      const priceItem = pd.priceItem || '';
      const priceBox = pd.priceBox || '';
      const calc = (parseFloat(priceItem)||0) + (parseFloat(priceBox)||0);
      const newRow = [
        item.itemNum, item.variation || '',
        pd.condition || '', pd.allOriginal || '',
        priceItem, priceBox, calc > 0 ? calc.toFixed(2) : '',
        pd.hasBox || '', pd.boxCond || '',
        pd.photoItem || '', pd.photoBox || '',
        pd.notes || '', pd.datePurchased || '',
        pd.userEstWorth || '', pd.matchedTo || '',
        pd.setId || '', pd.yearMade || '',
      ];
      try {
        await sheetsUpdate(state.personalSheetId, 'My Collection!A' + pd.row + ':Q' + pd.row, [newRow]);
        state.personalData[pdKey] = Object.assign({}, pd, { priceComplete: calc > 0 ? calc.toFixed(2) : '' });
        overlay.remove();
        showToast('âœ“ Item updated!');
        buildDashboard();
      } catch(e) {
        saveBtn.textContent = 'ðŸ’¾ Save All Changes'; saveBtn.disabled = false;
        showToast('Error: ' + e.message);
      }
    };

    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'btn btn-secondary';
    cancelBtn.textContent = 'Cancel';
    cancelBtn.onclick = function() { overlay.remove(); };

    footer.innerHTML = '';
    footer.appendChild(saveBtn);
    footer.appendChild(cancelBtn);
  }

  box.appendChild(footer);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}


function browseRowClick(event, idx) {
  // If click was on the varDesc popup span, don't intercept
  if (event.target.closest && event.target.closest('[onclick*="showVarDescPopup"]')) return;
  // Handle _personalOnly items encoded as negative sentinel
  if (idx <= -1000) {
    const poIdx = Math.abs(idx) - 1000;
    const pdKey = (window._poKeys || [])[poIdx];
    if (pdKey) { showOwnedItemMenu(-1, pdKey); }
    return;
  }
  const item = state.masterData[idx];
  if (!item) return;
  const keyPrefix = item.itemNum + '|' + item.variation + '|';
  const pdKey = Object.keys(state.personalData).find(k => k.startsWith(keyPrefix));
  const alreadyOwned = !!pdKey;
  if (alreadyOwned) {
    showOwnedItemMenu(idx, pdKey);
    return;
  }
  // Not owned â€” show quick prompt
  const existing = document.getElementById('browse-add-prompt');
  if (existing) existing.remove();
  const overlay = document.createElement('div');
  overlay.id = 'browse-add-prompt';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1.5rem';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  const box = document.createElement('div');
  box.style.cssText = 'background:var(--surface);border:1px solid rgba(232,64,28,0.4);border-radius:16px;max-width:440px;width:100%;padding:1.75rem;position:relative';
  // Header
  const hdr = document.createElement('div');
  hdr.style.cssText = 'font-family:var(--font-head);font-size:1.05rem;color:var(--accent);margin-bottom:0.25rem';
  hdr.textContent = 'No. ' + item.itemNum + (item.variation ? ' â€” Var. ' + item.variation : '');
  box.appendChild(hdr);
  const sub = document.createElement('div');
  sub.style.cssText = 'font-size:0.85rem;color:var(--text-mid);margin-bottom:0.25rem';
  sub.textContent = item.roadName || item.itemType || '';
  box.appendChild(sub);
  if (item.yearProd) {
    const yr = document.createElement('div');
    yr.style.cssText = 'font-size:0.75rem;color:var(--text-dim);margin-bottom:1.25rem';
    yr.textContent = item.yearProd + (item.itemType ? ' Â· ' + item.itemType : '');
    box.appendChild(yr);
  } else {
    sub.style.marginBottom = '1.25rem';
  }
  // Question
  const q = document.createElement('div');
  q.style.cssText = 'font-size:0.9rem;color:var(--text);margin-bottom:1.25rem;font-weight:500';
  q.textContent = 'Do you own this item?';
  box.appendChild(q);
  // Buttons
  const btnRow = document.createElement('div');
  btnRow.style.cssText = 'display:flex;gap:0.75rem';
  const yesBtn = document.createElement('button');
  yesBtn.className = 'btn btn-primary';
  yesBtn.style.cssText = 'flex:1;background:#e8401c;border-color:#e8401c;font-weight:600';
  yesBtn.textContent = 'âœ“ Yes â€” Add to Collection';
  yesBtn.onclick = function() { overlay.remove(); addFromBrowse(idx); };
  const viewBtn = document.createElement('button');
  viewBtn.className = 'btn btn-secondary';
  viewBtn.style.cssText = 'flex:1';
  viewBtn.textContent = 'View Details';
  viewBtn.onclick = function() {
    overlay.remove();
    // Show description popup
    const vdOverlay = document.createElement('div');
    vdOverlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1.5rem';
    vdOverlay.onclick = function(e) { if (e.target === vdOverlay) vdOverlay.remove(); };
    const vdBox = document.createElement('div');
    vdBox.style.cssText = 'background:var(--surface);border:1px solid var(--border);border-radius:14px;max-width:520px;width:100%;padding:1.75rem;position:relative;max-height:80vh;overflow-y:auto';
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'âœ•';
    closeBtn.style.cssText = 'position:absolute;top:0.75rem;right:0.75rem;background:none;border:none;color:var(--text-dim);font-size:1.1rem;cursor:pointer';
    closeBtn.onclick = function() { vdOverlay.remove(); };
    vdBox.appendChild(closeBtn);
    const rows = [
      ['Item #', item.itemNum + (item.variation ? ' â€” Var. ' + item.variation : '')],
      ['Type', item.itemType || 'â€”'],
      ['Road / Name', item.roadName || 'â€”'],
      ['Year', item.yearProd || 'â€”'],
      ['Market Value', item.marketVal ? '$' + parseFloat(item.marketVal).toLocaleString() : 'â€”'],
    ];
    rows.forEach(function(r) {
      const row = document.createElement('div');
      row.style.cssText = 'display:flex;gap:0.75rem;margin-bottom:0.4rem;font-size:0.85rem';
      const lbl = document.createElement('span');
      lbl.style.cssText = 'color:var(--text-dim);min-width:90px;flex-shrink:0';
      lbl.textContent = r[0];
      const val = document.createElement('span');
      val.style.cssText = 'color:var(--text)';
      val.textContent = r[1];
      row.appendChild(lbl);
      row.appendChild(val);
      vdBox.appendChild(row);
    });
    if (item.varDesc) {
      const vdSec = document.createElement('div');
      vdSec.style.cssText = 'margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid var(--border);font-size:0.82rem;color:var(--text-mid);line-height:1.6';
      vdSec.innerHTML = '<span style="color:var(--accent2);font-weight:600">Variation: </span>' + item.varDesc;
      vdBox.appendChild(vdSec);
    }
    if (item.description) {
      const descSec = document.createElement('div');
      descSec.style.cssText = 'margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid var(--border);font-size:0.82rem;color:var(--text-mid);line-height:1.6';
      descSec.textContent = item.description;
      vdBox.appendChild(descSec);
    }
    // Add to collection button at bottom
    const addBtn = document.createElement('button');
    addBtn.className = 'btn btn-primary';
    addBtn.style.cssText = 'margin-top:1.25rem;width:100%;background:#e8401c;border-color:#e8401c';
    addBtn.textContent = 'âœ“ Add to My Collection';
    addBtn.onclick = function() { vdOverlay.remove(); addFromBrowse(idx); };
    vdBox.appendChild(addBtn);
    vdOverlay.appendChild(vdBox);
    document.body.appendChild(vdOverlay);
  };
  const cancelBtn = document.createElement('button');
  cancelBtn.className = 'btn btn-secondary';
  cancelBtn.style.cssText = 'padding:0.6rem 0.9rem';
  cancelBtn.textContent = 'âœ•';
  cancelBtn.onclick = function() { overlay.remove(); };
  btnRow.appendChild(yesBtn);
  btnRow.appendChild(viewBtn);
  btnRow.appendChild(cancelBtn);
  box.appendChild(btnRow);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function addFromBrowse(idx) {
  const item = state.masterData[idx];
  if (!item) return;
  // Open the collection wizard with itemNum + variation pre-filled
  wizard = { step: 0, tab: 'collection', data: { tab: 'collection', itemNum: item.itemNum, variation: item.variation || '' }, steps: getSteps('collection'), matchedItem: item };
  document.getElementById('wizard-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  // Skip the tab picker (step 0) and itemNum step â€” advance past any steps
  // whose id is 'itemNum' or 'variation' (already known)
  const autoSkip = new Set(['tab', 'itemNum', 'variation']);
  while (wizard.step < wizard.steps.length - 1) {
    const s = wizard.steps[wizard.step];
    if (autoSkip.has(s.id) || (s.skipIf && s.skipIf(wizard.data))) {
      wizard.step++;
    } else {
      break;
    }
  }
  renderWizardStep();
}

// â”€â”€ ITEM MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openItem(idx) {
  const item = state.masterData[idx];
  state.currentItem = { item, idx };
  // Find by prefix since key now includes row number
  const keyPrefix = `${item.itemNum}|${item.variation}|`;
  const pdKey = Object.keys(state.personalData).find(k => k.startsWith(keyPrefix));
  const pd = pdKey ? state.personalData[pdKey] : {};

  document.getElementById('modal-item-num').textContent = `No. ${item.itemNum}${item.variation ? ' â€” Variation ' + item.variation : ''}`;
  document.getElementById('modal-title').textContent = item.roadName || item.itemType || item.description.substring(0, 60);
  const modalMatchedTo = pd?.matchedTo || '';
  const modalIsTender = isTender(item.itemNum);
  document.getElementById('modal-subtitle').textContent = `${item.itemType}${item.subType ? ' â€” ' + item.subType : ''}${item.yearProd ? ' Â· ' + item.yearProd : ''}`;
  // Set ID badge
  const setIdBadgeEl = document.getElementById('modal-set-badge');
  if (setIdBadgeEl) {
    if (pd?.setId) {
      setIdBadgeEl.style.display = 'inline-flex';
      // Find all other items in this set
      const setMates = Object.values(state.personalData)
        .filter(p => p.setId === pd.setId && p.itemNum !== item.itemNum)
        .map(p => p.itemNum);
      setIdBadgeEl.textContent = 'ðŸ”— Set: ' + pd.setId + (setMates.length ? ' (with ' + setMates.join(', ') + ')' : '');
    } else {
      setIdBadgeEl.style.display = 'none';
    }
  }

  const matchedBadgeEl = document.getElementById('modal-matched-badge');
  if (matchedBadgeEl) {
    if (modalMatchedTo) {
      matchedBadgeEl.style.display = 'inline-flex';
      matchedBadgeEl.innerHTML = `${modalIsTender ? 'ðŸš‚' : 'ðŸšƒ'} Matched ${modalIsTender ? 'Engine' : 'Tender'}: <strong style="margin-left:0.3rem">${modalMatchedTo}</strong>`;
    } else {
      matchedBadgeEl.style.display = 'none';
    }
  }
  document.getElementById('mi-type').textContent = item.itemType || 'â€”';
  document.getElementById('mi-year').textContent = item.yearProd || 'â€”';
  document.getElementById('mi-road').textContent = item.roadName || 'â€”';
  document.getElementById('mi-var').textContent = item.variation || '(no variation)';
  document.getElementById('mi-market').textContent = item.marketVal ? '$' + parseFloat(item.marketVal).toLocaleString() : 'â€”';
  document.getElementById('mi-ref').innerHTML = item.refLink ? `<a href="${item.refLink}" target="_blank">View on COTT â†—</a>` : 'â€”';
  document.getElementById('mi-desc').textContent = item.description || 'No description available.';
  const vd = document.getElementById('mi-varDesc-wrap');
  if (item.varDesc) { document.getElementById('mi-varDesc').textContent = item.varDesc; vd.style.display = 'block'; }
  else { vd.style.display = 'none'; }

  // Personal data - check owned and sold
  const sd = state.soldData[key] || {};
  const wd = state.wantData[key] || {};
  const itemStatus = pd.owned ? 'Owned' : sd.itemNum ? 'Sold' : wd.itemNum ? 'Want' : '';
  currentStatus = itemStatus || '';
  setStatus(itemStatus || 'Want');
  document.getElementById('fc-sale-price').value = sd.salePrice || '';
  document.getElementById('fc-date-sold').value = sd.dateSold || '';
  document.getElementById('fc-want-priority').value = wd.priority || 'Medium';
  document.getElementById('fc-want-price').value = wd.expectedPrice || '';
  document.getElementById('fc-want-notes').value = wd.notes || '';

  // copy field removed
  document.getElementById('fc-original').value = pd.allOriginal || 'Unknown';
  const cond = pd.condition || 7;
  document.getElementById('fc-condition').value = cond;
  document.getElementById('cond-display').textContent = cond;
  const toNum = v => (v && !isNaN(parseFloat(v))) ? v : '';
  document.getElementById('fc-price-item').value = toNum(pd.priceItem);
  document.getElementById('fc-price-box').value = toNum(pd.priceBox);
  document.getElementById('fc-price-complete').value = toNum(pd.priceComplete);
  document.getElementById('fc-has-box').value = ['Yes','No'].includes(pd.hasBox) ? pd.hasBox : 'No';
  document.getElementById('fc-box-cond').value = toNum(pd.boxCond);
  document.getElementById('fc-photo-item').value = pd.photoItem || '';
  document.getElementById('fc-photo-box').value = pd.photoBox || '';
  document.getElementById('fc-notes').value = pd.notes || '';

  // Show box-only prompt if row has box but no item info
  const isBoxOnly = pd.owned && pd.hasBox === 'Yes' && 
    (!pd.condition || pd.condition === 'N/A') && 
    (!pd.priceItem || pd.priceItem === 'N/A');
  const prompt = document.getElementById('box-only-prompt');
  if (prompt) prompt.style.display = isBoxOnly ? 'flex' : 'none';

  document.getElementById('item-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function fillItemFromBoxRow() {
  if (!state.currentItem) return;
  const { item } = state.currentItem;
  closeModal();
  // Start wizard in collection mode, pre-filled with item number, skip to item-info steps
  wizard = {
    step: 0,
    tab: 'collection',
    data: {
      tab: 'collection',
      itemNum: item.itemNum,
      variation: item.variation || '',
      boxOnly: false,
      _fillItemMode: true, // flag so we can pre-set item number
    },
    steps: getSteps('collection'),
    matchedItem: state.masterData.find(i => i.itemNum === item.itemNum) || null,
  };
  // Advance past tab and itemNum steps since we already know them
  wizard.step = 2; // start at condition step
  document.getElementById('wizard-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  renderWizardStep();
}

function closeModal() {
  document.getElementById('item-modal').classList.remove('open');
  document.body.style.overflow = '';
  state.currentItem = null;
}

function closeModalOnOverlay(e) { if (e.target === document.getElementById('item-modal')) closeModal(); }

let currentStatus = 'Want';

function setStatus(status) {
  currentStatus = status;
  // Update button styles
  ['Want','Owned','Sold'].forEach(s => {
    const btn = document.getElementById('status-' + s.toLowerCase());
    if (!btn) return;
    if (s === status) {
      const colors = { Want: 'var(--accent2)', Owned: 'var(--green)', Sold: '#9b59b6' };
      btn.style.background = colors[s] + '22';
      btn.style.borderColor = colors[s];
      btn.style.color = colors[s];
    } else {
      btn.style.background = 'var(--surface2)';
      btn.style.borderColor = 'var(--border)';
      btn.style.color = 'var(--text-mid)';
    }
  });
  document.getElementById('collection-form').style.display = (status === 'Owned' || status === 'Sold') ? 'block' : 'none';
  const soldFields = document.getElementById('sold-fields');
  if (soldFields) soldFields.style.display = status === 'Sold' ? 'block' : 'none';
  const wantFields = document.getElementById('want-fields');
  if (wantFields) wantFields.style.display = status === 'Want' ? 'block' : 'none';
}

async function saveItem() {
  if (!state.currentItem) return;
  const { item } = state.currentItem;
  const key = `${item.itemNum}|${item.variation}`;

  const copy = document.getElementById('fc-copy').value;
  const condition = document.getElementById('fc-condition').value;

  if (currentStatus === 'Owned') {
    // Write/update in My Collection tab
    const ownedRow = [
      item.itemNum, item.variation || '', copy, condition,
      document.getElementById('fc-original').value,
      document.getElementById('fc-price-item').value,
      document.getElementById('fc-price-box').value,
      document.getElementById('fc-price-complete').value,
      document.getElementById('fc-has-box').value,
      document.getElementById('fc-box-cond').value,
      document.getElementById('fc-photo-item').value,
      document.getElementById('fc-photo-box').value,
      document.getElementById('fc-notes').value,
    ];
    const existing = state.personalData[key];
    if (existing && existing.row) {
      await sheetsUpdate(state.personalSheetId, `My Collection!A${existing.row}:N${existing.row}`, [ownedRow]);
    } else {
      await sheetsAppend(state.personalSheetId, 'My Collection!A:N', [ownedRow]);
    }
    // Remove from Sold tab if it was there
    const soldEntry = state.soldData[key];
    if (soldEntry && soldEntry.row) {
      await sheetsUpdate(state.personalSheetId, `Sold!A${soldEntry.row}:H${soldEntry.row}`, [['','','','','','','','']]);
    }
    // Remove from Want List if it was there
    const wantEntry = state.wantData[key];
    if (wantEntry && wantEntry.row) {
      await sheetsUpdate(state.personalSheetId, `Want List!A${wantEntry.row}:E${wantEntry.row}`, [['','','','','']]);
    }

  } else if (currentStatus === 'Sold') {
    // Remove from My Collection
    const existing = state.personalData[key];
    if (existing && existing.row) {
      await sheetsUpdate(state.personalSheetId, `My Collection!A${existing.row}:N${existing.row}`, [['','','','','','','','','','','','','']]);
    }
    // Write to Sold tab
    const soldRow = [
      item.itemNum, item.variation || '', copy, condition,
      existing?.priceItem || document.getElementById('fc-price-item').value,
      document.getElementById('fc-sale-price').value,
      document.getElementById('fc-date-sold').value,
      document.getElementById('fc-notes').value,
    ];
    const soldEntry = state.soldData[key];
    if (soldEntry && soldEntry.row) {
      await sheetsUpdate(state.personalSheetId, `Sold!A${soldEntry.row}:H${soldEntry.row}`, [soldRow]);
    } else {
      await sheetsAppend(state.personalSheetId, 'Sold!A:H', [soldRow]);
    }

  } else if (currentStatus === 'Want') {
    // Remove from My Collection if present
    const existing = state.personalData[key];
    if (existing && existing.row) {
      await sheetsUpdate(state.personalSheetId, `My Collection!A${existing.row}:N${existing.row}`, [['','','','','','','','','','','','','']]);
    }
    // Write/update Want List tab
    const wantRow = [
      item.itemNum,
      item.variation || '',
      document.getElementById('fc-want-priority').value,
      document.getElementById('fc-want-price').value,
      document.getElementById('fc-want-notes').value,
    ];
    const wantEntry = state.wantData[key];
    if (wantEntry && wantEntry.row) {
      await sheetsUpdate(state.personalSheetId, `Want List!A${wantEntry.row}:E${wantEntry.row}`, [wantRow]);
    } else {
      await sheetsAppend(state.personalSheetId, 'Want List!A:E', [wantRow]);
    }
  }

  await loadPersonalData();

  // Reset all filters so the browse view shows everything
  state.filters.wantList = false;
  state.filters.owned = false;
  state.filters.unowned = false;
  state.filters.boxed = false;
  // Reset toggle button visual states


  closeModal();
  buildDashboard();
  buildSoldPage();
  renderBrowse();
}

// â”€â”€ REPORTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildReport() {
  const type = document.getElementById('report-type')?.value || 'wantlist';
  const thead = document.getElementById('report-thead');
  const tbody = document.getElementById('report-tbody');
  if (!thead || !tbody) return;

  if (type === 'wantlist') {
    thead.innerHTML = '<tr><th>Item #</th><th>Type</th><th>Road Name</th><th>Year</th><th>Variation</th><th>Est. Market Value</th><th>COTT Link</th></tr>';
    const wants = state.masterData.filter(i => !state.personalData[`${i.itemNum}|${i.variation}`]?.owned);
    tbody.innerHTML = wants.map(i => `
      <tr>
        <td><span class="item-num">${i.itemNum}</span></td>
        <td><span class="tag">${i.itemType || 'â€”'}</span></td>
        <td>${i.roadName || 'â€”'}</td>
        <td>${i.yearProd || 'â€”'}</td>
        <td>${i.variation || 'â€”'}</td>
        <td class="market-val">${i.marketVal ? '$'+parseFloat(i.marketVal).toLocaleString() : 'â€”'}</td>
        <td>${i.refLink ? `<a href="${i.refLink}" target="_blank" style="color:var(--accent2)">View â†—</a>` : 'â€”'}</td>
      </tr>`).join('') || '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-dim)">All items owned! ðŸŽ‰</td></tr>';

  } else if (type === 'collection') {
    thead.innerHTML = '<tr><th>Item #</th><th>Type</th><th>Road Name</th><th>Variation</th><th>Copy #</th><th>Condition</th><th>Has Box</th><th>All Original</th><th>Item Price</th><th>Item+Box</th></tr>';
    const owned = state.masterData.filter(i => state.personalData[`${i.itemNum}|${i.variation}`]?.owned);
    tbody.innerHTML = owned.map(i => {
      const pd = state.personalData[`${i.itemNum}|${i.variation}`];
      return `<tr>
        <td><span class="item-num">${i.itemNum}</span></td>
        <td><span class="tag">${i.itemType || 'â€”'}</span></td>
        <td>${i.roadName || 'â€”'}</td>
        <td>${i.variation || 'â€”'}</td>
        <td>${pd.copy || '1'}</td>
        <td>${pd.condition || 'â€”'}</td>
        <td>${pd.hasBox || 'â€”'}</td>
        <td>${pd.allOriginal || 'â€”'}</td>
        <td class="market-val">${pd.priceItem ? '$'+parseFloat(pd.priceItem).toLocaleString() : 'â€”'}</td>
        <td class="market-val">${pd.priceComplete ? '$'+parseFloat(pd.priceComplete).toLocaleString() : 'â€”'}</td>
      </tr>`;
    }).join('') || '<tr><td colspan="10" style="text-align:center;padding:2rem;color:var(--text-dim)">No owned items yet</td></tr>';

  } else if (type === 'value') {
    thead.innerHTML = '<tr><th>Category</th><th>Owned</th><th>Total in Master</th><th>% Complete</th><th>Est. Collection Value</th></tr>';
    const cats = {};
    state.masterData.forEach(i => {
      const t = i.itemType || 'Other';
      if (!cats[t]) cats[t] = { total: 0, owned: 0, value: 0 };
      cats[t].total++;
      const pd = state.personalData[`${i.itemNum}|${i.variation}`];
      if (pd?.owned) {
        cats[t].owned++;
        cats[t].value += parseFloat(pd.priceComplete || pd.priceItem || 0);
      }
    });
    tbody.innerHTML = Object.entries(cats).sort((a,b)=>b[1].owned-a[1].owned).map(([name, c]) => `
      <tr>
        <td>${name}</td>
        <td>${c.owned}</td>
        <td>${c.total}</td>
        <td>${c.total > 0 ? Math.round(c.owned/c.total*100) + '%' : 'â€”'}</td>
        <td class="market-val">${c.value > 0 ? '$'+Math.round(c.value).toLocaleString() : 'â€”'}</td>
      </tr>`).join('');

  } else if (type === 'missing-box') {
    thead.innerHTML = '<tr><th>Item #</th><th>Type</th><th>Road Name</th><th>Condition</th><th>Est. Market Value</th></tr>';
    const noBox = state.masterData.filter(i => {
      const pd = state.personalData[`${i.itemNum}|${i.variation}`];
      return pd?.owned && pd?.hasBox !== 'Yes';
    });
    tbody.innerHTML = noBox.map(i => {
      const pd = state.personalData[`${i.itemNum}|${i.variation}`];
      return `<tr>
        <td><span class="item-num">${i.itemNum}</span></td>
        <td><span class="tag">${i.itemType || 'â€”'}</span></td>
        <td>${i.roadName || 'â€”'}</td>
        <td>${pd.condition || 'â€”'}</td>
        <td class="market-val">${i.marketVal ? '$'+parseFloat(i.marketVal).toLocaleString() : 'â€”'}</td>
      </tr>`;
    }).join('') || '<tr><td colspan="5" style="text-align:center;padding:2rem;color:var(--text-dim)">All owned items have boxes!</td></tr>';
  }
}

function exportReport() {
  const thead = document.getElementById('report-thead');
  const tbody = document.getElementById('report-tbody');
  const headers = [...thead.querySelectorAll('th')].map(th => th.textContent).join(',');
  const rows = [...tbody.querySelectorAll('tr')].map(tr =>
    [...tr.querySelectorAll('td')].map(td => `"${td.textContent.replace(/"/g,'""')}"`).join(',')
  ).join('\n');
  const csv = headers + '\n' + rows;
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'lionel-report.csv'; a.click();
}

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildWantPage() {
  const isMobile = window.innerWidth <= 640;
  const entries = Object.values(state.wantData);
  // Keep count badge in sync
  const countBadge = document.getElementById('nav-wanted2');
  if (countBadge) countBadge.textContent = entries.length.toLocaleString();
  const cardsEl = document.getElementById('want-cards');
  const tableEl = document.getElementById('want-table');
  const tbody   = document.getElementById('want-tbody');

  // Priority order
  const priorityOrder = { 'High': 0, 'Medium': 1, 'Low': 2 };
  entries.sort((a, b) => (priorityOrder[a.priority] ?? 1) - (priorityOrder[b.priority] ?? 1));

  const priorityColor = { High: 'var(--accent)', Medium: 'var(--accent2)', Low: 'var(--text-dim)' };

  if (entries.length === 0) {
    const empty = `<div style="text-align:center;padding:3rem 1rem;color:var(--text-dim)"><div style="font-size:2.5rem;margin-bottom:0.5rem">â¤ï¸</div><p>Your want list is empty</p><p style="font-size:0.8rem;margin-top:0.5rem">Add items you're looking for</p></div>`;
    if (cardsEl) cardsEl.innerHTML = empty;
    if (tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-dim)">No items on want list</td></tr>';
    return;
  }

  if (isMobile) {
    if (tableEl) tableEl.style.display = 'none';
    if (cardsEl) cardsEl.style.display = 'flex';
    cardsEl.innerHTML = entries.map(w => {
      const master = state.masterData.find(m => m.itemNum === w.itemNum && (!w.variation || m.variation === w.variation));
      const name = master ? (master.roadName || master.description || master.itemType || '') : '';
      const pColor = priorityColor[w.priority] || 'var(--text-dim)';
      const masterIdx2 = master ? state.masterData.indexOf(master) : -1;
      return `<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:0.85rem 1rem;display:flex;align-items:center;gap:0.75rem;cursor:pointer" onclick="${masterIdx2>=0?`openItem(${masterIdx2})`:''}" >
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:0.5rem">
            <span style="font-family:var(--font-head);font-size:1.1rem;color:var(--accent)">${w.itemNum}</span>
            ${w.variation ? `<span style="font-size:0.72rem;color:var(--text-dim)">${w.variation}</span>` : ''}
            <span style="font-size:0.65rem;font-weight:600;color:${pColor};border:1px solid ${pColor};border-radius:4px;padding:0.1rem 0.4rem">${w.priority || 'Medium'}</span>
          </div>
          ${name ? `<div style="font-size:0.82rem;color:var(--text);margin-top:0.15rem">${name}</div>` : ''}
          ${w.notes ? `<div style="font-size:0.72rem;color:var(--text-dim);margin-top:0.15rem">${w.notes}</div>` : ''}
        </div>
        <div style="text-align:right;flex-shrink:0">
          ${w.expectedPrice ? `<div style="font-family:var(--font-mono);color:var(--accent2);font-size:0.9rem">$${parseFloat(w.expectedPrice).toLocaleString()}</div>` : ''}
        </div>
      </div>`;
    }).join('');
  } else {
    if (tableEl) tableEl.style.display = '';
    if (cardsEl) cardsEl.style.display = 'none';
    // Store descriptions in a map to avoid quoting issues in onclick
    window._wantDescs = {};
    tbody.innerHTML = entries.map((w, idx) => {
      const master = state.masterData.find(m => m.itemNum === w.itemNum && (!w.variation || m.variation === w.variation));
      const roadName = master ? (master.roadName || '') : '';
      const varDesc  = master ? (master.varDesc || master.variationDesc || '') : '';
      const fullDesc = master ? (master.description || '') : '';
      window._wantDescs[idx] = { title: roadName || w.itemNum, varDesc, fullDesc };
      const pColor = priorityColor[w.priority] || 'var(--text-dim)';
      const shortVar = varDesc.length > 30 ? varDesc.substring(0, 30) + 'â€¦' : varDesc;
      const varCell = varDesc
        ? `<span style="cursor:pointer;border-bottom:1px dashed var(--border);color:var(--text-mid)" onclick="showWantDesc(${idx})">${shortVar}</span>`
        : (w.variation ? `<span class="text-dim">${w.variation}</span>` : '<span class="text-dim">â€”</span>');
      return `<tr>
        <td><span class="item-num">${w.itemNum}</span></td>
        <td>${roadName || '<span class="text-dim">â€”</span>'}</td>
        <td>${w.variation || '<span class="text-dim">â€”</span>'}</td>
        <td>${varCell}</td>
        <td><span style="color:${pColor};font-weight:500">${w.priority || 'Medium'}</span></td>
        <td class="market-val">${w.expectedPrice ? '$' + parseFloat(w.expectedPrice).toLocaleString() : '<span class="text-dim">â€”</span>'}</td>
      </tr>`;
    }).join('') || '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-dim)">No items on want list</td></tr>';
  }
}

function showVarDescPopup(idx) {
  const item = state.masterData[idx];
  if (!item || !item.varDesc) return;
  const existing = document.getElementById('vardesc-popup');
  if (existing) existing.remove();
  const overlay = document.createElement('div');
  overlay.id = 'vardesc-popup';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1.5rem';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  const box = document.createElement('div');
  box.style.cssText = 'background:var(--surface);border:1px solid var(--border);border-radius:14px;max-width:520px;width:100%;padding:1.5rem;position:relative';
  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'âœ•';
  closeBtn.style.cssText = 'position:absolute;top:0.75rem;right:0.75rem;background:none;border:none;color:var(--text-dim);font-size:1.1rem;cursor:pointer';
  closeBtn.onclick = function() { overlay.remove(); };
  box.appendChild(closeBtn);
  const hdr = document.createElement('div');
  hdr.style.cssText = 'font-family:var(--font-head);color:var(--accent2);margin-bottom:0.5rem;margin-right:2rem';
  hdr.textContent = item.itemNum + (item.variation ? ' â€” Variation ' + item.variation : '') + (item.roadName ? ' Â· ' + item.roadName : '');
  box.appendChild(hdr);
  const varEl = document.createElement('div');
  varEl.style.cssText = 'font-size:0.9rem;color:var(--text);line-height:1.7';
  varEl.textContent = item.varDesc;
  box.appendChild(varEl);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function showWantDesc(idx) {
  const d = (window._wantDescs || {})[idx];
  if (!d) return;
  const existing = document.getElementById('want-desc-modal');
  if (existing) existing.remove();
  const overlay = document.createElement('div');
  overlay.id = 'want-desc-modal';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1.5rem';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  const box = document.createElement('div');
  box.style.cssText = 'background:var(--surface);border:1px solid var(--border);border-radius:14px;max-width:520px;width:100%;padding:1.5rem;position:relative';
  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'âœ•';
  closeBtn.style.cssText = 'position:absolute;top:0.75rem;right:0.75rem;background:none;border:none;color:var(--text-dim);font-size:1.1rem;cursor:pointer';
  closeBtn.onclick = function() { overlay.remove(); };
  box.appendChild(closeBtn);
  const titleEl = document.createElement('div');
  titleEl.style.cssText = 'font-family:var(--font-head);font-size:1rem;color:var(--accent2);margin-bottom:0.75rem;margin-right:2rem';
  titleEl.textContent = d.title;
  box.appendChild(titleEl);
  if (d.varDesc) {
    const varEl = document.createElement('div');
    varEl.style.cssText = 'font-size:0.85rem;color:var(--accent);font-weight:600;margin-bottom:0.5rem';
    varEl.textContent = 'Variation: ' + d.varDesc;
    box.appendChild(varEl);
  }
  const descEl = document.createElement('div');
  descEl.style.cssText = 'font-size:0.85rem;color:var(--text-mid);line-height:1.7';
  descEl.textContent = d.fullDesc || d.title;
  box.appendChild(descEl);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

function toggleSoldSummary() {
  const box = document.getElementById('sold-summary-box');
  const btn = document.getElementById('sold-summary-toggle');
  if (!box || !btn) return;
  const hidden = box.style.display === 'none';
  box.style.display = hidden ? 'flex' : 'none';
  btn.textContent = hidden ? 'Hide Summary' : 'Show Summary';
  try { localStorage.setItem('soldSummaryHidden', hidden ? '0' : '1'); } catch(e) {}
}

function buildSoldPage() {
  const soldEntries = Object.values(state.soldData);
  const tbody = document.getElementById('sold-tbody');

  // Populate summary stats
  const totalRevenue = soldEntries.reduce((sum, sd) => sum + (parseFloat(sd.salePrice) || 0), 0);
  const countEl = document.getElementById('sold-stat-count');
  const totalEl = document.getElementById('sold-stat-total');
  if (countEl) countEl.textContent = soldEntries.length.toLocaleString();
  if (totalEl) totalEl.textContent = totalRevenue > 0 ? '$' + Math.round(totalRevenue).toLocaleString() : '$0';

  // Restore hidden state from localStorage
  try {
    const box = document.getElementById('sold-summary-box');
    const btn = document.getElementById('sold-summary-toggle');
    if (box && btn && localStorage.getItem('soldSummaryHidden') === '1') {
      box.style.display = 'none';
      btn.textContent = 'Show Summary';
    }
  } catch(e) {}

  const isMobileSold = window.innerWidth <= 640;
  const soldCardsEl = document.getElementById('sold-cards');
  const soldTableWrap = document.getElementById('sold-table-wrap');

  if (isMobileSold) {
    if (soldCardsEl) soldCardsEl.style.display = 'flex';
    if (soldTableWrap) soldTableWrap.style.display = 'none';
    if (soldCardsEl) soldCardsEl.innerHTML = soldEntries.length ? soldEntries.map(sd => {
      const master = state.masterData.find(i => i.itemNum === sd.itemNum && i.variation === sd.variation) || {};
      return `<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:0.85rem 1rem">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <span style="font-family:var(--font-head);font-size:1.1rem;color:var(--accent)">${sd.itemNum}</span>
            ${sd.variation ? `<span style="font-size:0.72rem;color:var(--text-dim);margin-left:0.4rem">${sd.variation}</span>` : ''}
            ${master.roadName ? `<div style="font-size:0.82rem;color:var(--text);margin-top:0.1rem">${master.roadName}</div>` : ''}
            <div style="font-size:0.72rem;color:var(--text-dim);margin-top:0.15rem">${[master.itemType, sd.condition ? 'Cond: '+sd.condition : '', sd.dateSold].filter(Boolean).join(' Â· ')}</div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            ${sd.salePrice ? `<div style="font-family:var(--font-mono);color:#2ecc71;font-size:1.1rem;font-weight:600">$${parseFloat(sd.salePrice).toLocaleString()}</div>` : '<div style="color:var(--text-dim);font-size:0.8rem">No price</div>'}
          </div>
        </div>
      </div>`;
    }).join('') : '<div style="text-align:center;padding:3rem 1rem;color:var(--text-dim)"><div style="font-size:2.5rem;margin-bottom:0.5rem">ðŸ’°</div><p>No sold items yet</p></div>';
  } else {
    if (soldCardsEl) soldCardsEl.style.display = 'none';
    if (soldTableWrap) soldTableWrap.style.display = '';
    tbody.innerHTML = soldEntries.length ? soldEntries.map(sd => {
      const master = state.masterData.find(i => i.itemNum === sd.itemNum && i.variation === sd.variation) || {};
      return `<tr>
        <td><span class="item-num">${sd.itemNum}</span></td>
        <td><span class="tag">${master.itemType || 'â€”'}</span></td>
        <td>${master.roadName || 'â€”'}</td>
        <td>${sd.variation || 'â€”'}</td>
        <td>${sd.condition || 'â€”'}</td>
        <td class="market-val">${sd.salePrice ? '$' + parseFloat(sd.salePrice).toLocaleString() : 'â€”'}</td>
        <td class="text-dim">${sd.dateSold || 'â€”'}</td>
      </tr>`;
    }).join('') : '<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">ðŸ’°</div><p>No sold items yet</p></div></td></tr>';
  }

  document.getElementById('nav-sold').textContent = soldEntries.length;
}

function showPage(name, clickedEl) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.mobile-nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (clickedEl) clickedEl.classList.add('active');
  if (name === 'browse') renderBrowse();
  if (name === 'reports') buildReport();
  if (name === 'sold') buildSoldPage();
  if (name === 'want') buildWantPage();
  document.getElementById('main-content').scrollTop = 0;
}

// â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseJwt(token) {
  const base64 = token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/');
  return JSON.parse(atob(base64));
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = () => {
  if (typeof google !== 'undefined') initGoogle();
};
</script>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>
<script>
// â”€â”€ ADD ITEM WIZARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let wizard = {
  step: 0,
  tab: null,       // 'collection' | 'sold' | 'want'
  data: {},
  steps: [],
  matchedItem: null,
};

// Step definitions per tab
function getSteps(tab) {
  const base = [
    { id: 'tab',        title: 'What would you like to add?',          type: 'choice' },
    { id: 'itemNum',    title: 'What is the Lionel item number?',       type: 'text',     placeholder: 'e.g. 726, 2046, 6464-1' },
    { id: 'variation',  title: 'Which variation is it?',                type: 'variation', optional: true },
  ];

  if (tab === 'collection') {
    // Box-only mode: skip item condition/price, only ask box info
    if (wizard.data.boxOnly) {
      return [
        { id: 'tab',           title: 'What would you like to add?',       type: 'choice' },
        { id: 'itemNum',       title: 'What is the Lionel item number?',    type: 'text',     placeholder: 'e.g. 726, 2046, 6464-1' },
        { id: 'pickRow',       title: 'Which item is this box for?',        type: 'pickRow',  skipIf: (d) => {
          const matches = Object.keys(state.personalData).filter(k => k.split('|')[0] === (d.itemNum||'').trim());
          return matches.length <= 1; // skip if 0 or 1 match â€” no choice needed
        }},
        { id: 'boxCond',       title: 'What condition is the box?',         type: 'slider',   min:1, max:10 },
        { id: 'priceBox',      title: 'What did you pay for the box?',      type: 'money',    placeholder: '0.00', optional: true },
        { id: 'purchaseDate',  title: 'When did you buy the box?',          type: 'date',     optional: true },
        { id: 'userEstWorth',  title: 'What do you estimate it is worth?',  type: 'money',    placeholder: '0.00', optional: true },
        { id: 'notes',         title: 'Any notes about this box?',          type: 'textarea', optional: true },
        { id: 'confirm',       title: 'Ready to save box info!',            type: 'confirm' },
      ];
    }
    // Helper: is this a paired engine+tender set?
    const isPaired = (d) => d.tenderMatch && d.tenderMatch !== 'none' && d.tenderMatch !== '';
    const engineLabel = (d) => isPaired(d) ? ' (Engine Only â€” tender added next)' : '';
    const tenderLabel = (d) => ' (Tender: ' + (d.tenderMatch || '') + ')';

    return [...base,
      // â”€â”€ ENGINE section â”€â”€
      { id: 'condition',    title: 'What condition is the engine?',         type: 'slider',   min:1, max:10, skipIf: () => false },
      { id: 'allOriginal',  title: 'Is it all original parts?',             type: 'choice3',  choices: ['Yes','No','Unknown'] },
      { id: 'tenderMatch',  title: 'Tender / Engine matching',              type: 'tenderMatch',
        skipIf: (d) => {
          const num = (d.itemNum || '').trim();
          return getMatchingTenders(num).length === 0 && getMatchingLocos(num).length === 0;
        }
      },
      { id: 'setMatch', title: 'Multi-unit diesel set',                    type: 'setMatch',
        skipIf: (d) => !isF3AlcoUnit((d.itemNum || '').trim())
      },
      { id: 'unitPower', title: 'Is this a powered or dummy unit?',       type: 'choice2',
        choices: ['Powered', 'Dummy'],
        note: () => 'Lionel used the same item number for both. This will be saved as e.g. 2343-P or 2343-D.',
        skipIf: (d) => {
          const num = (d.itemNum || '').trim();
          // Only ask for A units (not B/C units â€” those are always unpowered dummies)
          return num.endsWith('C') || !isF3AlcoUnit(num);
        }
      },
      { id: 'hasBox',       title: 'Did the engine come with a box?',       type: 'choice2',  choices: ['Yes','No'], skipIf: (d) => !!d._attachToBox },
      { id: 'boxCond',      title: 'What condition is the engine box?',     type: 'slider',   min:1, max:10, skipIf: (d) => (d.hasBox !== 'Yes' && !d._attachToBox) || !!d._attachToBox },
      { id: 'photosItem',   title: 'Add photos of the engine',              type: 'drivePhotos', label: 'Item',
        note: (d) => isPaired(d) ? 'Engine photos only â€” tender photos will be added next. Each item is filed in its own Drive folder.' : '' },
      { id: 'photosBox',    title: 'Add photos of the engine box',          type: 'drivePhotos', label: 'Box',
        skipIf: (d) => (d.hasBox !== 'Yes' && !d._attachToBox) || !!d._attachToBox,
        note: (d) => isPaired(d) ? 'Engine box photos only â€” tender box photos will be added next.' : '' },

      // â”€â”€ TENDER section (only shown when paired) â”€â”€
      { id: '_tenderDivider', title: 'Now for the tender',                  type: 'divider',
        subtitle: (d) => 'Next we will record details for the matching tender (' + d.tenderMatch + '). It will be saved as a separate item in your collection.',
        skipIf: (d) => !isPaired(d) },
      { id: 'tenderCondition',  title: 'What condition is the tender?',     type: 'slider',   min:1, max:10, skipIf: (d) => !isPaired(d) },
      { id: 'tenderAllOriginal', title: 'Is the tender all original?',      type: 'choice3',  choices: ['Yes','No','Unknown'], skipIf: (d) => !isPaired(d) },
      { id: 'tenderHasBox',   title: 'Did the tender come with a box?',     type: 'choice2',  choices: ['Yes','No'], skipIf: (d) => !isPaired(d) },
      { id: 'tenderBoxCond',  title: 'What condition is the tender box?',   type: 'slider',   min:1, max:10, skipIf: (d) => !isPaired(d) || d.tenderHasBox !== 'Yes' },
      { id: 'photosTenderItem', title: 'Add photos of the tender',          type: 'drivePhotos', label: 'Item',
        tenderMode: true,
        note: () => 'Tender photos only â€” filed under the tender own Drive folder.',
        skipIf: (d) => !isPaired(d) },
      { id: 'photosTenderBox',  title: 'Add photos of the tender box',      type: 'drivePhotos', label: 'Box',
        tenderMode: true,
        note: () => 'Tender box photos only.',
        skipIf: (d) => !isPaired(d) || d.tenderHasBox !== 'Yes' },

      // â”€â”€ SET UNIT 2 section (only shown when buying as diesel set) â”€â”€
      { id: '_setDivider', title: 'Now for the second unit',             type: 'divider',
        subtitle: (d) => {
          const partner = getSetPartner((d.itemNum||'').trim()) || ((d.itemNum||'').trim()+'C');
          return 'Next we will record details for the ' + (d.setType||'AB') + ' set partner (' + partner + '). It will be saved as a separate item with the same Set ID.';
        },
        skipIf: (d) => d.setMatch !== 'set-now' },
      { id: 'unit2ItemNum',   title: 'Confirm second unit item number',   type: 'setUnit2Num',
        skipIf: (d) => d.setMatch !== 'set-now' },
      { id: 'unit2Condition', title: 'What condition is the second unit?', type: 'slider', min:1, max:10,
        skipIf: (d) => d.setMatch !== 'set-now' },
      { id: 'unit2AllOriginal', title: 'Is the second unit all original?', type: 'choice3', choices: ['Yes','No','Unknown'],
        skipIf: (d) => d.setMatch !== 'set-now' },
      { id: 'unit2HasBox',    title: 'Did the second unit come with a box?', type: 'choice2', choices: ['Yes','No'],
        skipIf: (d) => d.setMatch !== 'set-now' },
      { id: 'unit2BoxCond',   title: 'What condition is the second unit box?', type: 'slider', min:1, max:10,
        skipIf: (d) => d.setMatch !== 'set-now' || d.unit2HasBox !== 'Yes' },
      { id: 'photosUnit2Item', title: 'Add photos of the second unit',    type: 'drivePhotos', label: 'Item',
        unit2Mode: true,
        note: () => 'Photos for unit 2 â€” filed under its own Drive folder.',
        skipIf: (d) => d.setMatch !== 'set-now' },
      { id: 'photosUnit2Box',  title: 'Add photos of the second unit box', type: 'drivePhotos', label: 'Box',
        unit2Mode: true,
        note: () => 'Unit 2 box photos.',
        skipIf: (d) => d.setMatch !== 'set-now' || d.unit2HasBox !== 'Yes' },

      // â”€â”€ SET UNIT 3 section (ABA only) â”€â”€
      { id: '_set3Divider', title: 'Now for the third unit (A)',          type: 'divider',
        subtitle: () => 'Finally, the second A unit to complete the ABA set.',
        skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' },
      { id: 'unit3ItemNum',   title: 'Confirm third unit item number',    type: 'setUnit2Num',
        unit3: true,
        skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' },
      { id: 'unit3Power',     title: 'Is the third unit powered or dummy?', type: 'choice2',
        choices: ['Powered', 'Dummy'],
        note: () => 'Will be saved as e.g. 2343-P or 2343-D.',
        skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' },
      { id: 'unit3Condition', title: 'What condition is the third unit?', type: 'slider', min:1, max:10,
        skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' },
      { id: 'unit3AllOriginal', title: 'Is the third unit all original?', type: 'choice3', choices: ['Yes','No','Unknown'],
        skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' },
      { id: 'unit3HasBox',    title: 'Did the third unit come with a box?', type: 'choice2', choices: ['Yes','No'],
        skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' },
      { id: 'unit3BoxCond',   title: 'What condition is the third unit box?', type: 'slider', min:1, max:10,
        skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' || d.unit3HasBox !== 'Yes' },
      { id: 'photosUnit3Item', title: 'Add photos of the third unit',    type: 'drivePhotos', label: 'Item',
        unit3Mode: true,
        note: () => 'Photos for unit 3 (second A unit).',
        skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' },
      { id: 'photosUnit3Box',  title: 'Add photos of the third unit box', type: 'drivePhotos', label: 'Box',
        unit3Mode: true,
        note: () => 'Unit 3 box photos.',
        skipIf: (d) => d.setMatch !== 'set-now' || d.setType !== 'ABA' || d.unit3HasBox !== 'Yes' },

      // â”€â”€ PRICING (pricePaid handles all cases; save logic splits if paired/set) â”€â”€
      { id: 'pricePaid',    title: 'What did you pay?',                    type: 'pricePaid',
        note: (d) => isPaired(d) || d.setMatch === 'set-now' ? 'Full price goes to the first unit â€” other units will reference it in their notes.' : '' },
      { id: 'yearMade', title: 'What year do you think this was made?',      type: 'yearMade', optional: true },
      { id: 'datePurchased', title: 'When did you purchase?',               type: 'date',     optional: true },
      { id: 'userEstWorth',  title: 'What do you estimate it is worth?',
        type: 'money', placeholder: '0.00', optional: true,
        note: (d) => (isPaired(d) || d.setMatch === 'set-now') ? 'Full estimated value goes to the first unit.' : (d.hasBox === 'Yes' ? 'Include the value of both the item and the box.' : '') },

      // â”€â”€ TOGETHER photos (only when paired) â”€â”€
      { id: 'wantTogetherPhotos', title: 'Would you like to add photos of the engine and tender together?',
        type: 'choice2', choices: ['Yes','No'], skipIf: (d) => !isPaired(d) },
      { id: 'photosTogether',   title: 'Add photos of the engine and tender together',
        type: 'drivePhotos', label: 'Set',
        note: () => 'These photos will be filed under the engine Drive folder.',
        skipIf: (d) => !isPaired(d) || d.wantTogetherPhotos !== 'Yes' },

      { id: 'notes',        title: 'Any notes?',                           type: 'textarea', optional: true },
      { id: 'confirm',      title: 'Ready to save!',                       type: 'confirm' },
    ];
  } else if (tab === 'sold') {
    return [
      { id: 'tab',          title: 'What would you like to add?',         type: 'choice' },
      { id: 'itemNum',      title: 'What is the Lionel item number?',      type: 'text',        placeholder: 'e.g. 726, 2046, 6464-1' },
      { id: 'pickSoldItem', title: 'Which item are you selling?',          type: 'pickSoldItem',
        skipIf: (d) => {
          const matches = Object.keys(state.personalData).filter(k => k.split('|')[0] === (d.itemNum||'').trim());
          return matches.length === 0; // not in collection â€” skip picker
        }
      },
      { id: 'condition',    title: 'What condition was the item?',         type: 'slider',      min:1, max:10,
        skipIf: (d) => !!d.selectedSoldKey },
      { id: 'priceItem',    title: 'What did you originally pay for it?',  type: 'money',       placeholder: '0.00', optional: true,
        skipIf: (d) => !!d.selectedSoldKey },
      { id: 'salePrice',    title: 'What did you sell it for?',            type: 'money',       placeholder: '0.00' },
      { id: 'dateSold',     title: 'When did you sell it?',                type: 'date',        optional: true },
      { id: 'notes',        title: 'Any notes about the sale?',            type: 'textarea',    optional: true },
      { id: 'confirm',      title: 'Ready to save!',                       type: 'confirm' },
    ];
  } else { // want
    return [...base,
      { id: 'priority',      title: 'How high is your priority for this item?', type: 'choice3', choices: ['High','Medium','Low'] },
      { id: 'expectedPrice', title: 'What do you expect to pay?',               type: 'money',   placeholder: '0.00', optional: true },
      { id: 'notes',         title: "Any notes about what you're looking for?", type: 'textarea', optional: true },
      { id: 'confirm',       title: 'Ready to add to Want List!',               type: 'confirm' },
    ];
  }
}

function startAddWizard() {
  wizard = { step: 0, tab: null, data: {}, steps: getSteps(null), matchedItem: null };
  document.getElementById('wizard-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  renderWizardStep();
}

function openWizard(tab) {
  // Start wizard pre-set to a specific tab, skipping the tab picker step
  wizard = { step: 0, tab: tab, data: { tab: tab }, steps: getSteps(tab), matchedItem: null };
  document.getElementById('wizard-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  // Skip the first 'choice' step since tab is already selected
  if (wizard.steps[0] && wizard.steps[0].type === 'choice') {
    wizard.step = 1;
  }
  renderWizardStep();
}

function closeWizard() {
  document.getElementById('wizard-modal').classList.remove('open');
  document.body.style.overflow = '';
}

function closeWizardOnOverlay(e) {
  if (e.target === document.getElementById('wizard-modal')) closeWizard();
}

function renderWizardStep() {
  const steps = wizard.tab ? getSteps(wizard.tab) : getSteps(null);
  wizard.steps = steps;

  // Skip steps based on skipIf
  let step = wizard.step;
  while (step < steps.length - 1 && steps[step].skipIf && steps[step].skipIf(wizard.data)) {
    step++;
    wizard.step = step;
  }

  const s = steps[step];
  const total = steps.filter(st => !st.skipIf || !st.skipIf(wizard.data)).length;
  const current = steps.slice(0, step).filter(st => !st.skipIf || !st.skipIf(wizard.data)).length + 1;
  const pct = Math.round((current / total) * 100);

  // Declare nextBtn first â€” used in theme block below
  const nextBtn = document.getElementById('wizard-next-btn');

  // Apply color theme based on tab
  const wizModal = document.querySelector('#wizard-modal .modal');
  if (wizModal) {
    wizModal.classList.remove('wiz-collection','wiz-want','wiz-sold');
    if (wizard.tab === 'collection') wizModal.classList.add('wiz-collection');
    else if (wizard.tab === 'want')   wizModal.classList.add('wiz-want');
    else if (wizard.tab === 'sold')   wizModal.classList.add('wiz-sold');
  }
  const progBar = document.getElementById('wizard-progress');
  if (progBar) {
    if (wizard.tab === 'collection') progBar.style.background = '#e8401c';
    else if (wizard.tab === 'want')  progBar.style.background = '#2980b9';
    else if (wizard.tab === 'sold')  progBar.style.background = '#2ecc71';
    else                             progBar.style.background = 'var(--accent)';
  }
  if (nextBtn) {
    if (wizard.tab === 'want')       { nextBtn.style.background='#2980b9'; nextBtn.style.borderColor='#2980b9'; nextBtn.style.color='#fff'; }
    else if (wizard.tab === 'sold')  { nextBtn.style.background='#2ecc71'; nextBtn.style.borderColor='#2ecc71'; nextBtn.style.color='#081a0e'; }
    else                             { nextBtn.style.background=''; nextBtn.style.borderColor=''; nextBtn.style.color=''; }
  }

  document.getElementById('wizard-step-label').textContent = `Step ${current} of ${total}`;
  document.getElementById('wizard-title').textContent = s.title;
  document.getElementById('wizard-progress').style.width = pct + '%';
  document.getElementById('wizard-back-btn').style.display = step > 0 ? 'inline-flex' : 'none';
  const autoAdvanceTypes = new Set(['choice','choice2','choice3','variation','pickRow','pickSoldItem']);
  // setMatch and setUnit2Num need Next button (user may interact multiple times)
  if (s.type === 'confirm') {
    nextBtn.textContent = 'âœ“ Save';
    nextBtn.style.display = 'inline-flex';
  } else if (autoAdvanceTypes.has(s.type)) {
    nextBtn.style.display = 'none';
  } else {
    nextBtn.textContent = 'Next â†’';
    nextBtn.style.display = 'inline-flex';
  }

  const body = document.getElementById('wizard-body');

  if (s.type === 'choice') {
    // First step - choose tab
    body.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:0.75rem;padding-top:0.5rem">
        ${[['collection','âœ“ My Collection','Add an item you own','var(--green)'],
           ['sold','$ Sold','Record a sold item','#9b59b6'],
           ['want','â˜… Want List','Add to your wish list','var(--accent2)']].map(([val,label,desc,color]) => `
          <button onclick="wizardChooseTab('${val}')" style="
            display:flex;align-items:center;gap:1rem;padding:1rem 1.25rem;
            border-radius:10px;border:2px solid ${wizard.tab===val ? color : 'var(--border)'};
            background:${wizard.tab===val ? color+'22' : 'var(--surface2)'};
            color:var(--text);cursor:pointer;text-align:left;font-family:var(--font-body);
            transition:all 0.15s;width:100%
          ">
            <div style="font-size:1.5rem;width:36px;text-align:center">${label.split(' ')[0]}</div>
            <div>
              <div style="font-weight:600;font-size:0.95rem">${label.split(' ').slice(1).join(' ')}</div>
              <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.15rem">${desc}</div>
            </div>
          </button>`).join('')}

      </div>`;

  } else if (s.type === 'variation') {
    // Look up all variations for the entered item number
    const itemNum = wizard.data.itemNum || '';
    const variations = state.masterData.filter(i => i.itemNum === itemNum && i.variation);
    const val = wizard.data.variation || '';
    if (variations.length === 0) {
      // No variations in master - fall back to text input
      body.innerHTML = `
        <div style="padding-top:0.75rem">
          <input type="text" id="wiz-input" value="${val}" placeholder="Leave blank if no variation"
            style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;
            padding:0.75rem 1rem;color:var(--text);font-family:var(--font-body);font-size:1rem;outline:none"
            oninput="wizard.data.variation=this.value"
            onkeydown="if(event.key==='Enter')wizardNext()">
          ${s.note && s.note(wizard.data) ? `<div style="font-size:0.8rem;color:var(--accent2);margin-top:0.6rem;padding:0.5rem 0.75rem;background:rgba(245,166,35,0.1);border-radius:6px">${s.note(wizard.data)}</div>` : ''}
        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>
        ${(() => {
          const singleItem = state.masterData.find(i => i.itemNum === itemNum);
          return singleItem && singleItem.refLink
            ? '<a href="' + singleItem.refLink + '" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:0.4rem;margin-top:0.75rem;font-size:0.82rem;color:var(--accent2);text-decoration:none;padding:0.4rem 0.75rem;border:1px solid rgba(245,166,35,0.3);border-radius:6px;background:rgba(245,166,35,0.08)">View on COTT â†—</a>'
            : '';
        })()}
        </div>`;
      setTimeout(() => { const i = document.getElementById('wiz-input'); if(i) i.focus(); }, 50);
    } else {
      // Show variation cards with description tooltip
      body.innerHTML = `
        <div style="padding-top:0.5rem">
          <div style="display:flex;flex-direction:column;gap:0.5rem" id="var-cards">
            ${[{variation:'', varDesc:'No specific variation / not sure'}, ...variations].map(v => `
              <button onclick="wizardChooseVariation('${v.variation}')" style="
                display:flex;align-items:flex-start;gap:0.75rem;padding:0.85rem 1rem;
                border-radius:10px;text-align:left;width:100%;cursor:pointer;
                font-family:var(--font-body);transition:all 0.15s;
                border:2px solid ${val===v.variation ? 'var(--accent)' : 'var(--border)'};
                background:${val===v.variation ? 'rgba(232,64,28,0.12)' : 'var(--surface2)'};
                color:var(--text);
              ">
                <span style="
                  font-family:var(--font-mono);font-size:1rem;font-weight:600;
                  color:${val===v.variation ? 'var(--accent)' : 'var(--accent2)'};
                  min-width:2rem;padding-top:0.1rem;
                ">${v.variation || 'â€”'}</span>
                <span style="font-size:0.82rem;color:var(--text-mid);line-height:1.5">${v.varDesc || v.description || 'No description available'}</span>
              </button>`).join('')}
          </div>
          <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Selecting a variation will auto-advance</div>
          ${(() => {
            // Show COTT link for the selected variation, or the first variation if none selected
            const cottItem = variations.find(v => v.variation === val) || variations[0];
            return cottItem && cottItem.refLink
              ? '<a href="' + cottItem.refLink + '" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:0.4rem;margin-top:0.75rem;font-size:0.82rem;color:var(--accent2);text-decoration:none;padding:0.4rem 0.75rem;border:1px solid rgba(245,166,35,0.3);border-radius:6px;background:rgba(245,166,35,0.08)">View ' + (val ? val : 'item') + ' on COTT â†—</a>'
              : '';
          })()}
        </div>`;
    }

  } else if (s.type === 'text') {
    const val = wizard.data[s.id] || '';
    const showBoxOnly = s.id === 'itemNum' && wizard.tab === 'collection';
    const boxOnlyChecked = wizard.data.boxOnly || false;
    body.innerHTML = `
      <div style="padding-top:0.75rem">
        <input type="text" id="wiz-input" value="${val}" placeholder="${s.placeholder || ''}"
          style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;
          padding:0.75rem 1rem;color:var(--text);font-family:var(--font-body);font-size:1rem;outline:none"
          autocomplete="off"
          oninput="wizard.data['${s.id}']=this.value; if(this.id==='wiz-input' && wizard.steps[wizard.step].id==='itemNum') updateItemSuggestions(this.value)"
          onkeydown="handleSuggestionKey(event)">
        <div id="wiz-suggestions" style="display:none;flex-direction:column;gap:2px;margin-top:4px;max-height:220px;overflow-y:auto;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:4px"></div>
        ${s.optional ? '<div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>' : ''}
        <div id="wiz-match" style="margin-top:0.75rem"></div>
        ${showBoxOnly ? `
        <label onclick="toggleBoxOnly()" style="
          display:flex;align-items:center;gap:0.75rem;padding:0.85rem 1rem;margin-top:0.75rem;
          border-radius:10px;border:2px solid ${boxOnlyChecked ? 'var(--accent2)' : 'var(--border)'};
          background:${boxOnlyChecked ? 'rgba(245,166,35,0.1)' : 'var(--surface2)'};
          cursor:pointer;transition:all 0.15s;
        ">
          <div style="
            width:20px;height:20px;border-radius:5px;flex-shrink:0;
            border:2px solid ${boxOnlyChecked ? 'var(--accent2)' : 'var(--border)'};
            background:${boxOnlyChecked ? 'var(--accent2)' : 'transparent'};
            display:flex;align-items:center;justify-content:center;
            font-size:0.75rem;color:white;font-weight:700;transition:all 0.15s;
          ">${boxOnlyChecked ? 'âœ“' : ''}</div>
          <div>
            <div style="font-weight:600;font-size:0.9rem;color:var(--text)">Adding box info only</div>
            <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.1rem">I bought a separate box for this item</div>
          </div>
        </label>` : ''}
      </div>`;
    setTimeout(() => {
      const inp = document.getElementById('wiz-input');
      if (inp) {
        inp.focus();
        if (s.id === 'itemNum') {
          inp.addEventListener('input', debounceItemLookup);
          if (inp.value) updateItemSuggestions(inp.value);
        }
      }
    }, 50);

  } else if (s.type === 'slider') {
    const val = wizard.data[s.id] || 7;
    body.innerHTML = `
      <div style="padding-top:1rem">
        <div style="display:flex;align-items:center;gap:1rem">
          <div style="font-family:var(--font-head);font-size:3rem;color:var(--accent2);width:3rem" id="wiz-slider-val">${val}</div>
          <input type="range" min="${s.min}" max="${s.max}" value="${val}" id="wiz-slider" style="flex:1;accent-color:var(--accent)"
            oninput="wizard.data['${s.id}']=parseInt(this.value);document.getElementById('wiz-slider-val').textContent=this.value">
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:var(--text-dim);margin-top:0.25rem">
          <span>1 â€” Poor</span><span>5 â€” Good</span><span>10 â€” Mint</span>
        </div>
      </div>`;

  } else if (s.type === 'choice2' || s.type === 'choice3') {
    const val = wizard.data[s.id] || '';
    body.innerHTML = `
      <div style="display:flex;gap:0.75rem;flex-wrap:wrap;padding-top:0.75rem">
        ${s.choices.map(c => `
          <button onclick="wizardChoose('${s.id}','${c}')" style="
            flex:1;min-width:80px;padding:0.85rem;border-radius:10px;
            border:2px solid ${val===c ? 'var(--accent)' : 'var(--border)'};
            background:${val===c ? 'rgba(232,64,28,0.15)' : 'var(--surface2)'};
            color:${val===c ? 'var(--accent)' : 'var(--text-mid)'};
            font-family:var(--font-body);font-size:0.95rem;font-weight:500;cursor:pointer;transition:all 0.15s
          ">${c}</button>`).join('')}
      </div>`;

  } else if (s.type === 'pricePaid') {
    const itemVal = wizard.data.priceItem || '';
    body.innerHTML = `
      <div style="padding-top:0.75rem">
        <div style="font-size:0.72rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-dim);margin-bottom:0.4rem">What did you pay for the item? ($)</div>
        <div style="display:flex;align-items:center;gap:0.5rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem">
          <span style="color:var(--text-dim);font-size:1.2rem">$</span>
          <input type="number" id="wiz-price-item" value="${itemVal}" placeholder="0.00" min="0" step="0.01"
            style="flex:1;background:none;border:none;outline:none;color:var(--text);font-family:var(--font-body);font-size:1.1rem"
            oninput="wizard.data.priceItem=this.value"
            onkeydown="if(event.key==='Enter')wizardNext()">
        </div>
        ${s.note && s.note(wizard.data) ? `<div style="font-size:0.8rem;color:var(--accent2);margin-top:0.6rem;padding:0.5rem 0.75rem;background:rgba(245,166,35,0.1);border-radius:6px">${s.note(wizard.data)}</div>` : ''}
        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>
      </div>`;
    setTimeout(() => { const i = document.getElementById('wiz-price-item'); if(i) i.focus(); }, 50);

  } else if (s.type === 'money') {
    const val = wizard.data[s.id] || '';
    const moneyNote = s.note ? s.note(wizard.data) : '';
    const moneyNoteHtml = moneyNote ? '<div style="font-size:0.82rem;color:var(--accent2);margin-top:0.6rem;padding:0.5rem 0.75rem;background:rgba(245,166,35,0.12);border:1px solid rgba(245,166,35,0.4);border-radius:6px;line-height:1.4">' + moneyNote + '</div>' : '';
    body.innerHTML = `
      <div style="padding-top:0.75rem">
        <div style="display:flex;align-items:center;gap:0.5rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem">
          <span style="color:var(--text-dim);font-size:1.2rem">$</span>
          <input type="number" id="wiz-input" value="${val}" placeholder="${s.placeholder || '0.00'}" min="0" step="0.01"
            style="flex:1;background:none;border:none;outline:none;color:var(--text);font-family:var(--font-body);font-size:1.1rem"
            oninput="wizard.data['${s.id}']=this.value"
            onkeydown="if(event.key==='Enter')wizardNext()">
        </div>
        ${moneyNoteHtml}
        ${s.optional ? '<div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>' : ''}
      </div>`;
    setTimeout(() => { const i = document.getElementById('wiz-input'); if(i) i.focus(); }, 50);

  } else if (s.type === 'yearMade') {
    const wData = wizard.data;
    const itemNum  = (wData.itemNum  || '').trim();
    const variation = (wData.variation || '').trim();
    // Find the production year range from master data for this item/variation
    const match = state.masterData.find(m =>
        normalizeItemNum(m.itemNum) === normalizeItemNum(itemNum) &&
        (!variation || m.variation === variation)
      ) || state.masterData.find(m => normalizeItemNum(m.itemNum) === normalizeItemNum(itemNum));
    const yearRange = match ? (match.yearProd || '') : '';
    const curr = wData.yearMade || '';
    body.innerHTML = '<div style="padding-top:0.75rem">'
      + (yearRange
          ? '<div style="font-size:0.82rem;margin-bottom:0.75rem;padding:0.6rem 0.85rem;border-radius:8px;background:rgba(41,128,185,0.1);border:1px solid rgba(41,128,185,0.3);color:#2980b9">'
            + '<span style="font-weight:600">Production range for this variation:</span> ' + yearRange
            + '</div>'
          : '')
      + '<input type="number" id="wiz-year-input" value="' + curr + '" placeholder="e.g. 1952" min="1945" max="1969" '
      + 'style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem;color:var(--text);font-family:var(--font-mono);font-size:1.2rem;outline:none;letter-spacing:0.1em" '
      + 'oninput="wizard.data.yearMade=this.value" onkeydown="if(event.key===\'Enter\')wizardNext()">'
      + '<div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” if no year entered, the production range above will be used.</div>'
      + '</div>';
    setTimeout(function() { const i = document.getElementById('wiz-year-input'); if(i) i.focus(); }, 50);

  } else if (s.type === 'date') {
    const val = wizard.data[s.id] || '';
    body.innerHTML = `
      <div style="padding-top:0.75rem">
        <input type="date" id="wiz-input" value="${val}"
          style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;
          padding:0.75rem 1rem;color:var(--text);font-family:var(--font-body);font-size:1rem;outline:none"
          oninput="wizard.data['${s.id}']=this.value">
        ${s.note && s.note(wizard.data) ? `<div style="font-size:0.8rem;color:var(--accent2);margin-top:0.6rem;padding:0.5rem 0.75rem;background:rgba(245,166,35,0.1);border-radius:6px">${s.note(wizard.data)}</div>` : ''}
        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>
      </div>`;

  } else if (s.type === 'setMatch') {
    const itemNum = (wizard.data.itemNum || '').trim();
    const partner = getSetPartner(itemNum);
    const unitType = itemNum.endsWith('C') ? 'B unit' : 'A unit';
    const current = wizard.data.setMatch || '';

    // Check if user already owns a unit from this set
    const baseNum = itemNum.endsWith('C') ? itemNum.slice(0,-1) : itemNum;
    const ownedPartner = Object.values(state.personalData).find(pd =>
      pd.itemNum === baseNum || pd.itemNum === baseNum + 'C'
    );

    const smContainer = document.createElement('div');
    smContainer.style.cssText = 'padding-top:0.5rem';

    const intro = document.createElement('div');
    intro.style.cssText = 'font-size:0.85rem;color:var(--text-dim);margin-bottom:1rem';
    intro.textContent = 'This is a ' + unitType + ' that can be part of a multi-unit diesel set' + (partner ? ' (partner: ' + partner + ')' : '') + '.';
    smContainer.appendChild(intro);

    const opts = [
      { val: 'set-now',   icon: 'ðŸš‚ðŸš‚', label: 'Adding as a set now',        desc: 'Walk through all units together' },
      { val: 'link',      icon: 'ðŸ”—',   label: 'Link to unit already owned', desc: ownedPartner ? 'Found: ' + ownedPartner.itemNum + ' in your collection' : 'Assign same Set ID as existing unit', disabled: !ownedPartner },
      { val: 'standalone',icon: 'ðŸš‚',   label: 'Standalone / no set',        desc: 'Save this unit by itself' },
    ];

    opts.forEach(function(opt) {
      const btn = document.createElement('button');
      const sel = current === opt.val;
      btn.style.cssText = 'text-align:left;padding:0.85rem 1rem;border-radius:10px;cursor:pointer;width:100%;margin-bottom:0.5rem;'
        + 'border:2px solid ' + (sel ? 'var(--accent)' : 'var(--border)') + ';'
        + 'background:' + (sel ? 'rgba(232,64,28,0.12)' : 'var(--surface2)') + ';'
        + 'color:' + (opt.disabled ? 'var(--text-dim)' : 'var(--text)') + ';font-family:var(--font-body)';
      btn.disabled = opt.disabled;
      btn.onclick = function() {
        wizard.data.setMatch = opt.val;
        if (opt.val === 'set-now') {
          wizard.data._setId = genSetId(baseNum);
          wizard.data.unit2ItemNum = partner || baseNum + 'C';
          wizard.data.unit3ItemNum = wizard.data.itemNum; // ABA: third unit = same A number
        }
        if (opt.val === 'link' && ownedPartner) {
          wizard.data._setId = ownedPartner.setId || genSetId(baseNum);
        }
        renderWizardStep();
      };
      const top = document.createElement('div');
      top.style.cssText = 'display:flex;align-items:center;gap:0.75rem';
      const iconEl = document.createElement('span');
      iconEl.style.cssText = 'font-size:1.3rem';
      iconEl.textContent = opt.icon;
      const labelEl = document.createElement('div');
      labelEl.innerHTML = '<div style="font-weight:600;color:' + (sel?'var(--accent)':'inherit') + '">' + opt.label + '</div>'
        + '<div style="font-size:0.78rem;color:var(--text-dim)">' + opt.desc + '</div>';
      top.appendChild(iconEl);
      top.appendChild(labelEl);
      btn.appendChild(top);
      smContainer.appendChild(btn);
    });

    // Set type selector (AA/AB/ABA) â€” only show when 'set-now' selected
    if (current === 'set-now') {
      const typeDiv = document.createElement('div');
      typeDiv.style.cssText = 'margin-top:0.75rem;padding:0.75rem;background:var(--bg);border-radius:8px;border:1px solid var(--border)';
      typeDiv.innerHTML = '<div style="font-size:0.78rem;color:var(--text-dim);margin-bottom:0.5rem">What type of set?</div>';
      const btnRow = document.createElement('div');
      btnRow.style.cssText = 'display:flex;gap:0.5rem';
      ['AA','AB','ABA'].forEach(function(t) {
        const tb = document.createElement('button');
        const tsel = wizard.data.setType === t;
        tb.style.cssText = 'flex:1;padding:0.5rem;border-radius:7px;font-weight:600;cursor:pointer;font-family:var(--font-head);'
          + 'border:2px solid ' + (tsel?'var(--accent2)':'var(--border)') + ';'
          + 'background:' + (tsel?'rgba(245,166,35,0.15)':'var(--surface2)') + ';'
          + 'color:' + (tsel?'var(--accent2)':'var(--text-mid)');
        tb.textContent = t;
        tb.onclick = function() { wizard.data.setType = t; renderWizardStep(); };
        btnRow.appendChild(tb);
      });
      typeDiv.appendChild(btnRow);
      smContainer.appendChild(typeDiv);
    }

    const hint = document.createElement('div');
    hint.style.cssText = 'font-size:0.75rem;color:var(--text-dim);margin-top:0.75rem';
    hint.textContent = 'Optional â€” press Next to skip';
    smContainer.appendChild(hint);

    body.innerHTML = '';
    body.appendChild(smContainer);

  } else if (s.type === 'setUnit2Num') {
    // Pre-filled unit number â€” let user confirm or change
    const isUnit3 = !!s.unit3;
    const field = isUnit3 ? 'unit3ItemNum' : 'unit2ItemNum';
    const curr = wizard.data[field] || '';
    const label = isUnit3
      ? 'Third unit item number (second A unit â€” edit if needed)'
      : 'Second unit item number (pre-filled from partner â€” edit if needed)';
    body.innerHTML = '<div style="padding-top:0.75rem">'
      + '<div style="font-size:0.82rem;color:var(--text-dim);margin-bottom:0.5rem">' + label + '</div>'
      + '<input type="text" id="wiz-unit-num" value="' + curr + '" autocomplete="off" '
      + 'style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem;color:var(--text);font-family:var(--font-body);font-size:1rem;outline:none" '
      + 'oninput="wizard.data[\'' + field + '\']=this.value; updateUnitNumSuggestions(this.value,\'' + field + '\')" '
      + 'onkeydown="handleUnitNumKey(event)">'
      + '<div id="wiz-unit-suggestions" style="display:none;flex-direction:column;gap:2px;margin-top:4px;max-height:200px;overflow-y:auto;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:4px"></div>'
      + '</div>';
    setTimeout(function() {
      const i = document.getElementById('wiz-unit-num');
      if (i) { i.focus(); if (i.value) updateUnitNumSuggestions(i.value, field); }
    }, 50);

  } else if (s.type === 'divider') {
    const sub = s.subtitle ? s.subtitle(wizard.data) : '';
    body.innerHTML = '<div style="padding-top:1rem;text-align:center">'
      + '<div style="font-size:3rem;margin-bottom:0.75rem">ðŸšƒ</div>'
      + '<div style="font-size:0.95rem;color:var(--text-dim);line-height:1.6;max-width:340px;margin:0 auto">' + sub + '</div>'
      + '</div>';

  } else if (s.type === 'tenderMatch') {
    const tmItemNum = (wizard.data.itemNum || '').trim();
    const tmTenders = getMatchingTenders(tmItemNum);
    const tmLocos   = getMatchingLocos(tmItemNum);
    const tmIsTend  = tmLocos.length > 0;
    const tmCandidates = tmIsTend ? tmLocos : tmTenders;
    const tmRole    = tmIsTend ? 'locomotive' : 'tender';
    const tmCurrent = wizard.data.tenderMatch || '';
    const tmIntro   = tmIsTend
      ? ('This tender (' + tmItemNum + ') pairs with the following locomotive(s):')
      : ('This steam engine (' + tmItemNum + ') pairs with the following tender(s):');

    const tmContainer = document.createElement('div');
    tmContainer.style.cssText = 'padding-top:0.5rem';

    const tmIntroEl = document.createElement('div');
    tmIntroEl.style.cssText = 'font-size:0.85rem;color:var(--text-dim);margin-bottom:1rem';
    tmIntroEl.textContent = tmIntro;
    tmContainer.appendChild(tmIntroEl);

    tmCandidates.forEach(function(num) {
      const masterItem = state.masterData.find(function(m) { return m.itemNum === num; });
      const desc = masterItem ? (masterItem.roadName || masterItem.description || masterItem.itemType || '') : '';
      const owned = Object.values(state.personalData).find(function(pd) { return pd.itemNum === num; });
      const sel = tmCurrent === num;

      const btn = document.createElement('button');
      btn.style.cssText = 'text-align:left;padding:0.85rem 1rem;border-radius:10px;cursor:pointer;width:100%;margin-bottom:0.5rem;'
        + 'border:2px solid ' + (sel ? 'var(--accent)' : 'var(--border)') + ';'
        + 'background:' + (sel ? 'rgba(232,64,28,0.12)' : 'var(--surface2)') + ';'
        + 'color:var(--text);font-family:var(--font-body)';
      btn.onclick = function() { wizard.data.tenderMatch = num; renderWizardStep(); };

      const topRow = document.createElement('div');
      topRow.style.cssText = 'display:flex;align-items:center;justify-content:space-between';

      const numSpan = document.createElement('span');
      numSpan.style.cssText = 'font-family:var(--font-head);font-size:1.2rem;color:' + (sel ? 'var(--accent)' : 'var(--text)');
      numSpan.textContent = (tmIsTend ? 'ðŸš‚ ' : 'ðŸšƒ ') + num;
      topRow.appendChild(numSpan);

      if (owned) {
        const badge = document.createElement('span');
        badge.style.cssText = 'font-size:0.7rem;color:var(--accent2);border:1px solid var(--accent2);padding:0.15rem 0.5rem;border-radius:4px';
        badge.textContent = 'âœ“ In Collection';
        topRow.appendChild(badge);
      }
      btn.appendChild(topRow);

      if (desc) {
        const descEl = document.createElement('div');
        descEl.style.cssText = 'font-size:0.8rem;color:var(--text-dim);margin-top:0.2rem';
        descEl.textContent = desc;
        btn.appendChild(descEl);
      }
      tmContainer.appendChild(btn);
    });

    const noneBtn = document.createElement('button');
    noneBtn.style.cssText = 'text-align:left;padding:0.75rem 1rem;border-radius:10px;cursor:pointer;width:100%;'
      + 'border:2px solid var(--border);background:' + (tmCurrent === 'none' ? 'var(--surface2)' : 'transparent') + ';'
      + 'color:var(--text-dim);font-family:var(--font-body);font-size:0.85rem';
    noneBtn.textContent = 'No matching ' + tmRole + ' / not applicable';
    noneBtn.onclick = function() { wizard.data.tenderMatch = 'none'; renderWizardStep(); };
    tmContainer.appendChild(noneBtn);

    const tmHint = document.createElement('div');
    tmHint.style.cssText = 'font-size:0.75rem;color:var(--text-dim);margin-top:0.75rem';
    tmHint.textContent = 'Optional â€” press Next to skip';
    tmContainer.appendChild(tmHint);

    body.innerHTML = '';
    body.appendChild(tmContainer);

  } else if (s.type === 'drivePhotos') {
    const views = s.label === 'Box' ? BOX_VIEWS : s.label === 'Set' ? ITEM_VIEWS : ITEM_VIEWS;
    const stored = wizard.data[s.id] || {};
    body.innerHTML = `
      <div style="padding-top:0.25rem">
        <div style="font-size:0.78rem;color:var(--text-dim);margin-bottom:0.5rem">
          Drag &amp; drop or click each slot to upload. Photos save to Google Drive automatically.
        </div>
        ${s.note && s.note(wizard.data) ? '<div style="font-size:0.8rem;color:var(--accent2);margin-bottom:0.75rem;padding:0.5rem 0.75rem;background:rgba(245,166,35,0.1);border-radius:6px">' + s.note(wizard.data) + '</div>' : ''}
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.6rem" id="photo-grid">
          ${views.map(v => {
            const url = stored[v.key] || '';
            return `<div class="photo-drop-zone" data-view="${v.key}" data-sid="${s.id}"
              ondragover="event.preventDefault();this.style.borderColor='var(--accent)'"
              ondragleave="this.style.borderColor='var(--border)'"
              ondrop="handlePhotoDrop(event,'${s.id}','${v.key}')"
              onclick="document.getElementById('file-${s.id}-${v.key}').click()"
              style="border:2px dashed var(--border);border-radius:10px;min-height:90px;
              display:flex;flex-direction:column;align-items:center;justify-content:center;
              cursor:pointer;transition:border-color 0.2s;position:relative;overflow:hidden;
              background:var(--surface2)">
              ${url
                ? `<img src="${url}" style="width:100%;height:100%;object-fit:cover;position:absolute;inset:0" onerror="this.style.display='none'">
                   <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.6);
                   font-size:0.62rem;color:#fff;padding:2px 4px;text-align:center">${v.abbr} âœ“</div>`
                : `<div style="font-size:0.7rem;color:var(--text-dim);text-align:center;padding:0.5rem">
                   <div style="font-size:1.4rem;margin-bottom:0.2rem">ðŸ“·</div>
                   <div style="font-weight:600;color:var(--text-mid)">${v.abbr}</div>
                   <div style="font-size:0.62rem">${v.label}</div>
                   </div>`
              }
              <div id="prog-${s.id}-${v.key}" style="display:none;position:absolute;inset:0;
                background:rgba(0,0,0,0.7);align-items:center;justify-content:center;flex-direction:column">
                <div style="color:white;font-size:0.75rem">Uploadingâ€¦</div>
              </div>
            </div>
            <input type="file" id="file-${s.id}-${v.key}" accept="image/*" capture="environment" style="display:none"
              onchange="handlePhotoFile(event,'${s.id}','${v.key}')">`;
          }).join('')}
        </div>
        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.6rem">Optional â€” press Next to skip any views</div>
      </div>`;

  } else if (s.type === 'textarea') {
    const val = wizard.data[s.id] || '';
    body.innerHTML = `
      <div style="padding-top:0.75rem">
        <textarea id="wiz-input" placeholder="Optional notesâ€¦"
          style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;
          padding:0.75rem 1rem;color:var(--text);font-family:var(--font-body);font-size:0.9rem;
          outline:none;resize:vertical;min-height:100px"
          oninput="wizard.data['${s.id}']=this.value">${val}</textarea>
        ${s.note && s.note(wizard.data) ? `<div style="font-size:0.8rem;color:var(--accent2);margin-top:0.6rem;padding:0.5rem 0.75rem;background:rgba(245,166,35,0.1);border-radius:6px">${s.note(wizard.data)}</div>` : ''}
        <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem">Optional â€” press Next to skip</div>
      </div>`;
    setTimeout(() => { const i = document.getElementById('wiz-input'); if(i) i.focus(); }, 50);

  } else if (s.type === 'pickSoldItem') {
    const itemNum = (wizard.data.itemNum || '').trim();
    const matchKeys = Object.keys(state.personalData).filter(k => {
      const pd = state.personalData[k];
      // Show all owned rows for this item number
      // Include rows with real item info (condition not N/A or empty)
      return k.split('|')[0] === itemNum && pd.owned;
    });
    console.log('pickSoldItem matchKeys for', itemNum, ':', matchKeys, 'personalData keys:', Object.keys(state.personalData).filter(k => k.startsWith(itemNum + '|')));
    const selected = wizard.data.selectedSoldKey || '';
    body.innerHTML = `
      <div style="padding-top:0.5rem;display:flex;flex-direction:column;gap:0.5rem">
        ${matchKeys.length === 0 ? '<div style="color:var(--text-dim);font-size:0.85rem">No owned items found for this number.</div>' : ''}
        ${matchKeys.map(k => {
          const pd = state.personalData[k];
          const isSelected = selected === k;
          return `<button onclick="wizardPickSoldItem('${k}')" style="
            display:flex;align-items:flex-start;gap:0.75rem;padding:0.85rem 1rem;
            border-radius:10px;text-align:left;width:100%;cursor:pointer;
            font-family:var(--font-body);transition:all 0.15s;
            border:2px solid ${isSelected ? 'var(--accent)' : 'var(--border)'};
            background:${isSelected ? 'rgba(232,64,28,0.12)' : 'var(--surface2)'};
          ">
            <div style="flex:1">
              <div style="font-family:var(--font-mono);color:var(--accent2);font-size:0.9rem;font-weight:600">
                ${pd.itemNum}${pd.variation ? ' â€” Var ' + pd.variation : ''}
              </div>
              <div style="font-size:0.8rem;color:var(--text-mid);margin-top:0.3rem;display:flex;gap:1rem;flex-wrap:wrap">
                ${pd.condition ? `<span>Condition: <strong style="color:var(--text)">${pd.condition}</strong></span>` : ''}
                ${pd.hasBox === 'Yes' ? `<span style="color:var(--green)">âœ“ Has box</span>` : ''}
                ${pd.priceItem ? `<span>Paid: <strong style="color:var(--text)">$${parseFloat(pd.priceItem).toLocaleString()}</strong></span>` : ''}
                ${pd.allOriginal === 'Yes' ? `<span style="color:var(--accent2)">All original</span>` : ''}
              </div>
            </div>
            ${isSelected ? '<span style="color:var(--accent);font-size:1.1rem;align-self:center">âœ“</span>' : ''}
          </button>`;
        }).join('')}
        <button onclick="wizardPickSoldItem('__new__')" style="
          padding:0.75rem 1rem;border-radius:10px;text-align:left;width:100%;cursor:pointer;
          font-family:var(--font-body);font-size:0.85rem;transition:all 0.15s;
          border:2px solid ${selected==='__new__' ? 'var(--border)' : 'var(--border)'};
          background:var(--surface2);color:var(--text-dim);
        ">Not in my collection â€” enter details manually</button>
      </div>`;

  } else if (s.type === 'pickRow') {
    const itemNum = (wizard.data.itemNum || '').trim();
    const matchKeys = Object.keys(state.personalData).filter(k => k.split('|')[0] === itemNum);
    const selected = wizard.data.selectedRowKey || '';
    body.innerHTML = `
      <div style="padding-top:0.5rem;display:flex;flex-direction:column;gap:0.5rem">
        ${matchKeys.map(k => {
          const pd = state.personalData[k];
          const hasBoxAlready = pd.hasBox === 'Yes';
          const isSelected = selected === k;
          return `<button onclick="wizardPickRow('${k}')" style="
            display:flex;align-items:center;gap:0.75rem;padding:0.85rem 1rem;
            border-radius:10px;text-align:left;width:100%;cursor:pointer;
            font-family:var(--font-body);transition:all 0.15s;
            border:2px solid ${isSelected ? 'var(--accent)' : 'var(--border)'};
            background:${isSelected ? 'rgba(232,64,28,0.12)' : 'var(--surface2)'};
          ">
            <div style="flex:1">
              <div style="font-family:var(--font-mono);color:var(--accent2);font-size:0.85rem">${pd.itemNum} ${pd.variation ? 'â€” Var ' + pd.variation : ''}</div>
              <div style="font-size:0.8rem;color:var(--text-mid);margin-top:0.2rem">
                Condition: ${pd.condition || 'â€”'} Â· 
                ${hasBoxAlready
                  ? '<span style="color:var(--accent2)">Already has a box â€” will add new row</span>'
                  : '<span style="color:var(--green)">No box yet â€” will update this row</span>'}
              </div>
            </div>
            ${isSelected ? '<span style="color:var(--accent);font-size:1rem">âœ“</span>' : ''}
          </button>`;
        }).join('')}
      </div>`;

  } else if (s.type === 'confirm') {
    const item = wizard.matchedItem;
    body.innerHTML = `
      <div style="padding-top:0.5rem">
        ${item ? `
          <div style="background:var(--surface2);border-radius:8px;padding:0.85rem;margin-bottom:1rem">
            <div style="font-family:var(--font-mono);color:var(--accent2);font-size:0.8rem">No. ${item.itemNum}${item.variation ? ' â€” Var ' + item.variation : ''}</div>
            <div style="font-weight:600;margin-top:0.2rem">${item.roadName || item.itemType || ''}</div>
            <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.1rem">${item.yearProd || ''} Â· ${item.itemType || ''}</div>
          </div>` : `
          <div style="background:var(--surface2);border-radius:8px;padding:0.85rem;margin-bottom:1rem">
            <div style="font-family:var(--font-mono);color:var(--accent2)">Item ${wizard.data.itemNum || '?'}${wizard.data.variation ? ' Var ' + wizard.data.variation : ''}</div>
            <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.2rem">Not found in master inventory â€” will save with entered data</div>
          </div>`}
        <div style="display:flex;flex-direction:column;gap:0.35rem;font-size:0.83rem">
          ${Object.entries(wizard.data).filter(([k,v]) => k !== 'tab' && v && v !== '' && !Array.isArray(v)).map(([k,v]) => `
            <div style="display:flex;gap:0.5rem">
              <span style="color:var(--text-dim);min-width:130px;text-transform:capitalize">${k.replace(/([A-Z])/g,' $1').toLowerCase()}</span>
              <span>${k.includes('price') || k.includes('Price') || k.includes('Value') ? '$'+parseFloat(v).toLocaleString() : v}</span>
            </div>`).join('')}
        </div>
      </div>`;
  }
}

function wizardChooseTab(tab) {
  wizard.tab = tab;
  wizard.data.tab = tab;
  wizard.steps = getSteps(tab);
  renderWizardStep();
}

function wizardChoose(field, val) {
  wizard.data[field] = val;
  renderWizardStep();
  // Auto-advance for choice2/choice3 but not tenderMatch (user may want to review)
  const s = wizard.steps[wizard.step];
  if (s && s.type !== 'tenderMatch') {
    setTimeout(() => wizardNext(), 200);
  }
}

// Find personalData entry by itemNum|variation prefix (key includes row number)
function findPD(itemNum, variation) {
  const prefix = `${itemNum}|${variation || ''}|`;
  const k = Object.keys(state.personalData).find(k => k.startsWith(prefix));
  return k ? state.personalData[k] : null;
}
function findPDKey(itemNum, variation) {
  const prefix = `${itemNum}|${variation || ''}|`;
  return Object.keys(state.personalData).find(k => k.startsWith(prefix)) || null;
}

// â”€â”€ PHOTO UPLOAD HANDLERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function handlePhotoDrop(event, stepId, viewKey) {
  event.preventDefault();
  event.currentTarget.style.borderColor = 'var(--border)';
  const file = event.dataTransfer.files[0];
  if (file && file.type.startsWith('image/')) {
    await uploadWizardPhoto(file, stepId, viewKey);
  }
}

async function handlePhotoFile(event, stepId, viewKey) {
  const file = event.target.files[0];
  if (file) await uploadWizardPhoto(file, stepId, viewKey);
}

async function uploadWizardPhoto(file, stepId, viewKey) {
  const d = wizard.data;
  // For tender/set photo steps, use the tender or engine item number for the Drive folder
  const isTenderPhotoStep = stepId === 'photosTenderItem' || stepId === 'photosTenderBox';
  const isUnit2PhotoStep = stepId === 'photosUnit2Item' || stepId === 'photosUnit2Box';
  const isUnit3PhotoStep = stepId === 'photosUnit3Item' || stepId === 'photosUnit3Box';
  const isSetPhotoStep = stepId === 'photosTogether';
  const itemNum = isTenderPhotoStep
    ? (d.tenderMatch || d.itemNum || 'unknown').trim()
    : isUnit2PhotoStep
      ? (d.unit2ItemNum || d.itemNum || 'unknown').trim()
      : isUnit3PhotoStep
        ? (d.itemNum || 'unknown').trim()  // unit3 = second A unit, same number
        : (d.itemNum || 'unknown').trim();
  const variation = (d.variation || '').trim();

  // Show progress overlay
  const prog = document.getElementById('prog-' + stepId + '-' + viewKey);
  if (prog) { prog.style.display = 'flex'; }

  try {
    const url = await driveUploadItemPhoto(file, itemNum, viewKey);
    if (!wizard.data[stepId]) wizard.data[stepId] = {};
    wizard.data[stepId][viewKey] = url;
    // Re-render just this zone
    const zone = document.querySelector(`.photo-drop-zone[data-view="${viewKey}"][data-sid="${stepId}"]`);
    if (zone && url) {
      zone.innerHTML = `
        <img src="${url}" style="width:100%;height:100%;object-fit:cover;position:absolute;inset:0" onerror="this.style.display='none'">
        <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.6);
          font-size:0.62rem;color:#fff;padding:2px 4px;text-align:center">${viewKey} âœ“</div>`;
    }
  } catch(e) {
    console.error('Photo upload failed:', e);
    showToast('Photo upload failed: ' + e.message);
  } finally {
    if (prog) prog.style.display = 'none';
  }
}

function toggleBoxOnly() {
  wizard.data.boxOnly = !wizard.data.boxOnly;
  // Reset the step list so it picks up new boxOnly steps
  wizard.steps = getSteps(wizard.tab);
  renderWizardStep();
}

function wizardChooseAndAdvance(field, val) {
  wizard.data[field] = val;
  // Brief visual flash then advance
  setTimeout(() => wizardNext(), 150);
}

function toggleAttachToBox(itemNum) {
  wizard.data._attachToBox = !wizard.data._attachToBox;
  // Re-trigger lookup to refresh the checkbox display
  lookupItem(itemNum);
}

function wizardPickSoldItem(key) {
  wizard.data.selectedSoldKey = key;
  if (key !== '__new__') {
    const pd = state.personalData[key];
    if (pd) {
      // Pre-fill condition and original price from collection data
      if (pd.condition && pd.condition !== 'N/A') wizard.data.condition = parseInt(pd.condition);
      if (pd.priceItem && pd.priceItem !== 'N/A') wizard.data.priceItem = pd.priceItem;
    }
  }
  setTimeout(() => wizardNext(), 150);
}

function wizardPickRow(key) {
  wizard.data.selectedRowKey = key;
  setTimeout(() => wizardNext(), 150);
}

function wizardChooseVariation(variation) {
  wizard.data.variation = variation;
  setTimeout(() => wizardNext(), 150);
}

function updateWizardPhoto(field, idx, val) {
  // Legacy handler
  if (!wizard.data[field]) wizard.data[field] = {};
}

let itemLookupTimer;
let _suggestionIndex = -1;

function updateUnitNumSuggestions(query, field) {
  const el = document.getElementById('wiz-unit-suggestions');
  if (!el) return;
  const q = (query || '').trim().toLowerCase();
  if (q.length < 1) { el.style.display = 'none'; el.innerHTML = ''; return; }

  // Search master data for matching item numbers
  const seen = new Set();
  const candidates = [];
  state.masterData.forEach(function(m) {
    const num = normalizeItemNum(m.itemNum);
    if (!seen.has(num) && num.toLowerCase().includes(q)) {
      seen.add(num);
      candidates.push({ num: num, sub: (m.roadName || m.description || '').substring(0, 40) });
    }
  });

  candidates.sort(function(a, b) {
    const as = a.num.toLowerCase().startsWith(q);
    const bs = b.num.toLowerCase().startsWith(q);
    if (as && !bs) return -1;
    if (!as && bs) return 1;
    return a.num.localeCompare(b.num);
  });

  const top = candidates.slice(0, 10);
  if (top.length === 0) { el.style.display = 'none'; el.innerHTML = ''; return; }

  el.innerHTML = '';
  top.forEach(function(c) {
    const btn = document.createElement('button');
    btn.style.cssText = 'text-align:left;width:100%;padding:0.5rem 0.75rem;border:none;background:transparent;'
      + 'border-radius:6px;cursor:pointer;color:var(--text);font-family:var(--font-body);display:flex;align-items:baseline;gap:0.5rem';
    btn.onmouseenter = function() { btn.style.background = 'var(--surface2)'; };
    btn.onmouseleave = function() { btn.style.background = 'transparent'; };
    btn.onclick = function() {
      wizard.data[field] = c.num;
      const inp = document.getElementById('wiz-unit-num');
      if (inp) inp.value = c.num;
      el.style.display = 'none';
    };
    const numSpan = document.createElement('span');
    numSpan.style.cssText = 'font-family:var(--font-mono);font-weight:600;color:var(--accent2);font-size:0.95rem';
    numSpan.textContent = c.num;
    btn.appendChild(numSpan);
    if (c.sub) {
      const sub = document.createElement('span');
      sub.style.cssText = 'font-size:0.75rem;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap';
      sub.textContent = c.sub;
      btn.appendChild(sub);
    }
    el.appendChild(btn);
  });
  el.style.display = 'flex';
}

function handleUnitNumKey(e, field) {
  if (e.key === 'Enter') { wizardNext(); }
  else if (e.key === 'Escape') {
    const el = document.getElementById('wiz-unit-suggestions');
    if (el) el.style.display = 'none';
  }
}

function updateItemSuggestions(query) {
  const el = document.getElementById('wiz-suggestions');
  if (!el) return;
  const q = (query || '').trim().toLowerCase();
  if (q.length < 1) { el.style.display = 'none'; el.innerHTML = ''; return; }

  // Choose source based on tab
  const tab = wizard.tab;
  let candidates = [];

  if (tab === 'sold') {
    // Sell tab: suggest from owned collection
    const seen = new Set();
    Object.values(state.personalData).forEach(pd => {
      const key = pd.itemNum + (pd.variation ? ' (' + pd.variation + ')' : '');
      if (!seen.has(key) && pd.itemNum.toLowerCase().includes(q)) {
        seen.add(key);
        candidates.push({ num: pd.itemNum, label: key, sub: '' });
      }
    });
  } else {
    // Collection + Want: suggest from master list â€” unique item numbers
    const seen = new Set();
    state.masterData.forEach(m => {
      if (!seen.has(m.itemNum) && m.itemNum.toLowerCase().includes(q)) {
        seen.add(m.itemNum);
        const road = m.roadName || m.description || '';
        candidates.push({ num: m.itemNum, label: m.itemNum, sub: road.substring(0, 40) });
      }
    });
  }

  // Sort: starts-with first, then contains
  candidates.sort((a, b) => {
    const aStarts = a.num.toLowerCase().startsWith(q);
    const bStarts = b.num.toLowerCase().startsWith(q);
    if (aStarts && !bStarts) return -1;
    if (!aStarts && bStarts) return 1;
    return a.num.localeCompare(b.num);
  });

  candidates = candidates.slice(0, 12);

  if (candidates.length === 0) { el.style.display = 'none'; el.innerHTML = ''; return; }

  _suggestionIndex = -1;
  el.innerHTML = '';
  candidates.forEach(function(c, i) {
    const btn = document.createElement('button');
    btn.dataset.idx = i;
    btn.style.cssText = 'text-align:left;width:100%;padding:0.5rem 0.75rem;border:none;background:transparent;'
      + 'border-radius:6px;cursor:pointer;color:var(--text);font-family:var(--font-body);display:flex;align-items:baseline;gap:0.5rem';
    btn.onmouseenter = function() { highlightSuggestion(i); };
    btn.onclick = function() { selectSuggestion(c.num); };
    const numSpan = document.createElement('span');
    numSpan.style.cssText = 'font-family:var(--font-mono);font-weight:600;color:var(--accent2);font-size:0.95rem';
    numSpan.textContent = c.num;
    btn.appendChild(numSpan);
    if (c.sub) {
      const subSpan = document.createElement('span');
      subSpan.style.cssText = 'font-size:0.75rem;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap';
      subSpan.textContent = c.sub;
      btn.appendChild(subSpan);
    }
    el.appendChild(btn);
  });
  el.style.display = 'flex';
}

function highlightSuggestion(idx) {
  _suggestionIndex = idx;
  const el = document.getElementById('wiz-suggestions');
  if (!el) return;
  el.querySelectorAll('button').forEach(function(btn, i) {
    btn.style.background = i === idx ? 'var(--surface2)' : 'transparent';
  });
}

function selectSuggestion(num) {
  wizard.data.itemNum = num;
  const inp = document.getElementById('wiz-input');
  if (inp) inp.value = num;
  const el = document.getElementById('wiz-suggestions');
  if (el) { el.style.display = 'none'; el.innerHTML = ''; }
  lookupItem(num);
}

function handleSuggestionKey(e) {
  const el = document.getElementById('wiz-suggestions');
  const btns = el ? el.querySelectorAll('button') : [];
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    highlightSuggestion(Math.min(_suggestionIndex + 1, btns.length - 1));
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    highlightSuggestion(Math.max(_suggestionIndex - 1, 0));
  } else if (e.key === 'Enter') {
    if (_suggestionIndex >= 0 && btns[_suggestionIndex]) {
      e.preventDefault();
      btns[_suggestionIndex].click();
    } else {
      wizardNext();
    }
  } else if (e.key === 'Escape') {
    if (el) { el.style.display = 'none'; }
  }
}

function debounceItemLookup(e) {
  clearTimeout(itemLookupTimer);
  itemLookupTimer = setTimeout(() => lookupItem(e.target.value), 400);
}

function lookupItem(num) {
  const match = state.masterData.find(i => i.itemNum.toLowerCase() === num.trim().toLowerCase());
  wizard.matchedItem = match || null;
  const el = document.getElementById('wiz-match');
  if (!el) return;
  const trimmed = num.trim();
  if (!trimmed) { el.innerHTML = ''; return; }

  if (wizard.tab === 'sold') {
    // Sold mode: check collection first, show what they own
    const collectionKeys = Object.keys(state.personalData).filter(k => k.split('|')[0] === trimmed);
    const inCollection = collectionKeys.length > 0;
    if (inCollection) {
      const count = collectionKeys.length;
      el.innerHTML = `<div style="background:rgba(46,204,113,0.1);border:1px solid var(--green);border-radius:8px;padding:0.65rem 0.85rem;font-size:0.82rem">
        <span style="color:var(--green)">âœ“ Found in your collection</span> â€” ${count} item${count>1?'s':''} Â· select which one on the next step
      </div>`;
    } else {
      // Not in collection â€” show master catalog info if available
      if (match) {
        el.innerHTML = `<div style="background:rgba(245,166,35,0.1);border:1px solid var(--accent2);border-radius:8px;padding:0.65rem 0.85rem;font-size:0.82rem">
          <span style="color:var(--accent2)">Not in your collection</span> Â· ${match.roadName || match.itemType || ''} Â· ${match.yearProd || ''}<br>
          <span style="color:var(--text-dim)">You can still enter sale details manually</span>
        </div>`;
      } else {
        el.innerHTML = `<div style="font-size:0.8rem;color:var(--text-dim)">Not found in collection or catalog â€” enter details manually</div>`;
      }
    }
  } else if (wizard.data.boxOnly) {
    // Box-only mode: show collection status
    const collectionKey = Object.keys(state.personalData).find(k => k.startsWith(trimmed + '|'));
    const inCollection = !!collectionKey;
    const pd = inCollection ? state.personalData[collectionKey] : null;
    if (match) {
      el.innerHTML = `<div style="border-radius:8px;padding:0.65rem 0.85rem;font-size:0.82rem;
        background:rgba(46,204,113,0.1);border:1px solid var(--green)">
        <div><span style="color:var(--green)">âœ“ Found in catalog:</span> ${match.roadName || match.itemType || ''} Â· ${match.yearProd || ''}</div>
        <div style="margin-top:0.4rem;padding-top:0.4rem;border-top:1px solid rgba(255,255,255,0.08)">
          ${inCollection
            ? `<span style="color:var(--green)">âœ“ In your collection</span> Â· Condition: ${pd.condition || '?'} Â· Has box: ${pd.hasBox || 'No'}`
            : `<span style="color:var(--accent2)">âš  Box will be listed under Lionel Number ${trimmed}</span>`}
        </div>
      </div>`;
    } else {
      el.innerHTML = `<div style="background:rgba(245,166,35,0.1);border:1px solid var(--accent2);border-radius:8px;padding:0.65rem 0.85rem;font-size:0.82rem">
        <span style="color:var(--accent2)">âš  Not found in catalog</span> â€” will save box info anyway
        ${inCollection ? '<br><span style="color:var(--green)">âœ“ Found in your collection</span>' : ''}
      </div>`;
    }
  } else {
    // Normal mode: show catalog match + check for existing box-only row
    const boxOnlyKeys = Object.keys(state.personalData).filter(k => {
      const pd = state.personalData[k];
      return k.split('|')[0] === trimmed && pd.hasBox === 'Yes' &&
        (!pd.condition || pd.condition === 'N/A') && (!pd.priceItem || pd.priceItem === 'N/A');
    });
    const hasBoxOnlyRow = boxOnlyKeys.length > 0;

    if (match) {
      el.innerHTML = `<div style="background:rgba(46,204,113,0.1);border:1px solid var(--green);border-radius:8px;padding:0.65rem 0.85rem;font-size:0.82rem">
        <span style="color:var(--green)">âœ“ Found:</span> ${match.roadName || match.itemType || ''} Â· ${match.yearProd || ''} Â· ${match.itemType || ''}
        ${match.variation ? '<br><span style="color:var(--text-dim)">Note: multiple variations exist â€” select on next step</span>' : ''}
        ${hasBoxOnlyRow ? `<div style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid rgba(255,255,255,0.08)">
          <span style="color:var(--accent2)">ðŸ“¦ A box is already logged for this item.</span>
          <label onclick="toggleAttachToBox('${trimmed}')" style="display:inline-flex;align-items:center;gap:0.4rem;margin-left:0.5rem;cursor:pointer">
            <span id="attach-box-check" style="
              display:inline-flex;align-items:center;justify-content:center;
              width:16px;height:16px;border-radius:3px;font-size:0.65rem;font-weight:700;color:white;
              background:${wizard.data._attachToBox ? 'var(--accent2)' : 'transparent'};
              border:2px solid ${wizard.data._attachToBox ? 'var(--accent2)' : 'var(--text-dim)'}
            ">${wizard.data._attachToBox ? 'âœ“' : ''}</span>
            <span style="color:var(--text-dim);font-size:0.8rem">Add item info to that box row</span>
          </label>
        </div>` : ''}
      </div>`;
    } else {
      el.innerHTML = `<div style="font-size:0.8rem;color:var(--text-dim)">Not found in master inventory â€” will save anyway</div>`;
    }
  }
}

function wizardBack() {
  if (wizard.step > 0) {
    wizard.step--;
    // Skip back over skipIf steps
    while (wizard.step > 0 && wizard.steps[wizard.step].skipIf && wizard.steps[wizard.step].skipIf(wizard.data)) {
      wizard.step--;
    }
    renderWizardStep();
  }
}

async function wizardNext() {
  const steps = wizard.steps;
  const s = steps[wizard.step];

  // Validate required fields
  if (s.type === 'choice' && !wizard.tab) {
    alert('Please select where to add the item.'); return;
  }
  if (s.type === 'text' && !s.optional && !wizard.data[s.id]?.trim()) {
    alert('This field is required.'); return;
  }
  if (s.type === 'money' && !s.optional && !wizard.data[s.id]) {
    alert('Please enter a price.'); return;
  }
  if ((s.type === 'choice2' || s.type === 'choice3') && !wizard.data[s.id]) {
    alert('Please make a selection.'); return;
  }

  // If this is the confirm step, save
  if (s.type === 'confirm') {
    await saveWizardItem();
    return;
  }

  // Photo-only mode: after completing a drivePhotos step, save the link and close
  if (wizard.data._photoOnly && s.type === 'drivePhotos') {
    await savePhotoOnlyUpdate();
    return;
  }

  // Commit slider default if user never moved it
  if (s.type === 'slider' && (wizard.data[s.id] === undefined || wizard.data[s.id] === null)) {
    wizard.data[s.id] = 7;
  }

  // Advance
  wizard.step++;

  // Skip steps based on skipIf
  while (wizard.step < steps.length - 1 && steps[wizard.step].skipIf && steps[wizard.step].skipIf(wizard.data)) {
    wizard.step++;
  }

  renderWizardStep();
}

async function savePhotoOnlyUpdate() {
  const d = wizard.data;
  const pdKey = d._updatePdKey;
  if (!pdKey || !state.personalData[pdKey]) {
    closeWizard(); return;
  }
  const pd = state.personalData[pdKey];
  // Get the folder link from whichever photo step just ran
  const photoObj = d.photosItem || d.photosBox || {};
  const folderLink = Object.values(photoObj).find(v => v) || '';
  if (folderLink && pd.row) {
    // Write folder link to col J (index 9) of the existing row
    try {
      await sheetsUpdate(state.personalSheetId, 'My Collection!J' + pd.row, [[folderLink]]);
      pd.photoItem = folderLink;
      showToast('âœ“ Photos saved!');
    } catch(e) {
      showToast('Photos uploaded but link save failed: ' + e.message);
    }
  } else {
    showToast('âœ“ Photos uploaded!');
  }
  closeWizard();
  // Refresh camera icons on current browse view
  if (folderLink) {
    const itemNum = pd.itemNum;
    const variation = pd.variation || '';
    const c1 = document.getElementById('cam-' + itemNum + '-' + variation);
    const c2 = document.getElementById('cam-' + itemNum + '-' + variation + '-m');
    if (c1) c1.style.display = 'inline';
    if (c2) c2.style.display = 'inline';
  }
}

async function saveWizardItem() {
  const d = wizard.data;
  const tab = wizard.tab;
  // Apply powered/dummy suffix to A units (B units ending in C are never powered)
  const _rawItemNum = (d.itemNum || '').trim();
  const _pdSuffix = (raw, power) => {
    if (!power || raw.endsWith('C')) return raw;
    return raw + (power === 'Powered' ? '-P' : '-D');
  };
  const itemNum = _pdSuffix(_rawItemNum, d.unitPower);
  const variation = (d.variation || '').trim();
  const key = `${itemNum}|${variation}`;
  // Photos are now Drive URL objects keyed by view
  const photoObj = d.photosItem || {};
  const boxPhotoObj = d.photosBox || {};
  // Primary display photo = Front View, fallback to first available
  // All views return the same folder link â€” just grab the first one found
  const anyItemLink = Object.values(photoObj).find(v => v) || '';
  const anyBoxLink  = Object.values(boxPhotoObj).find(v => v) || '';
  const photos    = [anyItemLink];
  const boxPhotos = [anyBoxLink];

  try {
    if (tab === 'collection') {
      // Find existing by row-keyed lookup (key includes row number now)
      let existing = Object.keys(state.personalData)
        .map(k => state.personalData[k])
        .find(pd => pd.itemNum === itemNum && pd.variation === variation) || null;
      if (d.boxOnly) {
        // Use explicitly selected row if user picked one
        if (d.selectedRowKey && state.personalData[d.selectedRowKey]) {
          existing = state.personalData[d.selectedRowKey];
        } else if (!existing) {
          // Fall back to first match by item number
          const matchKey = Object.keys(state.personalData).find(k => k.split('|')[0] === itemNum);
          if (matchKey) existing = state.personalData[matchKey];
        }
      } else if (d._attachToBox) {
        // Adding new item â€” find the box-only row by item number
        // Box-only rows have hasBox=Yes but no meaningful item condition/price
        const boxKey = Object.keys(state.personalData).find(k => {
          const pd = state.personalData[k];
          const noCondition = !pd.condition || pd.condition === '' || pd.condition === 'N/A';
          const noItemPrice = !pd.priceItem || pd.priceItem === '' || pd.priceItem === 'N/A';
          return k.split('|')[0] === itemNum && pd.hasBox === 'Yes' && noCondition && noItemPrice;
        });
        if (boxKey) existing = state.personalData[boxKey];
        console.log('_attachToBox lookup â€” boxKey:', boxKey, 'existing row:', existing?.row);
      }
      let row;
      if (d.boxOnly) {
        const ex = existing || {};
        const itemExists = !!existing;
        // Compute item+box complete price if we have both
        const itemPrice = parseFloat(ex.priceItem && ex.priceItem !== 'N/A' ? ex.priceItem : 0) || 0;
        const boxPrice  = parseFloat(d.priceBox) || 0;
        const completePrice = (itemPrice > 0 && boxPrice > 0)
          ? (itemPrice + boxPrice).toFixed(2)
          : boxPrice > 0 ? d.priceBox  // just the box price when no item price
          : (ex.priceComplete || '');
        row = [
          itemNum,
          itemExists ? (ex.variation || variation) : variation,
          ex.condition || (itemExists ? '' : 'N/A'),
          'Yes',  // box-only rows always set all original to Yes
          ex.priceItem || (itemExists ? '' : 'N/A'),
          d.priceBox || '',
          completePrice,
          'Yes',
          d.boxCond || '',
          ex.photoItem || '',
          boxPhotos[0] || '',
          ( d.notes || ex.notes || '' ).trim(),
          d.purchaseDate || ex.datePurchased || '',
          d.userEstWorth || ex.userEstWorth || '',
        ];
      } else {
        const _paired = d.tenderMatch && d.tenderMatch !== 'none';
        const enginePrice = _paired
          ? (d.priceItem ? (parseFloat(d.priceItem)/2).toFixed(2) : '')
          : (d.priceItem || '');
        const engineWorth = _paired
          ? (d.userEstWorth ? (parseFloat(d.userEstWorth)/2).toFixed(2) : '')
          : (d.userEstWorth || '');
        const calcComplete = _paired
          ? (enginePrice ? parseFloat(enginePrice) : 0)
          : ((parseFloat(d.priceItem)||0) + (parseFloat(d.priceBox)||0));
        row = [
          itemNum, variation,
          d.condition || '',
          d.allOriginal || '',
          enginePrice,
          d.priceBox || '',
          calcComplete > 0 ? calcComplete.toFixed(2) : '',
          d.hasBox || 'No',
          d.boxCond || '',
          photos[0] || '',
          boxPhotos[0] || '',
          ( d.notes || '' ).trim(),
          d.datePurchased || '',
          engineWorth,
          d.tenderMatch && d.tenderMatch !== 'none' ? d.tenderMatch : '',
          '',  // Set ID â€” filled in after save if set unit
          d.yearMade || '',  // Year Made (col Q)
        ];
      }
      // â”€â”€ SET UNIT SAVE: if diesel set, save unit2 (and unit3) rows with shared Set ID â”€â”€
  const isSetSave = d.setMatch === 'set-now';
  const setId = d._setId || '';

  if (isSetSave && d.unit2ItemNum) {
    const u2Num = (d.unit2ItemNum || '').trim();
    // Unit 1 keeps full price/worth; other units get $0 with a note pointing to unit 1
    const setPriceNote = (baseNote, leadNum) => {
      const ref = 'Set price on item ' + leadNum;
      return baseNote ? baseNote + '; ' + ref : ref;
    };

    const u2Row = [
      u2Num, '',
      d.unit2Condition || '',
      d.unit2AllOriginal || '',
      '', '', '',   // $0 â€” price is on unit 1
      d.unit2HasBox || 'No',
      d.unit2BoxCond || '',
      '', '',
      setPriceNote((d.notes || '').trim(), itemNum),
      d.datePurchased || '',
      '',           // $0 worth â€” worth is on unit 1
      itemNum,      // matchedTo = suffixed A unit
      setId,
    ];
    await sheetsAppend(state.personalSheetId, 'My Collection', [u2Row]);

    // Unit 3 (ABA second A unit)
    if (d.setType === 'ABA') {
      const u3Num = _pdSuffix((d.unit3ItemNum || _rawItemNum).trim(), d.unit3Power);
      const u3Row = [
        u3Num, '',
        d.unit3Condition || '',
        d.unit3AllOriginal || '',
        '', '', '',   // $0 â€” price is on unit 1
        d.unit3HasBox || 'No',
        d.unit3BoxCond || '',
        '', '',
        setPriceNote((d.notes || '').trim(), itemNum),
        d.datePurchased || '',
        '',           // $0 worth â€” worth is on unit 1
        u2Num,        // matchedTo = B unit
        setId,
      ];
      await sheetsAppend(state.personalSheetId, 'My Collection', [u3Row]);
      // Update u2Row matchedTo to also reference u3Num

    }

    // Update unit 1 row to include setId
    row[15] = setId;
    row[14] = row[14] || u2Num; // matchedTo
  }

  // Link-to-existing: just tag unit 1 with the existing set's setId
  if (d.setMatch === 'link' && d._setId) {
    row[15] = d._setId;
    // Update the existing unit's setId if it doesn't have one
    const existingUnit = Object.values(state.personalData).find(pd =>
      pd.itemNum === (itemNum.endsWith('C') ? itemNum.slice(0,-1) : itemNum+'C')
    );
    if (existingUnit && existingUnit.row && !existingUnit.setId) {
      sheetsUpdate(state.personalSheetId, 'My Collection!P' + existingUnit.row, [[d._setId]])
        .catch(e => console.warn('Set ID backfill:', e));
    }
  }

  // â”€â”€ PAIRED SAVE: if engine+tender together, save a second row for the tender â”€â”€
  const isPairedSave = d.tenderMatch && d.tenderMatch !== 'none';
  if (isPairedSave) {
    const tNum = d.tenderMatch.trim();
    const tVariation = '';
    const tenderNote = (() => {
      const ref = 'Set price on item ' + itemNum;
      return d.notes ? d.notes.trim() + '; ' + ref : ref;
    })();
    const tRow = [
      tNum, tVariation,
      d.tenderCondition || '',
      d.tenderAllOriginal || '',
      '', '',  '',  // $0 â€” full price is on the engine row
      d.tenderHasBox || 'No',
      d.tenderBoxCond || '',
      '',          // photo â€” filed separately under tender folder
      '',          // box photo
      tenderNote,
      d.datePurchased || '',
      '',          // $0 worth â€” worth is on the engine row
      itemNum,     // matchedTo = engine number
    ];
    await sheetsAppend(state.personalSheetId, 'My Collection', [tRow]);
    // Update engine row matchedTo to point to tender
    row[14] = tNum;
  }

  // Cross-link: if a tender/engine was matched, update that item's matchedTo column too
  const matchedNum = (!isPairedSave && d.tenderMatch && d.tenderMatch !== 'none') ? d.tenderMatch : null;
  if (matchedNum) {
    const matchedEntry = Object.values(state.personalData).find(pd => pd.itemNum === matchedNum);
    if (matchedEntry && matchedEntry.row) {
      // Update col O (index 14) of the matched row
      sheetsUpdate(state.personalSheetId, `My Collection!O${matchedEntry.row}`, [[itemNum]]).catch(e => console.warn('Cross-link update:', e));
      matchedEntry.matchedTo = itemNum;
    }
  }

  if (d._fillItemMode && existing?.row) {
        // Preserve ALL box fields, update only item fields
        row[5]  = existing.priceBox    || row[5];
        row[7]  = existing.hasBox      || 'Yes';
        row[8]  = existing.boxCond     || row[8];
        row[10] = existing.photoBox    || row[10];
        row[12] = existing.datePurchased || row[12];
        row[13] = d.userEstWorth || existing.userEstWorth || '';
        const fp = parseFloat(row[4]) || 0;
        const bp = parseFloat(row[5]) || 0;
        row[6] = fp > 0 && bp > 0 ? (fp + bp).toFixed(2) : (existing.priceComplete || '');
        const newNote = row[11] || '';
        const exNote  = existing.notes || '';
        const itemLabel = newNote.trim() ? `Item: ${newNote.trim()}` : '';
        const boxLabel  = exNote.trim()  ? `Box: ${exNote.trim()}`   : '';
        row[11] = [boxLabel, itemLabel].filter(Boolean).join(' | ');
        await sheetsUpdate(state.personalSheetId, `My Collection!A${existing.row}:N${existing.row}`, [row]);
      } else if (d._attachToBox && existing?.row) {
        // Attaching item to existing box row â€” preserve box data, merge notes
        row[2]  = d.condition || row[2];           // always use entered condition
        row[5]  = existing.priceBox    || row[5];  // keep box price
        row[7]  = existing.hasBox      || 'Yes';
        row[8]  = existing.boxCond     || row[8];  // keep box condition
        row[10] = existing.photoBox    || row[10]; // keep box photo
        row[12] = existing.datePurchased || row[12]; // keep date
        row[13] = d.userEstWorth || existing.userEstWorth || row[13];
        const fp2 = parseFloat(row[4]) || 0;
        const bp2 = parseFloat(row[5]) || 0;
        row[6] = fp2 > 0 && bp2 > 0 ? (fp2 + bp2).toFixed(2) : (existing.priceComplete || '');
        const newNote2 = row[11] || '';
        const exNote2  = existing.notes || '';
        const itemLabel2 = newNote2.trim() ? `Item: ${newNote2.trim()}` : '';
        const boxLabel2  = exNote2.trim()  ? `Box: ${exNote2.trim()}`   : '';
        row[11] = [boxLabel2, itemLabel2].filter(Boolean).join(' | ');
        await sheetsUpdate(state.personalSheetId, `My Collection!A${existing.row}:N${existing.row}`, [row]);
      } else {
        // Always append for a plain new collection add â€” never overwrite existing rows
        await sheetsAppend(state.personalSheetId, 'My Collection!A:N', [row]);
      }

    } else if (tab === 'sold') {
      // If user picked a collection row, pull its data and clear it from My Collection
      const collectionEntry = d.selectedSoldKey ? state.personalData[d.selectedSoldKey] : null;
      const soldVariation = collectionEntry ? (collectionEntry.variation || '') : variation;
      const soldCondition = d.condition || (collectionEntry?.condition !== 'N/A' ? collectionEntry?.condition : '') || '';
      const soldPricePaid = d.priceItem || (collectionEntry?.priceItem !== 'N/A' ? collectionEntry?.priceItem : '') || '';

      const row = [
        itemNum, soldVariation, '1',
        soldCondition,
        soldPricePaid,
        d.salePrice || '',
        d.dateSold || '',
        ( d.notes || '' ).trim(),
      ];
      const soldKey = `${itemNum}|${soldVariation}`;
      const existingSold = state.soldData[soldKey];
      if (existingSold?.row) {
        await sheetsUpdate(state.personalSheetId, `Sold!A${existingSold.row}:H${existingSold.row}`, [row]);
      } else {
        await sheetsAppend(state.personalSheetId, 'Sold!A:H', [row]);
      }
      // Delete the row from My Collection
      if (collectionEntry?.row) {
        await sheetsDeleteRow(state.personalSheetId, 'My Collection', collectionEntry.row);
      }
      // Move photo folder to Sold in Drive
      if (collectionEntry?.itemNum) {
        try { await driveMoveToSold(collectionEntry.itemNum); } catch(e) { console.warn('Drive move failed:', e); }
      }

    } else if (tab === 'want') {
      const row = [
        itemNum, variation,
        d.priority || 'Medium',
        d.expectedPrice || '',
        ( d.notes || '' ).trim(),
      ];
      const existing = state.wantData[key];
      if (existing?.row) {
        await sheetsUpdate(state.personalSheetId, `Want List!A${existing.row}:E${existing.row}`, [row]);
      } else {
        await sheetsAppend(state.personalSheetId, 'Want List!A:E', [row]);
      }
    }

    closeWizard();
    // Small delay to ensure Google Sheets has committed the data
    await new Promise(r => setTimeout(r, 800));
    await loadPersonalData();
    console.log('After reload - personalData keys:', Object.keys(state.personalData));
    console.log('After reload - soldData keys:', Object.keys(state.soldData));
    console.log('After reload - wantData keys:', Object.keys(state.wantData));
    resetFilters();
    buildDashboard();
    buildSoldPage();
    renderBrowse();
    showToast(`âœ“ Item ${itemNum} added to ${tab === 'collection' ? 'My Collection' : tab === 'sold' ? 'Sold' : 'Want List'}!`);

  } catch(e) {
    console.error('Save error:', e);
    alert('Error saving: ' + e.message);
  }
}

function showToast(msg) {
  let toast = document.getElementById('toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'toast';
    toast.style.cssText = `position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);
      background:var(--green);color:white;padding:0.75rem 1.5rem;border-radius:8px;
      font-size:0.9rem;font-weight:500;z-index:999;opacity:0;transition:opacity 0.3s;
      font-family:var(--font-body);box-shadow:0 4px 20px rgba(0,0,0,0.3)`;
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.style.opacity = '1';
  setTimeout(() => { toast.style.opacity = '0'; }, 3000);
}

</script>
